{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/graph/public/angular/graph_client_workspace.js","dependencies":[{"path":"x-pack/legacy/plugins/graph/public/angular/graph_client_workspace.js","mtime":1585205044197},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKLyoKICogQ29weXJpZ2h0IEVsYXN0aWNzZWFyY2ggQi5WLiBhbmQvb3IgbGljZW5zZWQgdG8gRWxhc3RpY3NlYXJjaCBCLlYuIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gTGljZW5zZWQgdW5kZXIgdGhlIEVsYXN0aWMgTGljZW5zZTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBFbGFzdGljIExpY2Vuc2UuCiAqLwovLyBLaWJhbmEgd3JhcHBlcgp2YXIgZDMgPSByZXF1aXJlKCdkMycpOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7CiAgLy8gUGx1Z2dhYmxlIGZ1bmN0aW9uIHRvIGhhbmRsZSB0aGUgY29tbXMgd2l0aCBhIHNlcnZlci4gRGVmYXVsdCBpbXBsIGhlcmUgaXMKICAvLyBmb3IgdXNlIG91dHNpZGUgb2YgS2liYW5hIHNlcnZlciB3aXRoIGRpcmVjdCBhY2Nlc3MgdG8gZWxhc3RpY3NlYXJjaAogIHZhciBncmFwaEV4cGxvcmVyID0gZnVuY3Rpb24gZ3JhcGhFeHBsb3JlcihpbmRleE5hbWUsIHR5cGVOYW1lLCByZXF1ZXN0LCByZXNwb25zZUhhbmRsZXIpIHsKICAgIHZhciBkYXRhRm9yU2VydmVyID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCk7CiAgICAkLmFqYXgoewogICAgICB0eXBlOiAnUE9TVCcsCiAgICAgIHVybDogJ2h0dHA6Ly9sb2NhbGhvc3Q6OTIwMC8nICsgaW5kZXhOYW1lICsgJy9fZ3JhcGgvZXhwbG9yZScsCiAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04JywKICAgICAgYXN5bmM6IHRydWUsCiAgICAgIGRhdGE6IGRhdGFGb3JTZXJ2ZXIsCiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoZGF0YSkgewogICAgICAgIHJlc3BvbnNlSGFuZGxlcihkYXRhKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIHNlYXJjaGVyID0gZnVuY3Rpb24gc2VhcmNoZXIoaW5kZXhOYW1lLCByZXF1ZXN0LCByZXNwb25zZUhhbmRsZXIpIHsKICAgIHZhciBkYXRhRm9yU2VydmVyID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCk7CiAgICAkLmFqYXgoewogICAgICB0eXBlOiAnUE9TVCcsCiAgICAgIHVybDogJ2h0dHA6Ly9sb2NhbGhvc3Q6OTIwMC8nICsgaW5kZXhOYW1lICsgJy9fc2VhcmNoP3Jlc3RfdG90YWxfaGl0c19hc19pbnQ9dHJ1ZScsCiAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04JywKICAgICAgLy9Ob3Qgc3VyZSB3aHkgdGhpcyB3YXMgbmVjZXNzYXJ5IC0gd29ya2VkIHdpdGhvdXQgZWxzZXdoZXJlCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBkYXRhOiBkYXRhRm9yU2VydmVyLAogICAgICBzdWNjZXNzOiBmdW5jdGlvbiBzdWNjZXNzKGRhdGEpIHsKICAgICAgICByZXNwb25zZUhhbmRsZXIoZGF0YSk7CiAgICAgIH0KICAgIH0pOwogIH07IC8vID09PT09PSBVbmRvIG9wZXJhdGlvbnMgPT09PT09PT09PT09PQoKCiAgZnVuY3Rpb24gQWRkTm9kZU9wZXJhdGlvbihub2RlLCBvd25lcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHZtID0gb3duZXI7CiAgICBzZWxmLm5vZGUgPSBub2RlOwoKICAgIHNlbGYudW5kbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdm0uYXJyUmVtb3ZlKHZtLm5vZGVzLCBzZWxmLm5vZGUpOwogICAgICB2bS5hcnJSZW1vdmUodm0uc2VsZWN0ZWROb2Rlcywgc2VsZi5ub2RlKTsKICAgICAgc2VsZi5ub2RlLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgZGVsZXRlIHZtLm5vZGVzTWFwW3NlbGYubm9kZS5pZF07CiAgICB9OwoKICAgIHNlbGYucmVkbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdm0ubm9kZXMucHVzaChzZWxmLm5vZGUpOwogICAgICB2bS5ub2Rlc01hcFtzZWxmLm5vZGUuaWRdID0gc2VsZi5ub2RlOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIEFkZEVkZ2VPcGVyYXRpb24oZWRnZSwgb3duZXIpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciB2bSA9IG93bmVyOwogICAgc2VsZi5lZGdlID0gZWRnZTsKCiAgICBzZWxmLnVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZtLmFyclJlbW92ZSh2bS5lZGdlcywgc2VsZi5lZGdlKTsKICAgICAgZGVsZXRlIHZtLmVkZ2VzTWFwW3NlbGYuZWRnZS5pZF07CiAgICB9OwoKICAgIHNlbGYucmVkbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdm0uZWRnZXMucHVzaChzZWxmLmVkZ2UpOwogICAgICB2bS5lZGdlc01hcFtzZWxmLmVkZ2UuaWRdID0gc2VsZi5lZGdlOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIFJldmVyc2VPcGVyYXRpb24ob3BlcmF0aW9uKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmV2ZXJzZU9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICAgIHNlbGYudW5kbyA9IHJldmVyc2VPcGVyYXRpb24ucmVkbzsKICAgIHNlbGYucmVkbyA9IHJldmVyc2VPcGVyYXRpb24udW5kbzsKICB9CgogIGZ1bmN0aW9uIEdyb3VwT3BlcmF0aW9uKHJlY2VpdmVyLCBvcnBoYW4sIHZtKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLnJlY2VpdmVyID0gcmVjZWl2ZXI7CiAgICBzZWxmLm9ycGhhbiA9IG9ycGhhbjsKCiAgICBzZWxmLnVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYub3JwaGFuLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIH07CgogICAgc2VsZi5yZWRvID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmLm9ycGhhbi5wYXJlbnQgPSBzZWxmLnJlY2VpdmVyOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIFVuR3JvdXBPcGVyYXRpb24ocGFyZW50LCBjaGlsZCwgdm0pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYucGFyZW50ID0gcGFyZW50OwogICAgc2VsZi5jaGlsZCA9IGNoaWxkOwoKICAgIHNlbGYudW5kbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5jaGlsZC5wYXJlbnQgPSBzZWxmLnBhcmVudDsKICAgIH07CgogICAgc2VsZi5yZWRvID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmNoaWxkLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVXb3Jrc3BhY2Uob3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBHcmFwaFdvcmtzcGFjZShvcHRpb25zKTsKICB9IC8vIFRoZSBtYWluIGNvbnN0cnVjdG9yIGZvciBvdXIgR3JhcGhXb3Jrc3BhY2UKCgogIGZ1bmN0aW9uIEdyYXBoV29ya3NwYWNlKG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuYmxhY2tsaXN0ZWROb2RlcyA9IFtdOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMudW5kb0xvZyA9IFtdOwogICAgdGhpcy5yZWRvTG9nID0gW107CiAgICB0aGlzLnNlbGVjdGVkTm9kZXMgPSBbXTsKCiAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgdGhpcy5vcHRpb25zID0ge307CiAgICB9CgogICAgdGhpcy5ub2Rlc01hcCA9IHt9OwogICAgdGhpcy5lZGdlc01hcCA9IHt9OwogICAgdGhpcy5zZWFyY2hUZXJtID0gJyc7IC8vQSBzZXF1ZW5jZSBudW1iZXIgdXNlZCB0byBrbm93IHdoZW4gYSBub2RlIHdhcyBhZGRlZAoKICAgIHRoaXMuc2VxTnVtYmVyID0gMDsKICAgIHRoaXMubm9kZXMgPSBbXTsKICAgIHRoaXMuZWRnZXMgPSBbXTsKICAgIHRoaXMubGFzdFJlcXVlc3QgPSBudWxsOwogICAgdGhpcy5sYXN0UmVzcG9uc2UgPSBudWxsOwogICAgdGhpcy5jaGFuZ2VIYW5kbGVyID0gb3B0aW9ucy5jaGFuZ2VIYW5kbGVyOwoKICAgIGlmIChvcHRpb25zLmdyYXBoRXhwbG9yZVByb3h5KSB7CiAgICAgIGdyYXBoRXhwbG9yZXIgPSBvcHRpb25zLmdyYXBoRXhwbG9yZVByb3h5OwogICAgfQoKICAgIGlmIChvcHRpb25zLnNlYXJjaFByb3h5KSB7CiAgICAgIHNlYXJjaGVyID0gb3B0aW9ucy5zZWFyY2hQcm94eTsKICAgIH0KCiAgICB0aGlzLmFkZFVuZG9Mb2dFbnRyeSA9IGZ1bmN0aW9uICh1bmRvT3BlcmF0aW9ucykgewogICAgICBzZWxmLnVuZG9Mb2cucHVzaCh1bmRvT3BlcmF0aW9ucyk7CgogICAgICBpZiAoc2VsZi51bmRvTG9nLmxlbmd0aCA+IDUwKSB7CiAgICAgICAgLy9SZW1vdmUgdGhlIG9sZGVzdAogICAgICAgIHNlbGYudW5kb0xvZy5zcGxpY2UoMCwgMSk7CiAgICAgIH0KCiAgICAgIHNlbGYucmVkb0xvZyA9IFtdOwogICAgfTsKCiAgICB0aGlzLnVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsYXN0T3BzID0gdGhpcy51bmRvTG9nLnBvcCgpOwoKICAgICAgaWYgKGxhc3RPcHMpIHsKICAgICAgICB0aGlzLnN0b3BMYXlvdXQoKTsKICAgICAgICB0aGlzLnJlZG9Mb2cucHVzaChsYXN0T3BzKTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBsYXN0T3BzKSB7CiAgICAgICAgICBsYXN0T3BzW2ldLnVuZG8oKTsKICAgICAgICB9CgogICAgICAgIHRoaXMucnVuTGF5b3V0KCk7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5yZWRvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgbGFzdE9wcyA9IHRoaXMucmVkb0xvZy5wb3AoKTsKCiAgICAgIGlmIChsYXN0T3BzKSB7CiAgICAgICAgdGhpcy5zdG9wTGF5b3V0KCk7CiAgICAgICAgdGhpcy51bmRvTG9nLnB1c2gobGFzdE9wcyk7CgogICAgICAgIGZvciAodmFyIGkgaW4gbGFzdE9wcykgewogICAgICAgICAgbGFzdE9wc1tpXS5yZWRvKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnJ1bkxheW91dCgpOwogICAgICB9CiAgICB9OyAvL0RldGVybWluZXMgaWYgMiBub2RlcyBhcmUgY29ubmVjdGVkIHZpYSBhbiBlZGdlCgoKICAgIHRoaXMuYXJlTGlua2VkID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgaWYgKGEgPT0gYikgcmV0dXJuIHRydWU7CiAgICAgIHZhciBhbGxFZGdlcyA9IHRoaXMuZWRnZXM7CgogICAgICBmb3IgKHZhciBlIGluIGFsbEVkZ2VzKSB7CiAgICAgICAgaWYgKGUuc291cmNlID09IGEpIHsKICAgICAgICAgIGlmIChlLnRhcmdldCA9PSBiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGUuc291cmNlID09IGIpIHsKICAgICAgICAgIGlmIChlLnRhcmdldCA9PSBhKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsgLy89PT09PT09PSBTZWxlY3Rpb24gZnVuY3Rpb25zID09PT09PT09CgoKICAgIHRoaXMuc2VsZWN0QWxsID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmLnNlbGVjdGVkTm9kZXMgPSBbXTsKCiAgICAgIGZvciAodmFyIG4gaW4gc2VsZi5ub2RlcykgewogICAgICAgIHZhciBub2RlID0gc2VsZi5ub2Rlc1tuXTsKCiAgICAgICAgaWYgKG5vZGUucGFyZW50ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuc2VsZWN0ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBub2RlLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5zZWxlY3ROb25lID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmLnNlbGVjdGVkTm9kZXMgPSBbXTsKCiAgICAgIGZvciAodmFyIG4gaW4gc2VsZi5ub2RlcykgewogICAgICAgIHZhciBub2RlID0gc2VsZi5ub2Rlc1tuXTsKICAgICAgICBub2RlLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnNlbGVjdEludmVydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzID0gW107CgogICAgICBmb3IgKHZhciBuIGluIHNlbGYubm9kZXMpIHsKICAgICAgICB2YXIgbm9kZSA9IHNlbGYubm9kZXNbbl07CgogICAgICAgIGlmIChub2RlLnBhcmVudCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gIW5vZGUuaXNTZWxlY3RlZDsKCiAgICAgICAgaWYgKG5vZGUuaXNTZWxlY3RlZCkgewogICAgICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc2VsZWN0Tm9kZXMgPSBmdW5jdGlvbiAobm9kZXMpIHsKICAgICAgZm9yICh2YXIgbiBpbiBub2RlcykgewogICAgICAgIHZhciBub2RlID0gbm9kZXNbbl07CiAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHNlbGYuc2VsZWN0ZWROb2Rlcy5pbmRleE9mKG5vZGUpIDwgMCkgewogICAgICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc2VsZWN0Tm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIG5vZGUuaXNTZWxlY3RlZCA9IHRydWU7CgogICAgICBpZiAoc2VsZi5zZWxlY3RlZE5vZGVzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5kZWxldGVTZWxlY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhbGxBbmRHcm91cGVkID0gc2VsZi5yZXR1cm5VbnBhY2tlZEdyb3VwZWRzKHNlbGYuc2VsZWN0ZWROb2Rlcyk7IC8vIE5vdGhpbmcgc2VsZWN0ZWQgc28gcHJvY2VzcyBhbGwgbm9kZXMKCiAgICAgIGlmIChhbGxBbmRHcm91cGVkLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgYWxsQW5kR3JvdXBlZCA9IHNlbGYubm9kZXMuc2xpY2UoMCk7CiAgICAgIH0KCiAgICAgIHZhciB1bmRvT3BlcmF0aW9ucyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSBpbiBhbGxBbmRHcm91cGVkKSB7CiAgICAgICAgdmFyIG5vZGUgPSBhbGxBbmRHcm91cGVkW2ldOyAvL1dlIHNldCBzZWxlY3RlZCB0byBmYWxzZSBiZWNhdXNlIGRlc3BpdGUgYmVpbmcgZGVsZXRlZCwgbm9kZSBvYmplY3RzIHNpdCBpbiBhbiB1bmRvIGxvZwoKICAgICAgICBub2RlLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICBkZWxldGUgc2VsZi5ub2Rlc01hcFtub2RlLmlkXTsKICAgICAgICB1bmRvT3BlcmF0aW9ucy5wdXNoKG5ldyBSZXZlcnNlT3BlcmF0aW9uKG5ldyBBZGROb2RlT3BlcmF0aW9uKG5vZGUsIHNlbGYpKSk7CiAgICAgIH0KCiAgICAgIHNlbGYuYXJyUmVtb3ZlQWxsKHNlbGYubm9kZXMsIGFsbEFuZEdyb3VwZWQpOwogICAgICBzZWxmLmFyclJlbW92ZUFsbChzZWxmLnNlbGVjdGVkTm9kZXMsIGFsbEFuZEdyb3VwZWQpOwogICAgICB2YXIgZGFuZ2xpbmdFZGdlcyA9IHNlbGYuZWRnZXMuZmlsdGVyKGZ1bmN0aW9uIChlZGdlKSB7CiAgICAgICAgcmV0dXJuIHNlbGYubm9kZXMuaW5kZXhPZihlZGdlLnNvdXJjZSkgPCAwIHx8IHNlbGYubm9kZXMuaW5kZXhPZihlZGdlLnRhcmdldCkgPCAwOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIF9pIGluIGRhbmdsaW5nRWRnZXMpIHsKICAgICAgICB2YXIgZWRnZSA9IGRhbmdsaW5nRWRnZXNbX2ldOwogICAgICAgIGRlbGV0ZSBzZWxmLmVkZ2VzTWFwW2VkZ2UuaWRdOwogICAgICAgIHVuZG9PcGVyYXRpb25zLnB1c2gobmV3IFJldmVyc2VPcGVyYXRpb24obmV3IEFkZEVkZ2VPcGVyYXRpb24oZWRnZSwgc2VsZikpKTsKICAgICAgfQoKICAgICAgc2VsZi5hZGRVbmRvTG9nRW50cnkodW5kb09wZXJhdGlvbnMpOwogICAgICBzZWxmLmFyclJlbW92ZUFsbChzZWxmLmVkZ2VzLCBkYW5nbGluZ0VkZ2VzKTsKICAgICAgc2VsZi5ydW5MYXlvdXQoKTsKICAgIH07CgogICAgdGhpcy5zZWxlY3ROZWlnaGJvdXJzID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgbmV3U2VsZWN0aW9ucyA9IFtdOwoKICAgICAgZm9yICh2YXIgbiBpbiBzZWxmLmVkZ2VzKSB7CiAgICAgICAgdmFyIGVkZ2UgPSBzZWxmLmVkZ2VzW25dOwoKICAgICAgICBpZiAoIWVkZ2UudG9wU3JjLmlzU2VsZWN0ZWQpIHsKICAgICAgICAgIGlmIChzZWxmLnNlbGVjdGVkTm9kZXMuaW5kZXhPZihlZGdlLnRvcFRhcmdldCkgPj0gMCkgewogICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9ucy5pbmRleE9mKGVkZ2UudG9wU3JjKSA8IDApIHsKICAgICAgICAgICAgICBuZXdTZWxlY3Rpb25zLnB1c2goZWRnZS50b3BTcmMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWVkZ2UudG9wVGFyZ2V0LmlzU2VsZWN0ZWQpIHsKICAgICAgICAgIGlmIChzZWxmLnNlbGVjdGVkTm9kZXMuaW5kZXhPZihlZGdlLnRvcFNyYykgPj0gMCkgewogICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9ucy5pbmRleE9mKGVkZ2UudG9wVGFyZ2V0KSA8IDApIHsKICAgICAgICAgICAgICBuZXdTZWxlY3Rpb25zLnB1c2goZWRnZS50b3BUYXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKHZhciBpIGluIG5ld1NlbGVjdGlvbnMpIHsKICAgICAgICB2YXIgbmV3bHlTZWxlY3RlZE5vZGUgPSBuZXdTZWxlY3Rpb25zW2ldOwogICAgICAgIHNlbGYuc2VsZWN0ZWROb2Rlcy5wdXNoKG5ld2x5U2VsZWN0ZWROb2RlKTsKICAgICAgICBuZXdseVNlbGVjdGVkTm9kZS5pc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnNlbGVjdE5vbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIG4gaW4gc2VsZi5zZWxlY3RlZE5vZGVzKSB7CiAgICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzW25dLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzID0gW107CiAgICB9OwoKICAgIHRoaXMuZGVzZWxlY3ROb2RlID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgbm9kZS5pc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgIHNlbGYuYXJyUmVtb3ZlKHNlbGYuc2VsZWN0ZWROb2Rlcywgbm9kZSk7CiAgICB9OwoKICAgIHRoaXMuZ2V0QWxsU2VsZWN0ZWROb2RlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucmV0dXJuVW5wYWNrZWRHcm91cGVkcyhzZWxmLnNlbGVjdGVkTm9kZXMpOwogICAgfTsKCiAgICB0aGlzLmNvbG9yU2VsZWN0ZWQgPSBmdW5jdGlvbiAoY29sb3JOdW0pIHsKICAgICAgdmFyIHNlbGVjdGlvbnMgPSBzZWxmLmdldEFsbFNlbGVjdGVkTm9kZXMoKTsKCiAgICAgIGZvciAodmFyIGkgaW4gc2VsZWN0aW9ucykgewogICAgICAgIHNlbGVjdGlvbnNbaV0uY29sb3IgPSBjb2xvck51bTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmdldFNlbGVjdGlvbnNUaGF0QXJlR3JvdXBlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgc2VsZWN0aW9ucyA9IHNlbGYuc2VsZWN0ZWROb2RlczsKCiAgICAgIGZvciAodmFyIGkgaW4gc2VsZWN0aW9ucykgewogICAgICAgIHZhciBub2RlID0gc2VsZWN0aW9uc1tpXTsKCiAgICAgICAgaWYgKG5vZGUubnVtQ2hpbGRyZW4gPiAwKSB7CiAgICAgICAgICByZXN1bHQucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIHRoaXMudW5ncm91cFNlbGVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNlbGVjdGlvbnMgPSBzZWxmLmdldFNlbGVjdGlvbnNUaGF0QXJlR3JvdXBlZCgpOwoKICAgICAgZm9yICh2YXIgaSBpbiBzZWxlY3Rpb25zKSB7CiAgICAgICAgdmFyIG5vZGUgPSBzZWxlY3Rpb25zW2ldOwogICAgICAgIHNlbGYudW5ncm91cChub2RlKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnRvZ2dsZU5vZGVTZWxlY3Rpb24gPSBmdW5jdGlvbiAobm9kZSkgewogICAgICBpZiAobm9kZS5pc1NlbGVjdGVkKSB7CiAgICAgICAgc2VsZi5kZXNlbGVjdE5vZGUobm9kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICBzZWxmLnNlbGVjdGVkTm9kZXMucHVzaChub2RlKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5vZGUuaXNTZWxlY3RlZDsKICAgIH07CgogICAgdGhpcy5yZXR1cm5VbnBhY2tlZEdyb3VwZWRzID0gZnVuY3Rpb24gKHRvcExldmVsTm9kZUFycmF5KSB7CiAgICAgIC8vR2F0aGVyIGFueSBncm91cGVkIG5vZGVzIHRoYXQgYXJlIHBhcnQgb2YgdGhpcyB0b3AtbGV2ZWwgc2VsZWN0aW9uCiAgICAgIHZhciByZXN1bHQgPSB0b3BMZXZlbE5vZGVBcnJheS5zbGljZSgpOyAvLyBXZSBpdGVyYXRlIG92ZXIgZWRnZXMgbm90IG5vZGVzIGJlY2F1c2UgZWRnZXMgY29udmVuaWVudGx5IGhvbGQgdGhlIHRvcC1tb3N0CiAgICAgIC8vIG5vZGUgaW5mb3JtYXRpb24uCgogICAgICB2YXIgZWRnZXMgPSB0aGlzLmVkZ2VzOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZGdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBlZGdlID0gZWRnZXNbaV07CiAgICAgICAgdmFyIHRvcExldmVsU291cmNlID0gZWRnZS50b3BTcmM7CiAgICAgICAgdmFyIHRvcExldmVsVGFyZ2V0ID0gZWRnZS50b3BUYXJnZXQ7CgogICAgICAgIGlmIChyZXN1bHQuaW5kZXhPZih0b3BMZXZlbFRhcmdldCkgPj0gMCkgewogICAgICAgICAgLy92aXNpYmxlIHRvcC1sZXZlbCBub2RlIGlzIHNlbGVjdGVkIC0gYWRkIGFsbCBuZXN0ZWRzIHN0YXJ0aW5nIGZyb20gYm90dG9tIHVwCiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZWRnZS50YXJnZXQ7CgogICAgICAgICAgd2hpbGUgKHRhcmdldC5wYXJlbnQgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmIChyZXN1bHQuaW5kZXhPZih0YXJnZXQpIDwgMCkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocmVzdWx0LmluZGV4T2YodG9wTGV2ZWxTb3VyY2UpID49IDApIHsKICAgICAgICAgIC8vdmlzaWJsZSB0b3AtbGV2ZWwgbm9kZSBpcyBzZWxlY3RlZCAtIGFkZCBhbGwgbmVzdGVkcyBzdGFydGluZyBmcm9tIGJvdHRvbSB1cAogICAgICAgICAgdmFyIHNvdXJjZSA9IGVkZ2Uuc291cmNlOwoKICAgICAgICAgIHdoaWxlIChzb3VyY2UucGFyZW50ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAocmVzdWx0LmluZGV4T2Yoc291cmNlKSA8IDApIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChzb3VyY2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2UucGFyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvL2VuZCBvZiBlZGdlcyBsb29wCgoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07IC8vID09PT09PT0gTWlzY2VsbGFuZW91cyBmdW5jdGlvbnMKCgogICAgdGhpcy5jbGVhckdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnN0b3BMYXlvdXQoKTsKICAgICAgdGhpcy5ub2RlcyA9IFtdOwogICAgICB0aGlzLmVkZ2VzID0gW107CiAgICAgIHRoaXMudW5kb0xvZyA9IFtdOwogICAgICB0aGlzLnJlZG9Mb2cgPSBbXTsKICAgICAgdGhpcy5ub2Rlc01hcCA9IHt9OwogICAgICB0aGlzLmVkZ2VzTWFwID0ge307CiAgICAgIHRoaXMuYmxhY2tsaXN0ZWROb2RlcyA9IFtdOwogICAgICB0aGlzLnNlbGVjdGVkTm9kZXMgPSBbXTsKICAgICAgdGhpcy5sYXN0UmVzcG9uc2UgPSBudWxsOwogICAgfTsKCiAgICB0aGlzLmFyclJlbW92ZUFsbCA9IGZ1bmN0aW9uIHJlbW92ZShhcnIsIGl0ZW1zKSB7CiAgICAgIGZvciAodmFyIGkgPSBpdGVtcy5sZW5ndGg7IGktLTspIHsKICAgICAgICBzZWxmLmFyclJlbW92ZShhcnIsIGl0ZW1zW2ldKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmFyclJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZShhcnIsIGl0ZW0pIHsKICAgICAgZm9yICh2YXIgaSA9IGFyci5sZW5ndGg7IGktLTspIHsKICAgICAgICBpZiAoYXJyW2ldID09PSBpdGVtKSB7CiAgICAgICAgICBhcnIuc3BsaWNlKGksIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB0aGlzLmdldE5laWdoYm91cnMgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICB2YXIgbmVpZ2hib3VyTm9kZXMgPSBbXTsKCiAgICAgIGZvciAodmFyIGUgaW4gc2VsZi5lZGdlcykgewogICAgICAgIHZhciBlZGdlID0gc2VsZi5lZGdlc1tlXTsKCiAgICAgICAgaWYgKGVkZ2UudG9wU3JjID09IGVkZ2UudG9wVGFyZ2V0KSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmIChlZGdlLnRvcFNyYyA9PSBub2RlKSB7CiAgICAgICAgICBpZiAobmVpZ2hib3VyTm9kZXMuaW5kZXhPZihlZGdlLnRvcFRhcmdldCkgPCAwKSB7CiAgICAgICAgICAgIG5laWdoYm91ck5vZGVzLnB1c2goZWRnZS50b3BUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVkZ2UudG9wVGFyZ2V0ID09IG5vZGUpIHsKICAgICAgICAgIGlmIChuZWlnaGJvdXJOb2Rlcy5pbmRleE9mKGVkZ2UudG9wU3JjKSA8IDApIHsKICAgICAgICAgICAgbmVpZ2hib3VyTm9kZXMucHVzaChlZGdlLnRvcFNyYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbmVpZ2hib3VyTm9kZXM7CiAgICB9OyAvL0NyZWF0ZXMgYSBxdWVyeSB0aGF0IHJlcHJlc2VudHMgYSBub2RlIC0gZWl0aGVyIHNpbXBsZSB0ZXJtIHF1ZXJ5IG9yIGJvb2xlYW4gaWYgZ3JvdXBlZAoKCiAgICB0aGlzLmJ1aWxkTm9kZVF1ZXJ5ID0gZnVuY3Rpb24gKHRvcExldmVsTm9kZSkgewogICAgICB2YXIgY29udGFpbmVkTm9kZXMgPSBbdG9wTGV2ZWxOb2RlXTsKICAgICAgY29udGFpbmVkTm9kZXMgPSBzZWxmLnJldHVyblVucGFja2VkR3JvdXBlZHMoY29udGFpbmVkTm9kZXMpOwoKICAgICAgaWYgKGNvbnRhaW5lZE5vZGVzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgLy9TaW1wbGUgY2FzZSAtIHJldHVybiBhIHNpbmdsZS10ZXJtIHF1ZXJ5CiAgICAgICAgdmFyIHRxID0ge307CiAgICAgICAgdHFbdG9wTGV2ZWxOb2RlLmRhdGEuZmllbGRdID0gdG9wTGV2ZWxOb2RlLmRhdGEudGVybTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdGVybTogdHEKICAgICAgICB9OwogICAgICB9CgogICAgICB2YXIgdGVybXNCeUZpZWxkID0ge307CgogICAgICBmb3IgKHZhciBpIGluIGNvbnRhaW5lZE5vZGVzKSB7CiAgICAgICAgdmFyIG5vZGUgPSBjb250YWluZWROb2Rlc1tpXTsKICAgICAgICB2YXIgdGVybXNMaXN0ID0gdGVybXNCeUZpZWxkW25vZGUuZGF0YS5maWVsZF07CgogICAgICAgIGlmICghdGVybXNMaXN0KSB7CiAgICAgICAgICB0ZXJtc0xpc3QgPSBbXTsKICAgICAgICAgIHRlcm1zQnlGaWVsZFtub2RlLmRhdGEuZmllbGRdID0gdGVybXNMaXN0OwogICAgICAgIH0KCiAgICAgICAgdGVybXNMaXN0LnB1c2gobm9kZS5kYXRhLnRlcm0pOwogICAgICB9IC8vU2luZ2xlIGZpZWxkIGNhc2UKCgogICAgICBpZiAoT2JqZWN0LmtleXModGVybXNCeUZpZWxkKS5sZW5ndGggPT0gMSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0ZXJtczogdGVybXNCeUZpZWxkCiAgICAgICAgfTsKICAgICAgfSAvL011bHRpLWZpZWxkIGNhc2UgLSBidWlsZCBhIGJvb2wgcXVlcnkgd2l0aCBwZXItZmllbGQgdGVybXMgY2xhdXNlcy4KCgogICAgICB2YXIgcSA9IHsKICAgICAgICBib29sOiB7CiAgICAgICAgICBzaG91bGQ6IFtdCiAgICAgICAgfQogICAgICB9OwoKICAgICAgZm9yICh2YXIgZmllbGQgaW4gdGVybXNCeUZpZWxkKSB7CiAgICAgICAgdmFyIF90cSA9IHt9OwogICAgICAgIF90cVtmaWVsZF0gPSB0ZXJtc0J5RmllbGRbZmllbGRdOwogICAgICAgIHEuYm9vbC5zaG91bGQucHVzaCh7CiAgICAgICAgICB0ZXJtczogX3RxCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBxOwogICAgfTsgLy89PT09PT0gTGF5b3V0IGZ1bmN0aW9ucyA9PT09PT09PQoKCiAgICB0aGlzLnN0b3BMYXlvdXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmZvcmNlKSB7CiAgICAgICAgdGhpcy5mb3JjZS5zdG9wKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZm9yY2UgPSBudWxsOwogICAgfTsKCiAgICB0aGlzLnJ1bkxheW91dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5zdG9wTGF5b3V0KCk7IC8vIFRoZSBzZXQgb2Ygbm9kZXMgYW5kIGVkZ2VzIHdlIHByZXNlbnQgdG8gdGhlIGQzIGxheW91dCBhbGdvcml0aG1zCiAgICAgIC8vIGlzIHBvdGVudGlhbGx5IGEgcmVkdWNlZCBzZXQgb2Ygbm9kZXMgaWYgdGhlIGNsaWVudCBoYXMgdXNlZCBhbnkKICAgICAgLy8gZ3JvdXBpbmcgb2Ygbm9kZXMgaW50byBwYXJlbnQgbm9kZXMuCgogICAgICB2YXIgZWZmZWN0aXZlRWRnZXMgPSBbXTsKICAgICAgdmFyIGVkZ2VzID0gc2VsZi5lZGdlczsKCiAgICAgIGZvciAodmFyIGUgaW4gZWRnZXMpIHsKICAgICAgICB2YXIgZWRnZSA9IGVkZ2VzW2VdOwogICAgICAgIHZhciB0b3BTcmMgPSBlZGdlLnNvdXJjZTsKICAgICAgICB2YXIgdG9wVGFyZ2V0ID0gZWRnZS50YXJnZXQ7CgogICAgICAgIHdoaWxlICh0b3BTcmMucGFyZW50ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgdG9wU3JjID0gdG9wU3JjLnBhcmVudDsKICAgICAgICB9CgogICAgICAgIHdoaWxlICh0b3BUYXJnZXQucGFyZW50ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgdG9wVGFyZ2V0ID0gdG9wVGFyZ2V0LnBhcmVudDsKICAgICAgICB9CgogICAgICAgIGVkZ2UudG9wU3JjID0gdG9wU3JjOwogICAgICAgIGVkZ2UudG9wVGFyZ2V0ID0gdG9wVGFyZ2V0OwoKICAgICAgICBpZiAodG9wU3JjICE9IHRvcFRhcmdldCkgewogICAgICAgICAgZWZmZWN0aXZlRWRnZXMucHVzaCh7CiAgICAgICAgICAgIHNvdXJjZTogdG9wU3JjLAogICAgICAgICAgICB0YXJnZXQ6IHRvcFRhcmdldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgdmlzaWJsZU5vZGVzID0gc2VsZi5ub2Rlcy5maWx0ZXIoZnVuY3Rpb24gKG4pIHsKICAgICAgICByZXR1cm4gbi5wYXJlbnQgPT0gdW5kZWZpbmVkOwogICAgICB9KTsgLy9yZXNldCB0aGVuIHJvbGwtdXAgYWxsIHRoZSBjb3VudHMKCiAgICAgIHZhciBhbGxOb2RlcyA9IHNlbGYubm9kZXM7CgogICAgICBmb3IgKHZhciBuIGluIGFsbE5vZGVzKSB7CiAgICAgICAgdmFyIG5vZGUgPSBhbGxOb2Rlc1tuXTsKICAgICAgICBub2RlLm51bUNoaWxkcmVuID0gMDsKICAgICAgfQoKICAgICAgZm9yICh2YXIgX24gaW4gYWxsTm9kZXMpIHsKICAgICAgICB2YXIgX25vZGUgPSBhbGxOb2Rlc1tfbl07CgogICAgICAgIHdoaWxlIChfbm9kZS5wYXJlbnQgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBfbm9kZSA9IF9ub2RlLnBhcmVudDsKICAgICAgICAgIF9ub2RlLm51bUNoaWxkcmVuID0gX25vZGUubnVtQ2hpbGRyZW4gKyAxOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5mb3JjZSA9IGQzLmxheW91dC5mb3JjZSgpLm5vZGVzKHZpc2libGVOb2RlcykubGlua3MoZWZmZWN0aXZlRWRnZXMpLmZyaWN0aW9uKDAuOCkubGlua0Rpc3RhbmNlKDEwMCkuY2hhcmdlKC0xNTAwKS5ncmF2aXR5KDAuMTUpLnRoZXRhKDAuOTkpLmFscGhhKDAuNSkuc2l6ZShbODAwLCA2MDBdKS5vbigndGljaycsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIG5vZGVBcnJheSA9IHNlbGYubm9kZXM7CiAgICAgICAgdmFyIGhhc1JvbGx1cHMgPSBmYWxzZTsgLy9VcGRhdGUgdGhlIHBvc2l0aW9uIG9mIGFsbCAidG9wIGxldmVsIG5vZGVzIgoKICAgICAgICBmb3IgKHZhciBpIGluIG5vZGVBcnJheSkgewogICAgICAgICAgdmFyIF9uMiA9IG5vZGVBcnJheVtpXTsgLy9Db2RlIHRvIHN1cHBvcnQgcm9sbC11cHMKCiAgICAgICAgICBpZiAoX24yLnBhcmVudCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgX24yLmt4ID0gX24yLng7CiAgICAgICAgICAgIF9uMi5reSA9IF9uMi55OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzUm9sbHVwcyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzUm9sbHVwcykgewogICAgICAgICAgZm9yICh2YXIgX2kyIGluIG5vZGVBcnJheSkgewogICAgICAgICAgICB2YXIgX24zID0gbm9kZUFycmF5W19pMl07IC8vQ29kZSB0byBzdXBwb3J0IHJvbGwtdXBzCgogICAgICAgICAgICBpZiAoX24zLnBhcmVudCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLyBJcyBhIGdyb3VwZWQgbm9kZSAtIGluaGVyaXQgcGFyZW50J3MgcG9zaXRpb24gc28gZWRnZXMgcG9pbnQgaW50byBwYXJlbnQKICAgICAgICAgICAgICAvLyBkMyB0aGlua3MgaXQgaGFzIG1vdmVkIGl0IHRvIHggYW5kIHkgYnV0IHdlIGhhdmUgZmluYWwgc2F5IHVzaW5nIGt4IGFuZCBreS4KICAgICAgICAgICAgICB2YXIgdG9wTGV2ZWxOb2RlID0gX24zLnBhcmVudDsKCiAgICAgICAgICAgICAgd2hpbGUgKHRvcExldmVsTm9kZS5wYXJlbnQgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0b3BMZXZlbE5vZGUgPSB0b3BMZXZlbE5vZGUucGFyZW50OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX24zLmt4ID0gdG9wTGV2ZWxOb2RlLng7CiAgICAgICAgICAgICAgX24zLmt5ID0gdG9wTGV2ZWxOb2RlLnk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChzZWxmLmNoYW5nZUhhbmRsZXIpIHsKICAgICAgICAgIC8vIEhvb2sgdG8gYWxsb3cgYW55IGNsaWVudCB0byByZXNwb25kIHRvIHBvc2l0aW9uIGNoYW5nZXMKICAgICAgICAgIC8vIGUuZy4gYW5ndWxhciBhZGp1c3RzIGFuZCByZXBhaW50cyBub2RlIHBvc2l0aW9ucyBvbiBzY3JlZW4uCiAgICAgICAgICBzZWxmLmNoYW5nZUhhbmRsZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLmZvcmNlLnN0YXJ0KCk7CiAgICB9OyAvLz09PT09PT09R3JvdXBpbmcgZnVuY3Rpb25zPT09PT09PT09PQogICAgLy9NZXJnZXMgYWxsIHNlbGVjdGVkIG5vZGVzIGludG8gbm9kZQoKCiAgICB0aGlzLmdyb3VwU2VsZWN0aW9ucyA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHZhciBvcHMgPSBbXTsKICAgICAgc2VsZi5ub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uIChvdGhlck5vZGUpIHsKICAgICAgICBpZiAob3RoZXJOb2RlICE9IG5vZGUgJiYgb3RoZXJOb2RlLmlzU2VsZWN0ZWQgJiYgb3RoZXJOb2RlLnBhcmVudCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG90aGVyTm9kZS5wYXJlbnQgPSBub2RlOwogICAgICAgICAgb3RoZXJOb2RlLmlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgIHNlbGYuYXJyUmVtb3ZlKHNlbGYuc2VsZWN0ZWROb2Rlcywgb3RoZXJOb2RlKTsKICAgICAgICAgIG9wcy5wdXNoKG5ldyBHcm91cE9wZXJhdGlvbihub2RlLCBvdGhlck5vZGUsIHNlbGYpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBzZWxmLnNlbGVjdE5vbmUoKTsKICAgICAgc2VsZi5zZWxlY3ROb2RlKG5vZGUpOwogICAgICBzZWxmLmFkZFVuZG9Mb2dFbnRyeShvcHMpOwogICAgICBzZWxmLnJ1bkxheW91dCgpOwogICAgfTsKCiAgICB0aGlzLm1lcmdlTmVpZ2hib3VycyA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHZhciBuZWlnaGJvdXJzID0gc2VsZi5nZXROZWlnaGJvdXJzKG5vZGUpOwogICAgICB2YXIgb3BzID0gW107CiAgICAgIG5laWdoYm91cnMuZm9yRWFjaChmdW5jdGlvbiAob3RoZXJOb2RlKSB7CiAgICAgICAgaWYgKG90aGVyTm9kZSAhPSBub2RlICYmIG90aGVyTm9kZS5wYXJlbnQgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBvdGhlck5vZGUucGFyZW50ID0gbm9kZTsKICAgICAgICAgIG90aGVyTm9kZS5pc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICBzZWxmLmFyclJlbW92ZShzZWxmLnNlbGVjdGVkTm9kZXMsIG90aGVyTm9kZSk7CiAgICAgICAgICBvcHMucHVzaChuZXcgR3JvdXBPcGVyYXRpb24obm9kZSwgb3RoZXJOb2RlLCBzZWxmKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2VsZi5hZGRVbmRvTG9nRW50cnkob3BzKTsKICAgICAgc2VsZi5ydW5MYXlvdXQoKTsKICAgIH07CgogICAgdGhpcy5tZXJnZVNlbGVjdGlvbnMgPSBmdW5jdGlvbiAodGFyZ2V0Tm9kZSkgewogICAgICBpZiAoIXRhcmdldE5vZGUpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgLSBtZXJnZSBjYWxsZWQgb24gdW5kZWZpbmVkIHRhcmdldCcpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHNlbENsb25lID0gc2VsZi5zZWxlY3RlZE5vZGVzLnNsaWNlKCk7CiAgICAgIHZhciBvcHMgPSBbXTsKICAgICAgc2VsQ2xvbmUuZm9yRWFjaChmdW5jdGlvbiAob3RoZXJOb2RlKSB7CiAgICAgICAgaWYgKG90aGVyTm9kZSAhPSB0YXJnZXROb2RlICYmIG90aGVyTm9kZS5wYXJlbnQgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBvdGhlck5vZGUucGFyZW50ID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgIG90aGVyTm9kZS5pc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICBzZWxmLmFyclJlbW92ZShzZWxmLnNlbGVjdGVkTm9kZXMsIG90aGVyTm9kZSk7CiAgICAgICAgICBvcHMucHVzaChuZXcgR3JvdXBPcGVyYXRpb24odGFyZ2V0Tm9kZSwgb3RoZXJOb2RlLCBzZWxmKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2VsZi5hZGRVbmRvTG9nRW50cnkob3BzKTsKICAgICAgc2VsZi5ydW5MYXlvdXQoKTsKICAgIH07CgogICAgdGhpcy51bmdyb3VwID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgdmFyIG9wcyA9IFtdOwogICAgICBzZWxmLm5vZGVzLmZvckVhY2goZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgaWYgKG90aGVyLnBhcmVudCA9PSBub2RlKSB7CiAgICAgICAgICBvdGhlci5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICBvcHMucHVzaChuZXcgVW5Hcm91cE9wZXJhdGlvbihub2RlLCBvdGhlciwgc2VsZikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHNlbGYuYWRkVW5kb0xvZ0VudHJ5KG9wcyk7CiAgICAgIHNlbGYucnVuTGF5b3V0KCk7CiAgICB9OwoKICAgIHRoaXMudW5ibGFja2xpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICBzZWxmLmFyclJlbW92ZShzZWxmLmJsYWNrbGlzdGVkTm9kZXMsIG5vZGUpOwogICAgfTsKCiAgICB0aGlzLmJsYWNrbGlzdFNlbGVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNlbGVjdGlvbiA9IHNlbGYuZ2V0QWxsU2VsZWN0ZWROb2RlcygpOwogICAgICB2YXIgZGFuZ2xpbmdFZGdlcyA9IFtdOwogICAgICBzZWxmLmVkZ2VzLmZvckVhY2goZnVuY3Rpb24gKGVkZ2UpIHsKICAgICAgICBpZiAoc2VsZWN0aW9uLmluZGV4T2YoZWRnZS5zb3VyY2UpID49IDAgfHwgc2VsZWN0aW9uLmluZGV4T2YoZWRnZS50YXJnZXQpID49IDApIHsKICAgICAgICAgIGRlbGV0ZSBzZWxmLmVkZ2VzTWFwW2VkZ2UuaWRdOwogICAgICAgICAgZGFuZ2xpbmdFZGdlcy5wdXNoKGVkZ2UpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBmb3IgKHZhciBuIGluIHNlbGVjdGlvbikgewogICAgICAgIHZhciBub2RlID0gc2VsZWN0aW9uW25dOwogICAgICAgIGRlbGV0ZSBzZWxmLm5vZGVzTWFwW25vZGUuaWRdOwogICAgICAgIHNlbGYuYmxhY2tsaXN0ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgIG5vZGUuaXNTZWxlY3RlZCA9IGZhbHNlOwogICAgICB9CgogICAgICBzZWxmLmFyclJlbW92ZUFsbChzZWxmLm5vZGVzLCBzZWxlY3Rpb24pOwogICAgICBzZWxmLmFyclJlbW92ZUFsbChzZWxmLmVkZ2VzLCBkYW5nbGluZ0VkZ2VzKTsKICAgICAgc2VsZi5zZWxlY3RlZE5vZGVzID0gW107CiAgICAgIHNlbGYucnVuTGF5b3V0KCk7CiAgICB9OyAvLyBBICJzaW1wbGUgc2VhcmNoIiBvcGVyYXRpb24gdGhhdCByZXF1aXJlcyBubyBwYXJhbWV0ZXJzIGZyb20gdGhlIGNsaWVudC4KICAgIC8vIFBlcmZvcm1zIG51bUhvcHMgaG9wcyBwdWxsaW5nIGluIGZpZWxkLXNwZWNpZmljIG51bWJlciBvZiB0ZXJtcyBlYWNoIHRpbWUKCgogICAgdGhpcy5zaW1wbGVTZWFyY2ggPSBmdW5jdGlvbiAoc2VhcmNoVGVybSwgZmllbGRzQ2hvaWNlLCBudW1Ib3BzKSB7CiAgICAgIHZhciBxcyA9IHsKICAgICAgICBxdWVyeV9zdHJpbmc6IHsKICAgICAgICAgIHF1ZXJ5OiBzZWFyY2hUZXJtCiAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gdGhpcy5zZWFyY2gocXMsIGZpZWxkc0Nob2ljZSwgbnVtSG9wcyk7CiAgICB9OwoKICAgIHRoaXMuc2VhcmNoID0gZnVuY3Rpb24gKHF1ZXJ5LCBmaWVsZHNDaG9pY2UsIG51bUhvcHMpIHsKICAgICAgaWYgKCFmaWVsZHNDaG9pY2UpIHsKICAgICAgICBmaWVsZHNDaG9pY2UgPSBzZWxmLm9wdGlvbnMudmVydGV4X2ZpZWxkczsKICAgICAgfQoKICAgICAgdmFyIHN0ZXAgPSB7fTsgLy9BZGQgYW55IGJsYWNrbGlzdGVkIG5vZGVzIHRvIGV4Y2x1c2lvbiBsaXN0CgogICAgICB2YXIgZXhjbHVkZU5vZGVzQnlGaWVsZCA9IHt9OwogICAgICB2YXIgbm90cyA9IFtdOwogICAgICB2YXIgYXZvaWROb2RlcyA9IHRoaXMuYmxhY2tsaXN0ZWROb2RlczsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXZvaWROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuID0gYXZvaWROb2Rlc1tpXTsKICAgICAgICB2YXIgYXJyID0gZXhjbHVkZU5vZGVzQnlGaWVsZFtuLmRhdGEuZmllbGRdOwoKICAgICAgICBpZiAoIWFycikgewogICAgICAgICAgYXJyID0gW107CiAgICAgICAgICBleGNsdWRlTm9kZXNCeUZpZWxkW24uZGF0YS5maWVsZF0gPSBhcnI7CiAgICAgICAgfQoKICAgICAgICBhcnIucHVzaChuLmRhdGEudGVybSk7IC8vQWRkIHRvIGxpc3Qgb2YgbXVzdF9ub3RzIGluIGd1aWRpbmcgcXVlcnkKCiAgICAgICAgdmFyIHRxID0ge307CiAgICAgICAgdHFbbi5kYXRhLmZpZWxkXSA9IG4uZGF0YS50ZXJtOwogICAgICAgIG5vdHMucHVzaCh7CiAgICAgICAgICB0ZXJtOiB0cQogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgcm9vdFN0ZXAgPSBzdGVwOwoKICAgICAgZm9yICh2YXIgaG9wTnVtID0gMDsgaG9wTnVtIDwgbnVtSG9wczsgaG9wTnVtKyspIHsKICAgICAgICB2YXIgX2FyciA9IFtdOwoKICAgICAgICBmb3IgKHZhciBmIGluIGZpZWxkc0Nob2ljZSkgewogICAgICAgICAgdmFyIGZpZWxkID0gZmllbGRzQ2hvaWNlW2ZdLm5hbWU7CiAgICAgICAgICB2YXIgaG9wU2l6ZSA9IGZpZWxkc0Nob2ljZVtmXS5ob3BTaXplOwogICAgICAgICAgdmFyIGV4Y2x1ZGVzID0gZXhjbHVkZU5vZGVzQnlGaWVsZFtmaWVsZF07CiAgICAgICAgICB2YXIgc3RlcEZpZWxkID0gewogICAgICAgICAgICBmaWVsZDogZmllbGQsCiAgICAgICAgICAgIHNpemU6IGhvcFNpemUsCiAgICAgICAgICAgIG1pbl9kb2NfY291bnQ6IHBhcnNlSW50KHNlbGYub3B0aW9ucy5leHBsb3JlQ29udHJvbHMubWluRG9jQ291bnQpCiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChleGNsdWRlcykgewogICAgICAgICAgICBzdGVwRmllbGQuZXhjbHVkZSA9IGV4Y2x1ZGVzOwogICAgICAgICAgfQoKICAgICAgICAgIF9hcnIucHVzaChzdGVwRmllbGQpOwogICAgICAgIH0KCiAgICAgICAgc3RlcC52ZXJ0aWNlcyA9IF9hcnI7CgogICAgICAgIGlmIChob3BOdW0gPCBudW1Ib3BzIC0gMSkgewogICAgICAgICAgLy8gaWYgKHMgPCAoc3RlcFNpemVzLmxlbmd0aCAtIDEpKSB7CiAgICAgICAgICB2YXIgbmV4dFN0ZXAgPSB7fTsKICAgICAgICAgIHN0ZXAuY29ubmVjdGlvbnMgPSBuZXh0U3RlcDsKICAgICAgICAgIHN0ZXAgPSBuZXh0U3RlcDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChub3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBxdWVyeSA9IHsKICAgICAgICAgIGJvb2w6IHsKICAgICAgICAgICAgbXVzdDogW3F1ZXJ5XSwKICAgICAgICAgICAgbXVzdF9ub3Q6IG5vdHMKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgY29udHJvbHM6IHNlbGYuYnVpbGRDb250cm9scygpLAogICAgICAgIGNvbm5lY3Rpb25zOiByb290U3RlcC5jb25uZWN0aW9ucywKICAgICAgICB2ZXJ0aWNlczogcm9vdFN0ZXAudmVydGljZXMKICAgICAgfTsKICAgICAgc2VsZi5jYWxsRWxhc3RpY3NlYXJjaChyZXF1ZXN0KTsKICAgIH07CgogICAgdGhpcy5idWlsZENvbnRyb2xzID0gZnVuY3Rpb24gKCkgewogICAgICAvL1RoaXMgaXMgYW4gb2JqZWN0IG1hbmFnZWQgYnkgdGhlIGNsaWVudCB0aGF0IG1heSBiZSBzdWJqZWN0IHRvIGNoYW5nZQogICAgICB2YXIgZ3VpU2V0dGluZ3NPYmogPSBzZWxmLm9wdGlvbnMuZXhwbG9yZUNvbnRyb2xzOwogICAgICB2YXIgY29udHJvbHMgPSB7CiAgICAgICAgdXNlX3NpZ25pZmljYW5jZTogZ3VpU2V0dGluZ3NPYmoudXNlU2lnbmlmaWNhbmNlLAogICAgICAgIHNhbXBsZV9zaXplOiBndWlTZXR0aW5nc09iai5zYW1wbGVTaXplLAogICAgICAgIHRpbWVvdXQ6IHBhcnNlSW50KGd1aVNldHRpbmdzT2JqLnRpbWVvdXRNaWxsaXMpCiAgICAgIH07IC8vIGNvbnNvbGUubG9nKCJndWlTZXR0aW5nc09iaiIsZ3VpU2V0dGluZ3NPYmopOwoKICAgICAgaWYgKGd1aVNldHRpbmdzT2JqLnNhbXBsZURpdmVyc2l0eUZpZWxkICE9IG51bGwpIHsKICAgICAgICBjb250cm9scy5zYW1wbGVfZGl2ZXJzaXR5ID0gewogICAgICAgICAgZmllbGQ6IGd1aVNldHRpbmdzT2JqLnNhbXBsZURpdmVyc2l0eUZpZWxkLm5hbWUsCiAgICAgICAgICBtYXhfZG9jc19wZXJfdmFsdWU6IGd1aVNldHRpbmdzT2JqLm1heFZhbHVlc1BlckRvYwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBjb250cm9sczsKICAgIH07CgogICAgdGhpcy5tYWtlTm9kZUlkID0gZnVuY3Rpb24gKGZpZWxkLCB0ZXJtKSB7CiAgICAgIHJldHVybiBmaWVsZCArICcuLicgKyB0ZXJtOwogICAgfTsKCiAgICB0aGlzLm1ha2VFZGdlSWQgPSBmdW5jdGlvbiAoc3JjSWQsIHRhcmdldElkKSB7CiAgICAgIHZhciBpZCA9IHNyY0lkICsgJy0+JyArIHRhcmdldElkOwoKICAgICAgaWYgKHNyY0lkID4gdGFyZ2V0SWQpIHsKICAgICAgICBpZCA9IHRhcmdldElkICsgJy0+JyArIHNyY0lkOwogICAgICB9CgogICAgICByZXR1cm4gaWQ7CiAgICB9OyAvLz09PT09PT0gIEFkZHMgbmV3IG5vZGVzIHJldHJpZXZlZCBmcm9tIGFuIGVsYXN0aWNzZWFyY2ggc2VhcmNoID09PT09PT09CgoKICAgIHRoaXMubWVyZ2VHcmFwaCA9IGZ1bmN0aW9uIChuZXdEYXRhKSB7CiAgICAgIHRoaXMuc3RvcExheW91dCgpOwoKICAgICAgaWYgKCFuZXdEYXRhLm5vZGVzKSB7CiAgICAgICAgbmV3RGF0YS5ub2RlcyA9IFtdOwogICAgICB9CgogICAgICB2YXIgbGFzdE9wcyA9IFtdOyAvLyA9PT0gQ29tbWVudGVkIG91dCAtIG5vdCBzdXJlIGl0IHdhcyBvYnZpb3VzIHRvIHVzZXJzIHdoYXQgdmFyaW91cyBjaXJjbGUgc2l6ZXMgbWVhbnQKICAgICAgLy8gdmFyIG1pbkNpcmNsZVNpemUgPSA1OwogICAgICAvLyB2YXIgbWF4Q2lyY2xlU2l6ZSA9IDI1OwogICAgICAvLyB2YXIgc2l6ZVNjYWxlID0gZDMuc2NhbGUucG93KCkuZXhwb25lbnQoMC4xNSkKICAgICAgLy8gICAuZG9tYWluKFswLCBkMy5tYXgobmV3RGF0YS5ub2RlcywgZnVuY3Rpb24oZCkgewogICAgICAvLyAgICAgcmV0dXJuIGQud2VpZ2h0OwogICAgICAvLyAgIH0pXSkKICAgICAgLy8gICAucmFuZ2UoW21pbkNpcmNsZVNpemUsIG1heENpcmNsZVNpemVdKTsKICAgICAgLy9SZW1vdmUgbm9kZXMgd2UgYWxyZWFkeSBoYXZlCgogICAgICB2YXIgZGVkdXBlZE5vZGVzID0gW107CgogICAgICBmb3IgKHZhciBvIGluIG5ld0RhdGEubm9kZXMpIHsKICAgICAgICB2YXIgbm9kZSA9IG5ld0RhdGEubm9kZXNbb107IC8vQXNzaWduIGFuIElECgogICAgICAgIG5vZGUuaWQgPSBzZWxmLm1ha2VOb2RlSWQobm9kZS5maWVsZCwgbm9kZS50ZXJtKTsKCiAgICAgICAgaWYgKCF0aGlzLm5vZGVzTWFwW25vZGUuaWRdKSB7CiAgICAgICAgICAvL0RlZmF1bHQgdGhlIGxhYmVsCiAgICAgICAgICBpZiAoIW5vZGUubGFiZWwpIHsKICAgICAgICAgICAgbm9kZS5sYWJlbCA9IG5vZGUudGVybTsKICAgICAgICAgIH0KCiAgICAgICAgICBkZWR1cGVkTm9kZXMucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkZWR1cGVkTm9kZXMubGVuZ3RoID4gMCAmJiB0aGlzLm9wdGlvbnMubm9kZUxhYmVsbGVyKSB7CiAgICAgICAgLy8gQSBob29rIGZvciBjbGllbnQgY29kZSB0byBhdHRhY2ggbGFiZWxzIGV0YyB0byBuZXdseSBpbnRyb2R1Y2VkIG5vZGVzLgogICAgICAgIHRoaXMub3B0aW9ucy5ub2RlTGFiZWxsZXIoZGVkdXBlZE5vZGVzKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgX28gaW4gZGVkdXBlZE5vZGVzKSB7CiAgICAgICAgdmFyIGRlZHVwZWROb2RlID0gZGVkdXBlZE5vZGVzW19vXTsKICAgICAgICB2YXIgbGFiZWwgPSBkZWR1cGVkTm9kZS50ZXJtOwoKICAgICAgICBpZiAoZGVkdXBlZE5vZGUubGFiZWwpIHsKICAgICAgICAgIGxhYmVsID0gZGVkdXBlZE5vZGUubGFiZWw7CiAgICAgICAgfQoKICAgICAgICB2YXIgX25vZGUyID0gewogICAgICAgICAgeDogMSwKICAgICAgICAgIHk6IDEsCiAgICAgICAgICBudW1DaGlsZHJlbjogMCwKICAgICAgICAgIHBhcmVudDogdW5kZWZpbmVkLAogICAgICAgICAgaXNTZWxlY3RlZDogZmFsc2UsCiAgICAgICAgICBpZDogZGVkdXBlZE5vZGUuaWQsCiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBjb2xvcjogZGVkdXBlZE5vZGUuY29sb3IsCiAgICAgICAgICBpY29uOiBkZWR1cGVkTm9kZS5pY29uLAogICAgICAgICAgZGF0YTogZGVkdXBlZE5vZGUKICAgICAgICB9OyAvLyAgICAgICAgbm9kZS5zY2FsZWRTaXplID0gc2l6ZVNjYWxlKG5vZGUuZGF0YS53ZWlnaHQpOwoKICAgICAgICBfbm9kZTIuc2NhbGVkU2l6ZSA9IDE1OwogICAgICAgIF9ub2RlMi5zZXFOdW1iZXIgPSB0aGlzLnNlcU51bWJlcisrOwogICAgICAgIHRoaXMubm9kZXMucHVzaChfbm9kZTIpOwogICAgICAgIGxhc3RPcHMucHVzaChuZXcgQWRkTm9kZU9wZXJhdGlvbihfbm9kZTIsIHNlbGYpKTsKICAgICAgICB0aGlzLm5vZGVzTWFwW19ub2RlMi5pZF0gPSBfbm9kZTI7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIF9vMiBpbiBuZXdEYXRhLmVkZ2VzKSB7CiAgICAgICAgdmFyIGVkZ2UgPSBuZXdEYXRhLmVkZ2VzW19vMl07CiAgICAgICAgdmFyIHNyYyA9IG5ld0RhdGEubm9kZXNbZWRnZS5zb3VyY2VdOwogICAgICAgIHZhciB0YXJnZXQgPSBuZXdEYXRhLm5vZGVzW2VkZ2UudGFyZ2V0XTsKICAgICAgICBlZGdlLmlkID0gdGhpcy5tYWtlRWRnZUlkKHNyYy5pZCwgdGFyZ2V0LmlkKTsgLy9Mb29rdXAgdGhlIHdyYXBwZXJzIG9iamVjdCB0aGF0IHdpbGwgaG9sZCBkaXNwbGF5IEluZm8gbGlrZSB4L3kgY29vcmRpbmF0ZXMKCiAgICAgICAgdmFyIHNyY1dyYXBwZXJPYmogPSB0aGlzLm5vZGVzTWFwW3NyYy5pZF07CiAgICAgICAgdmFyIHRhcmdldFdyYXBwZXJPYmogPSB0aGlzLm5vZGVzTWFwW3RhcmdldC5pZF07CiAgICAgICAgdmFyIGV4aXN0aW5nRWRnZSA9IHRoaXMuZWRnZXNNYXBbZWRnZS5pZF07CgogICAgICAgIGlmIChleGlzdGluZ0VkZ2UpIHsKICAgICAgICAgIGV4aXN0aW5nRWRnZS53ZWlnaHQgPSBNYXRoLm1heChleGlzdGluZ0VkZ2Uud2VpZ2h0LCBlZGdlLndlaWdodCk7IC8vVE9ETyB1cGRhdGUgd2lkdGggdG9vPwoKICAgICAgICAgIGV4aXN0aW5nRWRnZS5kb2NfY291bnQgPSBNYXRoLm1heChleGlzdGluZ0VkZ2UuZG9jX2NvdW50LCBlZGdlLmRvY19jb3VudCk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHZhciBuZXdFZGdlID0gewogICAgICAgICAgc291cmNlOiBzcmNXcmFwcGVyT2JqLAogICAgICAgICAgdGFyZ2V0OiB0YXJnZXRXcmFwcGVyT2JqLAogICAgICAgICAgd2VpZ2h0OiBlZGdlLndlaWdodCwKICAgICAgICAgIHdpZHRoOiBlZGdlLndpZHRoLAogICAgICAgICAgaWQ6IGVkZ2UuaWQsCiAgICAgICAgICBkb2NfY291bnQ6IGVkZ2UuZG9jX2NvdW50CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGVkZ2UubGFiZWwpIHsKICAgICAgICAgIG5ld0VkZ2UubGFiZWwgPSBlZGdlLmxhYmVsOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5lZGdlc01hcFtuZXdFZGdlLmlkXSA9IG5ld0VkZ2U7CiAgICAgICAgdGhpcy5lZGdlcy5wdXNoKG5ld0VkZ2UpOwogICAgICAgIGxhc3RPcHMucHVzaChuZXcgQWRkRWRnZU9wZXJhdGlvbihuZXdFZGdlLCBzZWxmKSk7CiAgICAgIH0KCiAgICAgIGlmIChsYXN0T3BzLmxlbmd0aCA+IDApIHsKICAgICAgICBzZWxmLmFkZFVuZG9Mb2dFbnRyeShsYXN0T3BzKTsKICAgICAgfQoKICAgICAgdGhpcy5ydW5MYXlvdXQoKTsKICAgIH07CgogICAgdGhpcy5tZXJnZUlkcyA9IGZ1bmN0aW9uIChwYXJlbnRJZCwgY2hpbGRJZCkgewogICAgICB2YXIgcGFyZW50ID0gc2VsZi5nZXROb2RlKHBhcmVudElkKTsKICAgICAgdmFyIGNoaWxkID0gc2VsZi5nZXROb2RlKGNoaWxkSWQpOwoKICAgICAgaWYgKGNoaWxkLmlzU2VsZWN0ZWQpIHsKICAgICAgICBjaGlsZC5pc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgc2VsZi5hcnJSZW1vdmUoc2VsZi5zZWxlY3RlZE5vZGVzLCBjaGlsZCk7CiAgICAgIH0KCiAgICAgIGNoaWxkLnBhcmVudCA9IHBhcmVudDsKICAgICAgc2VsZi5hZGRVbmRvTG9nRW50cnkoW25ldyBHcm91cE9wZXJhdGlvbihwYXJlbnQsIGNoaWxkLCBzZWxmKV0pOwogICAgICBzZWxmLnJ1bkxheW91dCgpOwogICAgfTsKCiAgICB0aGlzLmdldE5vZGUgPSBmdW5jdGlvbiAobm9kZUlkKSB7CiAgICAgIHJldHVybiB0aGlzLm5vZGVzTWFwW25vZGVJZF07CiAgICB9OwoKICAgIHRoaXMuZ2V0RWRnZSA9IGZ1bmN0aW9uIChlZGdlSWQpIHsKICAgICAgcmV0dXJuIHRoaXMuZWRnZXNNYXBbZWRnZUlkXTsKICAgIH07IC8vPT09PT09PSBFeHBhbmQgZnVuY3Rpb25zIHRvIHJlcXVlc3QgbmV3IGFkZGl0aW9ucyB0byB0aGUgZ3JhcGgKCgogICAgdGhpcy5leHBhbmRTZWxlY3RlZHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0YXJnZXRPcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fTsKICAgICAgdmFyIHN0YXJ0Tm9kZXMgPSBzZWxmLmdldEFsbFNlbGVjdGVkTm9kZXMoKTsKCiAgICAgIGlmIChzdGFydE5vZGVzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgc3RhcnROb2RlcyA9IHNlbGYubm9kZXM7CiAgICAgIH0KCiAgICAgIHZhciBjbG9uZSA9IHN0YXJ0Tm9kZXMuc2xpY2UoKTsKICAgICAgc2VsZi5leHBhbmQoY2xvbmUsIHRhcmdldE9wdGlvbnMpOwogICAgfTsKCiAgICB0aGlzLmV4cGFuZEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmV4cGFuZFNlbGVjdGVkcygpOwogICAgfTsgLy9GaW5kIG5ldyBub2RlcyB0byBsaW5rIHRvIGV4aXN0aW5nIHNlbGVjdGVkIG5vZGVzCgoKICAgIHRoaXMuZXhwYW5kTm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHNlbGYuZXhwYW5kKHNlbGYucmV0dXJuVW5wYWNrZWRHcm91cGVkcyhbbm9kZV0pLCB7fSk7CiAgICB9OyAvLyBBIG1hbnVhbCBleHBhbmQgZnVuY3Rpb24gd2hlcmUgdGhlIGNsaWVudCBwcm92aWRlcyB0aGUgbGlzdAogICAgLy8gb2YgZXhpc3Rpbmcgbm9kZXMgdGhhdCBhcmUgdGhlIHN0YXJ0IHBvaW50cyBhbmQgc29tZSBvcHRpb25zCiAgICAvLyBhYm91dCB3aGF0IHRhcmdldHMgYXJlIG9mIGludGVyZXN0LgoKCiAgICB0aGlzLmV4cGFuZCA9IGZ1bmN0aW9uIChzdGFydE5vZGVzLCB0YXJnZXRPcHRpb25zKSB7CiAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgdmFyIG5vZGVzQnlGaWVsZCA9IHt9OwogICAgICB2YXIgZXhjbHVkZU5vZGVzQnlGaWVsZCA9IHt9OyAvL0FkZCBhbnkgYmxhY2tsaXN0ZWQgbm9kZXMgdG8gZXhjbHVzaW9uIGxpc3QKCiAgICAgIHZhciBhdm9pZE5vZGVzID0gdGhpcy5ibGFja2xpc3RlZE5vZGVzOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdm9pZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIG4gPSBhdm9pZE5vZGVzW2ldOwogICAgICAgIHZhciBhcnIgPSBleGNsdWRlTm9kZXNCeUZpZWxkW24uZGF0YS5maWVsZF07CgogICAgICAgIGlmICghYXJyKSB7CiAgICAgICAgICBhcnIgPSBbXTsKICAgICAgICAgIGV4Y2x1ZGVOb2Rlc0J5RmllbGRbbi5kYXRhLmZpZWxkXSA9IGFycjsKICAgICAgICB9CgogICAgICAgIGlmIChhcnIuaW5kZXhPZihuLmRhdGEudGVybSkgPCAwKSB7CiAgICAgICAgICBhcnIucHVzaChuLmRhdGEudGVybSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgYWxsRXhpc3RpbmdOb2RlcyA9IHRoaXMubm9kZXM7CgogICAgICBmb3IgKHZhciBfaTMgPSAwOyBfaTMgPCBhbGxFeGlzdGluZ05vZGVzLmxlbmd0aDsgX2kzKyspIHsKICAgICAgICB2YXIgX240ID0gYWxsRXhpc3RpbmdOb2Rlc1tfaTNdOwogICAgICAgIHZhciBfYXJyMiA9IGV4Y2x1ZGVOb2Rlc0J5RmllbGRbX240LmRhdGEuZmllbGRdOwoKICAgICAgICBpZiAoIV9hcnIyKSB7CiAgICAgICAgICBfYXJyMiA9IFtdOwogICAgICAgICAgZXhjbHVkZU5vZGVzQnlGaWVsZFtfbjQuZGF0YS5maWVsZF0gPSBfYXJyMjsKICAgICAgICB9CgogICAgICAgIF9hcnIyLnB1c2goX240LmRhdGEudGVybSk7CiAgICAgIH0gLy9Pcmdhbml6ZSBub2RlcyBieSBmaWVsZAoKCiAgICAgIGZvciAodmFyIF9pNCA9IDA7IF9pNCA8IHN0YXJ0Tm9kZXMubGVuZ3RoOyBfaTQrKykgewogICAgICAgIHZhciBfbjUgPSBzdGFydE5vZGVzW19pNF07CiAgICAgICAgdmFyIF9hcnIzID0gbm9kZXNCeUZpZWxkW19uNS5kYXRhLmZpZWxkXTsKCiAgICAgICAgaWYgKCFfYXJyMykgewogICAgICAgICAgX2FycjMgPSBbXTsKICAgICAgICAgIG5vZGVzQnlGaWVsZFtfbjUuZGF0YS5maWVsZF0gPSBfYXJyMzsKICAgICAgICB9IC8vIHB1c2hpbmcgYm9vc3RzIHNlcnZlci1zaWRlIHRvIGluZmx1ZW5jZSBzYW1wbGluZy9kaXJlY3Rpb24KCgogICAgICAgIF9hcnIzLnB1c2goewogICAgICAgICAgdGVybTogX241LmRhdGEudGVybSwKICAgICAgICAgIGJvb3N0OiBfbjUuZGF0YS53ZWlnaHQKICAgICAgICB9KTsKCiAgICAgICAgX2FycjMgPSBleGNsdWRlTm9kZXNCeUZpZWxkW19uNS5kYXRhLmZpZWxkXTsKCiAgICAgICAgaWYgKCFfYXJyMykgewogICAgICAgICAgX2FycjMgPSBbXTsKICAgICAgICAgIGV4Y2x1ZGVOb2Rlc0J5RmllbGRbX241LmRhdGEuZmllbGRdID0gX2FycjM7CiAgICAgICAgfSAvL05PVEUgZm9yIHRoZSBlbnRpdHktYnVpbGRpbmcgdXNlIGNhc2UgbmVlZCB0byByZW1vdmUgZXhjbHVkZXMgdGhhdCBvdGhlcndpc2UKICAgICAgICAvLyBwcmV2ZW50IGJyaWRnZS1idWlsZGluZy4KCgogICAgICAgIGlmIChfYXJyMy5pbmRleE9mKF9uNS5kYXRhLnRlcm0pIDwgMCkgewogICAgICAgICAgX2FycjMucHVzaChfbjUuZGF0YS50ZXJtKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBwcmltYXJ5VmVydGljZXMgPSBbXTsKICAgICAgdmFyIHNlY29uZGFyeVZlcnRpY2VzID0gW107CgogICAgICBmb3IgKHZhciBmaWVsZE5hbWUgaW4gbm9kZXNCeUZpZWxkKSB7CiAgICAgICAgcHJpbWFyeVZlcnRpY2VzLnB1c2goewogICAgICAgICAgZmllbGQ6IGZpZWxkTmFtZSwKICAgICAgICAgIGluY2x1ZGU6IG5vZGVzQnlGaWVsZFtmaWVsZE5hbWVdLAogICAgICAgICAgbWluX2RvY19jb3VudDogcGFyc2VJbnQoc2VsZi5vcHRpb25zLmV4cGxvcmVDb250cm9scy5taW5Eb2NDb3VudCkKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIHRhcmdldEZpZWxkcyA9IHRoaXMub3B0aW9ucy52ZXJ0ZXhfZmllbGRzOwoKICAgICAgaWYgKHRhcmdldE9wdGlvbnMudG9GaWVsZHMpIHsKICAgICAgICB0YXJnZXRGaWVsZHMgPSB0YXJnZXRPcHRpb25zLnRvRmllbGRzOwogICAgICB9IC8vSWRlbnRpZnkgdGFyZ2V0IGZpZWxkcwoKCiAgICAgIGZvciAodmFyIGYgaW4gdGFyZ2V0RmllbGRzKSB7CiAgICAgICAgdmFyIF9maWVsZE5hbWUgPSB0YXJnZXRGaWVsZHNbZl0ubmFtZTsgLy8gU29tZXRpbWVzIHRoZSB0YXJnZXQgZmllbGQgaXMgZGlzYWJsZWQgZnJvbSBsb2FkaW5nIG5ldyBob3BzIHNvIHdlIG5lZWQgdG8gdXNlIHRoZSBsYXN0IHZhbGlkIGZpZ3VyZQoKICAgICAgICB2YXIgaG9wU2l6ZSA9IHRhcmdldEZpZWxkc1tmXS5ob3BTaXplID4gMCA/IHRhcmdldEZpZWxkc1tmXS5ob3BTaXplIDogdGFyZ2V0RmllbGRzW2ZdLmxhc3RWYWxpZEhvcFNpemU7CiAgICAgICAgdmFyIGZpZWxkSG9wID0gewogICAgICAgICAgZmllbGQ6IF9maWVsZE5hbWUsCiAgICAgICAgICBzaXplOiBob3BTaXplLAogICAgICAgICAgbWluX2RvY19jb3VudDogcGFyc2VJbnQoc2VsZi5vcHRpb25zLmV4cGxvcmVDb250cm9scy5taW5Eb2NDb3VudCkKICAgICAgICB9OwogICAgICAgIGZpZWxkSG9wLmV4Y2x1ZGUgPSBleGNsdWRlTm9kZXNCeUZpZWxkW19maWVsZE5hbWVdOwogICAgICAgIHNlY29uZGFyeVZlcnRpY2VzLnB1c2goZmllbGRIb3ApOwogICAgICB9CgogICAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgICBjb250cm9sczogc2VsZi5idWlsZENvbnRyb2xzKCksCiAgICAgICAgdmVydGljZXM6IHByaW1hcnlWZXJ0aWNlcywKICAgICAgICBjb25uZWN0aW9uczogewogICAgICAgICAgdmVydGljZXM6IHNlY29uZGFyeVZlcnRpY2VzCiAgICAgICAgfQogICAgICB9OwogICAgICBzZWxmLmxhc3RSZXF1ZXN0ID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCwgbnVsbCwgJ1x0Jyk7CiAgICAgIGdyYXBoRXhwbG9yZXIoc2VsZi5vcHRpb25zLmluZGV4TmFtZSwgcmVxdWVzdCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBzZWxmLmxhc3RSZXNwb25zZSA9IEpTT04uc3RyaW5naWZ5KGRhdGEsIG51bGwsICdcdCcpOwogICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgIHZhciBlZGdlcyA9IFtdOyAvL0xhYmVsIGZpZWxkcyB3aXRoIGEgZmllbGQgbnVtYmVyIGZvciBDU1Mgc3R5bGluZwoKICAgICAgICBmb3IgKHZhciBfbjYgaW4gZGF0YS52ZXJ0aWNlcykgewogICAgICAgICAgdmFyIG5vZGUgPSBkYXRhLnZlcnRpY2VzW19uNl07CgogICAgICAgICAgZm9yICh2YXIgX2YgaW4gdGFyZ2V0RmllbGRzKSB7CiAgICAgICAgICAgIHZhciBmaWVsZERlZiA9IHRhcmdldEZpZWxkc1tfZl07CgogICAgICAgICAgICBpZiAobm9kZS5maWVsZCA9PSBmaWVsZERlZi5uYW1lKSB7CiAgICAgICAgICAgICAgbm9kZS5jb2xvciA9IGZpZWxkRGVmLmNvbG9yOwogICAgICAgICAgICAgIG5vZGUuaWNvbiA9IGZpZWxkRGVmLmljb247CiAgICAgICAgICAgICAgbm9kZS5maWVsZERlZiA9IGZpZWxkRGVmOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBTaXplIHRoZSBlZGdlcyBiYXNlZCBvbiB0aGUgbWF4aW11bSB3ZWlnaHQKCgogICAgICAgIHZhciBtaW5MaW5lU2l6ZSA9IDI7CiAgICAgICAgdmFyIG1heExpbmVTaXplID0gMTA7CiAgICAgICAgdmFyIG1heEVkZ2VXZWlnaHQgPSAwLjAwMDAwMDAxOwoKICAgICAgICBmb3IgKHZhciBlIGluIGRhdGEuY29ubmVjdGlvbnMpIHsKICAgICAgICAgIHZhciBlZGdlID0gZGF0YS5jb25uZWN0aW9uc1tlXTsKICAgICAgICAgIG1heEVkZ2VXZWlnaHQgPSBNYXRoLm1heChtYXhFZGdlV2VpZ2h0LCBlZGdlLndlaWdodCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBfZSBpbiBkYXRhLmNvbm5lY3Rpb25zKSB7CiAgICAgICAgICB2YXIgX2VkZ2UgPSBkYXRhLmNvbm5lY3Rpb25zW19lXTsKICAgICAgICAgIGVkZ2VzLnB1c2goewogICAgICAgICAgICBzb3VyY2U6IF9lZGdlLnNvdXJjZSwKICAgICAgICAgICAgdGFyZ2V0OiBfZWRnZS50YXJnZXQsCiAgICAgICAgICAgIGRvY19jb3VudDogX2VkZ2UuZG9jX2NvdW50LAogICAgICAgICAgICB3ZWlnaHQ6IF9lZGdlLndlaWdodCwKICAgICAgICAgICAgd2lkdGg6IE1hdGgubWF4KG1pbkxpbmVTaXplLCBfZWRnZS53ZWlnaHQgLyBtYXhFZGdlV2VpZ2h0ICogbWF4TGluZVNpemUpCiAgICAgICAgICB9KTsKICAgICAgICB9IC8vIEFkZCB0aGUgbmV3IG5vZGVzIGFuZCBlZGdlcyBpbnRvIHRoZSBleGlzdGluZyB3b3Jrc3BhY2UncyBncmFwaAoKCiAgICAgICAgc2VsZi5tZXJnZUdyYXBoKHsKICAgICAgICAgIG5vZGVzOiBkYXRhLnZlcnRpY2VzLAogICAgICAgICAgZWRnZXM6IGVkZ2VzCiAgICAgICAgfSk7CiAgICAgIH0pOyAvLz09PT09IEVuZCBleHBhbmQgZ3JhcGggPT09PT09PT09PT09PT09PT09PT09PT09CiAgICB9OwoKICAgIHRoaXMudHJpbUV4Y2Vzc05ld0VkZ2VzID0gZnVuY3Rpb24gKG5ld05vZGVzLCBuZXdFZGdlcykgewogICAgICB2YXIgdHJpbW1lZEVkZ2VzID0gW107CiAgICAgIHZhciBtYXhOdW1FZGdlc1RvUmV0dXJuID0gNTsgLy9UcmltIGhlcmUgdG8ganVzdCB0aGUgbmV3IGVkZ2VzIHRoYXQgYXJlIG1vc3QgaW50ZXJlc3RpbmcuCgogICAgICBmb3IgKHZhciBvIGluIG5ld0VkZ2VzKSB7CiAgICAgICAgdmFyIGVkZ2UgPSBuZXdFZGdlc1tvXTsKICAgICAgICB2YXIgc3JjID0gbmV3Tm9kZXNbZWRnZS5zb3VyY2VdOwogICAgICAgIHZhciB0YXJnZXQgPSBuZXdOb2Rlc1tlZGdlLnRhcmdldF07CiAgICAgICAgdmFyIHNyY0lkID0gc3JjLmZpZWxkICsgJy4uJyArIHNyYy50ZXJtOwogICAgICAgIHZhciB0YXJnZXRJZCA9IHRhcmdldC5maWVsZCArICcuLicgKyB0YXJnZXQudGVybTsKICAgICAgICB2YXIgaWQgPSB0aGlzLm1ha2VFZGdlSWQoc3JjSWQsIHRhcmdldElkKTsKICAgICAgICB2YXIgZXhpc3RpbmdTcmNOb2RlID0gc2VsZi5ub2Rlc01hcFtzcmNJZF07CiAgICAgICAgdmFyIGV4aXN0aW5nVGFyZ2V0Tm9kZSA9IHNlbGYubm9kZXNNYXBbdGFyZ2V0SWRdOwoKICAgICAgICBpZiAoZXhpc3RpbmdTcmNOb2RlICE9IG51bGwgJiYgZXhpc3RpbmdUYXJnZXROb2RlICE9IG51bGwpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1NyY05vZGUucGFyZW50ICE9IHVuZGVmaW5lZCAmJiBleGlzdGluZ1RhcmdldE5vZGUucGFyZW50ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAvLyBib3RoIG5vZGVzIGFyZSByb2xsZWQtdXAgYW5kIGdyb3VwZWQgc28gdGhpcyBlZGdlIHdvdWxkIG5vdCBiZSBhIHZpc2libGUKICAgICAgICAgICAgLy8gY2hhbmdlIHRvIHRoZSBncmFwaCAtIGxvc2UgaXQgaW4gZmF2b3VyIG9mIGFueSBvdGhlciB2aXNpYmxlIG9uZXMuCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I/IE1pc3Npbmcgbm9kZXMgJyArIHNyY0lkICsgJyBvciAnICsgdGFyZ2V0SWQsIHNlbGYubm9kZXNNYXApOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgZXhpc3RpbmdFZGdlID0gc2VsZi5lZGdlc01hcFtpZF07CgogICAgICAgIGlmIChleGlzdGluZ0VkZ2UpIHsKICAgICAgICAgIGV4aXN0aW5nRWRnZS53ZWlnaHQgPSBNYXRoLm1heChleGlzdGluZ0VkZ2Uud2VpZ2h0LCBlZGdlLndlaWdodCk7CiAgICAgICAgICBleGlzdGluZ0VkZ2UuZG9jX2NvdW50ID0gTWF0aC5tYXgoZXhpc3RpbmdFZGdlLmRvY19jb3VudCwgZWRnZS5kb2NfY291bnQpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRyaW1tZWRFZGdlcy5wdXNoKGVkZ2UpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHRyaW1tZWRFZGdlcy5sZW5ndGggPiBtYXhOdW1FZGdlc1RvUmV0dXJuKSB7CiAgICAgICAgLy90cmltIHRvIG9ubHkgdGhlIG1vc3QgaW50ZXJlc3Rpbmcgb25lcwogICAgICAgIHRyaW1tZWRFZGdlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYi53ZWlnaHQgLSBhLndlaWdodDsKICAgICAgICB9KTsKICAgICAgICB0cmltbWVkRWRnZXMgPSB0cmltbWVkRWRnZXMuc3BsaWNlKDAsIG1heE51bUVkZ2VzVG9SZXR1cm4pOwogICAgICB9CgogICAgICByZXR1cm4gdHJpbW1lZEVkZ2VzOwogICAgfTsKCiAgICB0aGlzLmdldFF1ZXJ5ID0gZnVuY3Rpb24gKHN0YXJ0Tm9kZXMsIGxvb3NlKSB7CiAgICAgIHZhciBzaG91bGRzID0gW107CiAgICAgIHZhciBub2RlcyA9IHN0YXJ0Tm9kZXM7CgogICAgICBpZiAoIXN0YXJ0Tm9kZXMpIHsKICAgICAgICBub2RlcyA9IHNlbGYubm9kZXM7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGJzIGluIG5vZGVzKSB7CiAgICAgICAgdmFyIG5vZGUgPSBub2Rlc1tic107CgogICAgICAgIGlmIChub2RlLnBhcmVudCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHNob3VsZHMucHVzaChzZWxmLmJ1aWxkTm9kZVF1ZXJ5KG5vZGUpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgYm9vbDogewogICAgICAgICAgc2hvdWxkOiBzaG91bGRzLAogICAgICAgICAgbWluaW11bV9zaG91bGRfbWF0Y2g6IE1hdGgubWluKHNob3VsZHMubGVuZ3RoLCBsb29zZSA/IDEgOiAyKQogICAgICAgIH0KICAgICAgfTsKICAgIH07CgogICAgdGhpcy5nZXRTZWxlY3RlZE9yQWxsTm9kZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdGFydE5vZGVzID0gc2VsZi5nZXRBbGxTZWxlY3RlZE5vZGVzKCk7CgogICAgICBpZiAoc3RhcnROb2Rlcy5sZW5ndGggPT09IDApIHsKICAgICAgICBzdGFydE5vZGVzID0gc2VsZi5ub2RlczsKICAgICAgfQoKICAgICAgcmV0dXJuIHN0YXJ0Tm9kZXM7CiAgICB9OwoKICAgIHRoaXMuZ2V0U2VsZWN0ZWRPckFsbFRvcE5vZGVzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2VsZi5nZXRTZWxlY3RlZE9yQWxsTm9kZXMoKS5maWx0ZXIoZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5wYXJlbnQgPT09IHVuZGVmaW5lZDsKICAgICAgfSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGFkZFRlcm1Ub0ZpZWxkTGlzdChtYXAsIGZpZWxkLCB0ZXJtKSB7CiAgICAgIHZhciBhcnIgPSBtYXBbZmllbGRdOwoKICAgICAgaWYgKCFhcnIpIHsKICAgICAgICBhcnIgPSBbXTsKICAgICAgICBtYXBbZmllbGRdID0gYXJyOwogICAgICB9CgogICAgICBhcnIucHVzaCh0ZXJtKTsKICAgIH0KICAgIC8qKgogICAgICogQWRkIG1pc3NpbmcgbGlua3MgYmV0d2VlbiBleGlzdGluZyBub2RlcwogICAgICogQHBhcmFtIG1heE5ld0VkZ2VzIE1heCBudW1iZXIgb2YgbmV3IGVkZ2VzIGFkZGVkLiBBdm9pZCBhZGRpbmcgdG9vIG1hbnkgbmV3IGVkZ2VzCiAgICAgKiBhdCBvbmNlIGludG8gdGhlIGdyYXBoIG90aGVyd2lzZSBkaXNvcmllbnRhdGluZwogICAgICovCgoKICAgIHRoaXMuZmlsbEluR3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBtYXhOZXdFZGdlcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogMTA7CiAgICAgIHZhciBub2Rlc0ZvckxpbmtpbmcgPSBzZWxmLmdldFNlbGVjdGVkT3JBbGxUb3BOb2RlcygpOwogICAgICB2YXIgbWF4TnVtVmVydGljZXNTZWFyY2hhYmxlID0gMTAwOyAvLyBTZXJ2ZXIgbGltaXRhdGlvbiAtIHdlIGNhbiBvbmx5IHNlYXJjaCBmb3IgY29ubmVjdGlvbnMgYmV0d2VlbiBtYXggMTAwIHZlcnRpY2VzIGF0IGEgdGltZS4KCiAgICAgIGlmIChub2Rlc0ZvckxpbmtpbmcubGVuZ3RoID4gbWF4TnVtVmVydGljZXNTZWFyY2hhYmxlKSB7CiAgICAgICAgLy9NYWtlIGEgc2VsZWN0aW9uIG9mIHJhbmRvbSBub2RlcyBmcm9tIHRoZSBhcnJheS4gU2hpZnQgdGhlIHJhbmRvbSBjaG9pY2VzCiAgICAgICAgLy8gdG8gdGhlIGZyb250IG9mIHRoZSBhcnJheS4KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1heE51bVZlcnRpY2VzU2VhcmNoYWJsZTsgaSsrKSB7CiAgICAgICAgICB2YXIgb2xkTm9kZSA9IG5vZGVzRm9yTGlua2luZ1tpXTsKICAgICAgICAgIHZhciByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChub2Rlc0ZvckxpbmtpbmcubGVuZ3RoIC0gaSkpICsgaTsgLy9Td2FwIHRoZSBub2RlIHBvc2l0aW9ucyBvZiB0aGUgcmFuZG9tbHkgc2VsZWN0ZWQgbm9kZSBhbmQgaQoKICAgICAgICAgIG5vZGVzRm9yTGlua2luZ1tpXSA9IG5vZGVzRm9yTGlua2luZ1tyYW5kb21JbmRleF07CiAgICAgICAgICBub2Rlc0ZvckxpbmtpbmdbcmFuZG9tSW5kZXhdID0gb2xkTm9kZTsKICAgICAgICB9IC8vIFRyaW0gdG8gb3VyIHJhbmRvbSBzZWxlY3Rpb24KCgogICAgICAgIG5vZGVzRm9yTGlua2luZyA9IG5vZGVzRm9yTGlua2luZy5zbGljZSgwLCBtYXhOdW1WZXJ0aWNlc1NlYXJjaGFibGUgLSAxKTsKICAgICAgfSAvLyBDcmVhdGUgb3VyIHF1ZXJ5L2FnZ3JlZ2F0aW9uIHJlcXVlc3QgdXNpbmcgdGhlIHNlbGVjdGVkIG5vZGVzLgogICAgICAvLyBGaWx0ZXJzIGFyZSBuYW1lZCBhZnRlciB0aGUgaW5kZXggb2YgdGhlIG5vZGUgaW4gdGhlIG5vZGVzRm9yTGlua2luZwogICAgICAvLyBhcnJheS4gVGhlIHJlc3VsdCBidWNrZXQgZGVzY3JpYmluZyB0aGUgcmVsYXRpb25zaGlwIGJldHdlZW4KICAgICAgLy8gdGhlIGZpcnN0IDIgbm9kZXMgaW4gdGhlIGFycmF5IHdpbGwgdGhlcmVmb3JlIGJlIGxhYmVsbGVkICIwfDEiCgoKICAgICAgdmFyIHNob3VsZHMgPSBbXTsKICAgICAgdmFyIGZpbHRlck1hcCA9IHt9OwogICAgICBub2Rlc0ZvckxpbmtpbmcuZm9yRWFjaChmdW5jdGlvbiAobm9kZSwgbm9kZU51bSkgewogICAgICAgIHZhciBub2RlUXVlcnkgPSBzZWxmLmJ1aWxkTm9kZVF1ZXJ5KG5vZGUpOwogICAgICAgIHNob3VsZHMucHVzaChub2RlUXVlcnkpOwogICAgICAgIGZpbHRlck1hcFtub2RlTnVtXSA9IG5vZGVRdWVyeTsKICAgICAgfSk7CiAgICAgIHZhciBzZWFyY2hSZXEgPSB7CiAgICAgICAgc2l6ZTogMCwKICAgICAgICBxdWVyeTogewogICAgICAgICAgYm9vbDogewogICAgICAgICAgICAvLyBPbmx5IG1hdGNoIGRvY3MgdGhhdCBzaGFyZSAyIG5vZGVzIHNvIGNhbiBoZWxwIGRlc2NyaWJlIHRoZWlyIHJlbGF0aW9uc2hpcAogICAgICAgICAgICBtaW5pbXVtX3Nob3VsZF9tYXRjaDogMiwKICAgICAgICAgICAgc2hvdWxkOiBzaG91bGRzCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhZ2dzOiB7CiAgICAgICAgICBtYXRyaXg6IHsKICAgICAgICAgICAgYWRqYWNlbmN5X21hdHJpeDogewogICAgICAgICAgICAgIHNlcGFyYXRvcjogJ3wnLAogICAgICAgICAgICAgIGZpbHRlcnM6IGZpbHRlck1hcAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OyAvLyBTZWFyY2ggZm9yIGNvbm5lY3Rpb25zIGJldHdlZW4gdGhlIHNlbGVjdGVkIG5vZGVzLgoKICAgICAgc2VhcmNoZXIoc2VsZi5vcHRpb25zLmluZGV4TmFtZSwgc2VhcmNoUmVxLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBudW1Eb2NzTWF0Y2hlZCA9IGRhdGEuaGl0cy50b3RhbDsKICAgICAgICB2YXIgYnVja2V0cyA9IGRhdGEuYWdncmVnYXRpb25zLm1hdHJpeC5idWNrZXRzOwogICAgICAgIHZhciB2ZXJ0aWNlcyA9IG5vZGVzRm9yTGlua2luZy5tYXAoZnVuY3Rpb24gKGV4aXN0aW5nTm9kZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZmllbGQ6IGV4aXN0aW5nTm9kZS5kYXRhLmZpZWxkLAogICAgICAgICAgICB0ZXJtOiBleGlzdGluZ05vZGUuZGF0YS50ZXJtLAogICAgICAgICAgICB3ZWlnaHQ6IDEsCiAgICAgICAgICAgIGRlcHRoOiAwCiAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICAgIHZhciBjb25uZWN0aW9ucyA9IFtdOwogICAgICAgIHZhciBtYXhFZGdlV2VpZ2h0ID0gMDsgLy8gVHVybiBtYXRyaXggYXJyYXkgb2YgcmVzdWx0cyBpbnRvIGEgbWFwCgogICAgICAgIHZhciBrZXllZEJ1Y2tldHMgPSB7fTsKICAgICAgICBidWNrZXRzLmZvckVhY2goZnVuY3Rpb24gKGJ1Y2tldCkgewogICAgICAgICAga2V5ZWRCdWNrZXRzW2J1Y2tldC5rZXldID0gYnVja2V0OwogICAgICAgIH0pOwogICAgICAgIGJ1Y2tldHMuZm9yRWFjaChmdW5jdGlvbiAoYnVja2V0KSB7CiAgICAgICAgICAvLyBXZSBjYWxpYnJhdGUgbGluZSB0aGlja25lc3MgYmFzZWQgb24gJSBvZiBtYXggd2VpZ2h0IG9mCiAgICAgICAgICAvLyBhbGwgZWRnZXMgKGluY2x1ZGluZyB0aGUgZWRnZXMgd2UgbWF5IGFscmVhZHkgaGF2ZSBpbiB0aGUgd29ya3NwYWNlKQogICAgICAgICAgdmFyIGlkcyA9IGJ1Y2tldC5rZXkuc3BsaXQoJ3wnKTsKCiAgICAgICAgICBpZiAoaWRzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAvLyBidWNrZXQgcmVwcmVzZW50cyBhbiBlZGdlCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuZXhwbG9yZUNvbnRyb2xzLnVzZVNpZ25pZmljYW5jZSkgewogICAgICAgICAgICAgIHZhciB0MSA9IGtleWVkQnVja2V0c1tpZHNbMF1dLmRvY19jb3VudDsKICAgICAgICAgICAgICB2YXIgdDIgPSBrZXllZEJ1Y2tldHNbaWRzWzFdXS5kb2NfY291bnQ7CiAgICAgICAgICAgICAgdmFyIHQxQW5kVDIgPSBidWNrZXQuZG9jX2NvdW50OyAvLyBDYWxjIHRoZSBzaWduaWZpY2FudF90ZXJtcyBzY29yZSB0byBwcmlvcml0aXplIHNlbGVjdGlvbiBvZiBpbnRlcmVzdGluZyBsaW5rcwoKICAgICAgICAgICAgICBidWNrZXQud2VpZ2h0ID0gc2VsZi5KTEhTY29yZSh0MUFuZFQyLCBNYXRoLm1heCh0MSwgdDIpLCBNYXRoLm1pbih0MSwgdDIpLCBudW1Eb2NzTWF0Y2hlZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gcHJpb3JpdGl6ZSBsaW5rcyBwdXJlbHkgb24gdm9sdW1lIG9mIGludGVyc2VjdGluZyBkb2NzCiAgICAgICAgICAgICAgYnVja2V0LndlaWdodCA9IGJ1Y2tldC5kb2NfY291bnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1heEVkZ2VXZWlnaHQgPSBNYXRoLm1heChtYXhFZGdlV2VpZ2h0LCBidWNrZXQud2VpZ2h0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgYmFja0ZpbGxlZE1pbkxpbmVTaXplID0gMjsKICAgICAgICB2YXIgYmFja0ZpbGxlZE1heExpbmVTaXplID0gNTsKICAgICAgICBidWNrZXRzLmZvckVhY2goZnVuY3Rpb24gKGJ1Y2tldCkgewogICAgICAgICAgaWYgKGJ1Y2tldC5kb2NfY291bnQgPCBwYXJzZUludChzZWxmLm9wdGlvbnMuZXhwbG9yZUNvbnRyb2xzLm1pbkRvY0NvdW50KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGlkcyA9IGJ1Y2tldC5rZXkuc3BsaXQoJ3wnKTsKCiAgICAgICAgICBpZiAoaWRzLmxlbmd0aCA9PSAyKSB7CiAgICAgICAgICAgIC8vIEJ1Y2tldCByZXByZXNlbnRzIGFuIGVkZ2UKICAgICAgICAgICAgdmFyIHNyY05vZGUgPSBub2Rlc0ZvckxpbmtpbmdbaWRzWzBdXTsKICAgICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBub2Rlc0ZvckxpbmtpbmdbaWRzWzFdXTsKICAgICAgICAgICAgdmFyIGVkZ2VJZCA9IHNlbGYubWFrZUVkZ2VJZChzcmNOb2RlLmlkLCB0YXJnZXROb2RlLmlkKTsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nRWRnZSA9IHNlbGYuZWRnZXNNYXBbZWRnZUlkXTsKCiAgICAgICAgICAgIGlmIChleGlzdGluZ0VkZ2UpIHsKICAgICAgICAgICAgICAvLyBUd2VhayB0aGUgZG9jX2NvdW50IHNjb3JlIGhhdmluZyBqdXN0IGxvb2tlZCBpdCB1cC4KICAgICAgICAgICAgICBleGlzdGluZ0VkZ2UuZG9jX2NvdW50ID0gTWF0aC5tYXgoZXhpc3RpbmdFZGdlLmRvY19jb3VudCwgYnVja2V0LmRvY19jb3VudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29ubmVjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAvLyBzb3VyY2UgYW5kIHRhcmdldCB2YWx1ZXMgYXJlIGluZGV4ZXMgaW50byB0aGUgdmVydGljZXMgYXJyYXkKICAgICAgICAgICAgICAgIHNvdXJjZTogcGFyc2VJbnQoaWRzWzBdKSwKICAgICAgICAgICAgICAgIHRhcmdldDogcGFyc2VJbnQoaWRzWzFdKSwKICAgICAgICAgICAgICAgIHdlaWdodDogYnVja2V0LndlaWdodCwKICAgICAgICAgICAgICAgIHdpZHRoOiBNYXRoLm1heChiYWNrRmlsbGVkTWluTGluZVNpemUsIGJ1Y2tldC53ZWlnaHQgLyBtYXhFZGdlV2VpZ2h0ICogYmFja0ZpbGxlZE1heExpbmVTaXplKSwKICAgICAgICAgICAgICAgIGRvY19jb3VudDogYnVja2V0LmRvY19jb3VudAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7IC8vIFRyaW0gdGhlIGFycmF5IG9mIGNvbm5lY3Rpb25zIHNvIHRoYXQgd2UgZG9uJ3QgYWRkIHRvbyBtYW55IGF0IG9uY2UgLSBkaXNvcmllbnRhdGluZyBmb3IgdXNlcnMgb3RoZXJ3aXNlCgogICAgICAgIGlmIChjb25uZWN0aW9ucy5sZW5ndGggPiBtYXhOZXdFZGdlcykgewogICAgICAgICAgY29ubmVjdGlvbnMgPSBjb25uZWN0aW9ucy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBiLndlaWdodCAtIGEud2VpZ2h0OwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0aW9ucyA9IGNvbm5lY3Rpb25zLnNsaWNlKDAsIG1heE5ld0VkZ2VzKTsKICAgICAgICB9IC8vIE1lcmdlIHRoZSBuZXcgZWRnZXMgaW50byB0aGUgZXhpc3Rpbmcgd29ya3NwYWNlJ3MgZ3JhcGguCiAgICAgICAgLy8gV2UgcmV1c2UgdGhlIG1lcmdlR3JhcGggZnVuY3Rpb24gdXNlZCB0byBoYW5kbGUgdGhlCiAgICAgICAgLy8gcmVzdWx0cyBvZiBvdGhlciBjYWxscyB0byB0aGUgc2VydmVyLXNpZGUgR3JhcGggQVBJCiAgICAgICAgLy8gc28gbXVzdCBwYWNrYWdlIHRoZSByZXN1bHRzIGhlcmUgd2l0aCB0aGF0IHNhbWUgZm9ybWF0CiAgICAgICAgLy8gZXZlbiB0aG91Z2ggd2Uga25vdyBhbGwgdGhlIHZlcnRpY2VzIHdlIHByb3ZpZGUgd2lsbAogICAgICAgIC8vIGJlIGR1cGxpY2F0ZXMgYW5kIGlnbm9yZWQuCgoKICAgICAgICBzZWxmLm1lcmdlR3JhcGgoewogICAgICAgICAgbm9kZXM6IHZlcnRpY2VzLAogICAgICAgICAgZWRnZXM6IGNvbm5lY3Rpb25zCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsgLy8gUHJvdmlkZSBhICJmdXp6eSBmaW5kIHNpbWlsYXIiIHF1ZXJ5IHRoYXQgY2FuIGZpbmQgc2ltaWxhciBkb2NzIGJ1dCBwcmVmZXJhYmx5CiAgICAvLyBub3QgcmUtaXRlcmF0aW5nIHRoZSBleGFjdCB0ZXJtcyB3ZSBhbHJlYWR5IGhhdmUgaW4gdGhlIHdvcmtzcGFjZS4KICAgIC8vIFdlIHVzZSBhIGZyZWUtdGV4dCBzZWFyY2ggb24gdGhlIGluZGV4J3MgY29uZmlndXJlZCBkZWZhdWx0IGZpZWxkICh0eXBpY2FsbHkgJ19hbGwnKQogICAgLy8gdG8gZHJpbGwtZG93biBpbnRvIGRvY3MgdGhhdCBzaG91bGQgYmUgbGlua2VkIGJ1dCBhcmVuJ3QgdmlhIHRoZSBleGFjdCB0ZXJtcwogICAgLy8gd2UgaGF2ZSBpbiB0aGUgd29ya3NwYWNlCgoKICAgIHRoaXMuZ2V0TGlrZVRoaXNCdXROb3RUaGlzUXVlcnkgPSBmdW5jdGlvbiAoc3RhcnROb2RlcykgewogICAgICB2YXIgbGlrZVF1ZXJpZXMgPSBbXTsKICAgICAgdmFyIHR4dHNCeUZpZWxkVHlwZSA9IHt9OwogICAgICBzdGFydE5vZGVzLmZvckVhY2goZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICB2YXIgdHh0ID0gdHh0c0J5RmllbGRUeXBlW25vZGUuZGF0YS5maWVsZF07CgogICAgICAgIGlmICh0eHQpIHsKICAgICAgICAgIHR4dCA9IHR4dCArICcgJyArIG5vZGUubGFiZWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR4dCA9IG5vZGUubGFiZWw7CiAgICAgICAgfQoKICAgICAgICB0eHRzQnlGaWVsZFR5cGVbbm9kZS5kYXRhLmZpZWxkXSA9IHR4dDsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBmaWVsZCBpbiB0eHRzQnlGaWVsZFR5cGUpIHsKICAgICAgICBsaWtlUXVlcmllcy5wdXNoKHsKICAgICAgICAgIG1vcmVfbGlrZV90aGlzOiB7CiAgICAgICAgICAgIGxpa2U6IHR4dHNCeUZpZWxkVHlwZVtmaWVsZF0sCiAgICAgICAgICAgIG1pbl90ZXJtX2ZyZXE6IDEsCiAgICAgICAgICAgIG1pbmltdW1fc2hvdWxkX21hdGNoOiAnMjAlJywKICAgICAgICAgICAgbWluX2RvY19mcmVxOiAxLAogICAgICAgICAgICBib29zdF90ZXJtczogMiwKICAgICAgICAgICAgbWF4X3F1ZXJ5X3Rlcm1zOiAyNQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgZXhjbHVkZU5vZGVzQnlGaWVsZCA9IHt9OwogICAgICB2YXIgYWxsRXhpc3RpbmdOb2RlcyA9IHNlbGYubm9kZXM7CiAgICAgIGFsbEV4aXN0aW5nTm9kZXMuZm9yRWFjaChmdW5jdGlvbiAoZXhpc3RpbmdOb2RlKSB7CiAgICAgICAgYWRkVGVybVRvRmllbGRMaXN0KGV4Y2x1ZGVOb2Rlc0J5RmllbGQsIGV4aXN0aW5nTm9kZS5kYXRhLmZpZWxkLCBleGlzdGluZ05vZGUuZGF0YS50ZXJtKTsKICAgICAgfSk7CiAgICAgIHZhciBibGFja2xpc3RlZE5vZGVzID0gc2VsZi5ibGFja2xpc3RlZE5vZGVzOwogICAgICBibGFja2xpc3RlZE5vZGVzLmZvckVhY2goZnVuY3Rpb24gKGJsYWNrbGlzdGVkTm9kZSkgewogICAgICAgIGFkZFRlcm1Ub0ZpZWxkTGlzdChleGNsdWRlTm9kZXNCeUZpZWxkLCBibGFja2xpc3RlZE5vZGUuZGF0YS5maWVsZCwgYmxhY2tsaXN0ZWROb2RlLmRhdGEudGVybSk7CiAgICAgIH0pOyAvL0NyZWF0ZSBuZWdhdGl2ZSBib29zdGluZyBxdWVyaWVzIHRvIGF2b2lkIG1hdGNoaW5nIHdoYXQgeW91IGFscmVhZHkgaGF2ZSBpbiB0aGUgd29ya3NwYWNlLgoKICAgICAgdmFyIG5vdEV4aXN0aW5nTm9kZXMgPSBbXTsKICAgICAgT2JqZWN0LmtleXMoZXhjbHVkZU5vZGVzQnlGaWVsZCkuZm9yRWFjaChmdW5jdGlvbiAoZmllbGROYW1lKSB7CiAgICAgICAgdmFyIHRlcm1zUXVlcnkgPSB7fTsKICAgICAgICB0ZXJtc1F1ZXJ5W2ZpZWxkTmFtZV0gPSBleGNsdWRlTm9kZXNCeUZpZWxkW2ZpZWxkTmFtZV07CiAgICAgICAgbm90RXhpc3RpbmdOb2Rlcy5wdXNoKHsKICAgICAgICAgIHRlcm1zOiB0ZXJtc1F1ZXJ5CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIC8vIFVzZSBhIGJvb3N0aW5nIHF1ZXJ5IHRvIGVmZmVjdGl2ZWx5IHRvIHJlcXVlc3QgInNpbWlsYXIgdG8gdGhlc2UgSURTL2xhYmVscyBidXQKICAgICAgICAvLyBwcmVmZXJhYmx5IG5vdCBjb250YWluaW5nIHRoZXNlIGV4YWN0IElEcyIuCiAgICAgICAgYm9vc3Rpbmc6IHsKICAgICAgICAgIG5lZ2F0aXZlX2Jvb3N0OiAwLjAwMDEsCiAgICAgICAgICBuZWdhdGl2ZTogewogICAgICAgICAgICBib29sOiB7CiAgICAgICAgICAgICAgc2hvdWxkOiBub3RFeGlzdGluZ05vZGVzCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBwb3NpdGl2ZTogewogICAgICAgICAgICBib29sOiB7CiAgICAgICAgICAgICAgc2hvdWxkOiBsaWtlUXVlcmllcwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKCiAgICB0aGlzLmdldFNlbGVjdGVkSW50ZXJzZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICBpZiAoc2VsZi5zZWxlY3RlZE5vZGVzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0QWxsSW50ZXJzZWN0aW9ucyhjYWxsYmFjaywgc2VsZi5ub2Rlcyk7CiAgICAgIH0KCiAgICAgIGlmIChzZWxmLnNlbGVjdGVkTm9kZXMubGVuZ3RoID09IDEpIHsKICAgICAgICB2YXIgc2VsZWN0ZWROb2RlID0gc2VsZi5zZWxlY3RlZE5vZGVzWzBdOwogICAgICAgIHZhciBuZWlnaGJvdXJOb2RlcyA9IHNlbGYuZ2V0TmVpZ2hib3VycyhzZWxlY3RlZE5vZGUpOwogICAgICAgIG5laWdoYm91ck5vZGVzLnB1c2goc2VsZWN0ZWROb2RlKTsKICAgICAgICByZXR1cm4gc2VsZi5nZXRBbGxJbnRlcnNlY3Rpb25zKGNhbGxiYWNrLCBuZWlnaGJvdXJOb2Rlcyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzZWxmLmdldEFsbEludGVyc2VjdGlvbnMoY2FsbGJhY2ssIHNlbGYuZ2V0QWxsU2VsZWN0ZWROb2RlcygpKTsKICAgIH07CgogICAgdGhpcy5KTEhTY29yZSA9IGZ1bmN0aW9uIChzdWJzZXRGcmVxLCBzdWJzZXRTaXplLCBzdXBlcnNldEZyZXEsIHN1cGVyc2V0U2l6ZSkgewogICAgICB2YXIgc3Vic2V0UHJvYmFiaWxpdHkgPSBzdWJzZXRGcmVxIC8gc3Vic2V0U2l6ZTsKICAgICAgdmFyIHN1cGVyc2V0UHJvYmFiaWxpdHkgPSBzdXBlcnNldEZyZXEgLyBzdXBlcnNldFNpemU7CiAgICAgIHZhciBhYnNvbHV0ZVByb2JhYmlsaXR5Q2hhbmdlID0gc3Vic2V0UHJvYmFiaWxpdHkgLSBzdXBlcnNldFByb2JhYmlsaXR5OwoKICAgICAgaWYgKGFic29sdXRlUHJvYmFiaWxpdHlDaGFuZ2UgPD0gMCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CgogICAgICB2YXIgcmVsYXRpdmVQcm9iYWJpbGl0eUNoYW5nZSA9IHN1YnNldFByb2JhYmlsaXR5IC8gc3VwZXJzZXRQcm9iYWJpbGl0eTsKICAgICAgcmV0dXJuIGFic29sdXRlUHJvYmFiaWxpdHlDaGFuZ2UgKiByZWxhdGl2ZVByb2JhYmlsaXR5Q2hhbmdlOwogICAgfTsgLy8gQ3VycmVudGx5IHVudXNlZCBpbiB0aGUgS2liYW5hIFVJLiBJdCB3YXMgYSB1dGlsaXR5IHRoYXQgcHJvdmlkZWQgYSBzb3J0ZWQgbGlzdAogICAgLy8gb2YgcmVjb21tZW5kZWQgbm9kZSBtZXJnZXMgZm9yIGEgc2VsZWN0aW9uIG9mIG5vZGVzLiBUb3AgcmVzdWx0cyB3b3VsZCBiZQogICAgLy8gcmFyZSBub2RlcyB0aGF0IEFMV0FZUyBhcHBlYXIgYWxvbmdzaWRlIG1vcmUgcG9wdWxhciBvbmVzIGUuZy4gdGV4dDo5MjAwIGFsd2F5cwogICAgLy8gYXBwZWFycyBhbG9uZ3NpZGUgaGFzaHRhZzplbGFzdGljc2VhcmNoIHNvIHdvdWxkIGJlIG9mZmVyZWQgYXMgYSBsaWtlbHkgY2FuZGlkYXRlCiAgICAvLyBmb3IgbWVyZ2luZy4KICAgIC8vIERldGVybWluZXMgdW5pb24vaW50ZXJzZWN0aW9uIHN0YXRzIGZvciBuZWlnaGJvdXJzIG9mIGEgbm9kZS4KICAgIC8vIFRPRE8gLSBjb3VsZCBtb3ZlIHNlcnZlci1zaWRlIGFzIGEgZ3JhcGggQVBJIGZ1bmN0aW9uPwoKCiAgICB0aGlzLmdldEFsbEludGVyc2VjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIG5vZGVzKSB7CiAgICAgIC8vRW5zdXJlIHRoZXNlIGFyZSBhbGwgdG9wLWxldmVsIG5vZGVzIG9ubHkKICAgICAgbm9kZXMgPSBub2Rlcy5maWx0ZXIoZnVuY3Rpb24gKG4pIHsKICAgICAgICByZXR1cm4gbi5wYXJlbnQgPT0gdW5kZWZpbmVkOwogICAgICB9KTsKICAgICAgdmFyIGFsbFF1ZXJpZXMgPSBub2Rlcy5tYXAoZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICByZXR1cm4gc2VsZi5idWlsZE5vZGVRdWVyeShub2RlKTsKICAgICAgfSk7CiAgICAgIHZhciBhbGxRdWVyeSA9IHsKICAgICAgICBib29sOiB7CiAgICAgICAgICBzaG91bGQ6IGFsbFF1ZXJpZXMKICAgICAgICB9CiAgICAgIH07IC8vPT09PT09PT09PT09PT09PT09PT0KCiAgICAgIHZhciByZXF1ZXN0ID0gewogICAgICAgIHF1ZXJ5OiBhbGxRdWVyeSwKICAgICAgICBzaXplOiAwLAogICAgICAgIGFnZ3M6IHsKICAgICAgICAgIGFsbDogewogICAgICAgICAgICBnbG9iYWw6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgc291cmNlczogewogICAgICAgICAgICAvLyBDb3VsZCB1c2Ugc2lnbmlmaWNhbnRfdGVybXMgbm90IGZpbHRlcnMgdG8gZ2V0IHN0YXRzIGJ1dAogICAgICAgICAgICAvLyBmb3IgdGhlIGZhY3Qgc29tZSBvZiB0aGUgbm9kZXMgYXJlIGdyb3VwcyBvZiB0ZXJtcy4KICAgICAgICAgICAgZmlsdGVyczogewogICAgICAgICAgICAgIGZpbHRlcnM6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFnZ3M6IHsKICAgICAgICAgICAgICB0YXJnZXRzOiB7CiAgICAgICAgICAgICAgICBmaWx0ZXJzOiB7CiAgICAgICAgICAgICAgICAgIGZpbHRlcnM6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZm9yICh2YXIgbiBpbiBhbGxRdWVyaWVzKSB7CiAgICAgICAgLy8gQWRkIGFnZ3MgdG8gZ2V0IGludGVyc2VjdGlvbiBzdGF0cyB3aXRoIHJvb3Qgbm9kZS4KICAgICAgICByZXF1ZXN0LmFnZ3Muc291cmNlcy5maWx0ZXJzLmZpbHRlcnNbJ2JnJyArIG5dID0gYWxsUXVlcmllc1tuXTsKICAgICAgICByZXF1ZXN0LmFnZ3Muc291cmNlcy5hZ2dzLnRhcmdldHMuZmlsdGVycy5maWx0ZXJzWydmZycgKyBuXSA9IGFsbFF1ZXJpZXNbbl07CiAgICAgIH0KCiAgICAgIHZhciBkYXRhRm9yU2VydmVyID0gSlNPTi5zdHJpbmdpZnkocmVxdWVzdCk7CiAgICAgIHNlYXJjaGVyKHNlbGYub3B0aW9ucy5pbmRleE5hbWUsIHJlcXVlc3QsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHRlcm1JbnRlcnNlY3RzID0gW107CiAgICAgICAgdmFyIGZ1bGxEb2NDb3VudHMgPSBbXTsKICAgICAgICB2YXIgYWxsRG9jQ291bnQgPSBkYXRhLmFnZ3JlZ2F0aW9ucy5hbGwuZG9jX2NvdW50OyAvLyBHYXRoZXIgdGhlIGJhY2tncm91bmQgc3RhdHMgZm9yIGFsbCBub2Rlcy4KCiAgICAgICAgZm9yICh2YXIgX243IGluIG5vZGVzKSB7CiAgICAgICAgICBmdWxsRG9jQ291bnRzLnB1c2goZGF0YS5hZ2dyZWdhdGlvbnMuc291cmNlcy5idWNrZXRzWydiZycgKyBfbjddLmRvY19jb3VudCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBfbjggaW4gbm9kZXMpIHsKICAgICAgICAgIHZhciByb290Tm9kZSA9IG5vZGVzW19uOF07CiAgICAgICAgICB2YXIgdDEgPSBmdWxsRG9jQ291bnRzW19uOF07CiAgICAgICAgICB2YXIgYmFzZUFnZyA9IGRhdGEuYWdncmVnYXRpb25zLnNvdXJjZXMuYnVja2V0c1snYmcnICsgX244XS50YXJnZXRzLmJ1Y2tldHM7CgogICAgICAgICAgZm9yICh2YXIgbCBpbiBub2RlcykgewogICAgICAgICAgICB2YXIgdDIgPSBmdWxsRG9jQ291bnRzW2xdOwogICAgICAgICAgICB2YXIgbGVhZk5vZGUgPSBub2Rlc1tsXTsKCiAgICAgICAgICAgIGlmIChsID09IF9uOCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodDEgPiB0MikgewogICAgICAgICAgICAgIC8vIFdlIHNob3VsZCBnZXQgdGhlIHNhbWUgc3RhdHMgZm9yIHQyLT50MSBmcm9tIHRoZSB0MS0+dDIgYnVja2V0IHBhdGgKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3ROb2RlLmlkID4gbGVhZk5vZGUuaWQpIHsKICAgICAgICAgICAgICAgIC8vIFdlIHNob3VsZCBnZXQgdGhlIHNhbWUgc3RhdHMgZm9yIHQyLT50MSBmcm9tIHRoZSB0MS0+dDIgYnVja2V0IHBhdGgKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHQxQW5kVDIgPSBiYXNlQWdnWydmZycgKyBsXS5kb2NfY291bnQ7CgogICAgICAgICAgICBpZiAodDFBbmRUMiA9PSAwKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBuZWlnaGJvdXJOb2RlID0gbm9kZXNbbF07CiAgICAgICAgICAgIHZhciB0MUxhYmVsID0gcm9vdE5vZGUuZGF0YS5sYWJlbDsKCiAgICAgICAgICAgIGlmIChyb290Tm9kZS5udW1DaGlsZHJlbiA+IDApIHsKICAgICAgICAgICAgICB0MUxhYmVsICs9ICcoKycgKyByb290Tm9kZS5udW1DaGlsZHJlbiArICcpJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHQyTGFiZWwgPSBuZWlnaGJvdXJOb2RlLmRhdGEubGFiZWw7CgogICAgICAgICAgICBpZiAobmVpZ2hib3VyTm9kZS5udW1DaGlsZHJlbiA+IDApIHsKICAgICAgICAgICAgICB0MkxhYmVsICs9ICcoKycgKyBuZWlnaGJvdXJOb2RlLm51bUNoaWxkcmVuICsgJyknOwogICAgICAgICAgICB9IC8vIEEgc3RyYWlnaHQgcGVyY2VudGFnZSBjYW4gYmUgcG9vciBpZiB0MT09MSAoMTAwJSkgLSBub3QgdG9vIG11Y2ggc3RyZW5ndGggb2YgZXZpZGVuY2UKICAgICAgICAgICAgLy8gIHZhciBtZXJnZUNvbmZpZGVuY2U9dDFBbmRUMi90MTsKICAgICAgICAgICAgLy8gU28gdXNpbmcgU2lnbmlmaWNhbmNlIGhldXJpc3RpYyBpbnN0ZWFkCgoKICAgICAgICAgICAgdmFyIG1lcmdlQ29uZmlkZW5jZSA9IHNlbGYuSkxIU2NvcmUodDFBbmRUMiwgdDIsIHQxLCBhbGxEb2NDb3VudCk7CiAgICAgICAgICAgIHZhciB0ZXJtSW50ZXJzZWN0ID0gewogICAgICAgICAgICAgIGlkMTogcm9vdE5vZGUuaWQsCiAgICAgICAgICAgICAgaWQyOiBuZWlnaGJvdXJOb2RlLmlkLAogICAgICAgICAgICAgIHRlcm0xOiB0MUxhYmVsLAogICAgICAgICAgICAgIHRlcm0yOiB0MkxhYmVsLAogICAgICAgICAgICAgIHYxOiB0MSwKICAgICAgICAgICAgICB2MjogdDIsCiAgICAgICAgICAgICAgbWVyZ2VMZWZ0Q29uZmlkZW5jZTogdDFBbmRUMiAvIHQxLAogICAgICAgICAgICAgIG1lcmdlUmlnaHRDb25maWRlbmNlOiB0MUFuZFQyIC8gdDIsCiAgICAgICAgICAgICAgbWVyZ2VDb25maWRlbmNlOiBtZXJnZUNvbmZpZGVuY2UsCiAgICAgICAgICAgICAgb3ZlcmxhcDogdDFBbmRUMgogICAgICAgICAgICB9OwogICAgICAgICAgICB0ZXJtSW50ZXJzZWN0cy5wdXNoKHRlcm1JbnRlcnNlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGVybUludGVyc2VjdHMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgaWYgKGIubWVyZ2VDb25maWRlbmNlICE9IGEubWVyZ2VDb25maWRlbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBiLm1lcmdlQ29uZmlkZW5jZSAtIGEubWVyZ2VDb25maWRlbmNlOwogICAgICAgICAgfSAvLyBJZiBvZiBlcXVhbCBzaW1pbGFyaXR5IHVzZSB0aGUgc2l6ZSBvZiB0aGUgb3ZlcmxhcCBhcwogICAgICAgICAgLy8gYSBtZWFzdXJlIG9mIG1hZ25pdHVkZS9zaWduaWZpY2FuY2UgZm9yIHRpZS1icmVha2VyLgoKCiAgICAgICAgICBpZiAoYi5vdmVybGFwICE9IGEub3ZlcmxhcCkgewogICAgICAgICAgICByZXR1cm4gYi5vdmVybGFwIC0gYS5vdmVybGFwOwogICAgICAgICAgfSAvL0FsbCBvdGhlciB0aGluZ3MgYmVpbmcgZXF1YWwgd2Ugbm93IGZhdm91ciB3aGVyZSB0MiBOT1QgdDEgaXMgc21hbGwuCgoKICAgICAgICAgIHJldHVybiBhLnYyIC0gYi52MjsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICBjYWxsYmFjayh0ZXJtSW50ZXJzZWN0cyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07IC8vIEludGVybmFsIHV0aWxpdHkgZnVuY3Rpb24gZm9yIGNhbGxpbmcgdGhlIEdyYXBoIEFQSSBhbmQgaGFuZGxpbmcgdGhlIHJlc3BvbnNlCiAgICAvLyBieSBtZXJnaW5nIHJlc3VsdHMgaW50byBleGlzdGluZyBub2RlcyBpbiB0aGlzIHdvcmtzcGFjZS4KCgogICAgdGhpcy5jYWxsRWxhc3RpY3NlYXJjaCA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICAgIHNlbGYubGFzdFJlcXVlc3QgPSBKU09OLnN0cmluZ2lmeShyZXF1ZXN0LCBudWxsLCAnXHQnKTsKICAgICAgZ3JhcGhFeHBsb3JlcihzZWxmLm9wdGlvbnMuaW5kZXhOYW1lLCByZXF1ZXN0LCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHNlbGYubGFzdFJlc3BvbnNlID0gSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgJ1x0Jyk7CiAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgdmFyIGVkZ2VzID0gW107IC8vTGFiZWwgdGhlIG5vZGVzIHdpdGggZmllbGQgbnVtYmVyIGZvciBDU1Mgc3R5bGluZwoKICAgICAgICBmb3IgKHZhciBuIGluIGRhdGEudmVydGljZXMpIHsKICAgICAgICAgIHZhciBub2RlID0gZGF0YS52ZXJ0aWNlc1tuXTsKCiAgICAgICAgICBmb3IgKHZhciBmIGluIHNlbGYub3B0aW9ucy52ZXJ0ZXhfZmllbGRzKSB7CiAgICAgICAgICAgIHZhciBmaWVsZERlZiA9IHNlbGYub3B0aW9ucy52ZXJ0ZXhfZmllbGRzW2ZdOwoKICAgICAgICAgICAgaWYgKG5vZGUuZmllbGQgPT0gZmllbGREZWYubmFtZSkgewogICAgICAgICAgICAgIG5vZGUuY29sb3IgPSBmaWVsZERlZi5jb2xvcjsKICAgICAgICAgICAgICBub2RlLmljb24gPSBmaWVsZERlZi5pY29uOwogICAgICAgICAgICAgIG5vZGUuZmllbGREZWYgPSBmaWVsZERlZjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gLy9TaXplIHRoZSBlZGdlcyBkZXBlbmRpbmcgb24gd2VpZ2h0CgoKICAgICAgICB2YXIgbWluTGluZVNpemUgPSAyOwogICAgICAgIHZhciBtYXhMaW5lU2l6ZSA9IDEwOwogICAgICAgIHZhciBtYXhFZGdlV2VpZ2h0ID0gMC4wMDAwMDAwMTsKCiAgICAgICAgZm9yICh2YXIgZSBpbiBkYXRhLmNvbm5lY3Rpb25zKSB7CiAgICAgICAgICB2YXIgZWRnZSA9IGRhdGEuY29ubmVjdGlvbnNbZV07CiAgICAgICAgICBtYXhFZGdlV2VpZ2h0ID0gTWF0aC5tYXgobWF4RWRnZVdlaWdodCwgZWRnZS53ZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgX2UyIGluIGRhdGEuY29ubmVjdGlvbnMpIHsKICAgICAgICAgIHZhciBfZWRnZTIgPSBkYXRhLmNvbm5lY3Rpb25zW19lMl07CiAgICAgICAgICBlZGdlcy5wdXNoKHsKICAgICAgICAgICAgc291cmNlOiBfZWRnZTIuc291cmNlLAogICAgICAgICAgICB0YXJnZXQ6IF9lZGdlMi50YXJnZXQsCiAgICAgICAgICAgIGRvY19jb3VudDogX2VkZ2UyLmRvY19jb3VudCwKICAgICAgICAgICAgd2VpZ2h0OiBfZWRnZTIud2VpZ2h0LAogICAgICAgICAgICB3aWR0aDogTWF0aC5tYXgobWluTGluZVNpemUsIF9lZGdlMi53ZWlnaHQgLyBtYXhFZGdlV2VpZ2h0ICogbWF4TGluZVNpemUpCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHNlbGYubWVyZ2VHcmFwaCh7CiAgICAgICAgICBub2RlczogZGF0YS52ZXJ0aWNlcywKICAgICAgICAgIGVkZ2VzOiBlZGdlcwogICAgICAgIH0sIHsKICAgICAgICAgIGxhYmVsbGVyOiBzZWxmLm9wdGlvbnMubGFiZWxsZXIKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9OwogIH0gLy89PT09PT09PT09PT09PT09PT09PT0KICAvLyBCZWdpbiBLaWJhbmEgd3JhcHBlcgoKCiAgcmV0dXJuIHsKICAgIGNyZWF0ZVdvcmtzcGFjZTogY3JlYXRlV29ya3NwYWNlCiAgfTsKfSgpOw=="},null]}