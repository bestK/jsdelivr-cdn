{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/ml/public/application/explorer/explorer_utils.js","dependencies":[{"path":"x-pack/legacy/plugins/ml/public/application/explorer/explorer_utils.js","mtime":1585205045704},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmNyZWF0ZUpvYnMgPSBjcmVhdGVKb2JzOwpleHBvcnRzLmdldENsZWFyZWRTZWxlY3RlZEFub21hbGllc1N0YXRlID0gZ2V0Q2xlYXJlZFNlbGVjdGVkQW5vbWFsaWVzU3RhdGU7CmV4cG9ydHMuZ2V0RGVmYXVsdFN3aW1sYW5lRGF0YSA9IGdldERlZmF1bHRTd2ltbGFuZURhdGE7CmV4cG9ydHMubG9hZEZpbHRlcmVkVG9wSW5mbHVlbmNlcnMgPSBsb2FkRmlsdGVyZWRUb3BJbmZsdWVuY2VyczsKZXhwb3J0cy5nZXRJbmZsdWVuY2VycyA9IGdldEluZmx1ZW5jZXJzOwpleHBvcnRzLmdldERhdGVGb3JtYXRUeiA9IGdldERhdGVGb3JtYXRUejsKZXhwb3J0cy5nZXRGaWVsZHNCeUpvYiA9IGdldEZpZWxkc0J5Sm9iOwpleHBvcnRzLmdldFNlbGVjdGlvblRpbWVSYW5nZSA9IGdldFNlbGVjdGlvblRpbWVSYW5nZTsKZXhwb3J0cy5nZXRTZWxlY3Rpb25JbmZsdWVuY2VycyA9IGdldFNlbGVjdGlvbkluZmx1ZW5jZXJzOwpleHBvcnRzLmdldFNlbGVjdGlvbkpvYklkcyA9IGdldFNlbGVjdGlvbkpvYklkczsKZXhwb3J0cy5nZXRTd2ltbGFuZUJ1Y2tldEludGVydmFsID0gZ2V0U3dpbWxhbmVCdWNrZXRJbnRlcnZhbDsKZXhwb3J0cy5sb2FkVmlld0J5VG9wRmllbGRWYWx1ZXNGb3JTZWxlY3RlZFRpbWUgPSBsb2FkVmlld0J5VG9wRmllbGRWYWx1ZXNGb3JTZWxlY3RlZFRpbWU7CmV4cG9ydHMuZ2V0Vmlld0J5U3dpbWxhbmVPcHRpb25zID0gZ2V0Vmlld0J5U3dpbWxhbmVPcHRpb25zOwpleHBvcnRzLnByb2Nlc3NPdmVyYWxsUmVzdWx0cyA9IHByb2Nlc3NPdmVyYWxsUmVzdWx0czsKZXhwb3J0cy5wcm9jZXNzVmlld0J5UmVzdWx0cyA9IHByb2Nlc3NWaWV3QnlSZXN1bHRzOwpleHBvcnRzLmxvYWRBbm5vdGF0aW9uc1RhYmxlRGF0YSA9IGxvYWRBbm5vdGF0aW9uc1RhYmxlRGF0YTsKZXhwb3J0cy5sb2FkQW5vbWFsaWVzVGFibGVEYXRhID0gbG9hZEFub21hbGllc1RhYmxlRGF0YTsKZXhwb3J0cy5sb2FkRGF0YUZvckNoYXJ0cyA9IGxvYWREYXRhRm9yQ2hhcnRzOwpleHBvcnRzLmxvYWRPdmVyYWxsRGF0YSA9IGxvYWRPdmVyYWxsRGF0YTsKZXhwb3J0cy5sb2FkVmlld0J5U3dpbWxhbmUgPSBsb2FkVmlld0J5U3dpbWxhbmU7CmV4cG9ydHMubG9hZFRvcEluZmx1ZW5jZXJzID0gbG9hZFRvcEluZmx1ZW5jZXJzOwoKdmFyIF9sb2Rhc2ggPSByZXF1aXJlKCJsb2Rhc2giKTsKCnZhciBfbW9tZW50VGltZXpvbmUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIm1vbWVudC10aW1lem9uZSIpKTsKCnZhciBfaTE4biA9IHJlcXVpcmUoIkBrYm4vaTE4biIpOwoKdmFyIF9jaHJvbWUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoInVpL2Nocm9tZSIpKTsKCnZhciBfbmV3X3BsYXRmb3JtID0gcmVxdWlyZSgidWkvbmV3X3BsYXRmb3JtIik7Cgp2YXIgX3RpbWVmaWx0ZXIgPSByZXF1aXJlKCJ1aS90aW1lZmlsdGVyIik7Cgp2YXIgX3NlYXJjaCA9IHJlcXVpcmUoIi4uLy4uLy4uL2NvbW1vbi9jb25zdGFudHMvc2VhcmNoIik7Cgp2YXIgX2Fub21hbHlfdXRpbHMgPSByZXF1aXJlKCIuLi8uLi8uLi9jb21tb24vdXRpbC9hbm9tYWx5X3V0aWxzIik7Cgp2YXIgX2pvYl91dGlscyA9IHJlcXVpcmUoIi4uLy4uLy4uL2NvbW1vbi91dGlsL2pvYl91dGlscyIpOwoKdmFyIF9wYXJzZV9pbnRlcnZhbCA9IHJlcXVpcmUoIi4uLy4uLy4uL2NvbW1vbi91dGlsL3BhcnNlX2ludGVydmFsIik7Cgp2YXIgX21sX2FwaV9zZXJ2aWNlID0gcmVxdWlyZSgiLi4vc2VydmljZXMvbWxfYXBpX3NlcnZpY2UiKTsKCnZhciBfam9iX3NlcnZpY2UgPSByZXF1aXJlKCIuLi9zZXJ2aWNlcy9qb2Jfc2VydmljZSIpOwoKdmFyIF9yZXN1bHRzX3NlcnZpY2UgPSByZXF1aXJlKCIuLi9zZXJ2aWNlcy9yZXN1bHRzX3NlcnZpY2UiKTsKCnZhciBfdGltZV9idWNrZXRzID0gcmVxdWlyZSgiLi4vdXRpbC90aW1lX2J1Y2tldHMiKTsKCnZhciBfZXhwbG9yZXJfY29uc3RhbnRzID0gcmVxdWlyZSgiLi9leHBsb3Jlcl9jb25zdGFudHMiKTsKCnZhciBfbGVnYWN5X3V0aWxzID0gcmVxdWlyZSgiLi9sZWdhY3lfdXRpbHMiKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9CgpmdW5jdGlvbiBfdG9Db25zdW1hYmxlQXJyYXkoYXJyKSB7IHJldHVybiBfYXJyYXlXaXRob3V0SG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5KGFycikgfHwgX25vbkl0ZXJhYmxlU3ByZWFkKCk7IH0KCmZ1bmN0aW9uIF9ub25JdGVyYWJsZVNwcmVhZCgpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIHNwcmVhZCBub24taXRlcmFibGUgaW5zdGFuY2UiKTsgfQoKZnVuY3Rpb24gX2l0ZXJhYmxlVG9BcnJheShpdGVyKSB7IGlmIChTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGl0ZXIpIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpdGVyKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSIpIHJldHVybiBBcnJheS5mcm9tKGl0ZXIpOyB9CgpmdW5jdGlvbiBfYXJyYXlXaXRob3V0SG9sZXMoYXJyKSB7IGlmIChBcnJheS5pc0FycmF5KGFycikpIHsgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsgYXJyMltpXSA9IGFycltpXTsgfSByZXR1cm4gYXJyMjsgfSB9Cgp2YXIgbWxBbm5vdGF0aW9uc0VuYWJsZWQgPSBfY2hyb21lLmRlZmF1bHQuZ2V0SW5qZWN0ZWQoJ21sQW5ub3RhdGlvbnNFbmFibGVkJywgZmFsc2UpOyAvLyBjcmVhdGUgbmV3IGpvYiBvYmplY3RzIGJhc2VkIG9uIHN0YW5kYXJkIGpvYiBjb25maWcgb2JqZWN0cwovLyBuZXcgam9iIG9iamVjdHMganVzdCBjb250YWluIGpvYiBpZCwgYnVja2V0IHNwYW4gaW4gc2Vjb25kcyBhbmQgYSBzZWxlY3RlZCBmbGFnLgoKCmZ1bmN0aW9uIGNyZWF0ZUpvYnMoam9icykgewogIHJldHVybiBqb2JzLm1hcChmdW5jdGlvbiAoam9iKSB7CiAgICB2YXIgYnVja2V0U3BhbiA9ICgwLCBfcGFyc2VfaW50ZXJ2YWwucGFyc2VJbnRlcnZhbCkoam9iLmFuYWx5c2lzX2NvbmZpZy5idWNrZXRfc3Bhbik7CiAgICByZXR1cm4gewogICAgICBpZDogam9iLmpvYl9pZCwKICAgICAgc2VsZWN0ZWQ6IGZhbHNlLAogICAgICBidWNrZXRTcGFuU2Vjb25kczogYnVja2V0U3Bhbi5hc1NlY29uZHMoKQogICAgfTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0Q2xlYXJlZFNlbGVjdGVkQW5vbWFsaWVzU3RhdGUoKSB7CiAgcmV0dXJuIHsKICAgIHNlbGVjdGVkQ2VsbHM6IHVuZGVmaW5lZCwKICAgIHZpZXdCeUxvYWRlZEZvclRpbWVGb3JtYXR0ZWQ6IG51bGwKICB9Owp9CgpmdW5jdGlvbiBnZXREZWZhdWx0U3dpbWxhbmVEYXRhKCkgewogIHJldHVybiB7CiAgICBmaWVsZE5hbWU6ICcnLAogICAgbGFuZUxhYmVsczogW10sCiAgICBwb2ludHM6IFtdLAogICAgaW50ZXJ2YWw6IDM2MDAKICB9Owp9CgpmdW5jdGlvbiBsb2FkRmlsdGVyZWRUb3BJbmZsdWVuY2Vycyhqb2JJZHMsIGVhcmxpZXN0TXMsIGxhdGVzdE1zLCByZWNvcmRzLCBpbmZsdWVuY2Vycywgbm9JbmZsdWVuY2Vyc0NvbmZpZ3VyZWQsIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnkpIHsKICB2YXIgcmVjb3JkSW5mbHVlbmNlcnNCeU5hbWUsIHVuaXFWYWx1ZXNCeU5hbWUsIGZpbHRlckluZmx1ZW5jZXJzOwogIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gbG9hZEZpbHRlcmVkVG9wSW5mbHVlbmNlcnMkKF9jb250ZXh0KSB7CiAgICB3aGlsZSAoMSkgewogICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgY2FzZSAwOgogICAgICAgICAgLy8gRmlsdGVyIHRoZSBUb3AgSW5mbHVlbmNlcnMgbGlzdCB0byBzaG93IGp1c3QgdGhlIGluZmx1ZW5jZXJzIGZyb20KICAgICAgICAgIC8vIHRoZSByZWNvcmRzIGluIHRoZSBzZWxlY3RlZCB0aW1lIHJhbmdlLgogICAgICAgICAgcmVjb3JkSW5mbHVlbmNlcnNCeU5hbWUgPSB7fTsgLy8gQWRkIHRoZSBzcGVjaWZpZWQgaW5mbHVlbmNlcihzKSB0byBlbnN1cmUgdGhleSBhcmUgdXNlZCBpbiB0aGUgZmlsdGVyCiAgICAgICAgICAvLyBldmVuIGlmIHRoZWlyIGluZmx1ZW5jZXIgc2NvcmUgZm9yIHRoZSBzZWxlY3RlZCB0aW1lIHJhbmdlIGlzIHplcm8uCgogICAgICAgICAgaW5mbHVlbmNlcnMuZm9yRWFjaChmdW5jdGlvbiAoaW5mbHVlbmNlcikgewogICAgICAgICAgICB2YXIgZmllbGROYW1lID0gaW5mbHVlbmNlci5maWVsZE5hbWU7CgogICAgICAgICAgICBpZiAocmVjb3JkSW5mbHVlbmNlcnNCeU5hbWVbaW5mbHVlbmNlci5maWVsZE5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICByZWNvcmRJbmZsdWVuY2Vyc0J5TmFtZVtpbmZsdWVuY2VyLmZpZWxkTmFtZV0gPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmVjb3JkSW5mbHVlbmNlcnNCeU5hbWVbZmllbGROYW1lXS5wdXNoKGluZmx1ZW5jZXIuZmllbGRWYWx1ZSk7CiAgICAgICAgICB9KTsgLy8gQWRkIHRoZSBpbmZsdWVuY2VycyBmcm9tIHRoZSB0b3Agc2NvcmluZyBhbm9tYWxpZXMuCgogICAgICAgICAgcmVjb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uIChyZWNvcmQpIHsKICAgICAgICAgICAgdmFyIGluZmx1ZW5jZXJzQnlOYW1lID0gcmVjb3JkLmluZmx1ZW5jZXJzIHx8IFtdOwogICAgICAgICAgICBpbmZsdWVuY2Vyc0J5TmFtZS5mb3JFYWNoKGZ1bmN0aW9uIChpbmZsdWVuY2VyKSB7CiAgICAgICAgICAgICAgdmFyIF9yZWNvcmRJbmZsdWVuY2Vyc0J5TjsKCiAgICAgICAgICAgICAgdmFyIGZpZWxkTmFtZSA9IGluZmx1ZW5jZXIuaW5mbHVlbmNlcl9maWVsZF9uYW1lOwogICAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlcyA9IGluZmx1ZW5jZXIuaW5mbHVlbmNlcl9maWVsZF92YWx1ZXM7CgogICAgICAgICAgICAgIGlmIChyZWNvcmRJbmZsdWVuY2Vyc0J5TmFtZVtmaWVsZE5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJlY29yZEluZmx1ZW5jZXJzQnlOYW1lW2ZpZWxkTmFtZV0gPSBbXTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIChfcmVjb3JkSW5mbHVlbmNlcnNCeU4gPSByZWNvcmRJbmZsdWVuY2Vyc0J5TmFtZVtmaWVsZE5hbWVdKS5wdXNoLmFwcGx5KF9yZWNvcmRJbmZsdWVuY2Vyc0J5TiwgX3RvQ29uc3VtYWJsZUFycmF5KGZpZWxkVmFsdWVzKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICB1bmlxVmFsdWVzQnlOYW1lID0ge307CiAgICAgICAgICBPYmplY3Qua2V5cyhyZWNvcmRJbmZsdWVuY2Vyc0J5TmFtZSkuZm9yRWFjaChmdW5jdGlvbiAoZmllbGROYW1lKSB7CiAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlcyA9IHJlY29yZEluZmx1ZW5jZXJzQnlOYW1lW2ZpZWxkTmFtZV07CiAgICAgICAgICAgIHVuaXFWYWx1ZXNCeU5hbWVbZmllbGROYW1lXSA9ICgwLCBfbG9kYXNoLnVuaXEpKGZpZWxkVmFsdWVzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZmlsdGVySW5mbHVlbmNlcnMgPSBbXTsKICAgICAgICAgIE9iamVjdC5rZXlzKHVuaXFWYWx1ZXNCeU5hbWUpLmZvckVhY2goZnVuY3Rpb24gKGZpZWxkTmFtZSkgewogICAgICAgICAgICAvLyBGaW5kIHJlY29yZCBpbmZsdWVuY2VycyB3aXRoIHRoZSBzYW1lIGZpZWxkIG5hbWUgYXMgdGhlIGNsaWNrZWQgb24gY2VsbChzKS4KICAgICAgICAgICAgdmFyIG1hdGNoaW5nRmllbGROYW1lID0gaW5mbHVlbmNlcnMuZmluZChmdW5jdGlvbiAoaW5mbHVlbmNlcikgewogICAgICAgICAgICAgIHJldHVybiBpbmZsdWVuY2VyLmZpZWxkTmFtZSA9PT0gZmllbGROYW1lOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChtYXRjaGluZ0ZpZWxkTmFtZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgLy8gRmlsdGVyIGZvciB0aGUgdmFsdWUocykgb2YgdGhlIGNsaWNrZWQgb24gY2VsbChzKS4KICAgICAgICAgICAgICBmaWx0ZXJJbmZsdWVuY2Vycy5wdXNoLmFwcGx5KGZpbHRlckluZmx1ZW5jZXJzLCBfdG9Db25zdW1hYmxlQXJyYXkoaW5mbHVlbmNlcnMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBGb3Igb3RoZXIgZmllbGQgbmFtZXMsIGFkZCB2YWx1ZXMgZnJvbSBhbGwgcmVjb3Jkcy4KICAgICAgICAgICAgICB1bmlxVmFsdWVzQnlOYW1lW2ZpZWxkTmFtZV0uZm9yRWFjaChmdW5jdGlvbiAoZmllbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgZmlsdGVySW5mbHVlbmNlcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGZpZWxkTmFtZTogZmllbGROYW1lLAogICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlOiBmaWVsZFZhbHVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBfY29udGV4dC5uZXh0ID0gOTsKICAgICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXdyYXAobG9hZFRvcEluZmx1ZW5jZXJzKGpvYklkcywgZWFybGllc3RNcywgbGF0ZXN0TXMsIGZpbHRlckluZmx1ZW5jZXJzLCBub0luZmx1ZW5jZXJzQ29uZmlndXJlZCwgaW5mbHVlbmNlcnNGaWx0ZXJRdWVyeSkpOwoKICAgICAgICBjYXNlIDk6CiAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBfY29udGV4dC5zZW50KTsKCiAgICAgICAgY2FzZSAxMDoKICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgfQogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBnZXRJbmZsdWVuY2VycygpIHsKICB2YXIgc2VsZWN0ZWRKb2JzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBbXTsKICB2YXIgaW5mbHVlbmNlcnMgPSBbXTsKICBzZWxlY3RlZEpvYnMuZm9yRWFjaChmdW5jdGlvbiAoc2VsZWN0ZWRKb2IpIHsKICAgIHZhciBqb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmdldEpvYihzZWxlY3RlZEpvYi5pZCk7CgogICAgaWYgKGpvYiAhPT0gdW5kZWZpbmVkICYmIGpvYi5hbmFseXNpc19jb25maWcgJiYgam9iLmFuYWx5c2lzX2NvbmZpZy5pbmZsdWVuY2VycykgewogICAgICBpbmZsdWVuY2Vycy5wdXNoLmFwcGx5KGluZmx1ZW5jZXJzLCBfdG9Db25zdW1hYmxlQXJyYXkoam9iLmFuYWx5c2lzX2NvbmZpZy5pbmZsdWVuY2VycykpOwogICAgfQogIH0pOwogIHJldHVybiBpbmZsdWVuY2VyczsKfQoKZnVuY3Rpb24gZ2V0RGF0ZUZvcm1hdFR6KCkgewogIHZhciBjb25maWcgPSBfbmV3X3BsYXRmb3JtLm5wU3RhcnQuY29yZS51aVNldHRpbmdzOyAvLyBQYXNzIHRoZSB0aW1lem9uZSB0byB0aGUgc2VydmVyIGZvciB1c2Ugd2hlbiBhZ2dyZWdhdGluZyBhbm9tYWxpZXMgKGJ5IGRheSAvIGhvdXIpIGZvciB0aGUgdGFibGUuCgogIHZhciB0ekNvbmZpZyA9IGNvbmZpZy5nZXQoJ2RhdGVGb3JtYXQ6dHonKTsKICB2YXIgZGF0ZUZvcm1hdFR6ID0gdHpDb25maWcgIT09ICdCcm93c2VyJyA/IHR6Q29uZmlnIDogX21vbWVudFRpbWV6b25lLmRlZmF1bHQudHouZ3Vlc3MoKTsKICByZXR1cm4gZGF0ZUZvcm1hdFR6Owp9CgpmdW5jdGlvbiBnZXRGaWVsZHNCeUpvYigpIHsKICByZXR1cm4gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5qb2JzLnJlZHVjZShmdW5jdGlvbiAocmVkdWNlZEZpZWxkc0J5Sm9iLCBqb2IpIHsKICAgIC8vIEFkZCB0aGUgbGlzdCBvZiBkaXN0aW5jdCBieSwgb3ZlciwgcGFydGl0aW9uIGFuZCBpbmZsdWVuY2VyIGZpZWxkcyBmb3IgZWFjaCBqb2IuCiAgICB2YXIgYW5hbHlzaXNDb25maWcgPSBqb2IuYW5hbHlzaXNfY29uZmlnOwogICAgdmFyIGluZmx1ZW5jZXJzID0gYW5hbHlzaXNDb25maWcuaW5mbHVlbmNlcnMgfHwgW107CiAgICB2YXIgZmllbGRzRm9ySm9iID0gKGFuYWx5c2lzQ29uZmlnLmRldGVjdG9ycyB8fCBbXSkucmVkdWNlKGZ1bmN0aW9uIChyZWR1Y2VkZmllbGRzRm9ySm9iLCBkZXRlY3RvcikgewogICAgICBpZiAoZGV0ZWN0b3IucGFydGl0aW9uX2ZpZWxkX25hbWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJlZHVjZWRmaWVsZHNGb3JKb2IucHVzaChkZXRlY3Rvci5wYXJ0aXRpb25fZmllbGRfbmFtZSk7CiAgICAgIH0KCiAgICAgIGlmIChkZXRlY3Rvci5vdmVyX2ZpZWxkX25hbWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJlZHVjZWRmaWVsZHNGb3JKb2IucHVzaChkZXRlY3Rvci5vdmVyX2ZpZWxkX25hbWUpOwogICAgICB9IC8vIEZvciBqb2JzIHdpdGggYnkgYW5kIG92ZXIgZmllbGRzLCBkb24ndCBhZGQgdGhlICdieScgZmllbGQgYXMgdGhpcwogICAgICAvLyBmaWVsZCB3aWxsIG9ubHkgYmUgYWRkZWQgdG8gdGhlIHRvcC1sZXZlbCBmaWVsZHMgZm9yIHJlY29yZCB0eXBlIHJlc3VsdHMKICAgICAgLy8gaWYgaXQgYWxzbyBhbiBpbmZsdWVuY2VyIG92ZXIgdGhlIGJ1Y2tldC4KCgogICAgICBpZiAoZGV0ZWN0b3IuYnlfZmllbGRfbmFtZSAhPT0gdW5kZWZpbmVkICYmIGRldGVjdG9yLm92ZXJfZmllbGRfbmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmVkdWNlZGZpZWxkc0ZvckpvYi5wdXNoKGRldGVjdG9yLmJ5X2ZpZWxkX25hbWUpOwogICAgICB9CgogICAgICByZXR1cm4gcmVkdWNlZGZpZWxkc0ZvckpvYjsKICAgIH0sIFtdKS5jb25jYXQoaW5mbHVlbmNlcnMpOwogICAgcmVkdWNlZEZpZWxkc0J5Sm9iW2pvYi5qb2JfaWRdID0gKDAsIF9sb2Rhc2gudW5pcSkoZmllbGRzRm9ySm9iKTsKICAgIHJlZHVjZWRGaWVsZHNCeUpvYlsnKiddID0gKDAsIF9sb2Rhc2gudW5pb24pKHJlZHVjZWRGaWVsZHNCeUpvYlsnKiddLCByZWR1Y2VkRmllbGRzQnlKb2Jbam9iLmpvYl9pZF0pOwogICAgcmV0dXJuIHJlZHVjZWRGaWVsZHNCeUpvYjsKICB9LCB7CiAgICAnKic6IFtdCiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFNlbGVjdGlvblRpbWVSYW5nZShzZWxlY3RlZENlbGxzLCBpbnRlcnZhbCwgYm91bmRzKSB7CiAgLy8gUmV0dXJucyB0aGUgdGltZSByYW5nZSBvZiB0aGUgY2VsbChzKSBjdXJyZW50bHkgc2VsZWN0ZWQgaW4gdGhlIHN3aW1sYW5lLgogIC8vIElmIG5vIGNlbGwocykgYXJlIGN1cnJlbnRseSBzZWxlY3RlZCwgcmV0dXJucyB0aGUgZGFzaGJvYXJkIHRpbWUgcmFuZ2UuCiAgdmFyIGVhcmxpZXN0TXMgPSBib3VuZHMubWluLnZhbHVlT2YoKTsKICB2YXIgbGF0ZXN0TXMgPSBib3VuZHMubWF4LnZhbHVlT2YoKTsKCiAgaWYgKHNlbGVjdGVkQ2VsbHMgIT09IHVuZGVmaW5lZCAmJiBzZWxlY3RlZENlbGxzLnRpbWVzICE9PSB1bmRlZmluZWQpIHsKICAgIC8vIHRpbWUgcHJvcGVydHkgb2YgdGhlIGNlbGwgZGF0YSBpcyBhbiBhcnJheSwgd2l0aCB0aGUgZWxlbWVudHMgYmVpbmcKICAgIC8vIHRoZSBzdGFydCB0aW1lcyBvZiB0aGUgZmlyc3QgYW5kIGxhc3QgY2VsbCBzZWxlY3RlZC4KICAgIGVhcmxpZXN0TXMgPSBzZWxlY3RlZENlbGxzLnRpbWVzWzBdICE9PSB1bmRlZmluZWQgPyBzZWxlY3RlZENlbGxzLnRpbWVzWzBdICogMTAwMCA6IGJvdW5kcy5taW4udmFsdWVPZigpOwogICAgbGF0ZXN0TXMgPSBib3VuZHMubWF4LnZhbHVlT2YoKTsKCiAgICBpZiAoc2VsZWN0ZWRDZWxscy50aW1lc1sxXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIFN1YnRyYWN0IDEgbXMgc28gc2VhcmNoIGRvZXMgbm90IGluY2x1ZGUgc3RhcnQgb2YgbmV4dCBidWNrZXQuCiAgICAgIGxhdGVzdE1zID0gKHNlbGVjdGVkQ2VsbHMudGltZXNbMV0gKyBpbnRlcnZhbCkgKiAxMDAwIC0gMTsKICAgIH0KICB9CgogIHJldHVybiB7CiAgICBlYXJsaWVzdE1zOiBlYXJsaWVzdE1zLAogICAgbGF0ZXN0TXM6IGxhdGVzdE1zCiAgfTsKfQoKZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSW5mbHVlbmNlcnMoc2VsZWN0ZWRDZWxscywgZmllbGROYW1lKSB7CiAgaWYgKHNlbGVjdGVkQ2VsbHMgIT09IHVuZGVmaW5lZCAmJiBzZWxlY3RlZENlbGxzLnR5cGUgIT09IF9leHBsb3Jlcl9jb25zdGFudHMuU1dJTUxBTkVfVFlQRS5PVkVSQUxMICYmIHNlbGVjdGVkQ2VsbHMudmlld0J5RmllbGROYW1lICE9PSB1bmRlZmluZWQgJiYgc2VsZWN0ZWRDZWxscy52aWV3QnlGaWVsZE5hbWUgIT09IF9leHBsb3Jlcl9jb25zdGFudHMuVklFV19CWV9KT0JfTEFCRUwpIHsKICAgIHJldHVybiBzZWxlY3RlZENlbGxzLmxhbmVzLm1hcChmdW5jdGlvbiAobGFuZUxhYmVsKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZmllbGROYW1lOiBmaWVsZE5hbWUsCiAgICAgICAgZmllbGRWYWx1ZTogbGFuZUxhYmVsCiAgICAgIH07CiAgICB9KTsKICB9CgogIHJldHVybiBbXTsKfQoKZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSm9iSWRzKHNlbGVjdGVkQ2VsbHMsIHNlbGVjdGVkSm9icykgewogIGlmIChzZWxlY3RlZENlbGxzICE9PSB1bmRlZmluZWQgJiYgc2VsZWN0ZWRDZWxscy50eXBlICE9PSBfZXhwbG9yZXJfY29uc3RhbnRzLlNXSU1MQU5FX1RZUEUuT1ZFUkFMTCAmJiBzZWxlY3RlZENlbGxzLnZpZXdCeUZpZWxkTmFtZSAhPT0gdW5kZWZpbmVkICYmIHNlbGVjdGVkQ2VsbHMudmlld0J5RmllbGROYW1lID09PSBfZXhwbG9yZXJfY29uc3RhbnRzLlZJRVdfQllfSk9CX0xBQkVMKSB7CiAgICByZXR1cm4gc2VsZWN0ZWRDZWxscy5sYW5lczsKICB9CgogIHJldHVybiBzZWxlY3RlZEpvYnMubWFwKGZ1bmN0aW9uIChkKSB7CiAgICByZXR1cm4gZC5pZDsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0U3dpbWxhbmVCdWNrZXRJbnRlcnZhbChzZWxlY3RlZEpvYnMsIHN3aW1sYW5lQ29udGFpbmVyV2lkdGgpIHsKICAvLyBCdWNrZXRpbmcgaW50ZXJ2YWwgc2hvdWxkIGJlIHRoZSBtYXhpbXVtIG9mIHRoZSBjaGFydCByZWxhdGVkIGludGVydmFsIChpLmUuIHRpbWUgcmFuZ2UgcmVsYXRlZCkKICAvLyBhbmQgdGhlIG1heCBidWNrZXQgc3BhbiBmb3IgdGhlIGpvYnMgc2hvd24gaW4gdGhlIGNoYXJ0LgogIHZhciBib3VuZHMgPSBfdGltZWZpbHRlci50aW1lZmlsdGVyLmdldEFjdGl2ZUJvdW5kcygpOwoKICB2YXIgYnVja2V0cyA9IG5ldyBfdGltZV9idWNrZXRzLlRpbWVCdWNrZXRzKCk7CiAgYnVja2V0cy5zZXRJbnRlcnZhbCgnYXV0bycpOwogIGJ1Y2tldHMuc2V0Qm91bmRzKGJvdW5kcyk7CiAgdmFyIGludGVydmFsU2Vjb25kcyA9IGJ1Y2tldHMuZ2V0SW50ZXJ2YWwoKS5hc1NlY29uZHMoKTsgLy8gaWYgdGhlIHN3aW1sYW5lIGNlbGwgd2lkdGhzIGFyZSB0b28gc21hbGwgdGhleSB3aWxsIG5vdCBiZSB2aXNpYmxlCiAgLy8gY2FsY3VsYXRlIGhvdyBtYW55IGJ1Y2tldHMgd2lsbCBiZSBkcmF3biBiZWZvcmUgdGhlIHN3aW1sYW5lcyBhcmUgYWN0dWFsbHkgcmVuZGVyZWQKICAvLyBhbmQgaW5jcmVhc2UgdGhlIGludGVydmFsIHRvIHdpZGVuIHRoZSBjZWxscyBpZiB0aGV5J3JlIGdvaW5nIHRvIGJlIHNtYWxsZXIgdGhhbiA4cHgKICAvLyB0aGlzIGhhcyB0byBiZSBkb25lIGF0IHRoaXMgc3RhZ2Ugc28gYWxsIHNlYXJjaGVzIHVzZSB0aGUgc2FtZSBpbnRlcnZhbAoKICB2YXIgdGltZXJhbmdlU2Vjb25kcyA9IChib3VuZHMubWF4LnZhbHVlT2YoKSAtIGJvdW5kcy5taW4udmFsdWVPZigpKSAvIDEwMDA7CiAgdmFyIG51bUJ1Y2tldHMgPSBwYXJzZUludCh0aW1lcmFuZ2VTZWNvbmRzIC8gaW50ZXJ2YWxTZWNvbmRzKTsKICB2YXIgY2VsbFdpZHRoID0gTWF0aC5mbG9vcihzd2ltbGFuZUNvbnRhaW5lcldpZHRoIC8gbnVtQnVja2V0cyAqIDEwMCkgLyAxMDA7IC8vIGlmIHRoZSBjZWxsIHdpZHRoIGlzIGdvaW5nIHRvIGJlIGxlc3MgdGhhbiA4cHgsIGRvdWJsZSB0aGUgaW50ZXJ2YWwKCiAgaWYgKGNlbGxXaWR0aCA8IDgpIHsKICAgIGJ1Y2tldHMuc2V0SW50ZXJ2YWwoaW50ZXJ2YWxTZWNvbmRzICogMiArICdzJyk7CiAgfQoKICB2YXIgbWF4QnVja2V0U3BhblNlY29uZHMgPSBzZWxlY3RlZEpvYnMucmVkdWNlKGZ1bmN0aW9uIChtZW1vLCBqb2IpIHsKICAgIHJldHVybiBNYXRoLm1heChtZW1vLCBqb2IuYnVja2V0U3BhblNlY29uZHMpOwogIH0sIDApOwoKICBpZiAobWF4QnVja2V0U3BhblNlY29uZHMgPiBpbnRlcnZhbFNlY29uZHMpIHsKICAgIGJ1Y2tldHMuc2V0SW50ZXJ2YWwobWF4QnVja2V0U3BhblNlY29uZHMgKyAncycpOwogICAgYnVja2V0cy5zZXRCb3VuZHMoYm91bmRzKTsKICB9CgogIHJldHVybiBidWNrZXRzLmdldEludGVydmFsKCk7Cn0KCmZ1bmN0aW9uIGxvYWRWaWV3QnlUb3BGaWVsZFZhbHVlc0ZvclNlbGVjdGVkVGltZShlYXJsaWVzdE1zLCBsYXRlc3RNcywgc2VsZWN0ZWRKb2JzLCB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSwgc3dpbWxhbmVMaW1pdCwgbm9JbmZsdWVuY2Vyc0NvbmZpZ3VyZWQpIHsKICB2YXIgc2VsZWN0ZWRKb2JJZHMgPSBzZWxlY3RlZEpvYnMubWFwKGZ1bmN0aW9uIChkKSB7CiAgICByZXR1cm4gZC5pZDsKICB9KTsgLy8gRmluZCB0aGUgdG9wIGZpZWxkIHZhbHVlcyBmb3IgdGhlIHNlbGVjdGVkIHRpbWUsIGFuZCB0aGVuIGxvYWQgdGhlICd2aWV3IGJ5JwogIC8vIHN3aW1sYW5lIG92ZXIgdGhlIGZ1bGwgdGltZSByYW5nZSBmb3IgdGhvc2Ugc3BlY2lmaWMgZmllbGQgdmFsdWVzLgoKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIGlmICh2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSAhPT0gX2V4cGxvcmVyX2NvbnN0YW50cy5WSUVXX0JZX0pPQl9MQUJFTCkgewogICAgICBfcmVzdWx0c19zZXJ2aWNlLm1sUmVzdWx0c1NlcnZpY2UuZ2V0VG9wSW5mbHVlbmNlcnMoc2VsZWN0ZWRKb2JJZHMsIGVhcmxpZXN0TXMsIGxhdGVzdE1zLCBzd2ltbGFuZUxpbWl0KS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgaWYgKHJlc3AuaW5mbHVlbmNlcnNbdmlld0J5U3dpbWxhbmVGaWVsZE5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJlc29sdmUoW10pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvcEZpZWxkVmFsdWVzID0gW107CiAgICAgICAgdmFyIHRvcEluZmx1ZW5jZXJzID0gcmVzcC5pbmZsdWVuY2Vyc1t2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZV07CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRvcEluZmx1ZW5jZXJzKSkgewogICAgICAgICAgdG9wSW5mbHVlbmNlcnMuZm9yRWFjaChmdW5jdGlvbiAoaW5mbHVlbmNlckRhdGEpIHsKICAgICAgICAgICAgaWYgKGluZmx1ZW5jZXJEYXRhLm1heEFub21hbHlTY29yZSA+IDApIHsKICAgICAgICAgICAgICB0b3BGaWVsZFZhbHVlcy5wdXNoKGluZmx1ZW5jZXJEYXRhLmluZmx1ZW5jZXJGaWVsZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXNvbHZlKHRvcEZpZWxkVmFsdWVzKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBfcmVzdWx0c19zZXJ2aWNlLm1sUmVzdWx0c1NlcnZpY2UuZ2V0U2NvcmVzQnlCdWNrZXQoc2VsZWN0ZWRKb2JJZHMsIGVhcmxpZXN0TXMsIGxhdGVzdE1zLCBnZXRTd2ltbGFuZUJ1Y2tldEludGVydmFsKHNlbGVjdGVkSm9icywgKDAsIF9sZWdhY3lfdXRpbHMuZ2V0U3dpbWxhbmVDb250YWluZXJXaWR0aCkobm9JbmZsdWVuY2Vyc0NvbmZpZ3VyZWQpKS5hc1NlY29uZHMoKSArICdzJywgc3dpbWxhbmVMaW1pdCkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgIHZhciB0b3BGaWVsZFZhbHVlcyA9IE9iamVjdC5rZXlzKHJlc3AucmVzdWx0cyk7CiAgICAgICAgcmVzb2x2ZSh0b3BGaWVsZFZhbHVlcyk7CiAgICAgIH0pOwogICAgfQogIH0pOwp9IC8vIE9idGFpbiB0aGUgbGlzdCBvZiAnVmlldyBieScgZmllbGRzIHBlciBqb2IgYW5kIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lCgoKZnVuY3Rpb24gZ2V0Vmlld0J5U3dpbWxhbmVPcHRpb25zKF9yZWYpIHsKICB2YXIgY3VycmVudFZpZXdCeVN3aW1sYW5lRmllbGROYW1lID0gX3JlZi5jdXJyZW50Vmlld0J5U3dpbWxhbmVGaWVsZE5hbWUsCiAgICAgIGZpbHRlckFjdGl2ZSA9IF9yZWYuZmlsdGVyQWN0aXZlLAogICAgICBmaWx0ZXJlZEZpZWxkcyA9IF9yZWYuZmlsdGVyZWRGaWVsZHMsCiAgICAgIGlzQW5kT3BlcmF0b3IgPSBfcmVmLmlzQW5kT3BlcmF0b3IsCiAgICAgIHNlbGVjdGVkQ2VsbHMgPSBfcmVmLnNlbGVjdGVkQ2VsbHMsCiAgICAgIHNlbGVjdGVkSm9icyA9IF9yZWYuc2VsZWN0ZWRKb2JzOwogIHZhciBzZWxlY3RlZEpvYklkcyA9IHNlbGVjdGVkSm9icy5tYXAoZnVuY3Rpb24gKGQpIHsKICAgIHJldHVybiBkLmlkOwogIH0pOyAvLyBVbmlxdWUgaW5mbHVlbmNlcnMgZm9yIHRoZSBzZWxlY3RlZCBqb2IocykuCgogIHZhciB2aWV3QnlPcHRpb25zID0gKDAsIF9sb2Rhc2guY2hhaW4pKF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2Uuam9icy5yZWR1Y2UoZnVuY3Rpb24gKHJlZHVjZWRWaWV3QnlPcHRpb25zLCBqb2IpIHsKICAgIGlmIChzZWxlY3RlZEpvYklkcy5zb21lKGZ1bmN0aW9uIChqb2JJZCkgewogICAgICByZXR1cm4gam9iSWQgPT09IGpvYi5qb2JfaWQ7CiAgICB9KSkgewogICAgICByZXR1cm4gcmVkdWNlZFZpZXdCeU9wdGlvbnMuY29uY2F0KGpvYi5hbmFseXNpc19jb25maWcuaW5mbHVlbmNlcnMgfHwgW10pOwogICAgfQoKICAgIHJldHVybiByZWR1Y2VkVmlld0J5T3B0aW9uczsKICB9LCBbXSkpLnVuaXEoKS5zb3J0QnkoZnVuY3Rpb24gKGZpZWxkTmFtZSkgewogICAgcmV0dXJuIGZpZWxkTmFtZS50b0xvd2VyQ2FzZSgpOwogIH0pLnZhbHVlKCk7CiAgdmlld0J5T3B0aW9ucy5wdXNoKF9leHBsb3Jlcl9jb25zdGFudHMuVklFV19CWV9KT0JfTEFCRUwpOwogIHZhciB2aWV3QnlTd2ltbGFuZU9wdGlvbnMgPSB2aWV3QnlPcHRpb25zOwogIHZhciB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSA9IHVuZGVmaW5lZDsKCiAgaWYgKHZpZXdCeVN3aW1sYW5lT3B0aW9ucy5pbmRleE9mKGN1cnJlbnRWaWV3QnlTd2ltbGFuZUZpZWxkTmFtZSkgIT09IC0xKSB7CiAgICAvLyBTZXQgdGhlIHN3aW1sYW5lIHZpZXdCeSB0byB0aGF0IHN0b3JlZCBpbiB0aGUgc3RhdGUgKFVSTCkgaWYgc2V0LgogICAgLy8gVGhpcyBtZWFucyB3ZSByZXNldCBpdCB0byB0aGUgY3VycmVudCBzdGF0ZSBiZWNhdXNlIGl0IHdhcyBzZXQgYnkgdGhlIGxpc3RlbmVyCiAgICAvLyBvbiBpbml0aWFsaXphdGlvbi4KICAgIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lID0gY3VycmVudFZpZXdCeVN3aW1sYW5lRmllbGROYW1lOwogIH0gZWxzZSB7CiAgICBpZiAoc2VsZWN0ZWRKb2JJZHMubGVuZ3RoID4gMSkgewogICAgICAvLyBJZiBtb3JlIHRoYW4gb25lIGpvYiBzZWxlY3RlZCwgZGVmYXVsdCB0byBqb2IgSUQuCiAgICAgIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lID0gX2V4cGxvcmVyX2NvbnN0YW50cy5WSUVXX0JZX0pPQl9MQUJFTDsKICAgIH0gZWxzZSBpZiAoX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5qb2JzLmxlbmd0aCA+IDAgJiYgc2VsZWN0ZWRKb2JJZHMubGVuZ3RoID4gMCkgewogICAgICAvLyBGb3IgYSBzaW5nbGUgam9iLCBkZWZhdWx0IHRvIHRoZSBmaXJzdCBwYXJ0aXRpb24sIG92ZXIsCiAgICAgIC8vIGJ5IG9yIGluZmx1ZW5jZXIgZmllbGQgb2YgdGhlIGZpcnN0IHNlbGVjdGVkIGpvYi4KICAgICAgdmFyIGZpcnN0U2VsZWN0ZWRKb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmpvYnMuZmluZChmdW5jdGlvbiAoam9iKSB7CiAgICAgICAgcmV0dXJuIGpvYi5qb2JfaWQgPT09IHNlbGVjdGVkSm9iSWRzWzBdOwogICAgICB9KTsKCiAgICAgIHZhciBmaXJzdEpvYkluZmx1ZW5jZXJzID0gZmlyc3RTZWxlY3RlZEpvYi5hbmFseXNpc19jb25maWcuaW5mbHVlbmNlcnMgfHwgW107CiAgICAgIGZpcnN0U2VsZWN0ZWRKb2IuYW5hbHlzaXNfY29uZmlnLmRldGVjdG9ycy5mb3JFYWNoKGZ1bmN0aW9uIChkZXRlY3RvcikgewogICAgICAgIGlmIChkZXRlY3Rvci5wYXJ0aXRpb25fZmllbGRfbmFtZSAhPT0gdW5kZWZpbmVkICYmIGZpcnN0Sm9iSW5mbHVlbmNlcnMuaW5kZXhPZihkZXRlY3Rvci5wYXJ0aXRpb25fZmllbGRfbmFtZSkgIT09IC0xKSB7CiAgICAgICAgICB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSA9IGRldGVjdG9yLnBhcnRpdGlvbl9maWVsZF9uYW1lOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRldGVjdG9yLm92ZXJfZmllbGRfbmFtZSAhPT0gdW5kZWZpbmVkICYmIGZpcnN0Sm9iSW5mbHVlbmNlcnMuaW5kZXhPZihkZXRlY3Rvci5vdmVyX2ZpZWxkX25hbWUpICE9PSAtMSkgewogICAgICAgICAgdmlld0J5U3dpbWxhbmVGaWVsZE5hbWUgPSBkZXRlY3Rvci5vdmVyX2ZpZWxkX25hbWU7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSAvLyBGb3Igam9icyB3aXRoIGJ5IGFuZCBvdmVyIGZpZWxkcywgZG9uJ3QgYWRkIHRoZSAnYnknIGZpZWxkIGFzIHRoaXMKICAgICAgICAvLyBmaWVsZCB3aWxsIG9ubHkgYmUgYWRkZWQgdG8gdGhlIHRvcC1sZXZlbCBmaWVsZHMgZm9yIHJlY29yZCB0eXBlIHJlc3VsdHMKICAgICAgICAvLyBpZiBpdCBhbHNvIGFuIGluZmx1ZW5jZXIgb3ZlciB0aGUgYnVja2V0LgoKCiAgICAgICAgaWYgKGRldGVjdG9yLmJ5X2ZpZWxkX25hbWUgIT09IHVuZGVmaW5lZCAmJiBkZXRlY3Rvci5vdmVyX2ZpZWxkX25hbWUgPT09IHVuZGVmaW5lZCAmJiBmaXJzdEpvYkluZmx1ZW5jZXJzLmluZGV4T2YoZGV0ZWN0b3IuYnlfZmllbGRfbmFtZSkgIT09IC0xKSB7CiAgICAgICAgICB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSA9IGRldGVjdG9yLmJ5X2ZpZWxkX25hbWU7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmICh2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGZpcnN0Sm9iSW5mbHVlbmNlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdmlld0J5U3dpbWxhbmVGaWVsZE5hbWUgPSBmaXJzdEpvYkluZmx1ZW5jZXJzWzBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBObyBpbmZsdWVuY2VycyBmb3IgZmlyc3Qgc2VsZWN0ZWQgam9iIC0gc2V0IHRvIGZpcnN0IGF2YWlsYWJsZSBvcHRpb24uCiAgICAgICAgICB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSA9IHZpZXdCeVN3aW1sYW5lT3B0aW9ucy5sZW5ndGggPiAwID8gdmlld0J5U3dpbWxhbmVPcHRpb25zWzBdIDogdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gLy8gZmlsdGVyIFZpZXcgYnkgb3B0aW9ucyB0byByZWxldmFudCBmaWx0ZXIgZmllbGRzCiAgLy8gSWYgaXQncyBhbiBBTkQgZmlsdGVyIG9ubHkgc2hvdyBqb2IgSWQgdmlldyBieSBhcyB0aGUgcmVzdCB3aWxsIGhhdmUgbm8gcmVzdWx0cwoKCiAgaWYgKGZpbHRlckFjdGl2ZSA9PT0gdHJ1ZSAmJiBpc0FuZE9wZXJhdG9yID09PSB0cnVlICYmIHNlbGVjdGVkQ2VsbHMgPT09IG51bGwpIHsKICAgIHZpZXdCeVN3aW1sYW5lT3B0aW9ucyA9IFtfZXhwbG9yZXJfY29uc3RhbnRzLlZJRVdfQllfSk9CX0xBQkVMXTsKICB9IGVsc2UgaWYgKGZpbHRlckFjdGl2ZSA9PT0gdHJ1ZSAmJiBBcnJheS5pc0FycmF5KHZpZXdCeVN3aW1sYW5lT3B0aW9ucykgJiYgQXJyYXkuaXNBcnJheShmaWx0ZXJlZEZpZWxkcykpIHsKICAgIHZhciBmaWx0ZXJlZE9wdGlvbnMgPSB2aWV3QnlTd2ltbGFuZU9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgcmV0dXJuIGZpbHRlcmVkRmllbGRzLmluY2x1ZGVzKG9wdGlvbikgfHwgb3B0aW9uID09PSBfZXhwbG9yZXJfY29uc3RhbnRzLlZJRVdfQllfSk9CX0xBQkVMIHx8IHNlbGVjdGVkQ2VsbHMgJiYgc2VsZWN0ZWRDZWxscy52aWV3QnlGaWVsZE5hbWUgPT09IG9wdGlvbjsKICAgIH0pOyAvLyBvbmx5IHJlcGxhY2Ugdmlld0J5U3dpbWxhbmVPcHRpb25zIHdpdGggZmlsdGVyZWRPcHRpb25zIGlmIHdlIGZvdW5kIGEgcmVsZXZhbnQgbWF0Y2hpbmcgZmllbGQKCiAgICBpZiAoZmlsdGVyZWRPcHRpb25zLmxlbmd0aCA+IDEpIHsKICAgICAgdmlld0J5U3dpbWxhbmVPcHRpb25zID0gZmlsdGVyZWRPcHRpb25zOwogICAgfQogIH0KCiAgcmV0dXJuIHsKICAgIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lOiB2aWV3QnlTd2ltbGFuZUZpZWxkTmFtZSwKICAgIHZpZXdCeVN3aW1sYW5lT3B0aW9uczogdmlld0J5U3dpbWxhbmVPcHRpb25zCiAgfTsKfQoKZnVuY3Rpb24gcHJvY2Vzc092ZXJhbGxSZXN1bHRzKHNjb3Jlc0J5VGltZSwgc2VhcmNoQm91bmRzLCBpbnRlcnZhbCkgewogIHZhciBvdmVyYWxsTGFiZWwgPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuZXhwbG9yZXIub3ZlcmFsbExhYmVsJywgewogICAgZGVmYXVsdE1lc3NhZ2U6ICdPdmVyYWxsJwogIH0pOwoKICB2YXIgZGF0YXNldCA9IHsKICAgIGxhbmVMYWJlbHM6IFtvdmVyYWxsTGFiZWxdLAogICAgcG9pbnRzOiBbXSwKICAgIGludGVydmFsOiBpbnRlcnZhbCwKICAgIGVhcmxpZXN0OiBzZWFyY2hCb3VuZHMubWluLnZhbHVlT2YoKSAvIDEwMDAsCiAgICBsYXRlc3Q6IHNlYXJjaEJvdW5kcy5tYXgudmFsdWVPZigpIC8gMTAwMAogIH07CgogIGlmIChPYmplY3Qua2V5cyhzY29yZXNCeVRpbWUpLmxlbmd0aCA+IDApIHsKICAgIC8vIFN0b3JlIHRoZSBlYXJsaWVzdCBhbmQgbGF0ZXN0IHRpbWVzIG9mIHRoZSBkYXRhIHJldHVybmVkIGJ5IHRoZSBFUyBhZ2dyZWdhdGlvbnMsCiAgICAvLyBUaGVzZSB3aWxsIGJlIHVzZWQgZm9yIGNhbGN1bGF0aW5nIHRoZSBlYXJsaWVzdCBhbmQgbGF0ZXN0IHRpbWVzIGZvciB0aGUgc3dpbWxhbmUgY2hhcnRzLgogICAgKDAsIF9sb2Rhc2guZWFjaCkoc2NvcmVzQnlUaW1lLCBmdW5jdGlvbiAoc2NvcmUsIHRpbWVNcykgewogICAgICB2YXIgdGltZSA9IHRpbWVNcyAvIDEwMDA7CiAgICAgIGRhdGFzZXQucG9pbnRzLnB1c2goewogICAgICAgIGxhbmVMYWJlbDogb3ZlcmFsbExhYmVsLAogICAgICAgIHRpbWU6IHRpbWUsCiAgICAgICAgdmFsdWU6IHNjb3JlCiAgICAgIH0pOwogICAgICBkYXRhc2V0LmVhcmxpZXN0ID0gTWF0aC5taW4odGltZSwgZGF0YXNldC5lYXJsaWVzdCk7CiAgICAgIGRhdGFzZXQubGF0ZXN0ID0gTWF0aC5tYXgodGltZSArIGRhdGFzZXQuaW50ZXJ2YWwsIGRhdGFzZXQubGF0ZXN0KTsKICAgIH0pOwogIH0KCiAgcmV0dXJuIGRhdGFzZXQ7Cn0KCmZ1bmN0aW9uIHByb2Nlc3NWaWV3QnlSZXN1bHRzKHNjb3Jlc0J5SW5mbHVlbmNlckFuZFRpbWUsIHNvcnRlZExhbmVWYWx1ZXMsIGJvdW5kcywgdmlld0J5U3dpbWxhbmVGaWVsZE5hbWUsIGludGVydmFsKSB7CiAgLy8gUHJvY2Vzc2VzIHRoZSBzY29yZXMgZm9yIHRoZSAndmlldyBieScgc3dpbWxhbmUuCiAgLy8gU29ydHMgdGhlIGxhbmVzIGFjY29yZGluZyB0byB0aGUgc3VwcGxpZWQgYXJyYXkgb2YgbGFuZQogIC8vIHZhbHVlcyBpbiB0aGUgb3JkZXIgaW4gd2hpY2ggdGhleSBzaG91bGQgYmUgZGlzcGxheWVkLAogIC8vIG9yIHBhc3MgYW4gZW1wdHkgYXJyYXkgdG8gc29ydCBsYW5lcyBhY2NvcmRpbmcgdG8gbWF4IHNjb3JlIG92ZXIgYWxsIHRpbWUuCiAgdmFyIGRhdGFzZXQgPSB7CiAgICBmaWVsZE5hbWU6IHZpZXdCeVN3aW1sYW5lRmllbGROYW1lLAogICAgcG9pbnRzOiBbXSwKICAgIGludGVydmFsOiBpbnRlcnZhbAogIH07IC8vIFNldCB0aGUgZWFybGllc3QgYW5kIGxhdGVzdCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgb3ZlcmFsbCBzd2ltbGFuZS4KCiAgZGF0YXNldC5lYXJsaWVzdCA9IGJvdW5kcy5lYXJsaWVzdDsKICBkYXRhc2V0LmxhdGVzdCA9IGJvdW5kcy5sYXRlc3Q7CiAgdmFyIGxhbmVMYWJlbHMgPSBbXTsKICB2YXIgbWF4U2NvcmVCeUxhbmVMYWJlbCA9IHt9OwogICgwLCBfbG9kYXNoLmVhY2gpKHNjb3Jlc0J5SW5mbHVlbmNlckFuZFRpbWUsIGZ1bmN0aW9uIChpbmZsdWVuY2VyRGF0YSwgaW5mbHVlbmNlckZpZWxkVmFsdWUpIHsKICAgIGxhbmVMYWJlbHMucHVzaChpbmZsdWVuY2VyRmllbGRWYWx1ZSk7CiAgICBtYXhTY29yZUJ5TGFuZUxhYmVsW2luZmx1ZW5jZXJGaWVsZFZhbHVlXSA9IDA7CiAgICAoMCwgX2xvZGFzaC5lYWNoKShpbmZsdWVuY2VyRGF0YSwgZnVuY3Rpb24gKGFub21hbHlTY29yZSwgdGltZU1zKSB7CiAgICAgIHZhciB0aW1lID0gdGltZU1zIC8gMTAwMDsKICAgICAgZGF0YXNldC5wb2ludHMucHVzaCh7CiAgICAgICAgbGFuZUxhYmVsOiBpbmZsdWVuY2VyRmllbGRWYWx1ZSwKICAgICAgICB0aW1lOiB0aW1lLAogICAgICAgIHZhbHVlOiBhbm9tYWx5U2NvcmUKICAgICAgfSk7CiAgICAgIG1heFNjb3JlQnlMYW5lTGFiZWxbaW5mbHVlbmNlckZpZWxkVmFsdWVdID0gTWF0aC5tYXgobWF4U2NvcmVCeUxhbmVMYWJlbFtpbmZsdWVuY2VyRmllbGRWYWx1ZV0sIGFub21hbHlTY29yZSk7CiAgICB9KTsKICB9KTsKICB2YXIgc29ydFZhbHVlc0xlbmd0aCA9IHNvcnRlZExhbmVWYWx1ZXMubGVuZ3RoOwoKICBpZiAoc29ydFZhbHVlc0xlbmd0aCA9PT0gMCkgewogICAgLy8gU29ydCBsYW5lcyBpbiBkZXNjZW5kaW5nIG9yZGVyIG9mIG1heCBzY29yZS4KICAgIC8vIE5vdGUgdGhlIGtleXMgaW4gc2NvcmVzQnlJbmZsdWVuY2VyQW5kVGltZSByZWNlaXZlZCBmcm9tIHRoZSBFUyByZXF1ZXN0CiAgICAvLyBhcmUgbm90IGd1YXJhbnRlZWQgdG8gYmUgc29ydGVkIGJ5IHNjb3JlIGlmIHRoZXkgY2FuIGJlIHBhcnNlZCBhcyBudW1iZXJzCiAgICAvLyAoZS5nLiBpZiB2aWV3aW5nIGJ5IEhUVFAgcmVzcG9uc2UgY29kZSkuCiAgICBkYXRhc2V0LmxhbmVMYWJlbHMgPSBsYW5lTGFiZWxzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIG1heFNjb3JlQnlMYW5lTGFiZWxbYl0gLSBtYXhTY29yZUJ5TGFuZUxhYmVsW2FdOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIC8vIFNvcnQgbGFuZXMgYWNjb3JkaW5nIHRvIHN1cHBsaWVkIG9yZGVyCiAgICAvLyBlLmcuIHdoZW4gYSBjZWxsIGluIHRoZSBvdmVyYWxsIHN3aW1sYW5lIGhhcyBiZWVuIHNlbGVjdGVkLgogICAgLy8gRmluZCB0aGUgaW5kZXggb2YgZWFjaCBsYW5lIGxhYmVsIGZyb20gdGhlIGFjdHVhbCBkYXRhIHNldCwKICAgIC8vIHJhdGhlciB0aGFuIHVzaW5nIHNvcnRlZExhbmVWYWx1ZXMgYXMtaXMsIGp1c3QgaW4gY2FzZSB0aGV5IGRpZmZlci4KICAgIGRhdGFzZXQubGFuZUxhYmVscyA9IGxhbmVMYWJlbHMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICB2YXIgYUluZGV4ID0gc29ydGVkTGFuZVZhbHVlcy5pbmRleE9mKGEpOwogICAgICB2YXIgYkluZGV4ID0gc29ydGVkTGFuZVZhbHVlcy5pbmRleE9mKGIpOwogICAgICBhSW5kZXggPSBhSW5kZXggPiAtMSA/IGFJbmRleCA6IHNvcnRWYWx1ZXNMZW5ndGg7CiAgICAgIGJJbmRleCA9IGJJbmRleCA+IC0xID8gYkluZGV4IDogc29ydFZhbHVlc0xlbmd0aDsKICAgICAgcmV0dXJuIGFJbmRleCAtIGJJbmRleDsKICAgIH0pOwogIH0KCiAgcmV0dXJuIGRhdGFzZXQ7Cn0KCmZ1bmN0aW9uIGxvYWRBbm5vdGF0aW9uc1RhYmxlRGF0YShzZWxlY3RlZENlbGxzLCBzZWxlY3RlZEpvYnMsIGludGVydmFsLCBib3VuZHMpIHsKICB2YXIgam9iSWRzID0gc2VsZWN0ZWRDZWxscyAhPT0gdW5kZWZpbmVkICYmIHNlbGVjdGVkQ2VsbHMudmlld0J5RmllbGROYW1lID09PSBfZXhwbG9yZXJfY29uc3RhbnRzLlZJRVdfQllfSk9CX0xBQkVMID8gc2VsZWN0ZWRDZWxscy5sYW5lcyA6IHNlbGVjdGVkSm9icy5tYXAoZnVuY3Rpb24gKGQpIHsKICAgIHJldHVybiBkLmlkOwogIH0pOwogIHZhciB0aW1lUmFuZ2UgPSBnZXRTZWxlY3Rpb25UaW1lUmFuZ2Uoc2VsZWN0ZWRDZWxscywgaW50ZXJ2YWwsIGJvdW5kcyk7CgogIGlmIChtbEFubm90YXRpb25zRW5hYmxlZCA9PT0gZmFsc2UpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pOwogIH0KCiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICBfbWxfYXBpX3NlcnZpY2UubWwuYW5ub3RhdGlvbnMuZ2V0QW5ub3RhdGlvbnMoewogICAgICBqb2JJZHM6IGpvYklkcywKICAgICAgZWFybGllc3RNczogdGltZVJhbmdlLmVhcmxpZXN0TXMsCiAgICAgIGxhdGVzdE1zOiB0aW1lUmFuZ2UubGF0ZXN0TXMsCiAgICAgIG1heEFubm90YXRpb25zOiBfc2VhcmNoLkFOTk9UQVRJT05TX1RBQkxFX0RFRkFVTFRfUVVFUllfU0laRQogICAgfSkudG9Qcm9taXNlKCkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICBpZiAocmVzcC5lcnJvciAhPT0gdW5kZWZpbmVkIHx8IHJlc3AuYW5ub3RhdGlvbnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiByZXNvbHZlKFtdKTsKICAgICAgfQoKICAgICAgdmFyIGFubm90YXRpb25zRGF0YSA9IFtdOwogICAgICBqb2JJZHMuZm9yRWFjaChmdW5jdGlvbiAoam9iSWQpIHsKICAgICAgICB2YXIgam9iQW5ub3RhdGlvbnMgPSByZXNwLmFubm90YXRpb25zW2pvYklkXTsKCiAgICAgICAgaWYgKGpvYkFubm90YXRpb25zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGFubm90YXRpb25zRGF0YS5wdXNoLmFwcGx5KGFubm90YXRpb25zRGF0YSwgX3RvQ29uc3VtYWJsZUFycmF5KGpvYkFubm90YXRpb25zKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc29sdmUoYW5ub3RhdGlvbnNEYXRhLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS50aW1lc3RhbXAgLSBiLnRpbWVzdGFtcDsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChkLCBpKSB7CiAgICAgICAgZC5rZXkgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgaSk7CiAgICAgICAgcmV0dXJuIGQ7CiAgICAgIH0pKTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBsb2FkaW5nIGxpc3Qgb2YgYW5ub3RhdGlvbnMgZm9yIGpvYnMgbGlzdDonLCByZXNwKTsgLy8gU2lsZW50bHkgZmFpbCBhbmQganVzdCByZXR1cm4gYW4gZW1wdHkgYXJyYXkgZm9yIGFubm90YXRpb25zIHRvIG5vdCBicmVhayB0aGUgVUkuCgogICAgICByZXR1cm4gcmVzb2x2ZShbXSk7CiAgICB9KTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZEFub21hbGllc1RhYmxlRGF0YShzZWxlY3RlZENlbGxzLCBzZWxlY3RlZEpvYnMsIGRhdGVGb3JtYXRUeiwgaW50ZXJ2YWwsIGJvdW5kcywgZmllbGROYW1lLCB0YWJsZUludGVydmFsLCB0YWJsZVNldmVyaXR5LCBpbmZsdWVuY2Vyc0ZpbHRlclF1ZXJ5KSB7CiAgdmFyIGpvYklkcywgaW5mbHVlbmNlcnMsIHRpbWVSYW5nZTsKICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIGxvYWRBbm9tYWxpZXNUYWJsZURhdGEkKF9jb250ZXh0MikgewogICAgd2hpbGUgKDEpIHsKICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgY2FzZSAwOgogICAgICAgICAgam9iSWRzID0gZ2V0U2VsZWN0aW9uSm9iSWRzKHNlbGVjdGVkQ2VsbHMsIHNlbGVjdGVkSm9icyk7CiAgICAgICAgICBpbmZsdWVuY2VycyA9IGdldFNlbGVjdGlvbkluZmx1ZW5jZXJzKHNlbGVjdGVkQ2VsbHMsIGZpZWxkTmFtZSk7CiAgICAgICAgICB0aW1lUmFuZ2UgPSBnZXRTZWxlY3Rpb25UaW1lUmFuZ2Uoc2VsZWN0ZWRDZWxscywgaW50ZXJ2YWwsIGJvdW5kcyk7CiAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICBfbWxfYXBpX3NlcnZpY2UubWwucmVzdWx0cy5nZXRBbm9tYWxpZXNUYWJsZURhdGEoam9iSWRzLCBbXSwgaW5mbHVlbmNlcnMsIHRhYmxlSW50ZXJ2YWwsIHRhYmxlU2V2ZXJpdHksIHRpbWVSYW5nZS5lYXJsaWVzdE1zLCB0aW1lUmFuZ2UubGF0ZXN0TXMsIGRhdGVGb3JtYXRUeiwgX3NlYXJjaC5BTk9NQUxJRVNfVEFCTEVfREVGQVVMVF9RVUVSWV9TSVpFLCBfZXhwbG9yZXJfY29uc3RhbnRzLk1BWF9DQVRFR09SWV9FWEFNUExFUywgaW5mbHVlbmNlcnNGaWx0ZXJRdWVyeSkudG9Qcm9taXNlKCkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgIHZhciBhbm9tYWxpZXMgPSByZXNwLmFub21hbGllczsKICAgICAgICAgICAgICB2YXIgZGV0ZWN0b3JzQnlKb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmRldGVjdG9yc0J5Sm9iOwogICAgICAgICAgICAgIGFub21hbGllcy5mb3JFYWNoKGZ1bmN0aW9uIChhbm9tYWx5KSB7CiAgICAgICAgICAgICAgICAvLyBBZGQgYSBkZXRlY3RvciBwcm9wZXJ0eSB0byBlYWNoIGFub21hbHkuCiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHRvIGZ1bmN0aW9uRGVzY3JpcHRpb24gaWYgbm8gZGVzY3JpcHRpb24gYXZhaWxhYmxlLgogICAgICAgICAgICAgICAgLy8gVE9ETyAtIHdoZW4gam9iX3NlcnZpY2UgaXMgbW92ZWQgc2VydmVyX3NpZGUsIG1vdmUgdGhpcyB0byBzZXJ2ZXIgZW5kcG9pbnQuCiAgICAgICAgICAgICAgICB2YXIgam9iSWQgPSBhbm9tYWx5LmpvYklkOwogICAgICAgICAgICAgICAgdmFyIGRldGVjdG9yID0gKDAsIF9sb2Rhc2guZ2V0KShkZXRlY3RvcnNCeUpvYiwgW2pvYklkLCBhbm9tYWx5LmRldGVjdG9ySW5kZXhdKTsKICAgICAgICAgICAgICAgIGFub21hbHkuZGV0ZWN0b3IgPSAoMCwgX2xvZGFzaC5nZXQpKGRldGVjdG9yLCBbJ2RldGVjdG9yX2Rlc2NyaXB0aW9uJ10sIGFub21hbHkuc291cmNlLmZ1bmN0aW9uX2Rlc2NyaXB0aW9uKTsgLy8gRm9yIGRldGVjdG9ycyB3aXRoIHJ1bGVzLCBhZGQgYSBwcm9wZXJ0eSB3aXRoIHRoZSBydWxlIGNvdW50LgoKICAgICAgICAgICAgICAgIGlmIChkZXRlY3RvciAhPT0gdW5kZWZpbmVkICYmIGRldGVjdG9yLmN1c3RvbV9ydWxlcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIGFub21hbHkucnVsZXNMZW5ndGggPSBkZXRlY3Rvci5jdXN0b21fcnVsZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgfSAvLyBBZGQgcHJvcGVydGllcyB1c2VkIGZvciBidWlsZGluZyB0aGUgbGlua3MgbWVudS4KICAgICAgICAgICAgICAgIC8vIFRPRE8gLSB3aGVuIGpvYl9zZXJ2aWNlIGlzIG1vdmVkIHNlcnZlcl9zaWRlLCBtb3ZlIHRoaXMgdG8gc2VydmVyIGVuZHBvaW50LgoKCiAgICAgICAgICAgICAgICB2YXIgam9iID0gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5nZXRKb2Ioam9iSWQpOwoKICAgICAgICAgICAgICAgIHZhciBpc0NoYXJ0YWJsZSA9ICgwLCBfam9iX3V0aWxzLmlzU291cmNlRGF0YUNoYXJ0YWJsZUZvckRldGVjdG9yKShqb2IsIGFub21hbHkuZGV0ZWN0b3JJbmRleCk7CgogICAgICAgICAgICAgICAgaWYgKGlzQ2hhcnRhYmxlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBtb2RlbCBwbG90IGlzIGVuYWJsZWQgZm9yIHRoaXMgam9iLgogICAgICAgICAgICAgICAgICAvLyBOZWVkIHRvIGNoZWNrIHRoZSBlbnRpdHkgZmllbGRzIGZvciB0aGUgcmVjb3JkIGluIGNhc2UgdGhlIG1vZGVsIHBsb3QgY29uZmlnIGhhcyBhIHRlcm1zIGxpc3QuCiAgICAgICAgICAgICAgICAgIC8vIElmIHRlcm1zIGlzIHNwZWNpZmllZCwgbW9kZWwgcGxvdCBpcyBvbmx5IHN0b3JlZCBpZiBib3RoIHRoZSBwYXJ0aXRpb24gYW5kIGJ5IGZpZWxkcyBhcHBlYXIgaW4gdGhlIGxpc3QuCiAgICAgICAgICAgICAgICAgIHZhciBlbnRpdHlGaWVsZHMgPSAoMCwgX2Fub21hbHlfdXRpbHMuZ2V0RW50aXR5RmllbGRMaXN0KShhbm9tYWx5LnNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGlzQ2hhcnRhYmxlID0gKDAsIF9qb2JfdXRpbHMuaXNNb2RlbFBsb3RFbmFibGVkKShqb2IsIGFub21hbHkuZGV0ZWN0b3JJbmRleCwgZW50aXR5RmllbGRzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhbm9tYWx5LmlzVGltZVNlcmllc1ZpZXdSZWNvcmQgPSBpc0NoYXJ0YWJsZTsKCiAgICAgICAgICAgICAgICBpZiAoX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5jdXN0b21VcmxzQnlKb2Jbam9iSWRdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgYW5vbWFseS5jdXN0b21VcmxzID0gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5jdXN0b21VcmxzQnlKb2Jbam9iSWRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlc29sdmUoewogICAgICAgICAgICAgICAgYW5vbWFsaWVzOiBhbm9tYWxpZXMsCiAgICAgICAgICAgICAgICBpbnRlcnZhbDogcmVzcC5pbnRlcnZhbCwKICAgICAgICAgICAgICAgIGV4YW1wbGVzQnlKb2JJZDogcmVzcC5leGFtcGxlc0J5Sm9iSWQsCiAgICAgICAgICAgICAgICBzaG93Vmlld1Nlcmllc0xpbms6IHRydWUsCiAgICAgICAgICAgICAgICBqb2JJZHM6IGpvYklkcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFeHBsb3JlciAtIGVycm9yIGxvYWRpbmcgZGF0YSBmb3IgYW5vbWFsaWVzIHRhYmxlOicsIHJlc3ApOwogICAgICAgICAgICAgIHJlamVjdCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pKTsKCiAgICAgICAgY2FzZSA0OgogICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgfQogICAgfQogIH0pOwp9IC8vIHRyYWNrIHRoZSByZXF1ZXN0IHRvIGJlIGFibGUgdG8gaWdub3JlIG91dCBvZiBkYXRlIHJlcXVlc3RzCi8vIGFuZCBhdm9pZCByYWNlIGNvbmRpdGlvbnMgZW5kaW5nIHVwIHdpdGggdGhlIHdyb25nIGNoYXJ0cy4KCgp2YXIgcmVxdWVzdENvdW50ID0gMDsKCmZ1bmN0aW9uIGxvYWREYXRhRm9yQ2hhcnRzKGpvYklkcywgZWFybGllc3RNcywgbGF0ZXN0TXMpIHsKICB2YXIgaW5mbHVlbmNlcnMsCiAgICAgIHNlbGVjdGVkQ2VsbHMsCiAgICAgIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnksCiAgICAgIF9hcmdzMyA9IGFyZ3VtZW50czsKICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIGxvYWREYXRhRm9yQ2hhcnRzJChfY29udGV4dDMpIHsKICAgIHdoaWxlICgxKSB7CiAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIGluZmx1ZW5jZXJzID0gX2FyZ3MzLmxlbmd0aCA+IDMgJiYgX2FyZ3MzWzNdICE9PSB1bmRlZmluZWQgPyBfYXJnczNbM10gOiBbXTsKICAgICAgICAgIHNlbGVjdGVkQ2VsbHMgPSBfYXJnczMubGVuZ3RoID4gNCA/IF9hcmdzM1s0XSA6IHVuZGVmaW5lZDsKICAgICAgICAgIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnkgPSBfYXJnczMubGVuZ3RoID4gNSA/IF9hcmdzM1s1XSA6IHVuZGVmaW5lZDsKICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgICAgICAvLyBKdXN0IHNraXAgZG9pbmcgdGhlIHJlcXVlc3Qgd2hlbiB0aGlzIGZ1bmN0aW9uCiAgICAgICAgICAgIC8vIGlzIGNhbGxlZCB3aXRob3V0IHRoZSBtaW5pbXVtIHJlcXVpcmVkIGRhdGEuCiAgICAgICAgICAgIGlmIChzZWxlY3RlZENlbGxzID09PSB1bmRlZmluZWQgJiYgaW5mbHVlbmNlcnMubGVuZ3RoID09PSAwICYmIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHJlc29sdmUoW10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbmV3UmVxdWVzdENvdW50ID0gKytyZXF1ZXN0Q291bnQ7CiAgICAgICAgICAgIHJlcXVlc3RDb3VudCA9IG5ld1JlcXVlc3RDb3VudDsgLy8gTG9hZCB0aGUgdG9wIGFub21hbGllcyAoYnkgcmVjb3JkX3Njb3JlKSB3aGljaCB3aWxsIGJlIGRpc3BsYXllZCBpbiB0aGUgY2hhcnRzLgoKICAgICAgICAgICAgX3Jlc3VsdHNfc2VydmljZS5tbFJlc3VsdHNTZXJ2aWNlLmdldFJlY29yZHNGb3JJbmZsdWVuY2VyKGpvYklkcywgaW5mbHVlbmNlcnMsIDAsIGVhcmxpZXN0TXMsIGxhdGVzdE1zLCA1MDAsIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnkpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAvLyBJZ25vcmUgdGhpcyByZXNwb25zZSBpZiBpdCdzIHJldHVybmVkIGJ5IGFuIG91dCBvZiBkYXRlIHByb21pc2UKICAgICAgICAgICAgICBpZiAobmV3UmVxdWVzdENvdW50IDwgcmVxdWVzdENvdW50KSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKFtdKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChzZWxlY3RlZENlbGxzICE9PSB1bmRlZmluZWQgJiYgT2JqZWN0LmtleXMoc2VsZWN0ZWRDZWxscykubGVuZ3RoID4gMCB8fCBpbmZsdWVuY2Vyc0ZpbHRlclF1ZXJ5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFeHBsb3JlciBhbm9tYWx5IGNoYXJ0cyBkYXRhIHNldDonLCByZXNwLnJlY29yZHMpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwLnJlY29yZHMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmVzb2x2ZShbXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkpOwoKICAgICAgICBjYXNlIDQ6CiAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGxvYWRPdmVyYWxsRGF0YShzZWxlY3RlZEpvYnMsIGludGVydmFsLCBib3VuZHMpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgIC8vIExvYWRzIHRoZSBvdmVyYWxsIGRhdGEgY29tcG9uZW50cyBpLmUuIHRoZSBvdmVyYWxsIHN3aW1sYW5lIGFuZCBpbmZsdWVuY2VycyBsaXN0LgogICAgaWYgKHNlbGVjdGVkSm9icyA9PT0gbnVsbCkgewogICAgICByZXNvbHZlKHsKICAgICAgICBsb2FkaW5nOiBmYWxzZSwKICAgICAgICBoYXNSZXN1dHM6IGZhbHNlCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9IC8vIEVuc3VyZSB0aGUgc2VhcmNoIGJvdW5kcyBhbGlnbiB0byB0aGUgYnVja2V0aW5nIGludGVydmFsIHVzZWQgaW4gdGhlIHN3aW1sYW5lIHNvCiAgICAvLyB0aGF0IHRoZSBmaXJzdCBhbmQgbGFzdCBidWNrZXRzIGFyZSBjb21wbGV0ZS4KCgogICAgdmFyIHNlYXJjaEJvdW5kcyA9ICgwLCBfdGltZV9idWNrZXRzLmdldEJvdW5kc1JvdW5kZWRUb0ludGVydmFsKShib3VuZHMsIGludGVydmFsLCBmYWxzZSk7CiAgICB2YXIgc2VsZWN0ZWRKb2JJZHMgPSBzZWxlY3RlZEpvYnMubWFwKGZ1bmN0aW9uIChkKSB7CiAgICAgIHJldHVybiBkLmlkOwogICAgfSk7IC8vIExvYWQgdGhlIG92ZXJhbGwgYnVja2V0IHNjb3JlcyBieSB0aW1lLgogICAgLy8gUGFzcyB0aGUgaW50ZXJ2YWwgaW4gc2Vjb25kcyBhcyB0aGUgc3dpbWxhbmUgcmVsaWVzIG9uIGEgZml4ZWQgbnVtYmVyIG9mIHNlY29uZHMgYmV0d2VlbiBidWNrZXRzCiAgICAvLyB3aGljaCB3b3VsZG4ndCBiZSB0aGUgY2FzZSBpZiBlLmcuICcxTScgd2FzIHVzZWQuCiAgICAvLyBQYXNzICd0cnVlJyB3aGVuIG9idGFpbmluZyBidWNrZXQgYm91bmRzIGR1ZSB0byB0aGUgd2F5IHRoZSBvdmVyYWxsX2J1Y2tldHMgZW5kcG9pbnQgd29ya3MKICAgIC8vIHRvIGVuc3VyZSB0aGUgc2VhcmNoIGlzIGluY2x1c2l2ZSBvZiBlbmQgdGltZS4KCiAgICB2YXIgb3ZlcmFsbEJ1Y2tldHNCb3VuZHMgPSAoMCwgX3RpbWVfYnVja2V0cy5nZXRCb3VuZHNSb3VuZGVkVG9JbnRlcnZhbCkoYm91bmRzLCBpbnRlcnZhbCwgdHJ1ZSk7CgogICAgX3Jlc3VsdHNfc2VydmljZS5tbFJlc3VsdHNTZXJ2aWNlLmdldE92ZXJhbGxCdWNrZXRTY29yZXMoc2VsZWN0ZWRKb2JJZHMsIC8vIE5vdGUgdGhlcmUgaXMgYW4gb3B0aW1pemF0aW9uIGZvciB3aGVuIHRvcF9uID09IDEuCiAgICAvLyBJZiB0b3BfbiA+IDEsIHdlIHNob3VsZCB0ZXN0IHdoYXQgaGFwcGVucyB3aGVuIHRoZSByZXF1ZXN0IHRha2VzIGxvbmcKICAgIC8vIGFuZCByZWZhY3RvciB0aGUgbG9hZGluZyBjYWxscywgaWYgbmVjZXNzYXJ5LCB0byBhdm9pZCBkZWxheXMgaW4gbG9hZGluZyBvdGhlciBjb21wb25lbnRzLgogICAgMSwgb3ZlcmFsbEJ1Y2tldHNCb3VuZHMubWluLnZhbHVlT2YoKSwgb3ZlcmFsbEJ1Y2tldHNCb3VuZHMubWF4LnZhbHVlT2YoKSwgaW50ZXJ2YWwuYXNTZWNvbmRzKCkgKyAncycpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgdmFyIG92ZXJhbGxTd2ltbGFuZURhdGEgPSBwcm9jZXNzT3ZlcmFsbFJlc3VsdHMocmVzcC5yZXN1bHRzLCBzZWFyY2hCb3VuZHMsIGludGVydmFsLmFzU2Vjb25kcygpKTsKICAgICAgY29uc29sZS5sb2coJ0V4cGxvcmVyIG92ZXJhbGwgc3dpbWxhbmUgZGF0YSBzZXQ6Jywgb3ZlcmFsbFN3aW1sYW5lRGF0YSk7CiAgICAgIHJlc29sdmUoewogICAgICAgIGxvYWRpbmc6IGZhbHNlLAogICAgICAgIG92ZXJhbGxTd2ltbGFuZURhdGE6IG92ZXJhbGxTd2ltbGFuZURhdGEKICAgICAgfSk7CiAgICB9KTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZFZpZXdCeVN3aW1sYW5lKGZpZWxkVmFsdWVzLCBib3VuZHMsIHNlbGVjdGVkSm9icywgdmlld0J5U3dpbWxhbmVGaWVsZE5hbWUsIHN3aW1sYW5lTGltaXQsIGluZmx1ZW5jZXJzRmlsdGVyUXVlcnksIG5vSW5mbHVlbmNlcnNDb25maWd1cmVkKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICB2YXIgZmluaXNoID0gZnVuY3Rpb24gZmluaXNoKHJlc3ApIHsKICAgICAgaWYgKHJlc3AgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciB2aWV3QnlTd2ltbGFuZURhdGEgPSBwcm9jZXNzVmlld0J5UmVzdWx0cyhyZXNwLnJlc3VsdHMsIGZpZWxkVmFsdWVzLCBib3VuZHMsIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lLCBnZXRTd2ltbGFuZUJ1Y2tldEludGVydmFsKHNlbGVjdGVkSm9icywgKDAsIF9sZWdhY3lfdXRpbHMuZ2V0U3dpbWxhbmVDb250YWluZXJXaWR0aCkobm9JbmZsdWVuY2Vyc0NvbmZpZ3VyZWQpKS5hc1NlY29uZHMoKSk7CiAgICAgICAgY29uc29sZS5sb2coJ0V4cGxvcmVyIHZpZXcgYnkgc3dpbWxhbmUgZGF0YSBzZXQ6Jywgdmlld0J5U3dpbWxhbmVEYXRhKTsKICAgICAgICByZXNvbHZlKHsKICAgICAgICAgIHZpZXdCeVN3aW1sYW5lRGF0YTogdmlld0J5U3dpbWxhbmVEYXRhLAogICAgICAgICAgdmlld0J5U3dpbWxhbmVEYXRhTG9hZGluZzogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNvbHZlKHsKICAgICAgICAgIHZpZXdCeVN3aW1sYW5lRGF0YUxvYWRpbmc6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgaWYgKHNlbGVjdGVkSm9icyA9PT0gdW5kZWZpbmVkIHx8IHZpZXdCeVN3aW1sYW5lRmllbGROYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgZmluaXNoKCk7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEVuc3VyZSB0aGUgc2VhcmNoIGJvdW5kcyBhbGlnbiB0byB0aGUgYnVja2V0aW5nIGludGVydmFsIHVzZWQgaW4gdGhlIHN3aW1sYW5lIHNvCiAgICAgIC8vIHRoYXQgdGhlIGZpcnN0IGFuZCBsYXN0IGJ1Y2tldHMgYXJlIGNvbXBsZXRlLgogICAgICB2YXIgdGltZWZpbHRlckJvdW5kcyA9IF90aW1lZmlsdGVyLnRpbWVmaWx0ZXIuZ2V0QWN0aXZlQm91bmRzKCk7CgogICAgICB2YXIgc2VhcmNoQm91bmRzID0gKDAsIF90aW1lX2J1Y2tldHMuZ2V0Qm91bmRzUm91bmRlZFRvSW50ZXJ2YWwpKHRpbWVmaWx0ZXJCb3VuZHMsIGdldFN3aW1sYW5lQnVja2V0SW50ZXJ2YWwoc2VsZWN0ZWRKb2JzLCAoMCwgX2xlZ2FjeV91dGlscy5nZXRTd2ltbGFuZUNvbnRhaW5lcldpZHRoKShub0luZmx1ZW5jZXJzQ29uZmlndXJlZCkpLCBmYWxzZSk7CiAgICAgIHZhciBzZWxlY3RlZEpvYklkcyA9IHNlbGVjdGVkSm9icy5tYXAoZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gZC5pZDsKICAgICAgfSk7IC8vIGxvYWQgc2NvcmVzIGJ5IGluZmx1ZW5jZXIvam9iSWQgdmFsdWUgYW5kIHRpbWUuCiAgICAgIC8vIFBhc3MgdGhlIGludGVydmFsIGluIHNlY29uZHMgYXMgdGhlIHN3aW1sYW5lIHJlbGllcyBvbiBhIGZpeGVkIG51bWJlciBvZiBzZWNvbmRzIGJldHdlZW4gYnVja2V0cwogICAgICAvLyB3aGljaCB3b3VsZG4ndCBiZSB0aGUgY2FzZSBpZiBlLmcuICcxTScgd2FzIHVzZWQuCgogICAgICB2YXIgaW50ZXJ2YWwgPSAiIi5jb25jYXQoZ2V0U3dpbWxhbmVCdWNrZXRJbnRlcnZhbChzZWxlY3RlZEpvYnMsICgwLCBfbGVnYWN5X3V0aWxzLmdldFN3aW1sYW5lQ29udGFpbmVyV2lkdGgpKG5vSW5mbHVlbmNlcnNDb25maWd1cmVkKSkuYXNTZWNvbmRzKCksICJzIik7CgogICAgICBpZiAodmlld0J5U3dpbWxhbmVGaWVsZE5hbWUgIT09IF9leHBsb3Jlcl9jb25zdGFudHMuVklFV19CWV9KT0JfTEFCRUwpIHsKICAgICAgICBfcmVzdWx0c19zZXJ2aWNlLm1sUmVzdWx0c1NlcnZpY2UuZ2V0SW5mbHVlbmNlclZhbHVlTWF4U2NvcmVCeVRpbWUoc2VsZWN0ZWRKb2JJZHMsIHZpZXdCeVN3aW1sYW5lRmllbGROYW1lLCBmaWVsZFZhbHVlcywgc2VhcmNoQm91bmRzLm1pbi52YWx1ZU9mKCksIHNlYXJjaEJvdW5kcy5tYXgudmFsdWVPZigpLCBpbnRlcnZhbCwgc3dpbWxhbmVMaW1pdCwgaW5mbHVlbmNlcnNGaWx0ZXJRdWVyeSkudGhlbihmaW5pc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBfam9iSWRzID0gZmllbGRWYWx1ZXMgIT09IHVuZGVmaW5lZCAmJiBmaWVsZFZhbHVlcy5sZW5ndGggPiAwID8gZmllbGRWYWx1ZXMgOiBzZWxlY3RlZEpvYklkczsKCiAgICAgICAgX3Jlc3VsdHNfc2VydmljZS5tbFJlc3VsdHNTZXJ2aWNlLmdldFNjb3Jlc0J5QnVja2V0KF9qb2JJZHMsIHNlYXJjaEJvdW5kcy5taW4udmFsdWVPZigpLCBzZWFyY2hCb3VuZHMubWF4LnZhbHVlT2YoKSwgaW50ZXJ2YWwsIHN3aW1sYW5lTGltaXQpLnRoZW4oZmluaXNoKTsKICAgICAgfQogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBsb2FkVG9wSW5mbHVlbmNlcnMoc2VsZWN0ZWRKb2JJZHMsIGVhcmxpZXN0TXMsIGxhdGVzdE1zKSB7CiAgdmFyIGluZmx1ZW5jZXJzLAogICAgICBub0luZmx1ZW5jZXJzQ29uZmlndXJlZCwKICAgICAgaW5mbHVlbmNlcnNGaWx0ZXJRdWVyeSwKICAgICAgX2FyZ3M0ID0gYXJndW1lbnRzOwogIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gbG9hZFRvcEluZmx1ZW5jZXJzJChfY29udGV4dDQpIHsKICAgIHdoaWxlICgxKSB7CiAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIGluZmx1ZW5jZXJzID0gX2FyZ3M0Lmxlbmd0aCA+IDMgJiYgX2FyZ3M0WzNdICE9PSB1bmRlZmluZWQgPyBfYXJnczRbM10gOiBbXTsKICAgICAgICAgIG5vSW5mbHVlbmNlcnNDb25maWd1cmVkID0gX2FyZ3M0Lmxlbmd0aCA+IDQgPyBfYXJnczRbNF0gOiB1bmRlZmluZWQ7CiAgICAgICAgICBpbmZsdWVuY2Vyc0ZpbHRlclF1ZXJ5ID0gX2FyZ3M0Lmxlbmd0aCA+IDUgPyBfYXJnczRbNV0gOiB1bmRlZmluZWQ7CiAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgICAgaWYgKG5vSW5mbHVlbmNlcnNDb25maWd1cmVkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgX3Jlc3VsdHNfc2VydmljZS5tbFJlc3VsdHNTZXJ2aWNlLmdldFRvcEluZmx1ZW5jZXJzKHNlbGVjdGVkSm9iSWRzLCBlYXJsaWVzdE1zLCBsYXRlc3RNcywgX2V4cGxvcmVyX2NvbnN0YW50cy5NQVhfSU5GTFVFTkNFUl9GSUVMRF9WQUxVRVMsIGluZmx1ZW5jZXJzLCBpbmZsdWVuY2Vyc0ZpbHRlclF1ZXJ5KS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAgICAgICAvLyBUT0RPIC0gc29ydCB0aGUgaW5mbHVlbmNlcnMga2V5cyBzbyB0aGF0IHRoZSBwYXJ0aXRpb24gZmllbGQocykgYXJlIGZpcnN0LgogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0V4cGxvcmVyIHRvcCBpbmZsdWVuY2VycyBkYXRhIHNldDonLCByZXNwLmluZmx1ZW5jZXJzKTsKICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcC5pbmZsdWVuY2Vycyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSh7fSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKTsKCiAgICAgICAgY2FzZSA0OgogICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgfQogICAgfQogIH0pOwp9"},null]}