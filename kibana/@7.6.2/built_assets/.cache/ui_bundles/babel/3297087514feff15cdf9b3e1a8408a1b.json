{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/ml/public/application/timeseriesexplorer/timeseriesexplorer.js","dependencies":[{"path":"x-pack/legacy/plugins/ml/public/application/timeseriesexplorer/timeseriesexplorer.js","mtime":1585205045988},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlRpbWVTZXJpZXNFeHBsb3JlciA9IHZvaWQgMDsKCnZhciBfbG9kYXNoID0gcmVxdWlyZSgibG9kYXNoIik7Cgp2YXIgX21vbWVudFRpbWV6b25lID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJtb21lbnQtdGltZXpvbmUiKSk7Cgp2YXIgX3J4anMgPSByZXF1aXJlKCJyeGpzIik7Cgp2YXIgX29wZXJhdG9ycyA9IHJlcXVpcmUoInJ4anMvb3BlcmF0b3JzIik7Cgp2YXIgX3Byb3BUeXBlcyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgicHJvcC10eXBlcyIpKTsKCnZhciBfcmVhY3QgPSBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChyZXF1aXJlKCJyZWFjdCIpKTsKCnZhciBfaTE4biA9IHJlcXVpcmUoIkBrYm4vaTE4biIpOwoKdmFyIF9yZWFjdDIgPSByZXF1aXJlKCJAa2JuL2kxOG4vcmVhY3QiKTsKCnZhciBfZXVpID0gcmVxdWlyZSgiQGVsYXN0aWMvZXVpIik7Cgp2YXIgX2Nocm9tZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgidWkvY2hyb21lIikpOwoKdmFyIF9ub3RpZnkgPSByZXF1aXJlKCJ1aS9ub3RpZnkiKTsKCnZhciBfcHVibGljID0gcmVxdWlyZSgiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL3BsdWdpbnMva2liYW5hX3V0aWxzL3B1YmxpYyIpOwoKdmFyIF9zZWFyY2ggPSByZXF1aXJlKCIuLi8uLi8uLi9jb21tb24vY29uc3RhbnRzL3NlYXJjaCIpOwoKdmFyIF9qb2JfdXRpbHMgPSByZXF1aXJlKCIuLi8uLi8uLi9jb21tb24vdXRpbC9qb2JfdXRpbHMiKTsKCnZhciBfYW5ub3RhdGlvbl9mbHlvdXQgPSByZXF1aXJlKCIuLi9jb21wb25lbnRzL2Fubm90YXRpb25zL2Fubm90YXRpb25fZmx5b3V0Iik7Cgp2YXIgX2Fubm90YXRpb25zX3RhYmxlID0gcmVxdWlyZSgiLi4vY29tcG9uZW50cy9hbm5vdGF0aW9ucy9hbm5vdGF0aW9uc190YWJsZSIpOwoKdmFyIF9hbm9tYWxpZXNfdGFibGUgPSByZXF1aXJlKCIuLi9jb21wb25lbnRzL2Fub21hbGllc190YWJsZS9hbm9tYWxpZXNfdGFibGUiKTsKCnZhciBfY2hhcnRfdG9vbHRpcCA9IHJlcXVpcmUoIi4uL2NvbXBvbmVudHMvY2hhcnRfdG9vbHRpcCIpOwoKdmFyIF9lbnRpdHlfY29udHJvbCA9IHJlcXVpcmUoIi4vY29tcG9uZW50cy9lbnRpdHlfY29udHJvbCIpOwoKdmFyIF9mb3JlY2FzdGluZ19tb2RhbCA9IHJlcXVpcmUoIi4vY29tcG9uZW50cy9mb3JlY2FzdGluZ19tb2RhbC9mb3JlY2FzdGluZ19tb2RhbCIpOwoKdmFyIF9sb2FkaW5nX2luZGljYXRvciA9IHJlcXVpcmUoIi4uL2NvbXBvbmVudHMvbG9hZGluZ19pbmRpY2F0b3IvbG9hZGluZ19pbmRpY2F0b3IiKTsKCnZhciBfc2VsZWN0X2ludGVydmFsID0gcmVxdWlyZSgiLi4vY29tcG9uZW50cy9jb250cm9scy9zZWxlY3RfaW50ZXJ2YWwvc2VsZWN0X2ludGVydmFsIik7Cgp2YXIgX3NlbGVjdF9zZXZlcml0eSA9IHJlcXVpcmUoIi4uL2NvbXBvbmVudHMvY29udHJvbHMvc2VsZWN0X3NldmVyaXR5L3NlbGVjdF9zZXZlcml0eSIpOwoKdmFyIF90aW1lc2VyaWVzX2NoYXJ0ID0gcmVxdWlyZSgiLi9jb21wb25lbnRzL3RpbWVzZXJpZXNfY2hhcnQvdGltZXNlcmllc19jaGFydCIpOwoKdmFyIF90aW1lc2VyaWVzZXhwbG9yZXJfbm9fY2hhcnRfZGF0YSA9IHJlcXVpcmUoIi4vY29tcG9uZW50cy90aW1lc2VyaWVzZXhwbG9yZXJfbm9fY2hhcnRfZGF0YSIpOwoKdmFyIF90aW1lc2VyaWVzZXhwbG9yZXJfcGFnZSA9IHJlcXVpcmUoIi4vdGltZXNlcmllc2V4cGxvcmVyX3BhZ2UiKTsKCnZhciBfbWxfYXBpX3NlcnZpY2UgPSByZXF1aXJlKCIuLi9zZXJ2aWNlcy9tbF9hcGlfc2VydmljZSIpOwoKdmFyIF9maWVsZF9mb3JtYXRfc2VydmljZSA9IHJlcXVpcmUoIi4uL3NlcnZpY2VzL2ZpZWxkX2Zvcm1hdF9zZXJ2aWNlIik7Cgp2YXIgX2ZvcmVjYXN0X3NlcnZpY2UgPSByZXF1aXJlKCIuLi9zZXJ2aWNlcy9mb3JlY2FzdF9zZXJ2aWNlIik7Cgp2YXIgX2pvYl9zZXJ2aWNlID0gcmVxdWlyZSgiLi4vc2VydmljZXMvam9iX3NlcnZpY2UiKTsKCnZhciBfcmVzdWx0c19zZXJ2aWNlID0gcmVxdWlyZSgiLi4vc2VydmljZXMvcmVzdWx0c19zZXJ2aWNlIik7Cgp2YXIgX3RpbWVfYnVja2V0cyA9IHJlcXVpcmUoIi4uL3V0aWwvdGltZV9idWNrZXRzIik7Cgp2YXIgX3RpbWVzZXJpZXNleHBsb3Jlcl9jb25zdGFudHMgPSByZXF1aXJlKCIuL3RpbWVzZXJpZXNleHBsb3Jlcl9jb25zdGFudHMiKTsKCnZhciBfdGltZXNlcmllc19zZWFyY2hfc2VydmljZSA9IHJlcXVpcmUoIi4vdGltZXNlcmllc19zZWFyY2hfc2VydmljZSIpOwoKdmFyIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMgPSByZXF1aXJlKCIuL3RpbWVzZXJpZXNleHBsb3Jlcl91dGlscyIpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqKSB7IGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBlbHNlIHsgdmFyIG5ld09iaiA9IHt9OyBpZiAob2JqICE9IG51bGwpIHsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiB7fTsgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IH0gbmV3T2JqLmRlZmF1bHQgPSBvYmo7IHJldHVybiBuZXdPYmo7IH0gfQoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiKSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gdHlwZW9mIG9iajsgfTsgfSBlbHNlIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7IH07IH0gcmV0dXJuIF90eXBlb2Yob2JqKTsgfQoKZnVuY3Rpb24gX2V4dGVuZHMoKSB7IF9leHRlbmRzID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbiAodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07IGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XTsgfSB9IH0gcmV0dXJuIHRhcmdldDsgfTsgcmV0dXJuIF9leHRlbmRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0KCmZ1bmN0aW9uIF9zbGljZWRUb0FycmF5KGFyciwgaSkgeyByZXR1cm4gX2FycmF5V2l0aEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheUxpbWl0KGFyciwgaSkgfHwgX25vbkl0ZXJhYmxlUmVzdCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVSZXN0KCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIik7IH0KCmZ1bmN0aW9uIF9pdGVyYWJsZVRvQXJyYXlMaW1pdChhcnIsIGkpIHsgdmFyIF9hcnIgPSBbXTsgdmFyIF9uID0gdHJ1ZTsgdmFyIF9kID0gZmFsc2U7IHZhciBfZSA9IHVuZGVmaW5lZDsgdHJ5IHsgZm9yICh2YXIgX2kgPSBhcnJbU3ltYm9sLml0ZXJhdG9yXSgpLCBfczsgIShfbiA9IChfcyA9IF9pLm5leHQoKSkuZG9uZSk7IF9uID0gdHJ1ZSkgeyBfYXJyLnB1c2goX3MudmFsdWUpOyBpZiAoaSAmJiBfYXJyLmxlbmd0aCA9PT0gaSkgYnJlYWs7IH0gfSBjYXRjaCAoZXJyKSB7IF9kID0gdHJ1ZTsgX2UgPSBlcnI7IH0gZmluYWxseSB7IHRyeSB7IGlmICghX24gJiYgX2lbInJldHVybiJdICE9IG51bGwpIF9pWyJyZXR1cm4iXSgpOyB9IGZpbmFsbHkgeyBpZiAoX2QpIHRocm93IF9lOyB9IH0gcmV0dXJuIF9hcnI7IH0KCmZ1bmN0aW9uIF9hcnJheVdpdGhIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgcmV0dXJuIGFycjsgfQoKZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KGFycikgeyByZXR1cm4gX2FycmF5V2l0aG91dEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheShhcnIpIHx8IF9ub25JdGVyYWJsZVNwcmVhZCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVTcHJlYWQoKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIik7IH0KCmZ1bmN0aW9uIF9pdGVyYWJsZVRvQXJyYXkoaXRlcikgeyBpZiAoU3ltYm9sLml0ZXJhdG9yIGluIE9iamVjdChpdGVyKSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaXRlcikgPT09ICJbb2JqZWN0IEFyZ3VtZW50c10iKSByZXR1cm4gQXJyYXkuZnJvbShpdGVyKTsgfQoKZnVuY3Rpb24gX2FycmF5V2l0aG91dEhvbGVzKGFycikgeyBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGFyci5sZW5ndGgpOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0gfQoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhzb3VyY2UsIHRydWUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTsgfSk7IH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMpIHsgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhzb3VyY2UpKTsgfSBlbHNlIHsgb3duS2V5cyhzb3VyY2UpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpKTsgfSk7IH0gfSByZXR1cm4gdGFyZ2V0OyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oc2VsZiwgY2FsbCkgeyBpZiAoY2FsbCAmJiAoX3R5cGVvZihjYWxsKSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGNhbGwgPT09ICJmdW5jdGlvbiIpKSB7IHJldHVybiBjYWxsOyB9IHJldHVybiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpOyB9CgpmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyBfZ2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3QuZ2V0UHJvdG90eXBlT2YgOiBmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyByZXR1cm4gby5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG8pOyB9OyByZXR1cm4gX2dldFByb3RvdHlwZU9mKG8pOyB9CgpmdW5jdGlvbiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpIHsgaWYgKHNlbGYgPT09IHZvaWQgMCkgeyB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOyB9IHJldHVybiBzZWxmOyB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAiZnVuY3Rpb24iICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBfc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpOyB9CgpmdW5jdGlvbiBfc2V0UHJvdG90eXBlT2YobywgcCkgeyBfc2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwgZnVuY3Rpb24gX3NldFByb3RvdHlwZU9mKG8sIHApIHsgby5fX3Byb3RvX18gPSBwOyByZXR1cm4gbzsgfTsgcmV0dXJuIF9zZXRQcm90b3R5cGVPZihvLCBwKTsgfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkgeyBpZiAoa2V5IGluIG9iaikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsgdmFsdWU6IHZhbHVlLCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pOyB9IGVsc2UgeyBvYmpba2V5XSA9IHZhbHVlOyB9IHJldHVybiBvYmo7IH0KCnZhciBtbEFubm90YXRpb25zRW5hYmxlZCA9IF9jaHJvbWUuZGVmYXVsdC5nZXRJbmplY3RlZCgnbWxBbm5vdGF0aW9uc0VuYWJsZWQnLCBmYWxzZSk7IC8vIFVzZWQgdG8gaW5kaWNhdGUgdGhlIGNoYXJ0IGlzIGJlaW5nIHBsb3R0ZWQgYWNyb3NzCi8vIGFsbCBwYXJ0aXRpb24gZmllbGQgdmFsdWVzLCB3aGVyZSB0aGUgY2FyZGluYWxpdHkgb2YgdGhlIGZpZWxkIGNhbm5vdCBiZQovLyBvYnRhaW5lZCBhcyBpdCBpcyBub3QgYWdncmVnYXRhYmxlIGUuZy4gJ2FsbCBkaXN0aW5jdCBrcGlfaW5kaWNhdG9yIHZhbHVlcycKCgp2YXIgYWxsVmFsdWVzTGFiZWwgPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLmFsbFBhcnRpdGlvblZhbHVlc0xhYmVsJywgewogIGRlZmF1bHRNZXNzYWdlOiAnYWxsJwp9KTsKCmZ1bmN0aW9uIGdldEVudGl0eUNvbnRyb2xPcHRpb25zKGZpZWxkVmFsdWVzKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGZpZWxkVmFsdWVzKSkgewogICAgcmV0dXJuIFtdOwogIH0KCiAgZmllbGRWYWx1ZXMuc29ydCgpOwogIHJldHVybiBmaWVsZFZhbHVlcy5tYXAoZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gewogICAgICBsYWJlbDogdmFsdWUKICAgIH07CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFZpZXdhYmxlRGV0ZWN0b3JzKHNlbGVjdGVkSm9iKSB7CiAgdmFyIGpvYkRldGVjdG9ycyA9IHNlbGVjdGVkSm9iLmFuYWx5c2lzX2NvbmZpZy5kZXRlY3RvcnM7CiAgdmFyIHZpZXdhYmxlRGV0ZWN0b3JzID0gW107CiAgKDAsIF9sb2Rhc2guZWFjaCkoam9iRGV0ZWN0b3JzLCBmdW5jdGlvbiAoZHRyLCBpbmRleCkgewogICAgaWYgKCgwLCBfam9iX3V0aWxzLmlzVGltZVNlcmllc1ZpZXdEZXRlY3Rvcikoc2VsZWN0ZWRKb2IsIGluZGV4KSkgewogICAgICB2aWV3YWJsZURldGVjdG9ycy5wdXNoKHsKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgZGV0ZWN0b3JfZGVzY3JpcHRpb246IGR0ci5kZXRlY3Rvcl9kZXNjcmlwdGlvbgogICAgICB9KTsKICAgIH0KICB9KTsKICByZXR1cm4gdmlld2FibGVEZXRlY3RvcnM7Cn0KCmZ1bmN0aW9uIGdldFRpbWVzZXJpZXNleHBsb3JlckRlZmF1bHRTdGF0ZSgpIHsKICByZXR1cm4gewogICAgY2hhcnREZXRhaWxzOiB1bmRlZmluZWQsCiAgICBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbDogdW5kZWZpbmVkLAogICAgY29udGV4dENoYXJ0RGF0YTogdW5kZWZpbmVkLAogICAgY29udGV4dEZvcmVjYXN0RGF0YTogdW5kZWZpbmVkLAogICAgLy8gTm90IGNoYXJ0YWJsZSBpZiBlLmcuIG1vZGVsIHBsb3Qgd2l0aCB0ZXJtcyBmb3IgYSB2YXJwIGRldGVjdG9yCiAgICBkYXRhTm90Q2hhcnRhYmxlOiBmYWxzZSwKICAgIGVudGl0aWVzTG9hZGluZzogZmFsc2UsCiAgICBlbnRpdHlWYWx1ZXM6IHt9LAogICAgZm9jdXNBbm5vdGF0aW9uRGF0YTogW10sCiAgICBmb2N1c0NoYXJ0RGF0YTogdW5kZWZpbmVkLAogICAgZm9jdXNGb3JlY2FzdERhdGE6IHVuZGVmaW5lZCwKICAgIGZ1bGxSZWZyZXNoOiB0cnVlLAogICAgaGFzUmVzdWx0czogZmFsc2UsCiAgICAvLyBDb3VudGVyIHRvIGtlZXAgdHJhY2sgb2Ygd2hhdCBkYXRhIHNldHMgaGF2ZSBiZWVuIGxvYWRlZC4KICAgIGxvYWRDb3VudGVyOiAwLAogICAgbG9hZGluZzogZmFsc2UsCiAgICBtb2RlbFBsb3RFbmFibGVkOiBmYWxzZSwKICAgIC8vIFRvZ2dsZXMgZGlzcGxheSBvZiBhbm5vdGF0aW9ucyBpbiB0aGUgZm9jdXMgY2hhcnQKICAgIHNob3dBbm5vdGF0aW9uczogbWxBbm5vdGF0aW9uc0VuYWJsZWQsCiAgICBzaG93QW5ub3RhdGlvbnNDaGVja2JveDogbWxBbm5vdGF0aW9uc0VuYWJsZWQsCiAgICAvLyBUb2dnbGVzIGRpc3BsYXkgb2YgZm9yZWNhc3QgZGF0YSBpbiB0aGUgZm9jdXMgY2hhcnQKICAgIHNob3dGb3JlY2FzdDogdHJ1ZSwKICAgIHNob3dGb3JlY2FzdENoZWNrYm94OiBmYWxzZSwKICAgIC8vIFRvZ2dsZXMgZGlzcGxheSBvZiBtb2RlbCBib3VuZHMgaW4gdGhlIGZvY3VzIGNoYXJ0CiAgICBzaG93TW9kZWxCb3VuZHM6IHRydWUsCiAgICBzaG93TW9kZWxCb3VuZHNDaGVja2JveDogZmFsc2UsCiAgICBzdmdXaWR0aDogMCwKICAgIHRhYmxlRGF0YTogdW5kZWZpbmVkLAogICAgem9vbUZyb206IHVuZGVmaW5lZCwKICAgIHpvb21UbzogdW5kZWZpbmVkLAogICAgem9vbUZyb21Gb2N1c0xvYWRlZDogdW5kZWZpbmVkLAogICAgem9vbVRvRm9jdXNMb2FkZWQ6IHVuZGVmaW5lZAogIH07Cn0KCnZhciBjb250YWluZXJQYWRkaW5nID0gMjQ7Cgp2YXIgVGltZVNlcmllc0V4cGxvcmVyID0KLyojX19QVVJFX18qLwpmdW5jdGlvbiAoX1JlYWN0JENvbXBvbmVudCkgewogIF9pbmhlcml0cyhUaW1lU2VyaWVzRXhwbG9yZXIsIF9SZWFjdCRDb21wb25lbnQpOwoKICBmdW5jdGlvbiBUaW1lU2VyaWVzRXhwbG9yZXIoKSB7CiAgICB2YXIgX2dldFByb3RvdHlwZU9mMjsKCiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFRpbWVTZXJpZXNFeHBsb3Jlcik7CgogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgX3RoaXMgPSBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCAoX2dldFByb3RvdHlwZU9mMiA9IF9nZXRQcm90b3R5cGVPZihUaW1lU2VyaWVzRXhwbG9yZXIpKS5jYWxsLmFwcGx5KF9nZXRQcm90b3R5cGVPZjIsIFt0aGlzXS5jb25jYXQoYXJncykpKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIGdldFRpbWVzZXJpZXNleHBsb3JlckRlZmF1bHRTdGF0ZSgpKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdWJzY3JpcHRpb25zIiwgbmV3IF9yeGpzLlN1YnNjcmlwdGlvbigpKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJyZXNpemVSZWYiLCAoMCwgX3JlYWN0LmNyZWF0ZVJlZikoKSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAicmVzaXplQ2hlY2tlciIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAicmVzaXplSGFuZGxlciIsIGZ1bmN0aW9uICgpIHsKICAgICAgX3RoaXMuc2V0U3RhdGUoewogICAgICAgIHN2Z1dpZHRoOiBfdGhpcy5yZXNpemVSZWYuY3VycmVudCAhPT0gbnVsbCA/IF90aGlzLnJlc2l6ZVJlZi5jdXJyZW50Lm9mZnNldFdpZHRoIC0gY29udGFpbmVyUGFkZGluZyA6IDAKICAgICAgfSk7CiAgICB9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJjb250ZXh0Q2hhcnQkIiwgbmV3IF9yeGpzLlN1YmplY3QoKSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2V0RmllbGROYW1lc1dpdGhFbXB0eVZhbHVlcyIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxhdGVzdEVudGl0eUNvbnRyb2xzID0gX3RoaXMuZ2V0Q29udHJvbHNGb3JEZXRlY3RvcigpOwoKICAgICAgcmV0dXJuIGxhdGVzdEVudGl0eUNvbnRyb2xzLmZpbHRlcihmdW5jdGlvbiAoX3JlZikgewogICAgICAgIHZhciBmaWVsZFZhbHVlID0gX3JlZi5maWVsZFZhbHVlOwogICAgICAgIHJldHVybiAhZmllbGRWYWx1ZTsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChfcmVmMikgewogICAgICAgIHZhciBmaWVsZE5hbWUgPSBfcmVmMi5maWVsZE5hbWU7CiAgICAgICAgcmV0dXJuIGZpZWxkTmFtZTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhcmVQYXJ0aXRpb25pbmdGaWVsZHNQcm92aWRlZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGZpZWxkTmFtZXNXaXRoRW1wdHlWYWx1ZXMgPSBfdGhpcy5nZXRGaWVsZE5hbWVzV2l0aEVtcHR5VmFsdWVzKCk7CgogICAgICByZXR1cm4gZmllbGROYW1lc1dpdGhFbXB0eVZhbHVlcy5sZW5ndGggPT09IDA7CiAgICB9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJkZXRlY3RvckluZGV4Q2hhbmdlSGFuZGxlciIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciBhcHBTdGF0ZUhhbmRsZXIgPSBfdGhpcy5wcm9wcy5hcHBTdGF0ZUhhbmRsZXI7CiAgICAgIHZhciBpZCA9IGUudGFyZ2V0LnZhbHVlOwoKICAgICAgaWYgKGlkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBhcHBTdGF0ZUhhbmRsZXIoX3RpbWVzZXJpZXNleHBsb3Jlcl9jb25zdGFudHMuQVBQX1NUQVRFX0FDVElPTi5TRVRfREVURUNUT1JfSU5ERVgsICtpZCk7CiAgICAgIH0KICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInRvZ2dsZVNob3dBbm5vdGF0aW9uc0hhbmRsZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChtbEFubm90YXRpb25zRW5hYmxlZCkgewogICAgICAgIF90aGlzLnNldFN0YXRlKGZ1bmN0aW9uIChwcmV2U3RhdGUpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHNob3dBbm5vdGF0aW9uczogIXByZXZTdGF0ZS5zaG93QW5ub3RhdGlvbnMKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInRvZ2dsZVNob3dGb3JlY2FzdEhhbmRsZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLnNldFN0YXRlKGZ1bmN0aW9uIChwcmV2U3RhdGUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc2hvd0ZvcmVjYXN0OiAhcHJldlN0YXRlLnNob3dGb3JlY2FzdAogICAgICAgIH07CiAgICAgIH0pOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAidG9nZ2xlU2hvd01vZGVsQm91bmRzSGFuZGxlciIsIGZ1bmN0aW9uICgpIHsKICAgICAgX3RoaXMuc2V0U3RhdGUoewogICAgICAgIHNob3dNb2RlbEJvdW5kczogIV90aGlzLnN0YXRlLnNob3dNb2RlbEJvdW5kcwogICAgICB9KTsKICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInByZXZpb3VzQ2hhcnRQcm9wcyIsIHt9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJwcmV2aW91c1Nob3dBbm5vdGF0aW9ucyIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAicHJldmlvdXNTaG93Rm9yZWNhc3QiLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInByZXZpb3VzU2hvd01vZGVsQm91bmRzIiwgdW5kZWZpbmVkKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJ0YWJsZUZpbHRlciIsIGZ1bmN0aW9uIChmaWVsZCwgdmFsdWUsIG9wZXJhdG9yKSB7CiAgICAgIHZhciBlbnRpdGllcyA9IF90aGlzLmdldENvbnRyb2xzRm9yRGV0ZWN0b3IoKTsKCiAgICAgIHZhciBlbnRpdHkgPSBlbnRpdGllcy5maW5kKGZ1bmN0aW9uIChfcmVmMykgewogICAgICAgIHZhciBmaWVsZE5hbWUgPSBfcmVmMy5maWVsZE5hbWU7CiAgICAgICAgcmV0dXJuIGZpZWxkTmFtZSA9PT0gZmllbGQ7CiAgICAgIH0pOwoKICAgICAgaWYgKGVudGl0eSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgYXBwU3RhdGVIYW5kbGVyID0gX3RoaXMucHJvcHMuYXBwU3RhdGVIYW5kbGVyOwogICAgICB2YXIgcmVzdWx0VmFsdWUgPSAnJzsKCiAgICAgIGlmIChvcGVyYXRvciA9PT0gJysnICYmIGVudGl0eS5maWVsZFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHJlc3VsdFZhbHVlID0gdmFsdWU7CiAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3IgPT09ICctJyAmJiBlbnRpdHkuZmllbGRWYWx1ZSA9PT0gdmFsdWUpIHsKICAgICAgICByZXN1bHRWYWx1ZSA9ICcnOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHJlc3VsdEVudGl0aWVzID0gX29iamVjdFNwcmVhZCh7fSwgZW50aXRpZXMucmVkdWNlKGZ1bmN0aW9uIChhcHBTdGF0ZUVudGl0aWVzLCBhcHBTdGF0ZUVudGl0eSkgewogICAgICAgIGFwcFN0YXRlRW50aXRpZXNbYXBwU3RhdGVFbnRpdHkuZmllbGROYW1lXSA9IGFwcFN0YXRlRW50aXR5LmZpZWxkVmFsdWU7CiAgICAgICAgcmV0dXJuIGFwcFN0YXRlRW50aXRpZXM7CiAgICAgIH0sIHt9KSwgX2RlZmluZVByb3BlcnR5KHt9LCBlbnRpdHkuZmllbGROYW1lLCByZXN1bHRWYWx1ZSkpOwoKICAgICAgYXBwU3RhdGVIYW5kbGVyKF90aW1lc2VyaWVzZXhwbG9yZXJfY29uc3RhbnRzLkFQUF9TVEFURV9BQ1RJT04uU0VUX0VOVElUSUVTLCByZXN1bHRFbnRpdGllcyk7CiAgICB9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJjb250ZXh0Q2hhcnRTZWxlY3RlZEluaXRDYWxsRG9uZSIsIGZhbHNlKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJjb250ZXh0Q2hhcnRTZWxlY3RlZCIsIGZ1bmN0aW9uIChzZWxlY3Rpb24pIHsKICAgICAgdmFyIHpvb21TdGF0ZSA9IHsKICAgICAgICBmcm9tOiBzZWxlY3Rpb24uZnJvbS50b0lTT1N0cmluZygpLAogICAgICAgIHRvOiBzZWxlY3Rpb24udG8udG9JU09TdHJpbmcoKQogICAgICB9OwoKICAgICAgaWYgKCgwLCBfbG9kYXNoLmlzRXF1YWwpKF90aGlzLnByb3BzLnpvb20sIHpvb21TdGF0ZSkgJiYgX3RoaXMuc3RhdGUuZm9jdXNDaGFydERhdGEgIT09IHVuZGVmaW5lZCAmJiBfdGhpcy5wcm9wcy5wcmV2aW91c1JlZnJlc2ggPT09IF90aGlzLnByb3BzLmxhc3RSZWZyZXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBfdGhpcy5jb250ZXh0Q2hhcnQkLm5leHQoc2VsZWN0aW9uKTsKCiAgICAgIF90aGlzLnByb3BzLmFwcFN0YXRlSGFuZGxlcihfdGltZXNlcmllc2V4cGxvcmVyX2NvbnN0YW50cy5BUFBfU1RBVEVfQUNUSU9OLlNFVF9aT09NLCB6b29tU3RhdGUpOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZW50aXR5RmllbGRWYWx1ZUNoYW5nZWQiLCBmdW5jdGlvbiAoZW50aXR5LCBmaWVsZFZhbHVlKSB7CiAgICAgIHZhciBhcHBTdGF0ZUhhbmRsZXIgPSBfdGhpcy5wcm9wcy5hcHBTdGF0ZUhhbmRsZXI7CgogICAgICB2YXIgZW50aXR5Q29udHJvbHMgPSBfdGhpcy5nZXRDb250cm9sc0ZvckRldGVjdG9yKCk7CgogICAgICB2YXIgcmVzdWx0RW50aXRpZXMgPSBfb2JqZWN0U3ByZWFkKHt9LCBlbnRpdHlDb250cm9scy5yZWR1Y2UoZnVuY3Rpb24gKGFwcFN0YXRlRW50aXRpZXMsIGFwcFN0YXRlRW50aXR5KSB7CiAgICAgICAgYXBwU3RhdGVFbnRpdGllc1thcHBTdGF0ZUVudGl0eS5maWVsZE5hbWVdID0gYXBwU3RhdGVFbnRpdHkuZmllbGRWYWx1ZTsKICAgICAgICByZXR1cm4gYXBwU3RhdGVFbnRpdGllczsKICAgICAgfSwge30pLCBfZGVmaW5lUHJvcGVydHkoe30sIGVudGl0eS5maWVsZE5hbWUsIGZpZWxkVmFsdWUpKTsKCiAgICAgIGFwcFN0YXRlSGFuZGxlcihfdGltZXNlcmllc2V4cGxvcmVyX2NvbnN0YW50cy5BUFBfU1RBVEVfQUNUSU9OLlNFVF9FTlRJVElFUywgcmVzdWx0RW50aXRpZXMpOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZW50aXR5RmllbGRTZWFyY2hDaGFuZ2VkIiwgKDAsIF9sb2Rhc2guZGVib3VuY2UpKGZ1bmN0aW9uIChlbnRpdHksIHF1ZXJ5VGVybSkgewogICAgICB2YXIgZW50aXR5Q29udHJvbHMgPSBfdGhpcy5nZXRDb250cm9sc0ZvckRldGVjdG9yKCk7CgogICAgICBfdGhpcy5sb2FkRW50aXR5VmFsdWVzKGVudGl0eUNvbnRyb2xzLCBfZGVmaW5lUHJvcGVydHkoe30sIGVudGl0eS5maWVsZFR5cGUsIHF1ZXJ5VGVybSkpOwogICAgfSwgNTAwKSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAibG9hZEFub21hbGllc1RhYmxlRGF0YSIsIGZ1bmN0aW9uIChlYXJsaWVzdE1zLCBsYXRlc3RNcykgewogICAgICB2YXIgX3RoaXMkcHJvcHMgPSBfdGhpcy5wcm9wcywKICAgICAgICAgIGRhdGVGb3JtYXRUeiA9IF90aGlzJHByb3BzLmRhdGVGb3JtYXRUeiwKICAgICAgICAgIHNlbGVjdGVkRGV0ZWN0b3JJbmRleCA9IF90aGlzJHByb3BzLnNlbGVjdGVkRGV0ZWN0b3JJbmRleCwKICAgICAgICAgIHNlbGVjdGVkSm9iSWQgPSBfdGhpcyRwcm9wcy5zZWxlY3RlZEpvYklkLAogICAgICAgICAgdGFibGVJbnRlcnZhbCA9IF90aGlzJHByb3BzLnRhYmxlSW50ZXJ2YWwsCiAgICAgICAgICB0YWJsZVNldmVyaXR5ID0gX3RoaXMkcHJvcHMudGFibGVTZXZlcml0eTsKCiAgICAgIHZhciBzZWxlY3RlZEpvYiA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpOwoKICAgICAgdmFyIGVudGl0eUNvbnRyb2xzID0gX3RoaXMuZ2V0Q29udHJvbHNGb3JEZXRlY3RvcigpOwoKICAgICAgcmV0dXJuIF9tbF9hcGlfc2VydmljZS5tbC5yZXN1bHRzLmdldEFub21hbGllc1RhYmxlRGF0YShbc2VsZWN0ZWRKb2Iuam9iX2lkXSwgX3RoaXMuZ2V0Q3JpdGVyaWFGaWVsZHMoc2VsZWN0ZWREZXRlY3RvckluZGV4LCBlbnRpdHlDb250cm9scyksIFtdLCB0YWJsZUludGVydmFsLCB0YWJsZVNldmVyaXR5LCBlYXJsaWVzdE1zLCBsYXRlc3RNcywgZGF0ZUZvcm1hdFR6LCBfc2VhcmNoLkFOT01BTElFU19UQUJMRV9ERUZBVUxUX1FVRVJZX1NJWkUpLnBpcGUoKDAsIF9vcGVyYXRvcnMubWFwKShmdW5jdGlvbiAocmVzcCkgewogICAgICAgIHZhciBhbm9tYWxpZXMgPSByZXNwLmFub21hbGllczsKICAgICAgICB2YXIgZGV0ZWN0b3JzQnlKb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmRldGVjdG9yc0J5Sm9iOwogICAgICAgIGFub21hbGllcy5mb3JFYWNoKGZ1bmN0aW9uIChhbm9tYWx5KSB7CiAgICAgICAgICAvLyBBZGQgYSBkZXRlY3RvciBwcm9wZXJ0eSB0byBlYWNoIGFub21hbHkuCiAgICAgICAgICAvLyBEZWZhdWx0IHRvIGZ1bmN0aW9uRGVzY3JpcHRpb24gaWYgbm8gZGVzY3JpcHRpb24gYXZhaWxhYmxlLgogICAgICAgICAgLy8gVE9ETyAtIHdoZW4gam9iX3NlcnZpY2UgaXMgbW92ZWQgc2VydmVyX3NpZGUsIG1vdmUgdGhpcyB0byBzZXJ2ZXIgZW5kcG9pbnQuCiAgICAgICAgICB2YXIgam9iSWQgPSBhbm9tYWx5LmpvYklkOwogICAgICAgICAgdmFyIGRldGVjdG9yID0gKDAsIF9sb2Rhc2guZ2V0KShkZXRlY3RvcnNCeUpvYiwgW2pvYklkLCBhbm9tYWx5LmRldGVjdG9ySW5kZXhdKTsKICAgICAgICAgIGFub21hbHkuZGV0ZWN0b3IgPSAoMCwgX2xvZGFzaC5nZXQpKGRldGVjdG9yLCBbJ2RldGVjdG9yX2Rlc2NyaXB0aW9uJ10sIGFub21hbHkuc291cmNlLmZ1bmN0aW9uX2Rlc2NyaXB0aW9uKTsgLy8gRm9yIGRldGVjdG9ycyB3aXRoIHJ1bGVzLCBhZGQgYSBwcm9wZXJ0eSB3aXRoIHRoZSBydWxlIGNvdW50LgoKICAgICAgICAgIHZhciBjdXN0b21SdWxlcyA9IGRldGVjdG9yLmN1c3RvbV9ydWxlczsKCiAgICAgICAgICBpZiAoY3VzdG9tUnVsZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhbm9tYWx5LnJ1bGVzTGVuZ3RoID0gY3VzdG9tUnVsZXMubGVuZ3RoOwogICAgICAgICAgfSAvLyBBZGQgcHJvcGVydGllcyB1c2VkIGZvciBidWlsZGluZyB0aGUgbGlua3MgbWVudS4KICAgICAgICAgIC8vIFRPRE8gLSB3aGVuIGpvYl9zZXJ2aWNlIGlzIG1vdmVkIHNlcnZlcl9zaWRlLCBtb3ZlIHRoaXMgdG8gc2VydmVyIGVuZHBvaW50LgoKCiAgICAgICAgICBpZiAoKDAsIF9sb2Rhc2guaGFzKShfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmN1c3RvbVVybHNCeUpvYiwgam9iSWQpKSB7CiAgICAgICAgICAgIGFub21hbHkuY3VzdG9tVXJscyA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuY3VzdG9tVXJsc0J5Sm9iW2pvYklkXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdGFibGVEYXRhOiB7CiAgICAgICAgICAgIGFub21hbGllczogYW5vbWFsaWVzLAogICAgICAgICAgICBpbnRlcnZhbDogcmVzcC5pbnRlcnZhbCwKICAgICAgICAgICAgZXhhbXBsZXNCeUpvYklkOiByZXNwLmV4YW1wbGVzQnlKb2JJZCwKICAgICAgICAgICAgc2hvd1ZpZXdTZXJpZXNMaW5rOiBmYWxzZQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKTsKICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImxvYWRFbnRpdHlWYWx1ZXMiLCBmdW5jdGlvbiBfY2FsbGVlKGVudGl0aWVzKSB7CiAgICAgIHZhciBzZWFyY2hUZXJtLAogICAgICAgICAgX3RoaXMkcHJvcHMyLAogICAgICAgICAgYm91bmRzLAogICAgICAgICAgc2VsZWN0ZWRKb2JJZCwKICAgICAgICAgIHNlbGVjdGVkRGV0ZWN0b3JJbmRleCwKICAgICAgICAgIHNlbGVjdGVkSm9iLAogICAgICAgICAgZGV0ZWN0b3JJbmRleCwKICAgICAgICAgIF9yZWY0LAogICAgICAgICAgcGFydGl0aW9uRmllbGQsCiAgICAgICAgICBvdmVyRmllbGQsCiAgICAgICAgICBieUZpZWxkLAogICAgICAgICAgZW50aXR5VmFsdWVzLAogICAgICAgICAgX2FyZ3MgPSBhcmd1bWVudHM7CgogICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIHNlYXJjaFRlcm0gPSBfYXJncy5sZW5ndGggPiAxICYmIF9hcmdzWzFdICE9PSB1bmRlZmluZWQgPyBfYXJnc1sxXSA6IHt9OwoKICAgICAgICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICBlbnRpdGllc0xvYWRpbmc6IHRydWUKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMkcHJvcHMyID0gX3RoaXMucHJvcHMsIGJvdW5kcyA9IF90aGlzJHByb3BzMi5ib3VuZHMsIHNlbGVjdGVkSm9iSWQgPSBfdGhpcyRwcm9wczIuc2VsZWN0ZWRKb2JJZCwgc2VsZWN0ZWREZXRlY3RvckluZGV4ID0gX3RoaXMkcHJvcHMyLnNlbGVjdGVkRGV0ZWN0b3JJbmRleDsKICAgICAgICAgICAgICBzZWxlY3RlZEpvYiA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpOyAvLyBQb3B1bGF0ZSB0aGUgZW50aXR5IGlucHV0IGRhdGFsaXN0cyB3aXRoIHRoZSB2YWx1ZXMgZnJvbSB0aGUgdG9wIHJlY29yZHMgYnkgc2NvcmUKICAgICAgICAgICAgICAvLyBmb3IgdGhlIHNlbGVjdGVkIGRldGVjdG9yIGFjcm9zcyB0aGUgZnVsbCB0aW1lIHJhbmdlLiBObyBuZWVkIHRvIHBhc3MgdGhyb3VnaCBmaW5pc2goKS4KCiAgICAgICAgICAgICAgZGV0ZWN0b3JJbmRleCA9IHNlbGVjdGVkRGV0ZWN0b3JJbmRleDsKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNzsKICAgICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKF9yZXN1bHRzX3NlcnZpY2UubWxSZXN1bHRzU2VydmljZS5mZXRjaFBhcnRpdGlvbkZpZWxkc1ZhbHVlcyhzZWxlY3RlZEpvYi5qb2JfaWQsIHNlYXJjaFRlcm0sIFt7CiAgICAgICAgICAgICAgICBmaWVsZE5hbWU6ICdkZXRlY3Rvcl9pbmRleCcsCiAgICAgICAgICAgICAgICBmaWVsZFZhbHVlOiBkZXRlY3RvckluZGV4CiAgICAgICAgICAgICAgfV0sIGJvdW5kcy5taW4udmFsdWVPZigpLCBib3VuZHMubWF4LnZhbHVlT2YoKSkudG9Qcm9taXNlKCkpOwoKICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgIF9yZWY0ID0gX2NvbnRleHQuc2VudDsKICAgICAgICAgICAgICBwYXJ0aXRpb25GaWVsZCA9IF9yZWY0LnBhcnRpdGlvbl9maWVsZDsKICAgICAgICAgICAgICBvdmVyRmllbGQgPSBfcmVmNC5vdmVyX2ZpZWxkOwogICAgICAgICAgICAgIGJ5RmllbGQgPSBfcmVmNC5ieV9maWVsZDsKICAgICAgICAgICAgICBlbnRpdHlWYWx1ZXMgPSB7fTsKICAgICAgICAgICAgICBlbnRpdGllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlczsKCiAgICAgICAgICAgICAgICBpZiAoKHBhcnRpdGlvbkZpZWxkID09PSBudWxsIHx8IHBhcnRpdGlvbkZpZWxkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJ0aXRpb25GaWVsZC5uYW1lKSA9PT0gZW50aXR5LmZpZWxkTmFtZSkgewogICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlcyA9IHBhcnRpdGlvbkZpZWxkLnZhbHVlczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoKG92ZXJGaWVsZCA9PT0gbnVsbCB8fCBvdmVyRmllbGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG92ZXJGaWVsZC5uYW1lKSA9PT0gZW50aXR5LmZpZWxkTmFtZSkgewogICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlcyA9IG92ZXJGaWVsZC52YWx1ZXM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKChieUZpZWxkID09PSBudWxsIHx8IGJ5RmllbGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJ5RmllbGQubmFtZSkgPT09IGVudGl0eS5maWVsZE5hbWUpIHsKICAgICAgICAgICAgICAgICAgZmllbGRWYWx1ZXMgPSBieUZpZWxkLnZhbHVlczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBlbnRpdHlWYWx1ZXNbZW50aXR5LmZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlczsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgX3RoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgZW50aXRpZXNMb2FkaW5nOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVudGl0eVZhbHVlczogZW50aXR5VmFsdWVzCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInNldEZvcmVjYXN0SWQiLCBmdW5jdGlvbiAoZm9yZWNhc3RJZCkgewogICAgICBfdGhpcy5wcm9wcy5hcHBTdGF0ZUhhbmRsZXIoX3RpbWVzZXJpZXNleHBsb3Jlcl9jb25zdGFudHMuQVBQX1NUQVRFX0FDVElPTi5TRVRfRk9SRUNBU1RfSUQsIGZvcmVjYXN0SWQpOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAibG9hZFNpbmdsZU1ldHJpY0RhdGEiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBmdWxsUmVmcmVzaCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogdHJ1ZTsKICAgICAgdmFyIF90aGlzJHByb3BzMyA9IF90aGlzLnByb3BzLAogICAgICAgICAgYXV0b1pvb21EdXJhdGlvbiA9IF90aGlzJHByb3BzMy5hdXRvWm9vbUR1cmF0aW9uLAogICAgICAgICAgYm91bmRzID0gX3RoaXMkcHJvcHMzLmJvdW5kcywKICAgICAgICAgIHNlbGVjdGVkRGV0ZWN0b3JJbmRleCA9IF90aGlzJHByb3BzMy5zZWxlY3RlZERldGVjdG9ySW5kZXgsCiAgICAgICAgICBzZWxlY3RlZEZvcmVjYXN0SWQgPSBfdGhpcyRwcm9wczMuc2VsZWN0ZWRGb3JlY2FzdElkLAogICAgICAgICAgc2VsZWN0ZWRKb2JJZCA9IF90aGlzJHByb3BzMy5zZWxlY3RlZEpvYklkLAogICAgICAgICAgem9vbSA9IF90aGlzJHByb3BzMy56b29tOwogICAgICB2YXIgY3VycmVudExvYWRDb3VudGVyID0gX3RoaXMuc3RhdGUubG9hZENvdW50ZXI7CgogICAgICB2YXIgY3VycmVudFNlbGVjdGVkSm9iID0gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5nZXRKb2Ioc2VsZWN0ZWRKb2JJZCk7CgogICAgICBpZiAoY3VycmVudFNlbGVjdGVkSm9iID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIF90aGlzLmNvbnRleHRDaGFydFNlbGVjdGVkSW5pdENhbGxEb25lID0gZmFsc2U7IC8vIE9ubHkgd2hlbiBgZnVsbFJlZnJlc2hgIGlzIHRydWUgd2UnbGwgcmVzZXQgYWxsIGRhdGEKICAgICAgLy8gYW5kIHNob3cgdGhlIGxvYWRpbmcgc3Bpbm5lciB3aXRoaW4gdGhlIHBhZ2UuCgogICAgICB2YXIgZW50aXR5Q29udHJvbHMgPSBfdGhpcy5nZXRDb250cm9sc0ZvckRldGVjdG9yKCk7CgogICAgICBfdGhpcy5zZXRTdGF0ZShfb2JqZWN0U3ByZWFkKHsKICAgICAgICBmdWxsUmVmcmVzaDogZnVsbFJlZnJlc2gsCiAgICAgICAgbG9hZENvdW50ZXI6IGN1cnJlbnRMb2FkQ291bnRlciArIDEsCiAgICAgICAgbG9hZGluZzogdHJ1ZQogICAgICB9LCBmdWxsUmVmcmVzaCA/IHsKICAgICAgICBjaGFydERldGFpbHM6IHVuZGVmaW5lZCwKICAgICAgICBjb250ZXh0Q2hhcnREYXRhOiB1bmRlZmluZWQsCiAgICAgICAgY29udGV4dEZvcmVjYXN0RGF0YTogdW5kZWZpbmVkLAogICAgICAgIGZvY3VzQ2hhcnREYXRhOiB1bmRlZmluZWQsCiAgICAgICAgZm9jdXNGb3JlY2FzdERhdGE6IHVuZGVmaW5lZCwKICAgICAgICBtb2RlbFBsb3RFbmFibGVkOiAoMCwgX2pvYl91dGlscy5pc01vZGVsUGxvdEVuYWJsZWQpKGN1cnJlbnRTZWxlY3RlZEpvYiwgc2VsZWN0ZWREZXRlY3RvckluZGV4LCBlbnRpdHlDb250cm9scyksCiAgICAgICAgaGFzUmVzdWx0czogZmFsc2UsCiAgICAgICAgZGF0YU5vdENoYXJ0YWJsZTogZmFsc2UKICAgICAgfSA6IHt9KSwgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdGhpcyRzdGF0ZSA9IF90aGlzLnN0YXRlLAogICAgICAgICAgICBsb2FkQ291bnRlciA9IF90aGlzJHN0YXRlLmxvYWRDb3VudGVyLAogICAgICAgICAgICBtb2RlbFBsb3RFbmFibGVkID0gX3RoaXMkc3RhdGUubW9kZWxQbG90RW5hYmxlZDsKICAgICAgICB2YXIgam9icyA9ICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLmNyZWF0ZVRpbWVTZXJpZXNKb2JEYXRhKShfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmpvYnMpOwoKICAgICAgICB2YXIgc2VsZWN0ZWRKb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmdldEpvYihzZWxlY3RlZEpvYklkKTsKCiAgICAgICAgdmFyIGRldGVjdG9ySW5kZXggPSBzZWxlY3RlZERldGVjdG9ySW5kZXg7CiAgICAgICAgdmFyIGF3YWl0aW5nQ291bnQgPSAzOwogICAgICAgIHZhciBzdGF0ZVVwZGF0ZSA9IHt9OyAvLyBmaW5pc2goKSBmdW5jdGlvbiwgY2FsbGVkIGFmdGVyIGVhY2ggZGF0YSBzZXQgaGFzIGJlZW4gbG9hZGVkIGFuZCBwcm9jZXNzZWQuCiAgICAgICAgLy8gVGhlIGxhc3Qgb25lIHRvIGNhbGwgaXQgd2lsbCB0cmlnZ2VyIHRoZSBwYWdlIHJlbmRlci4KCiAgICAgICAgdmFyIGZpbmlzaCA9IGZ1bmN0aW9uIGZpbmlzaChjb3VudGVyVmFyKSB7CiAgICAgICAgICBhd2FpdGluZ0NvdW50LS07CgogICAgICAgICAgaWYgKGF3YWl0aW5nQ291bnQgPT09IDAgJiYgY291bnRlclZhciA9PT0gbG9hZENvdW50ZXIpIHsKICAgICAgICAgICAgc3RhdGVVcGRhdGUuaGFzUmVzdWx0cyA9IEFycmF5LmlzQXJyYXkoc3RhdGVVcGRhdGUuY29udGV4dENoYXJ0RGF0YSkgJiYgc3RhdGVVcGRhdGUuY29udGV4dENoYXJ0RGF0YS5sZW5ndGggPiAwIHx8IEFycmF5LmlzQXJyYXkoc3RhdGVVcGRhdGUuY29udGV4dEZvcmVjYXN0RGF0YSkgJiYgc3RhdGVVcGRhdGUuY29udGV4dEZvcmVjYXN0RGF0YS5sZW5ndGggPiAwOwogICAgICAgICAgICBzdGF0ZVVwZGF0ZS5sb2FkaW5nID0gZmFsc2U7IC8vIFNldCB6b29tRnJvbS96b29tVG8gYXR0cmlidXRlcyBpbiBzY29wZSB3aGljaCB3aWxsIHJlc3VsdCBpbiB0aGUgbWV0cmljIGNoYXJ0IGF1dG9tYXRpY2FsbHkKICAgICAgICAgICAgLy8gc2VsZWN0aW5nIHRoZSBzcGVjaWZpZWQgcmFuZ2UgaW4gdGhlIGNvbnRleHQgY2hhcnQsIGFuZCBzbyBsb2FkaW5nIHRoYXQgZGF0ZSByYW5nZSBpbiB0aGUgZm9jdXMgY2hhcnQuCiAgICAgICAgICAgIC8vIE9ubHkgdG91Y2ggdGhlIHpvb20gcmFuZ2UgaWYgZGF0YSBmb3IgdGhlIGNvbnRleHQgY2hhcnQgaGFzIGJlZW4gbG9hZGVkIGFuZCBhbGwgbmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIHBhcnRpdGlvbiBmaWVsZHMgaGF2ZSBhIHNlbGVjdGlvbi4KCiAgICAgICAgICAgIGlmIChzdGF0ZVVwZGF0ZS5jb250ZXh0Q2hhcnREYXRhLmxlbmd0aCAmJiBfdGhpcy5hcmVQYXJ0aXRpb25pbmdGaWVsZHNQcm92aWRlZCgpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGEgem9vbSBwYXJhbWV0ZXIgaW4gdGhlIGFwcFN0YXRlIChVUkwpLgogICAgICAgICAgICAgIHZhciBmb2N1c1JhbmdlID0gKDAsIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMuY2FsY3VsYXRlSW5pdGlhbEZvY3VzUmFuZ2UpKHpvb20sIHN0YXRlVXBkYXRlLmNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsLCBib3VuZHMpOwoKICAgICAgICAgICAgICBpZiAoZm9jdXNSYW5nZSA9PT0gdW5kZWZpbmVkIHx8IF90aGlzLnByZXZpb3VzU2VsZWN0ZWRGb3JlY2FzdElkICE9PSBfdGhpcy5wcm9wcy5zZWxlY3RlZEZvcmVjYXN0SWQpIHsKICAgICAgICAgICAgICAgIGZvY3VzUmFuZ2UgPSAoMCwgX3RpbWVzZXJpZXNleHBsb3Jlcl91dGlscy5jYWxjdWxhdGVEZWZhdWx0Rm9jdXNSYW5nZSkoYXV0b1pvb21EdXJhdGlvbiwgc3RhdGVVcGRhdGUuY29udGV4dEFnZ3JlZ2F0aW9uSW50ZXJ2YWwsIHN0YXRlVXBkYXRlLmNvbnRleHRDaGFydERhdGEsIHN0YXRlVXBkYXRlLmNvbnRleHRGb3JlY2FzdERhdGEpOwogICAgICAgICAgICAgICAgX3RoaXMucHJldmlvdXNTZWxlY3RlZEZvcmVjYXN0SWQgPSBfdGhpcy5wcm9wcy5zZWxlY3RlZEZvcmVjYXN0SWQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfdGhpcy5jb250ZXh0Q2hhcnRTZWxlY3RlZCh7CiAgICAgICAgICAgICAgICBmcm9tOiBmb2N1c1JhbmdlWzBdLAogICAgICAgICAgICAgICAgdG86IGZvY3VzUmFuZ2VbMV0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RoaXMuc2V0U3RhdGUoc3RhdGVVcGRhdGUpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBub25CbGFua0VudGl0aWVzID0gZW50aXR5Q29udHJvbHMuZmlsdGVyKGZ1bmN0aW9uIChlbnRpdHkpIHsKICAgICAgICAgIHJldHVybiBlbnRpdHkuZmllbGRWYWx1ZS5sZW5ndGggPiAwOwogICAgICAgIH0pOwoKICAgICAgICBpZiAobW9kZWxQbG90RW5hYmxlZCA9PT0gZmFsc2UgJiYgKDAsIF9qb2JfdXRpbHMuaXNTb3VyY2VEYXRhQ2hhcnRhYmxlRm9yRGV0ZWN0b3IpKHNlbGVjdGVkSm9iLCBkZXRlY3RvckluZGV4KSA9PT0gZmFsc2UgJiYgbm9uQmxhbmtFbnRpdGllcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAvLyBGb3IgZGV0ZWN0b3JzIHdoZXJlIG1vZGVsIHBsb3QgaGFzIGJlZW4gZW5hYmxlZCB3aXRoIGEgdGVybXMgZmlsdGVyIGFuZCB0aGUKICAgICAgICAgIC8vIHNlbGVjdGVkIGVudGl0eShzKSBhcmUgbm90IGluIHRoZSB0ZXJtcyBsaXN0LCBpbmRpY2F0ZSB0aGF0IGRhdGEgY2Fubm90IGJlIHZpZXdlZC4KICAgICAgICAgIHN0YXRlVXBkYXRlLmhhc1Jlc3VsdHMgPSBmYWxzZTsKICAgICAgICAgIHN0YXRlVXBkYXRlLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIHN0YXRlVXBkYXRlLmRhdGFOb3RDaGFydGFibGUgPSB0cnVlOwoKICAgICAgICAgIF90aGlzLnNldFN0YXRlKHN0YXRlVXBkYXRlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSAvLyBDYWxjdWxhdGUgdGhlIGFnZ3JlZ2F0aW9uIGludGVydmFsIGZvciB0aGUgY29udGV4dCBjaGFydC4KICAgICAgICAvLyBDb250ZXh0IGNoYXJ0IHN3aW1sYW5lIHdpbGwgZGlzcGxheSBidWNrZXQgYW5vbWFseSBzY29yZSBhdCB0aGUgc2FtZSBpbnRlcnZhbC4KCgogICAgICAgIHN0YXRlVXBkYXRlLmNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsID0gKDAsIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMuY2FsY3VsYXRlQWdncmVnYXRpb25JbnRlcnZhbCkoYm91bmRzLCBfdGltZXNlcmllc2V4cGxvcmVyX2NvbnN0YW50cy5DSEFSVFNfUE9JTlRfVEFSR0VULCBqb2JzLCBzZWxlY3RlZEpvYik7IC8vIEVuc3VyZSB0aGUgc2VhcmNoIGJvdW5kcyBhbGlnbiB0byB0aGUgYnVja2V0aW5nIGludGVydmFsIHNvIHRoYXQgdGhlIGZpcnN0IGFuZCBsYXN0IGJ1Y2tldHMgYXJlIGNvbXBsZXRlLgogICAgICAgIC8vIEZvciBzdW0gb3IgY291bnQgZGV0ZWN0b3JzLCBzaG9ydCBidWNrZXRzIHdvdWxkIGhvbGQgc21hbGxlciB2YWx1ZXMsIGFuZCBtb2RlbCBib3VuZHMgd291bGQgYWxzbyBiZSBhZmZlY3RlZAogICAgICAgIC8vIHRvIHNvbWUgZXh0ZW50IHdpdGggYWxsIGRldGVjdG9yIGZ1bmN0aW9ucyBpZiBub3Qgc2VhcmNoaW5nIGNvbXBsZXRlIGJ1Y2tldHMuCgogICAgICAgIHZhciBzZWFyY2hCb3VuZHMgPSAoMCwgX3RpbWVfYnVja2V0cy5nZXRCb3VuZHNSb3VuZGVkVG9JbnRlcnZhbCkoYm91bmRzLCBzdGF0ZVVwZGF0ZS5jb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbCwgZmFsc2UpOyAvLyBRdWVyeSAxIC0gbG9hZCBtZXRyaWMgZGF0YSBhdCBsb3cgZ3JhbnVsYXJpdHkgYWNyb3NzIGZ1bGwgdGltZSByYW5nZS4KICAgICAgICAvLyBQYXNzIGEgY291bnRlciBmbGFnIGludG8gdGhlIGZpbmlzaCgpIGZ1bmN0aW9uIHRvIG1ha2Ugc3VyZSB3ZSBvbmx5IHByb2Nlc3MgdGhlIHJlc3VsdHMKICAgICAgICAvLyBmb3IgdGhlIG1vc3QgcmVjZW50IGNhbGwgdG8gdGhlIGxvYWQgdGhlIGRhdGEgaW4gY2FzZXMgd2hlcmUgdGhlIGpvYiBzZWxlY3Rpb24gYW5kIHRpbWUgZmlsdGVyCiAgICAgICAgLy8gaGF2ZSBiZWVuIGFsdGVyZWQgaW4gcXVpY2sgc3VjY2Vzc2lvbiAoc3VjaCBhcyBmcm9tIHRoZSBqb2IgcGlja2VyIHdpdGggJ0FwcGx5IHRpbWUgcmFuZ2UnKS4KCiAgICAgICAgdmFyIGNvdW50ZXIgPSBsb2FkQ291bnRlcjsKCiAgICAgICAgX3RpbWVzZXJpZXNfc2VhcmNoX3NlcnZpY2UubWxUaW1lU2VyaWVzU2VhcmNoU2VydmljZS5nZXRNZXRyaWNEYXRhKHNlbGVjdGVkSm9iLCBkZXRlY3RvckluZGV4LCBub25CbGFua0VudGl0aWVzLCBzZWFyY2hCb3VuZHMubWluLnZhbHVlT2YoKSwgc2VhcmNoQm91bmRzLm1heC52YWx1ZU9mKCksIHN0YXRlVXBkYXRlLmNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsLmV4cHJlc3Npb24pLnRvUHJvbWlzZSgpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIHZhciBmdWxsUmFuZ2VDaGFydERhdGEgPSAoMCwgX3RpbWVzZXJpZXNleHBsb3Jlcl91dGlscy5wcm9jZXNzTWV0cmljUGxvdFJlc3VsdHMpKHJlc3AucmVzdWx0cywgbW9kZWxQbG90RW5hYmxlZCk7CiAgICAgICAgICBzdGF0ZVVwZGF0ZS5jb250ZXh0Q2hhcnREYXRhID0gZnVsbFJhbmdlQ2hhcnREYXRhOwogICAgICAgICAgZmluaXNoKGNvdW50ZXIpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnVGltZSBzZXJpZXMgZXhwbG9yZXIgLSBlcnJvciBnZXR0aW5nIG1ldHJpYyBkYXRhIGZyb20gZWxhc3RpY3NlYXJjaDonLCByZXNwKTsKICAgICAgICB9KTsgLy8gUXVlcnkgMiAtIGxvYWQgbWF4IHJlY29yZCBzY29yZSBhdCBzYW1lIGdyYW51bGFyaXR5IGFzIGNvbnRleHQgY2hhcnQKICAgICAgICAvLyBhY3Jvc3MgZnVsbCB0aW1lIHJhbmdlIGZvciB1c2UgaW4gdGhlIHN3aW1sYW5lLgoKCiAgICAgICAgX3Jlc3VsdHNfc2VydmljZS5tbFJlc3VsdHNTZXJ2aWNlLmdldFJlY29yZE1heFNjb3JlQnlUaW1lKHNlbGVjdGVkSm9iLmpvYl9pZCwgX3RoaXMuZ2V0Q3JpdGVyaWFGaWVsZHMoZGV0ZWN0b3JJbmRleCwgZW50aXR5Q29udHJvbHMpLCBzZWFyY2hCb3VuZHMubWluLnZhbHVlT2YoKSwgc2VhcmNoQm91bmRzLm1heC52YWx1ZU9mKCksIHN0YXRlVXBkYXRlLmNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsLmV4cHJlc3Npb24pLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIHZhciBmdWxsUmFuZ2VSZWNvcmRTY29yZURhdGEgPSAoMCwgX3RpbWVzZXJpZXNleHBsb3Jlcl91dGlscy5wcm9jZXNzUmVjb3JkU2NvcmVSZXN1bHRzKShyZXNwLnJlc3VsdHMpOwogICAgICAgICAgc3RhdGVVcGRhdGUuc3dpbWxhbmVEYXRhID0gZnVsbFJhbmdlUmVjb3JkU2NvcmVEYXRhOwogICAgICAgICAgZmluaXNoKGNvdW50ZXIpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnVGltZSBzZXJpZXMgZXhwbG9yZXIgLSBlcnJvciBnZXR0aW5nIGJ1Y2tldCBhbm9tYWx5IHNjb3JlcyBmcm9tIGVsYXN0aWNzZWFyY2g6JywgcmVzcCk7CiAgICAgICAgfSk7IC8vIFF1ZXJ5IDMgLSBsb2FkIGRldGFpbHMgb24gdGhlIGNoYXJ0IHVzZWQgaW4gdGhlIGNoYXJ0IHRpdGxlIChjaGFydGluZyBmdW5jdGlvbiBhbmQgZW50aXR5KHMpKS4KCgogICAgICAgIF90aW1lc2VyaWVzX3NlYXJjaF9zZXJ2aWNlLm1sVGltZVNlcmllc1NlYXJjaFNlcnZpY2UuZ2V0Q2hhcnREZXRhaWxzKHNlbGVjdGVkSm9iLCBkZXRlY3RvckluZGV4LCBlbnRpdHlDb250cm9scywgc2VhcmNoQm91bmRzLm1pbi52YWx1ZU9mKCksIHNlYXJjaEJvdW5kcy5tYXgudmFsdWVPZigpKS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICBzdGF0ZVVwZGF0ZS5jaGFydERldGFpbHMgPSByZXNwLnJlc3VsdHM7CiAgICAgICAgICBmaW5pc2goY291bnRlcik7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdUaW1lIHNlcmllcyBleHBsb3JlciAtIGVycm9yIGdldHRpbmcgZW50aXR5IGNvdW50cyBmcm9tIGVsYXN0aWNzZWFyY2g6JywgcmVzcCk7CiAgICAgICAgfSk7IC8vIFBsdXMgcXVlcnkgZm9yIGZvcmVjYXN0IGRhdGEgaWYgdGhlcmUgaXMgYSBmb3JlY2FzdElkIHN0b3JlZCBpbiB0aGUgYXBwU3RhdGUuCgoKICAgICAgICBpZiAoc2VsZWN0ZWRGb3JlY2FzdElkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGF3YWl0aW5nQ291bnQrKzsKICAgICAgICAgIHZhciBhZ2dUeXBlID0gdW5kZWZpbmVkOwogICAgICAgICAgdmFyIGRldGVjdG9yID0gc2VsZWN0ZWRKb2IuYW5hbHlzaXNfY29uZmlnLmRldGVjdG9yc1tkZXRlY3RvckluZGV4XTsKICAgICAgICAgIHZhciBlc0FnZyA9ICgwLCBfam9iX3V0aWxzLm1sRnVuY3Rpb25Ub0VTQWdncmVnYXRpb24pKGRldGVjdG9yLmZ1bmN0aW9uKTsKCiAgICAgICAgICBpZiAobW9kZWxQbG90RW5hYmxlZCA9PT0gZmFsc2UgJiYgKGVzQWdnID09PSAnc3VtJyB8fCBlc0FnZyA9PT0gJ2NvdW50JykpIHsKICAgICAgICAgICAgYWdnVHlwZSA9IHsKICAgICAgICAgICAgICBhdmc6ICdzdW0nLAogICAgICAgICAgICAgIG1heDogJ3N1bScsCiAgICAgICAgICAgICAgbWluOiAnc3VtJwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIF9mb3JlY2FzdF9zZXJ2aWNlLm1sRm9yZWNhc3RTZXJ2aWNlLmdldEZvcmVjYXN0RGF0YShzZWxlY3RlZEpvYiwgZGV0ZWN0b3JJbmRleCwgc2VsZWN0ZWRGb3JlY2FzdElkLCBub25CbGFua0VudGl0aWVzLCBzZWFyY2hCb3VuZHMubWluLnZhbHVlT2YoKSwgc2VhcmNoQm91bmRzLm1heC52YWx1ZU9mKCksIHN0YXRlVXBkYXRlLmNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsLmV4cHJlc3Npb24sIGFnZ1R5cGUpLnRvUHJvbWlzZSgpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgc3RhdGVVcGRhdGUuY29udGV4dEZvcmVjYXN0RGF0YSA9ICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLnByb2Nlc3NGb3JlY2FzdFJlc3VsdHMpKHJlc3AucmVzdWx0cyk7CiAgICAgICAgICAgIGZpbmlzaChjb3VudGVyKTsKICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJUaW1lIHNlcmllcyBleHBsb3JlciAtIGVycm9yIGxvYWRpbmcgZGF0YSBmb3IgZm9yZWNhc3QgSUQgIi5jb25jYXQoc2VsZWN0ZWRGb3JlY2FzdElkKSwgcmVzcCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2V0Q29udHJvbHNGb3JEZXRlY3RvciIsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90aGlzJHByb3BzNCA9IF90aGlzLnByb3BzLAogICAgICAgICAgc2VsZWN0ZWREZXRlY3RvckluZGV4ID0gX3RoaXMkcHJvcHM0LnNlbGVjdGVkRGV0ZWN0b3JJbmRleCwKICAgICAgICAgIHNlbGVjdGVkRW50aXRpZXMgPSBfdGhpcyRwcm9wczQuc2VsZWN0ZWRFbnRpdGllcywKICAgICAgICAgIHNlbGVjdGVkSm9iSWQgPSBfdGhpcyRwcm9wczQuc2VsZWN0ZWRKb2JJZDsKCiAgICAgIHZhciBzZWxlY3RlZEpvYiA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpOwoKICAgICAgdmFyIGVudGl0aWVzID0gW107CgogICAgICBpZiAoc2VsZWN0ZWRKb2IgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBlbnRpdGllczsKICAgICAgfSAvLyBVcGRhdGUgdGhlIGVudGl0eSBkcm9wZG93biBjb250cm9sKHMpIGFjY29yZGluZyB0byB0aGUgcGFydGl0aW9uaW5nIGZpZWxkcyBmb3IgdGhlIHNlbGVjdGVkIGRldGVjdG9yLgoKCiAgICAgIHZhciBkZXRlY3RvckluZGV4ID0gc2VsZWN0ZWREZXRlY3RvckluZGV4OwogICAgICB2YXIgZGV0ZWN0b3IgPSBzZWxlY3RlZEpvYi5hbmFseXNpc19jb25maWcuZGV0ZWN0b3JzW2RldGVjdG9ySW5kZXhdOwogICAgICB2YXIgZW50aXRpZXNTdGF0ZSA9IHNlbGVjdGVkRW50aXRpZXM7CiAgICAgIHZhciBwYXJ0aXRpb25GaWVsZE5hbWUgPSAoMCwgX2xvZGFzaC5nZXQpKGRldGVjdG9yLCAncGFydGl0aW9uX2ZpZWxkX25hbWUnKTsKICAgICAgdmFyIG92ZXJGaWVsZE5hbWUgPSAoMCwgX2xvZGFzaC5nZXQpKGRldGVjdG9yLCAnb3Zlcl9maWVsZF9uYW1lJyk7CiAgICAgIHZhciBieUZpZWxkTmFtZSA9ICgwLCBfbG9kYXNoLmdldCkoZGV0ZWN0b3IsICdieV9maWVsZF9uYW1lJyk7CgogICAgICBpZiAocGFydGl0aW9uRmllbGROYW1lICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgcGFydGl0aW9uRmllbGRWYWx1ZSA9ICgwLCBfbG9kYXNoLmdldCkoZW50aXRpZXNTdGF0ZSwgcGFydGl0aW9uRmllbGROYW1lLCAnJyk7CiAgICAgICAgZW50aXRpZXMucHVzaCh7CiAgICAgICAgICBmaWVsZFR5cGU6ICdwYXJ0aXRpb25fZmllbGQnLAogICAgICAgICAgZmllbGROYW1lOiBwYXJ0aXRpb25GaWVsZE5hbWUsCiAgICAgICAgICBmaWVsZFZhbHVlOiBwYXJ0aXRpb25GaWVsZFZhbHVlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChvdmVyRmllbGROYW1lICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgb3ZlckZpZWxkVmFsdWUgPSAoMCwgX2xvZGFzaC5nZXQpKGVudGl0aWVzU3RhdGUsIG92ZXJGaWVsZE5hbWUsICcnKTsKICAgICAgICBlbnRpdGllcy5wdXNoKHsKICAgICAgICAgIGZpZWxkVHlwZTogJ292ZXJfZmllbGQnLAogICAgICAgICAgZmllbGROYW1lOiBvdmVyRmllbGROYW1lLAogICAgICAgICAgZmllbGRWYWx1ZTogb3ZlckZpZWxkVmFsdWUKICAgICAgICB9KTsKICAgICAgfSAvLyBGb3Igam9icyB3aXRoIGJ5IGFuZCBvdmVyIGZpZWxkcywgZG9uJ3QgYWRkIHRoZSAnYnknIGZpZWxkIGFzIHRoaXMKICAgICAgLy8gZmllbGQgd2lsbCBvbmx5IGJlIGFkZGVkIHRvIHRoZSB0b3AtbGV2ZWwgZmllbGRzIGZvciByZWNvcmQgdHlwZSByZXN1bHRzCiAgICAgIC8vIGlmIGl0IGFsc28gYW4gaW5mbHVlbmNlciBvdmVyIHRoZSBidWNrZXQuCiAgICAgIC8vIFRPRE8gLSBtZXRyaWMgZGF0YSBjYW4gYmUgZmlsdGVyZWQgYnkgdGhpcyBmaWVsZCwgc28gc2hvdWxkIG9ubHkgZXhjbHVkZQogICAgICAvLyBmcm9tIGZpbHRlciBmb3IgdGhlIGFub21hbHkgcmVjb3Jkcy4KCgogICAgICBpZiAoYnlGaWVsZE5hbWUgIT09IHVuZGVmaW5lZCAmJiBvdmVyRmllbGROYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgYnlGaWVsZFZhbHVlID0gKDAsIF9sb2Rhc2guZ2V0KShlbnRpdGllc1N0YXRlLCBieUZpZWxkTmFtZSwgJycpOwogICAgICAgIGVudGl0aWVzLnB1c2goewogICAgICAgICAgZmllbGRUeXBlOiAnYnlfZmllbGQnLAogICAgICAgICAgZmllbGROYW1lOiBieUZpZWxkTmFtZSwKICAgICAgICAgIGZpZWxkVmFsdWU6IGJ5RmllbGRWYWx1ZQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gZW50aXRpZXM7CiAgICB9KTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoVGltZVNlcmllc0V4cGxvcmVyLCBbewogICAga2V5OiAiZ2V0Rm9jdXNBZ2dyZWdhdGlvbkludGVydmFsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwoc2VsZWN0aW9uKSB7CiAgICAgIHZhciBzZWxlY3RlZEpvYklkID0gdGhpcy5wcm9wcy5zZWxlY3RlZEpvYklkOwogICAgICB2YXIgam9icyA9ICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLmNyZWF0ZVRpbWVTZXJpZXNKb2JEYXRhKShfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmpvYnMpOwoKICAgICAgdmFyIHNlbGVjdGVkSm9iID0gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5nZXRKb2Ioc2VsZWN0ZWRKb2JJZCk7IC8vIENhbGN1bGF0ZSB0aGUgYWdncmVnYXRpb24gaW50ZXJ2YWwgZm9yIHRoZSBmb2N1cyBjaGFydC4KCgogICAgICB2YXIgYm91bmRzID0gewogICAgICAgIG1pbjogKDAsIF9tb21lbnRUaW1lem9uZS5kZWZhdWx0KShzZWxlY3Rpb24uZnJvbSksCiAgICAgICAgbWF4OiAoMCwgX21vbWVudFRpbWV6b25lLmRlZmF1bHQpKHNlbGVjdGlvbi50bykKICAgICAgfTsKICAgICAgcmV0dXJuICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLmNhbGN1bGF0ZUFnZ3JlZ2F0aW9uSW50ZXJ2YWwpKGJvdW5kcywgX3RpbWVzZXJpZXNleHBsb3Jlcl9jb25zdGFudHMuQ0hBUlRTX1BPSU5UX1RBUkdFVCwgam9icywgc2VsZWN0ZWRKb2IpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXRzIGZvY3VzIGRhdGEgZm9yIHRoZSBjdXJyZW50IGNvbXBvbmVudCBzdGF0ZS8KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRGb2N1c0RhdGEiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEZvY3VzRGF0YShzZWxlY3Rpb24pIHsKICAgICAgdmFyIF90aGlzJHByb3BzNSA9IHRoaXMucHJvcHMsCiAgICAgICAgICBzZWxlY3RlZEpvYklkID0gX3RoaXMkcHJvcHM1LnNlbGVjdGVkSm9iSWQsCiAgICAgICAgICBzZWxlY3RlZEZvcmVjYXN0SWQgPSBfdGhpcyRwcm9wczUuc2VsZWN0ZWRGb3JlY2FzdElkLAogICAgICAgICAgc2VsZWN0ZWREZXRlY3RvckluZGV4ID0gX3RoaXMkcHJvcHM1LnNlbGVjdGVkRGV0ZWN0b3JJbmRleDsKICAgICAgdmFyIG1vZGVsUGxvdEVuYWJsZWQgPSB0aGlzLnN0YXRlLm1vZGVsUGxvdEVuYWJsZWQ7CgogICAgICB2YXIgc2VsZWN0ZWRKb2IgPSBfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmdldEpvYihzZWxlY3RlZEpvYklkKTsKCiAgICAgIHZhciBlbnRpdHlDb250cm9scyA9IHRoaXMuZ2V0Q29udHJvbHNGb3JEZXRlY3RvcigpOyAvLyBDYWxjdWxhdGUgdGhlIGFnZ3JlZ2F0aW9uIGludGVydmFsIGZvciB0aGUgZm9jdXMgY2hhcnQuCgogICAgICB2YXIgYm91bmRzID0gewogICAgICAgIG1pbjogKDAsIF9tb21lbnRUaW1lem9uZS5kZWZhdWx0KShzZWxlY3Rpb24uZnJvbSksCiAgICAgICAgbWF4OiAoMCwgX21vbWVudFRpbWV6b25lLmRlZmF1bHQpKHNlbGVjdGlvbi50bykKICAgICAgfTsKICAgICAgdmFyIGZvY3VzQWdncmVnYXRpb25JbnRlcnZhbCA9IHRoaXMuZ2V0Rm9jdXNBZ2dyZWdhdGlvbkludGVydmFsKHNlbGVjdGlvbik7IC8vIEVuc3VyZSB0aGUgc2VhcmNoIGJvdW5kcyBhbGlnbiB0byB0aGUgYnVja2V0aW5nIGludGVydmFsIHNvIHRoYXQgdGhlIGZpcnN0IGFuZCBsYXN0IGJ1Y2tldHMgYXJlIGNvbXBsZXRlLgogICAgICAvLyBGb3Igc3VtIG9yIGNvdW50IGRldGVjdG9ycywgc2hvcnQgYnVja2V0cyB3b3VsZCBob2xkIHNtYWxsZXIgdmFsdWVzLCBhbmQgbW9kZWwgYm91bmRzIHdvdWxkIGFsc28gYmUgYWZmZWN0ZWQKICAgICAgLy8gdG8gc29tZSBleHRlbnQgd2l0aCBhbGwgZGV0ZWN0b3IgZnVuY3Rpb25zIGlmIG5vdCBzZWFyY2hpbmcgY29tcGxldGUgYnVja2V0cy4KCiAgICAgIHZhciBzZWFyY2hCb3VuZHMgPSAoMCwgX3RpbWVfYnVja2V0cy5nZXRCb3VuZHNSb3VuZGVkVG9JbnRlcnZhbCkoYm91bmRzLCBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwsIGZhbHNlKTsKICAgICAgcmV0dXJuICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLmdldEZvY3VzRGF0YSkodGhpcy5nZXRDcml0ZXJpYUZpZWxkcyhzZWxlY3RlZERldGVjdG9ySW5kZXgsIGVudGl0eUNvbnRyb2xzKSwgc2VsZWN0ZWREZXRlY3RvckluZGV4LCBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwsIHNlbGVjdGVkRm9yZWNhc3RJZCwgbW9kZWxQbG90RW5hYmxlZCwgZW50aXR5Q29udHJvbHMuZmlsdGVyKGZ1bmN0aW9uIChlbnRpdHkpIHsKICAgICAgICByZXR1cm4gZW50aXR5LmZpZWxkVmFsdWUubGVuZ3RoID4gMDsKICAgICAgfSksIHNlYXJjaEJvdW5kcywgc2VsZWN0ZWRKb2IsIF90aW1lc2VyaWVzZXhwbG9yZXJfY29uc3RhbnRzLlRJTUVfRklFTERfTkFNRSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0Q3JpdGVyaWFGaWVsZHMiLAoKICAgIC8qKgogICAgICogVXBkYXRlcyBjcml0ZXJpYSBmaWVsZHMgZm9yIEFQSSBjYWxscywgZS5nLiBnZXRBbm9tYWxpZXNUYWJsZURhdGEKICAgICAqIEBwYXJhbSBkZXRlY3RvckluZGV4CiAgICAgKiBAcGFyYW0gZW50aXRpZXMKICAgICAqLwogICAgdmFsdWU6IGZ1bmN0aW9uIGdldENyaXRlcmlhRmllbGRzKGRldGVjdG9ySW5kZXgsIGVudGl0aWVzKSB7CiAgICAgIC8vIE9ubHkgZmlsdGVyIG9uIHRoZSBlbnRpdHkgaWYgdGhlIGZpZWxkIGhhcyBhIHZhbHVlLgogICAgICB2YXIgbm9uQmxhbmtFbnRpdGllcyA9IGVudGl0aWVzLmZpbHRlcihmdW5jdGlvbiAoZW50aXR5KSB7CiAgICAgICAgcmV0dXJuIGVudGl0eS5maWVsZFZhbHVlLmxlbmd0aCA+IDA7CiAgICAgIH0pOwogICAgICByZXR1cm4gW3sKICAgICAgICBmaWVsZE5hbWU6ICdkZXRlY3Rvcl9pbmRleCcsCiAgICAgICAgZmllbGRWYWx1ZTogZGV0ZWN0b3JJbmRleAogICAgICB9XS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KG5vbkJsYW5rRW50aXRpZXMpKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJsb2FkRm9ySm9iSWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGxvYWRGb3JKb2JJZChqb2JJZCkgewogICAgICB2YXIgX3RoaXMkcHJvcHM2ID0gdGhpcy5wcm9wcywKICAgICAgICAgIGFwcFN0YXRlSGFuZGxlciA9IF90aGlzJHByb3BzNi5hcHBTdGF0ZUhhbmRsZXIsCiAgICAgICAgICBzZWxlY3RlZERldGVjdG9ySW5kZXggPSBfdGhpcyRwcm9wczYuc2VsZWN0ZWREZXRlY3RvckluZGV4OwoKICAgICAgdmFyIHNlbGVjdGVkSm9iID0gX2pvYl9zZXJ2aWNlLm1sSm9iU2VydmljZS5nZXRKb2Ioam9iSWQpOwoKICAgICAgaWYgKHNlbGVjdGVkSm9iID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBkZXRlY3RvcnMgPSBnZXRWaWV3YWJsZURldGVjdG9ycyhzZWxlY3RlZEpvYik7IC8vIENoZWNrIHRoZSBzdXBwbGllZCBpbmRleCBpcyB2YWxpZC4KCiAgICAgIHZhciBhcHBTdGF0ZUR0cklkeCA9IHNlbGVjdGVkRGV0ZWN0b3JJbmRleDsKICAgICAgdmFyIGRldGVjdG9ySW5kZXggPSBhcHBTdGF0ZUR0cklkeCAhPT0gdW5kZWZpbmVkID8gYXBwU3RhdGVEdHJJZHggOiBkZXRlY3RvcnNbMF0uaW5kZXg7CgogICAgICBpZiAoKDAsIF9sb2Rhc2guZmluZCkoZGV0ZWN0b3JzLCB7CiAgICAgICAgaW5kZXg6IGRldGVjdG9ySW5kZXgKICAgICAgfSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciB3YXJuaW5nVGV4dCA9IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIucmVxdWVzdGVkRGV0ZWN0b3JJbmRleE5vdFZhbGlkV2FybmluZ01lc3NhZ2UnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1JlcXVlc3RlZCBkZXRlY3RvciBpbmRleCB7ZGV0ZWN0b3JJbmRleH0gaXMgbm90IHZhbGlkIGZvciBqb2Ige2pvYklkfScsCiAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgZGV0ZWN0b3JJbmRleDogZGV0ZWN0b3JJbmRleCwKICAgICAgICAgICAgam9iSWQ6IHNlbGVjdGVkSm9iLmpvYl9pZAogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBfbm90aWZ5LnRvYXN0Tm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKHdhcm5pbmdUZXh0KTsKCiAgICAgICAgZGV0ZWN0b3JJbmRleCA9IGRldGVjdG9yc1swXS5pbmRleDsKICAgICAgfQoKICAgICAgdmFyIGRldGVjdG9ySWQgPSBkZXRlY3RvckluZGV4OwoKICAgICAgaWYgKGRldGVjdG9ySWQgIT09IHNlbGVjdGVkRGV0ZWN0b3JJbmRleCkgewogICAgICAgIGFwcFN0YXRlSGFuZGxlcihfdGltZXNlcmllc2V4cGxvcmVyX2NvbnN0YW50cy5BUFBfU1RBVEVfQUNUSU9OLlNFVF9ERVRFQ1RPUl9JTkRFWCwgZGV0ZWN0b3JJZCk7CiAgICAgIH0gLy8gUG9wdWxhdGUgdGhlIG1hcCBvZiBqb2JzIC8gZGV0ZWN0b3JzIC8gZmllbGQgZm9ybWF0dGVycyBmb3IgdGhlIHNlbGVjdGVkIElEcyBhbmQgcmVmcmVzaC4KCgogICAgICBfZmllbGRfZm9ybWF0X3NlcnZpY2UubWxGaWVsZEZvcm1hdFNlcnZpY2UucG9wdWxhdGVGb3JtYXRzKFtqb2JJZF0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgcG9wdWxhdGluZyBmaWVsZCBmb3JtYXRzOicsIGVycik7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImNvbXBvbmVudERpZE1vdW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAvLyBSZXF1aXJlZCB0byByZWRyYXcgdGhlIHRpbWUgc2VyaWVzIGNoYXJ0IHdoZW4gdGhlIGNvbnRhaW5lciBpcyByZXNpemVkLgogICAgICB0aGlzLnJlc2l6ZUNoZWNrZXIgPSBuZXcgX3B1YmxpYy5SZXNpemVDaGVja2VyKHRoaXMucmVzaXplUmVmLmN1cnJlbnQpOwogICAgICB0aGlzLnJlc2l6ZUNoZWNrZXIub24oJ3Jlc2l6ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczIucmVzaXplSGFuZGxlcigpOwogICAgICB9KTsKICAgICAgdGhpcy5yZXNpemVIYW5kbGVyKCk7IC8vIExpc3RlbiBmb3IgY29udGV4dCBjaGFydCB1cGRhdGVzLgoKICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZCh0aGlzLmNvbnRleHRDaGFydCQucGlwZSgoMCwgX29wZXJhdG9ycy50YXApKGZ1bmN0aW9uIChzZWxlY3Rpb24pIHsKICAgICAgICBfdGhpczIuc2V0U3RhdGUoewogICAgICAgICAgem9vbUZyb206IHNlbGVjdGlvbi5mcm9tLAogICAgICAgICAgem9vbVRvOiBzZWxlY3Rpb24udG8KICAgICAgICB9KTsKICAgICAgfSksICgwLCBfb3BlcmF0b3JzLmRlYm91bmNlVGltZSkoNTAwKSwgKDAsIF9vcGVyYXRvcnMudGFwKShmdW5jdGlvbiAoc2VsZWN0aW9uKSB7CiAgICAgICAgdmFyIF90aGlzMiRzdGF0ZSA9IF90aGlzMi5zdGF0ZSwKICAgICAgICAgICAgY29udGV4dENoYXJ0RGF0YSA9IF90aGlzMiRzdGF0ZS5jb250ZXh0Q2hhcnREYXRhLAogICAgICAgICAgICBjb250ZXh0Rm9yZWNhc3REYXRhID0gX3RoaXMyJHN0YXRlLmNvbnRleHRGb3JlY2FzdERhdGEsCiAgICAgICAgICAgIGZvY3VzQ2hhcnREYXRhID0gX3RoaXMyJHN0YXRlLmZvY3VzQ2hhcnREYXRhLAogICAgICAgICAgICB6b29tRnJvbUZvY3VzTG9hZGVkID0gX3RoaXMyJHN0YXRlLnpvb21Gcm9tRm9jdXNMb2FkZWQsCiAgICAgICAgICAgIHpvb21Ub0ZvY3VzTG9hZGVkID0gX3RoaXMyJHN0YXRlLnpvb21Ub0ZvY3VzTG9hZGVkOwoKICAgICAgICBpZiAoKGNvbnRleHRDaGFydERhdGEgPT09IHVuZGVmaW5lZCB8fCBjb250ZXh0Q2hhcnREYXRhLmxlbmd0aCA9PT0gMCkgJiYgKGNvbnRleHRGb3JlY2FzdERhdGEgPT09IHVuZGVmaW5lZCB8fCBjb250ZXh0Rm9yZWNhc3REYXRhLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChfdGhpczIuY29udGV4dENoYXJ0U2VsZWN0ZWRJbml0Q2FsbERvbmUgPT09IGZhbHNlICYmIGZvY3VzQ2hhcnREYXRhID09PSB1bmRlZmluZWQgfHwgem9vbUZyb21Gb2N1c0xvYWRlZC5nZXRUaW1lKCkgIT09IHNlbGVjdGlvbi5mcm9tLmdldFRpbWUoKSB8fCB6b29tVG9Gb2N1c0xvYWRlZC5nZXRUaW1lKCkgIT09IHNlbGVjdGlvbi50by5nZXRUaW1lKCkpIHsKICAgICAgICAgIF90aGlzMi5jb250ZXh0Q2hhcnRTZWxlY3RlZEluaXRDYWxsRG9uZSA9IHRydWU7CgogICAgICAgICAgX3RoaXMyLnNldFN0YXRlKHsKICAgICAgICAgICAgbG9hZGluZzogdHJ1ZSwKICAgICAgICAgICAgZnVsbFJlZnJlc2g6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pLCAoMCwgX29wZXJhdG9ycy5zd2l0Y2hNYXApKGZ1bmN0aW9uIChzZWxlY3Rpb24pIHsKICAgICAgICB2YXIgc2VsZWN0ZWRKb2JJZCA9IF90aGlzMi5wcm9wcy5zZWxlY3RlZEpvYklkOwogICAgICAgIHZhciBqb2JzID0gKDAsIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMuY3JlYXRlVGltZVNlcmllc0pvYkRhdGEpKF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2Uuam9icyk7CgogICAgICAgIHZhciBzZWxlY3RlZEpvYiA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpOyAvLyBDYWxjdWxhdGUgdGhlIGFnZ3JlZ2F0aW9uIGludGVydmFsIGZvciB0aGUgZm9jdXMgY2hhcnQuCgoKICAgICAgICB2YXIgYm91bmRzID0gewogICAgICAgICAgbWluOiAoMCwgX21vbWVudFRpbWV6b25lLmRlZmF1bHQpKHNlbGVjdGlvbi5mcm9tKSwKICAgICAgICAgIG1heDogKDAsIF9tb21lbnRUaW1lem9uZS5kZWZhdWx0KShzZWxlY3Rpb24udG8pCiAgICAgICAgfTsKICAgICAgICB2YXIgZm9jdXNBZ2dyZWdhdGlvbkludGVydmFsID0gKDAsIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMuY2FsY3VsYXRlQWdncmVnYXRpb25JbnRlcnZhbCkoYm91bmRzLCBfdGltZXNlcmllc2V4cGxvcmVyX2NvbnN0YW50cy5DSEFSVFNfUE9JTlRfVEFSR0VULCBqb2JzLCBzZWxlY3RlZEpvYik7IC8vIEVuc3VyZSB0aGUgc2VhcmNoIGJvdW5kcyBhbGlnbiB0byB0aGUgYnVja2V0aW5nIGludGVydmFsIHNvIHRoYXQgdGhlIGZpcnN0IGFuZCBsYXN0IGJ1Y2tldHMgYXJlIGNvbXBsZXRlLgogICAgICAgIC8vIEZvciBzdW0gb3IgY291bnQgZGV0ZWN0b3JzLCBzaG9ydCBidWNrZXRzIHdvdWxkIGhvbGQgc21hbGxlciB2YWx1ZXMsIGFuZCBtb2RlbCBib3VuZHMgd291bGQgYWxzbyBiZSBhZmZlY3RlZAogICAgICAgIC8vIHRvIHNvbWUgZXh0ZW50IHdpdGggYWxsIGRldGVjdG9yIGZ1bmN0aW9ucyBpZiBub3Qgc2VhcmNoaW5nIGNvbXBsZXRlIGJ1Y2tldHMuCgogICAgICAgIHZhciBzZWFyY2hCb3VuZHMgPSAoMCwgX3RpbWVfYnVja2V0cy5nZXRCb3VuZHNSb3VuZGVkVG9JbnRlcnZhbCkoYm91bmRzLCBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwsIGZhbHNlKTsKICAgICAgICByZXR1cm4gKDAsIF9yeGpzLmZvcmtKb2luKShbX3RoaXMyLmdldEZvY3VzRGF0YShzZWxlY3Rpb24pLCAvLyBMb2FkIHRoZSBkYXRhIGZvciB0aGUgYW5vbWFsaWVzIHRhYmxlLgogICAgICAgIF90aGlzMi5sb2FkQW5vbWFsaWVzVGFibGVEYXRhKHNlYXJjaEJvdW5kcy5taW4udmFsdWVPZigpLCBzZWFyY2hCb3VuZHMubWF4LnZhbHVlT2YoKSldKTsKICAgICAgfSksICgwLCBfb3BlcmF0b3JzLndpdGhMYXRlc3RGcm9tKSh0aGlzLmNvbnRleHRDaGFydCQpKS5zdWJzY3JpYmUoZnVuY3Rpb24gKF9yZWY1KSB7CiAgICAgICAgdmFyIF9yZWY2ID0gX3NsaWNlZFRvQXJyYXkoX3JlZjUsIDIpLAogICAgICAgICAgICBfcmVmNiQgPSBfc2xpY2VkVG9BcnJheShfcmVmNlswXSwgMiksCiAgICAgICAgICAgIHJlZnJlc2hGb2N1c0RhdGEgPSBfcmVmNiRbMF0sCiAgICAgICAgICAgIHRhYmxlRGF0YSA9IF9yZWY2JFsxXSwKICAgICAgICAgICAgc2VsZWN0aW9uID0gX3JlZjZbMV07CgogICAgICAgIHZhciBtb2RlbFBsb3RFbmFibGVkID0gX3RoaXMyLnN0YXRlLm1vZGVsUGxvdEVuYWJsZWQ7IC8vIEFsbCB0aGUgZGF0YSBpcyByZWFkeSBub3cgZm9yIGEgc3RhdGUgdXBkYXRlLgoKICAgICAgICBfdGhpczIuc2V0U3RhdGUoX29iamVjdFNwcmVhZCh7CiAgICAgICAgICBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWw6IF90aGlzMi5nZXRGb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwoewogICAgICAgICAgICBmcm9tOiBzZWxlY3Rpb24uZnJvbSwKICAgICAgICAgICAgdG86IHNlbGVjdGlvbi50bwogICAgICAgICAgfSksCiAgICAgICAgICBsb2FkaW5nOiBmYWxzZSwKICAgICAgICAgIHNob3dNb2RlbEJvdW5kc0NoZWNrYm94OiBtb2RlbFBsb3RFbmFibGVkICYmIHJlZnJlc2hGb2N1c0RhdGEuZm9jdXNDaGFydERhdGEubGVuZ3RoID4gMCwKICAgICAgICAgIHpvb21Gcm9tRm9jdXNMb2FkZWQ6IHNlbGVjdGlvbi5mcm9tLAogICAgICAgICAgem9vbVRvRm9jdXNMb2FkZWQ6IHNlbGVjdGlvbi50bwogICAgICAgIH0sIHJlZnJlc2hGb2N1c0RhdGEsIHt9LCB0YWJsZURhdGEpKTsKICAgICAgfSkpOwogICAgICB0aGlzLmNvbXBvbmVudERpZFVwZGF0ZSgpOwogICAgfQogIH0sIHsKICAgIGtleTogImNvbXBvbmVudERpZFVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY29tcG9uZW50RGlkVXBkYXRlKHByZXZpb3VzUHJvcHMpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICBpZiAocHJldmlvdXNQcm9wcyA9PT0gdW5kZWZpbmVkIHx8IHByZXZpb3VzUHJvcHMuc2VsZWN0ZWRKb2JJZCAhPT0gdGhpcy5wcm9wcy5zZWxlY3RlZEpvYklkKSB7CiAgICAgICAgdGhpcy5jb250ZXh0Q2hhcnRTZWxlY3RlZEluaXRDYWxsRG9uZSA9IGZhbHNlOwogICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgZnVsbFJlZnJlc2g6IGZhbHNlLAogICAgICAgICAgbG9hZGluZzogdHJ1ZQogICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMy5sb2FkRm9ySm9iSWQoX3RoaXMzLnByb3BzLnNlbGVjdGVkSm9iSWQpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAocHJldmlvdXNQcm9wcyA9PT0gdW5kZWZpbmVkIHx8IHByZXZpb3VzUHJvcHMuc2VsZWN0ZWRKb2JJZCAhPT0gdGhpcy5wcm9wcy5zZWxlY3RlZEpvYklkIHx8IHByZXZpb3VzUHJvcHMuc2VsZWN0ZWREZXRlY3RvckluZGV4ICE9PSB0aGlzLnByb3BzLnNlbGVjdGVkRGV0ZWN0b3JJbmRleCB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5zZWxlY3RlZEVudGl0aWVzLCB0aGlzLnByb3BzLnNlbGVjdGVkRW50aXRpZXMpKSB7CiAgICAgICAgdmFyIGVudGl0eUNvbnRyb2xzID0gdGhpcy5nZXRDb250cm9sc0ZvckRldGVjdG9yKCk7CiAgICAgICAgdGhpcy5sb2FkRW50aXR5VmFsdWVzKGVudGl0eUNvbnRyb2xzKTsKICAgICAgfQoKICAgICAgaWYgKHByZXZpb3VzUHJvcHMgPT09IHVuZGVmaW5lZCB8fCBwcmV2aW91c1Byb3BzLnNlbGVjdGVkRm9yZWNhc3RJZCAhPT0gdGhpcy5wcm9wcy5zZWxlY3RlZEZvcmVjYXN0SWQpIHsKICAgICAgICBpZiAodGhpcy5wcm9wcy5zZWxlY3RlZEZvcmVjYXN0SWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmb3JlY2FzdCBkYXRhIHdpbGwgYmUgc2hvd24gaWYgaGlkZGVuIHByZXZpb3VzbHkuCiAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgc2hvd0ZvcmVjYXN0OiB0cnVlCiAgICAgICAgICB9KTsgLy8gTm90IGJlc3QgcHJhY3RpY2UgYnV0IHdlIG5lZWQgdGhlIHByZXZpb3VzIHZhbHVlIGZvciBhbm90aGVyIGNvbXBhcmlzb24KICAgICAgICAgIC8vIG9uY2UgYWxsIHRoZSBkYXRhIHdhcyBsb2FkZWQuCgogICAgICAgICAgaWYgKHByZXZpb3VzUHJvcHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLnByZXZpb3VzU2VsZWN0ZWRGb3JlY2FzdElkID0gcHJldmlvdXNQcm9wcy5zZWxlY3RlZEZvcmVjYXN0SWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocHJldmlvdXNQcm9wcyA9PT0gdW5kZWZpbmVkIHx8ICEoMCwgX2xvZGFzaC5pc0VxdWFsKShwcmV2aW91c1Byb3BzLmJvdW5kcywgdGhpcy5wcm9wcy5ib3VuZHMpIHx8ICEoMCwgX2xvZGFzaC5pc0VxdWFsKShwcmV2aW91c1Byb3BzLmxhc3RSZWZyZXNoLCB0aGlzLnByb3BzLmxhc3RSZWZyZXNoKSB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5zZWxlY3RlZERldGVjdG9ySW5kZXgsIHRoaXMucHJvcHMuc2VsZWN0ZWREZXRlY3RvckluZGV4KSB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5zZWxlY3RlZEVudGl0aWVzLCB0aGlzLnByb3BzLnNlbGVjdGVkRW50aXRpZXMpIHx8IHByZXZpb3VzUHJvcHMuc2VsZWN0ZWRGb3JlY2FzdElkICE9PSB0aGlzLnByb3BzLnNlbGVjdGVkRm9yZWNhc3RJZCB8fCBwcmV2aW91c1Byb3BzLnNlbGVjdGVkSm9iSWQgIT09IHRoaXMucHJvcHMuc2VsZWN0ZWRKb2JJZCkgewogICAgICAgIHZhciBmdWxsUmVmcmVzaCA9IHByZXZpb3VzUHJvcHMgPT09IHVuZGVmaW5lZCB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5ib3VuZHMsIHRoaXMucHJvcHMuYm91bmRzKSB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5zZWxlY3RlZERldGVjdG9ySW5kZXgsIHRoaXMucHJvcHMuc2VsZWN0ZWREZXRlY3RvckluZGV4KSB8fCAhKDAsIF9sb2Rhc2guaXNFcXVhbCkocHJldmlvdXNQcm9wcy5zZWxlY3RlZEVudGl0aWVzLCB0aGlzLnByb3BzLnNlbGVjdGVkRW50aXRpZXMpIHx8IHByZXZpb3VzUHJvcHMuc2VsZWN0ZWRGb3JlY2FzdElkICE9PSB0aGlzLnByb3BzLnNlbGVjdGVkRm9yZWNhc3RJZCB8fCBwcmV2aW91c1Byb3BzLnNlbGVjdGVkSm9iSWQgIT09IHRoaXMucHJvcHMuc2VsZWN0ZWRKb2JJZDsKICAgICAgICB0aGlzLmxvYWRTaW5nbGVNZXRyaWNEYXRhKGZ1bGxSZWZyZXNoKTsKICAgICAgfQoKICAgICAgaWYgKHByZXZpb3VzUHJvcHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBSZWxvYWQgdGhlIGFub21hbGllcyB0YWJsZSBpZiB0aGUgSW50ZXJ2YWwgb3IgVGhyZXNob2xkIGNvbnRyb2xzIGFyZSBjaGFuZ2VkLgoKCiAgICAgIHZhciB0YWJsZUNvbnRyb2xzTGlzdGVuZXIgPSBmdW5jdGlvbiB0YWJsZUNvbnRyb2xzTGlzdGVuZXIoKSB7CiAgICAgICAgdmFyIF90aGlzMyRzdGF0ZSA9IF90aGlzMy5zdGF0ZSwKICAgICAgICAgICAgem9vbUZyb20gPSBfdGhpczMkc3RhdGUuem9vbUZyb20sCiAgICAgICAgICAgIHpvb21UbyA9IF90aGlzMyRzdGF0ZS56b29tVG87CgogICAgICAgIGlmICh6b29tRnJvbSAhPT0gdW5kZWZpbmVkICYmIHpvb21UbyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBfdGhpczMubG9hZEFub21hbGllc1RhYmxlRGF0YSh6b29tRnJvbS5nZXRUaW1lKCksIHpvb21Uby5nZXRUaW1lKCkpLnN1YnNjcmliZShmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpczMuc2V0U3RhdGUocmVzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChwcmV2aW91c1Byb3BzLnRhYmxlSW50ZXJ2YWwgIT09IHRoaXMucHJvcHMudGFibGVJbnRlcnZhbCB8fCBwcmV2aW91c1Byb3BzLnRhYmxlU2V2ZXJpdHkgIT09IHRoaXMucHJvcHMudGFibGVTZXZlcml0eSkgewogICAgICAgIHRhYmxlQ29udHJvbHNMaXN0ZW5lcigpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiY29tcG9uZW50V2lsbFVubW91bnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTsKICAgICAgdGhpcy5yZXNpemVDaGVja2VyLmRlc3Ryb3koKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgX3RoaXMkcHJvcHM3ID0gdGhpcy5wcm9wcywKICAgICAgICAgIGF1dG9ab29tRHVyYXRpb24gPSBfdGhpcyRwcm9wczcuYXV0b1pvb21EdXJhdGlvbiwKICAgICAgICAgIGJvdW5kcyA9IF90aGlzJHByb3BzNy5ib3VuZHMsCiAgICAgICAgICBkYXRlRm9ybWF0VHogPSBfdGhpcyRwcm9wczcuZGF0ZUZvcm1hdFR6LAogICAgICAgICAgbGFzdFJlZnJlc2ggPSBfdGhpcyRwcm9wczcubGFzdFJlZnJlc2gsCiAgICAgICAgICBzZWxlY3RlZERldGVjdG9ySW5kZXggPSBfdGhpcyRwcm9wczcuc2VsZWN0ZWREZXRlY3RvckluZGV4LAogICAgICAgICAgc2VsZWN0ZWRKb2JJZCA9IF90aGlzJHByb3BzNy5zZWxlY3RlZEpvYklkOwogICAgICB2YXIgX3RoaXMkc3RhdGUyID0gdGhpcy5zdGF0ZSwKICAgICAgICAgIGNoYXJ0RGV0YWlscyA9IF90aGlzJHN0YXRlMi5jaGFydERldGFpbHMsCiAgICAgICAgICBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbCA9IF90aGlzJHN0YXRlMi5jb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbCwKICAgICAgICAgIGNvbnRleHRDaGFydERhdGEgPSBfdGhpcyRzdGF0ZTIuY29udGV4dENoYXJ0RGF0YSwKICAgICAgICAgIGNvbnRleHRGb3JlY2FzdERhdGEgPSBfdGhpcyRzdGF0ZTIuY29udGV4dEZvcmVjYXN0RGF0YSwKICAgICAgICAgIGRhdGFOb3RDaGFydGFibGUgPSBfdGhpcyRzdGF0ZTIuZGF0YU5vdENoYXJ0YWJsZSwKICAgICAgICAgIGVudGl0eVZhbHVlcyA9IF90aGlzJHN0YXRlMi5lbnRpdHlWYWx1ZXMsCiAgICAgICAgICBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwgPSBfdGhpcyRzdGF0ZTIuZm9jdXNBZ2dyZWdhdGlvbkludGVydmFsLAogICAgICAgICAgZm9jdXNBbm5vdGF0aW9uRGF0YSA9IF90aGlzJHN0YXRlMi5mb2N1c0Fubm90YXRpb25EYXRhLAogICAgICAgICAgZm9jdXNDaGFydERhdGEgPSBfdGhpcyRzdGF0ZTIuZm9jdXNDaGFydERhdGEsCiAgICAgICAgICBmb2N1c0ZvcmVjYXN0RGF0YSA9IF90aGlzJHN0YXRlMi5mb2N1c0ZvcmVjYXN0RGF0YSwKICAgICAgICAgIGZ1bGxSZWZyZXNoID0gX3RoaXMkc3RhdGUyLmZ1bGxSZWZyZXNoLAogICAgICAgICAgaGFzUmVzdWx0cyA9IF90aGlzJHN0YXRlMi5oYXNSZXN1bHRzLAogICAgICAgICAgbG9hZGluZyA9IF90aGlzJHN0YXRlMi5sb2FkaW5nLAogICAgICAgICAgbW9kZWxQbG90RW5hYmxlZCA9IF90aGlzJHN0YXRlMi5tb2RlbFBsb3RFbmFibGVkLAogICAgICAgICAgc2hvd0Fubm90YXRpb25zID0gX3RoaXMkc3RhdGUyLnNob3dBbm5vdGF0aW9ucywKICAgICAgICAgIHNob3dBbm5vdGF0aW9uc0NoZWNrYm94ID0gX3RoaXMkc3RhdGUyLnNob3dBbm5vdGF0aW9uc0NoZWNrYm94LAogICAgICAgICAgc2hvd0ZvcmVjYXN0ID0gX3RoaXMkc3RhdGUyLnNob3dGb3JlY2FzdCwKICAgICAgICAgIHNob3dGb3JlY2FzdENoZWNrYm94ID0gX3RoaXMkc3RhdGUyLnNob3dGb3JlY2FzdENoZWNrYm94LAogICAgICAgICAgc2hvd01vZGVsQm91bmRzID0gX3RoaXMkc3RhdGUyLnNob3dNb2RlbEJvdW5kcywKICAgICAgICAgIHNob3dNb2RlbEJvdW5kc0NoZWNrYm94ID0gX3RoaXMkc3RhdGUyLnNob3dNb2RlbEJvdW5kc0NoZWNrYm94LAogICAgICAgICAgc3ZnV2lkdGggPSBfdGhpcyRzdGF0ZTIuc3ZnV2lkdGgsCiAgICAgICAgICBzd2ltbGFuZURhdGEgPSBfdGhpcyRzdGF0ZTIuc3dpbWxhbmVEYXRhLAogICAgICAgICAgdGFibGVEYXRhID0gX3RoaXMkc3RhdGUyLnRhYmxlRGF0YSwKICAgICAgICAgIHpvb21Gcm9tID0gX3RoaXMkc3RhdGUyLnpvb21Gcm9tLAogICAgICAgICAgem9vbVRvID0gX3RoaXMkc3RhdGUyLnpvb21UbywKICAgICAgICAgIHpvb21Gcm9tRm9jdXNMb2FkZWQgPSBfdGhpcyRzdGF0ZTIuem9vbUZyb21Gb2N1c0xvYWRlZCwKICAgICAgICAgIHpvb21Ub0ZvY3VzTG9hZGVkID0gX3RoaXMkc3RhdGUyLnpvb21Ub0ZvY3VzTG9hZGVkOwogICAgICB2YXIgY2hhcnRQcm9wcyA9IHsKICAgICAgICBtb2RlbFBsb3RFbmFibGVkOiBtb2RlbFBsb3RFbmFibGVkLAogICAgICAgIGNvbnRleHRDaGFydERhdGE6IGNvbnRleHRDaGFydERhdGEsCiAgICAgICAgY29udGV4dENoYXJ0U2VsZWN0ZWQ6IHRoaXMuY29udGV4dENoYXJ0U2VsZWN0ZWQsCiAgICAgICAgY29udGV4dEZvcmVjYXN0RGF0YTogY29udGV4dEZvcmVjYXN0RGF0YSwKICAgICAgICBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbDogY29udGV4dEFnZ3JlZ2F0aW9uSW50ZXJ2YWwsCiAgICAgICAgc3dpbWxhbmVEYXRhOiBzd2ltbGFuZURhdGEsCiAgICAgICAgZm9jdXNBbm5vdGF0aW9uRGF0YTogZm9jdXNBbm5vdGF0aW9uRGF0YSwKICAgICAgICBmb2N1c0NoYXJ0RGF0YTogZm9jdXNDaGFydERhdGEsCiAgICAgICAgZm9jdXNGb3JlY2FzdERhdGE6IGZvY3VzRm9yZWNhc3REYXRhLAogICAgICAgIGZvY3VzQWdncmVnYXRpb25JbnRlcnZhbDogZm9jdXNBZ2dyZWdhdGlvbkludGVydmFsLAogICAgICAgIHN2Z1dpZHRoOiBzdmdXaWR0aCwKICAgICAgICB6b29tRnJvbTogem9vbUZyb20sCiAgICAgICAgem9vbVRvOiB6b29tVG8sCiAgICAgICAgem9vbUZyb21Gb2N1c0xvYWRlZDogem9vbUZyb21Gb2N1c0xvYWRlZCwKICAgICAgICB6b29tVG9Gb2N1c0xvYWRlZDogem9vbVRvRm9jdXNMb2FkZWQsCiAgICAgICAgYXV0b1pvb21EdXJhdGlvbjogYXV0b1pvb21EdXJhdGlvbgogICAgICB9OwogICAgICB2YXIgam9icyA9ICgwLCBfdGltZXNlcmllc2V4cGxvcmVyX3V0aWxzLmNyZWF0ZVRpbWVTZXJpZXNKb2JEYXRhKShfam9iX3NlcnZpY2UubWxKb2JTZXJ2aWNlLmpvYnMpOwoKICAgICAgaWYgKHNlbGVjdGVkRGV0ZWN0b3JJbmRleCA9PT0gdW5kZWZpbmVkIHx8IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfdGltZXNlcmllc2V4cGxvcmVyX3BhZ2UuVGltZVNlcmllc0V4cGxvcmVyUGFnZSwgewogICAgICAgICAgZGF0ZUZvcm1hdFR6OiBkYXRlRm9ybWF0VHosCiAgICAgICAgICByZXNpemVSZWY6IHRoaXMucmVzaXplUmVmCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBzZWxlY3RlZEpvYiA9IF9qb2Jfc2VydmljZS5tbEpvYlNlcnZpY2UuZ2V0Sm9iKHNlbGVjdGVkSm9iSWQpOwoKICAgICAgdmFyIGVudGl0eUNvbnRyb2xzID0gdGhpcy5nZXRDb250cm9sc0ZvckRldGVjdG9yKCk7CiAgICAgIHZhciBmaWVsZE5hbWVzV2l0aEVtcHR5VmFsdWVzID0gdGhpcy5nZXRGaWVsZE5hbWVzV2l0aEVtcHR5VmFsdWVzKCk7CiAgICAgIHZhciBhcmVQYXJ0aXRpb25pbmdGaWVsZHNQcm92aWRlZCA9IHRoaXMuYXJlUGFydGl0aW9uaW5nRmllbGRzUHJvdmlkZWQoKTsKICAgICAgdmFyIGRldGVjdG9yU2VsZWN0T3B0aW9ucyA9IGdldFZpZXdhYmxlRGV0ZWN0b3JzKHNlbGVjdGVkSm9iKS5tYXAoZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdmFsdWU6IGQuaW5kZXgsCiAgICAgICAgICB0ZXh0OiBkLmRldGVjdG9yX2Rlc2NyaXB0aW9uCiAgICAgICAgfTsKICAgICAgfSk7CiAgICAgIHZhciByZW5kZXJGb2N1c0NoYXJ0T25seSA9IHRydWU7CgogICAgICBpZiAoKDAsIF9sb2Rhc2guaXNFcXVhbCkodGhpcy5wcmV2aW91c0NoYXJ0UHJvcHMuZm9jdXNGb3JlY2FzdERhdGEsIGNoYXJ0UHJvcHMuZm9jdXNGb3JlY2FzdERhdGEpICYmICgwLCBfbG9kYXNoLmlzRXF1YWwpKHRoaXMucHJldmlvdXNDaGFydFByb3BzLmZvY3VzQ2hhcnREYXRhLCBjaGFydFByb3BzLmZvY3VzQ2hhcnREYXRhKSAmJiAoMCwgX2xvZGFzaC5pc0VxdWFsKSh0aGlzLnByZXZpb3VzQ2hhcnRQcm9wcy5mb2N1c0Fubm90YXRpb25EYXRhLCBjaGFydFByb3BzLmZvY3VzQW5ub3RhdGlvbkRhdGEpICYmIHRoaXMucHJldmlvdXNTaG93QW5ub3RhdGlvbnMgPT09IHNob3dBbm5vdGF0aW9ucyAmJiB0aGlzLnByZXZpb3VzU2hvd0ZvcmVjYXN0ID09PSBzaG93Rm9yZWNhc3QgJiYgdGhpcy5wcmV2aW91c1Nob3dNb2RlbEJvdW5kcyA9PT0gc2hvd01vZGVsQm91bmRzICYmIHRoaXMucHJvcHMucHJldmlvdXNSZWZyZXNoID09PSBsYXN0UmVmcmVzaCkgewogICAgICAgIHJlbmRlckZvY3VzQ2hhcnRPbmx5ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMucHJldmlvdXNDaGFydFByb3BzID0gY2hhcnRQcm9wczsKICAgICAgdGhpcy5wcmV2aW91c1Nob3dBbm5vdGF0aW9ucyA9IHNob3dBbm5vdGF0aW9uczsKICAgICAgdGhpcy5wcmV2aW91c1Nob3dGb3JlY2FzdCA9IHNob3dGb3JlY2FzdDsKICAgICAgdGhpcy5wcmV2aW91c1Nob3dNb2RlbEJvdW5kcyA9IHNob3dNb2RlbEJvdW5kczsKICAgICAgLyoqCiAgICAgICAqIEluZGljYXRlcyBpZiBhbnkgb2YgdGhlIHByZXZpb3VzIGNvbnRyb2xzIGlzIGVtcHR5LgogICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICovCgogICAgICB2YXIgaGFzRW1wdHlGaWVsZFZhbHVlcyA9IGZhbHNlOwogICAgICByZXR1cm4gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfdGltZXNlcmllc2V4cGxvcmVyX3BhZ2UuVGltZVNlcmllc0V4cGxvcmVyUGFnZSwgewogICAgICAgIGRhdGVGb3JtYXRUejogZGF0ZUZvcm1hdFR6LAogICAgICAgIGxvYWRpbmc6IGxvYWRpbmcsCiAgICAgICAgcmVzaXplUmVmOiB0aGlzLnJlc2l6ZVJlZgogICAgICB9LCBmaWVsZE5hbWVzV2l0aEVtcHR5VmFsdWVzLmxlbmd0aCA+IDAgJiYgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUNhbGxPdXQsIHsKICAgICAgICBjbGFzc05hbWU6ICJzaW5nbGUtbWV0cmljLXJlcXVlc3QtY2FsbG91dCIsCiAgICAgICAgdGl0bGU6IF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX3JlYWN0Mi5Gb3JtYXR0ZWRNZXNzYWdlLCB7CiAgICAgICAgICBpZDogInhwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci5zaW5nbGVNZXRyaWNSZXF1aXJlZE1lc3NhZ2UiLAogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICJUbyB2aWV3IGEgc2luZ2xlIG1ldHJpYyB5b3UgbXVzdCBzZWxlY3Qge21pc3NpbmdWYWx1ZXNDb3VudCwgcGx1cmFsLCBvbmUge2EgdmFsdWUgZm9yIHtmaWVsZE5hbWUxfX0gb3RoZXIge3ZhbHVlcyBmb3Ige2ZpZWxkTmFtZTF9IGFuZCB7ZmllbGROYW1lMn19fSIsCiAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgbWlzc2luZ1ZhbHVlc0NvdW50OiBmaWVsZE5hbWVzV2l0aEVtcHR5VmFsdWVzLmxlbmd0aCwKICAgICAgICAgICAgZmllbGROYW1lMTogZmllbGROYW1lc1dpdGhFbXB0eVZhbHVlc1swXSwKICAgICAgICAgICAgZmllbGROYW1lMjogZmllbGROYW1lc1dpdGhFbXB0eVZhbHVlc1sxXQogICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIGNvbG9yOiAid2FybmluZyIsCiAgICAgICAgaWNvblR5cGU6ICJoZWxwIiwKICAgICAgICBzaXplOiAicyIKICAgICAgfSksIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgICAgICBjbGFzc05hbWU6ICJzZXJpZXMtY29udHJvbHMiLAogICAgICAgICJkYXRhLXRlc3Qtc3ViaiI6ICJtbFNpbmdsZU1ldHJpY1ZpZXdlclNlcmllc0NvbnRyb2xzIgogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRmxleEdyb3VwLCBudWxsLCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRmxleEl0ZW0sIHsKICAgICAgICBncm93OiBmYWxzZQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRm9ybVJvdywgewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLmRldGVjdG9yTGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0RldGVjdG9yJwogICAgICAgIH0pCiAgICAgIH0sIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2V1aS5FdWlTZWxlY3QsIHsKICAgICAgICBvbkNoYW5nZTogdGhpcy5kZXRlY3RvckluZGV4Q2hhbmdlSGFuZGxlciwKICAgICAgICB2YWx1ZTogc2VsZWN0ZWREZXRlY3RvckluZGV4LAogICAgICAgIG9wdGlvbnM6IGRldGVjdG9yU2VsZWN0T3B0aW9ucywKICAgICAgICAiZGF0YS10ZXN0LXN1YmoiOiAibWxTaW5nbGVNZXRyaWNWaWV3ZXJEZXRlY3RvclNlbGVjdCIKICAgICAgfSkpKSwgZW50aXR5Q29udHJvbHMubWFwKGZ1bmN0aW9uIChlbnRpdHkpIHsKICAgICAgICB2YXIgZW50aXR5S2V5ID0gIiIuY29uY2F0KGVudGl0eS5maWVsZE5hbWUpOwogICAgICAgIHZhciBmb3JjZVNlbGVjdGlvbiA9ICFoYXNFbXB0eUZpZWxkVmFsdWVzICYmICFlbnRpdHkuZmllbGRWYWx1ZTsKICAgICAgICBoYXNFbXB0eUZpZWxkVmFsdWVzID0gIWhhc0VtcHR5RmllbGRWYWx1ZXMgJiYgZm9yY2VTZWxlY3Rpb247CiAgICAgICAgcmV0dXJuIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2VudGl0eV9jb250cm9sLkVudGl0eUNvbnRyb2wsIHsKICAgICAgICAgIGVudGl0eTogZW50aXR5LAogICAgICAgICAgZW50aXR5RmllbGRWYWx1ZUNoYW5nZWQ6IF90aGlzNC5lbnRpdHlGaWVsZFZhbHVlQ2hhbmdlZCwKICAgICAgICAgIGlzTG9hZGluZzogX3RoaXM0LnN0YXRlLmVudGl0aWVzTG9hZGluZywKICAgICAgICAgIG9uU2VhcmNoQ2hhbmdlOiBfdGhpczQuZW50aXR5RmllbGRTZWFyY2hDaGFuZ2VkLAogICAgICAgICAgZm9yY2VTZWxlY3Rpb246IGZvcmNlU2VsZWN0aW9uLAogICAgICAgICAga2V5OiBlbnRpdHlLZXksCiAgICAgICAgICBvcHRpb25zOiBnZXRFbnRpdHlDb250cm9sT3B0aW9ucyhlbnRpdHlWYWx1ZXNbZW50aXR5LmZpZWxkTmFtZV0pCiAgICAgICAgfSk7CiAgICAgIH0pLCBhcmVQYXJ0aXRpb25pbmdGaWVsZHNQcm92aWRlZCAmJiBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRmxleEl0ZW0sIHsKICAgICAgICBzdHlsZTogewogICAgICAgICAgdGV4dEFsaWduOiAncmlnaHQnCiAgICAgICAgfQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRm9ybVJvdywgewogICAgICAgIGhhc0VtcHR5TGFiZWxTcGFjZTogdHJ1ZSwKICAgICAgICBzdHlsZTogewogICAgICAgICAgbWF4V2lkdGg6ICcxMDAlJwogICAgICAgIH0KICAgICAgfSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZm9yZWNhc3RpbmdfbW9kYWwuRm9yZWNhc3RpbmdNb2RhbCwgewogICAgICAgIGpvYjogc2VsZWN0ZWRKb2IsCiAgICAgICAgZGV0ZWN0b3JJbmRleDogc2VsZWN0ZWREZXRlY3RvckluZGV4LAogICAgICAgIGVudGl0aWVzOiBlbnRpdHlDb250cm9scywKICAgICAgICBzZXRGb3JlY2FzdElkOiB0aGlzLnNldEZvcmVjYXN0SWQsCiAgICAgICAgY2xhc3NOYW1lOiAiZm9yZWNhc3QtY29udHJvbHMiCiAgICAgIH0pKSkpKSwgZnVsbFJlZnJlc2ggJiYgbG9hZGluZyA9PT0gdHJ1ZSAmJiBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9sb2FkaW5nX2luZGljYXRvci5Mb2FkaW5nSW5kaWNhdG9yLCB7CiAgICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIubG9hZGluZ0xhYmVsJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdMb2FkaW5nJwogICAgICAgIH0pCiAgICAgIH0pLCBhcmVQYXJ0aXRpb25pbmdGaWVsZHNQcm92aWRlZCAmJiBqb2JzLmxlbmd0aCA+IDAgJiYgKGZ1bGxSZWZyZXNoID09PSBmYWxzZSB8fCBsb2FkaW5nID09PSBmYWxzZSkgJiYgaGFzUmVzdWx0cyA9PT0gZmFsc2UgJiYgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfdGltZXNlcmllc2V4cGxvcmVyX25vX2NoYXJ0X2RhdGEuVGltZXNlcmllc2V4cGxvcmVyTm9DaGFydERhdGEsIHsKICAgICAgICBkYXRhTm90Q2hhcnRhYmxlOiBkYXRhTm90Q2hhcnRhYmxlLAogICAgICAgIGVudGl0aWVzOiBlbnRpdHlDb250cm9scwogICAgICB9KSwgYXJlUGFydGl0aW9uaW5nRmllbGRzUHJvdmlkZWQgJiYgam9icy5sZW5ndGggPiAwICYmIChmdWxsUmVmcmVzaCA9PT0gZmFsc2UgfHwgbG9hZGluZyA9PT0gZmFsc2UpICYmIGhhc1Jlc3VsdHMgPT09IHRydWUgJiYgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudCgiZGl2IiwgbnVsbCwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfY2hhcnRfdG9vbHRpcC5DaGFydFRvb2x0aXAsIG51bGwpLCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpVGV4dCwgewogICAgICAgIGNsYXNzTmFtZTogInJlc3VsdHMtY29udGFpbmVyIgogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgIGNsYXNzTmFtZTogInBhbmVsLXRpdGxlIgogICAgICB9LCBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnNpbmdsZVRpbWVTZXJpZXNBbmFseXNpc1RpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnU2luZ2xlIHRpbWUgc2VyaWVzIGFuYWx5c2lzIG9mIHtmdW5jdGlvbkxhYmVsfScsCiAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICBmdW5jdGlvbkxhYmVsOiBjaGFydERldGFpbHMuZnVuY3Rpb25MYWJlbAogICAgICAgIH0KICAgICAgfSkpLCAiXHhBMCIsIGNoYXJ0RGV0YWlscy5lbnRpdHlEYXRhLmNvdW50ID09PSAxICYmIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgY2xhc3NOYW1lOiAiZW50aXR5LWNvdW50LXRleHQiCiAgICAgIH0sIGNoYXJ0RGV0YWlscy5lbnRpdHlEYXRhLmVudGl0aWVzLmxlbmd0aCA+IDAgJiYgJygnLCBjaGFydERldGFpbHMuZW50aXR5RGF0YS5lbnRpdGllcy5tYXAoZnVuY3Rpb24gKGVudGl0eSkgewogICAgICAgIHJldHVybiAiIi5jb25jYXQoZW50aXR5LmZpZWxkTmFtZSwgIjogIikuY29uY2F0KGVudGl0eS5maWVsZFZhbHVlKTsKICAgICAgfSkuam9pbignLCAnKSwgY2hhcnREZXRhaWxzLmVudGl0eURhdGEuZW50aXRpZXMubGVuZ3RoID4gMCAmJiAnKScpLCBjaGFydERldGFpbHMuZW50aXR5RGF0YS5jb3VudCAhPT0gMSAmJiBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgIGNsYXNzTmFtZTogImVudGl0eS1jb3VudC10ZXh0IgogICAgICB9LCBjaGFydERldGFpbHMuZW50aXR5RGF0YS5lbnRpdGllcy5tYXAoZnVuY3Rpb24gKGNvdW50RGF0YSwgaSkgewogICAgICAgIHJldHVybiBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9yZWFjdC5GcmFnbWVudCwgewogICAgICAgICAga2V5OiBjb3VudERhdGEuZmllbGROYW1lCiAgICAgICAgfSwgX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci5jb3VudERhdGFJbkNoYXJ0RGV0YWlsc0Rlc2NyaXB0aW9uJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICd7b3BlbkJyYWNlfXtjYXJkaW5hbGl0eVZhbHVlfSBkaXN0aW5jdCB7ZmllbGROYW1lfSB7Y2FyZGluYWxpdHksIHBsdXJhbCwgb25lIHt9IG90aGVyIHsgdmFsdWVzfX17Y2xvc2VCcmFjZX0nLAogICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgIG9wZW5CcmFjZTogaSA9PT0gMCA/ICcoJyA6ICcnLAogICAgICAgICAgICBjbG9zZUJyYWNlOiBpID09PSBjaGFydERldGFpbHMuZW50aXR5RGF0YS5lbnRpdGllcy5sZW5ndGggLSAxID8gJyknIDogJycsCiAgICAgICAgICAgIGNhcmRpbmFsaXR5VmFsdWU6IGNvdW50RGF0YS5jYXJkaW5hbGl0eSA9PT0gMCA/IGFsbFZhbHVlc0xhYmVsIDogY291bnREYXRhLmNhcmRpbmFsaXR5LAogICAgICAgICAgICBjYXJkaW5hbGl0eTogY291bnREYXRhLmNhcmRpbmFsaXR5LAogICAgICAgICAgICBmaWVsZE5hbWU6IGNvdW50RGF0YS5maWVsZE5hbWUKICAgICAgICAgIH0KICAgICAgICB9KSwgaSAhPT0gY2hhcnREZXRhaWxzLmVudGl0eURhdGEuZW50aXRpZXMubGVuZ3RoIC0gMSA/ICcsICcgOiAnJyk7CiAgICAgIH0pKSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUZsZXhHcm91cCwgewogICAgICAgIHN0eWxlOiB7CiAgICAgICAgICBmbG9hdDogJ3JpZ2h0JwogICAgICAgIH0KICAgICAgfSwgc2hvd01vZGVsQm91bmRzQ2hlY2tib3ggJiYgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUZsZXhJdGVtLCB7CiAgICAgICAgZ3JvdzogZmFsc2UKICAgICAgfSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUNoZWNrYm94LCB7CiAgICAgICAgaWQ6ICJ0b2dnbGVNb2RlbEJvdW5kc0NoZWNrYm94IiwKICAgICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci5zaG93TW9kZWxCb3VuZHNMYWJlbCcsIHsKICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnc2hvdyBtb2RlbCBib3VuZHMnCiAgICAgICAgfSksCiAgICAgICAgY2hlY2tlZDogc2hvd01vZGVsQm91bmRzLAogICAgICAgIG9uQ2hhbmdlOiB0aGlzLnRvZ2dsZVNob3dNb2RlbEJvdW5kc0hhbmRsZXIKICAgICAgfSkpLCBzaG93QW5ub3RhdGlvbnNDaGVja2JveCAmJiBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRmxleEl0ZW0sIHsKICAgICAgICBncm93OiBmYWxzZQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpQ2hlY2tib3gsIHsKICAgICAgICBpZDogInRvZ2dsZUFubm90YXRpb25zQ2hlY2tib3giLAogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLmFubm90YXRpb25zTGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2Fubm90YXRpb25zJwogICAgICAgIH0pLAogICAgICAgIGNoZWNrZWQ6IHNob3dBbm5vdGF0aW9ucywKICAgICAgICBvbkNoYW5nZTogdGhpcy50b2dnbGVTaG93QW5ub3RhdGlvbnNIYW5kbGVyCiAgICAgIH0pKSwgc2hvd0ZvcmVjYXN0Q2hlY2tib3ggJiYgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUZsZXhJdGVtLCB7CiAgICAgICAgZ3JvdzogZmFsc2UKICAgICAgfSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUNoZWNrYm94LCB7CiAgICAgICAgaWQ6ICJ0b2dnbGVTaG93Rm9yZWNhc3RDaGVja2JveCIsCiAgICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIuc2hvd0ZvcmVjYXN0TGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ3Nob3cgZm9yZWNhc3QnCiAgICAgICAgfSksCiAgICAgICAgY2hlY2tlZDogc2hvd0ZvcmVjYXN0LAogICAgICAgIG9uQ2hhbmdlOiB0aGlzLnRvZ2dsZVNob3dGb3JlY2FzdEhhbmRsZXIKICAgICAgfSkpKSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgICAgIGNsYXNzTmFtZTogIm1sLXRpbWVzZXJpZXMtY2hhcnQiLAogICAgICAgICJkYXRhLXRlc3Qtc3ViaiI6ICJtbFNpbmdsZU1ldHJpY1ZpZXdlckNoYXJ0IgogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF90aW1lc2VyaWVzX2NoYXJ0LlRpbWVzZXJpZXNDaGFydCwgX2V4dGVuZHMoe30sIGNoYXJ0UHJvcHMsIHsKICAgICAgICBib3VuZHM6IGJvdW5kcywKICAgICAgICBkZXRlY3RvckluZGV4OiBzZWxlY3RlZERldGVjdG9ySW5kZXgsCiAgICAgICAgcmVuZGVyRm9jdXNDaGFydE9ubHk6IHJlbmRlckZvY3VzQ2hhcnRPbmx5LAogICAgICAgIHNlbGVjdGVkSm9iOiBzZWxlY3RlZEpvYiwKICAgICAgICBzaG93QW5ub3RhdGlvbnM6IHNob3dBbm5vdGF0aW9ucywKICAgICAgICBzaG93Rm9yZWNhc3Q6IHNob3dGb3JlY2FzdCwKICAgICAgICBzaG93TW9kZWxCb3VuZHM6IHNob3dNb2RlbEJvdW5kcwogICAgICB9KSkpLCBzaG93QW5ub3RhdGlvbnMgJiYgZm9jdXNBbm5vdGF0aW9uRGF0YS5sZW5ndGggPiAwICYmIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIG51bGwsIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgY2xhc3NOYW1lOiAicGFuZWwtdGl0bGUiCiAgICAgIH0sIF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIuYW5ub3RhdGlvbnNUaXRsZScsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0Fubm90YXRpb25zJwogICAgICB9KSksIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2Fubm90YXRpb25zX3RhYmxlLkFubm90YXRpb25zVGFibGUsIHsKICAgICAgICBhbm5vdGF0aW9uczogZm9jdXNBbm5vdGF0aW9uRGF0YSwKICAgICAgICBpc1NpbmdsZU1ldHJpY1ZpZXdlckxpbmtWaXNpYmxlOiBmYWxzZSwKICAgICAgICBpc051bWJlckJhZGdlVmlzaWJsZTogdHJ1ZQogICAgICB9KSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aVNwYWNlciwgewogICAgICAgIHNpemU6ICJsIgogICAgICB9KSksIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2Fubm90YXRpb25fZmx5b3V0LkFubm90YXRpb25GbHlvdXQsIG51bGwpLCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgIGNsYXNzTmFtZTogInBhbmVsLXRpdGxlIgogICAgICB9LCBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLmFub21hbGllc1RpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnQW5vbWFsaWVzJwogICAgICB9KSksIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2V1aS5FdWlGbGV4R3JvdXAsIHsKICAgICAgICBkaXJlY3Rpb246ICJyb3ciLAogICAgICAgIGd1dHRlclNpemU6ICJsIiwKICAgICAgICByZXNwb25zaXZlOiB0cnVlLAogICAgICAgIGNsYXNzTmFtZTogIm1sLWFub21hbGllcy1jb250cm9scyIKICAgICAgfSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUZsZXhJdGVtLCB7CiAgICAgICAgZ3JvdzogZmFsc2UsCiAgICAgICAgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiAnMTcwcHgnCiAgICAgICAgfQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpRm9ybVJvdywgewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnNldmVyaXR5VGhyZXNob2xkTGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1NldmVyaXR5IHRocmVzaG9sZCcKICAgICAgICB9KQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9zZWxlY3Rfc2V2ZXJpdHkuU2VsZWN0U2V2ZXJpdHksIG51bGwpKSksIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2V1aS5FdWlGbGV4SXRlbSwgewogICAgICAgIGdyb3c6IGZhbHNlLAogICAgICAgIHN0eWxlOiB7CiAgICAgICAgICB3aWR0aDogJzE3MHB4JwogICAgICAgIH0KICAgICAgfSwgX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfZXVpLkV1aUZvcm1Sb3csIHsKICAgICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci5pbnRlcnZhbExhYmVsJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdJbnRlcnZhbCcKICAgICAgICB9KQogICAgICB9LCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9zZWxlY3RfaW50ZXJ2YWwuU2VsZWN0SW50ZXJ2YWwsIG51bGwpKSkpLCBfcmVhY3QuZGVmYXVsdC5jcmVhdGVFbGVtZW50KF9ldWkuRXVpU3BhY2VyLCB7CiAgICAgICAgc2l6ZTogIm0iCiAgICAgIH0pKSksIGFyZVBhcnRpdGlvbmluZ0ZpZWxkc1Byb3ZpZGVkICYmIGpvYnMubGVuZ3RoID4gMCAmJiBoYXNSZXN1bHRzID09PSB0cnVlICYmIF9yZWFjdC5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoX2Fub21hbGllc190YWJsZS5Bbm9tYWxpZXNUYWJsZSwgewogICAgICAgIGJvdW5kczogYm91bmRzLAogICAgICAgIHRhYmxlRGF0YTogdGFibGVEYXRhLAogICAgICAgIGZpbHRlcjogdGhpcy50YWJsZUZpbHRlcgogICAgICB9KSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gVGltZVNlcmllc0V4cGxvcmVyOwp9KF9yZWFjdC5kZWZhdWx0LkNvbXBvbmVudCk7CgpleHBvcnRzLlRpbWVTZXJpZXNFeHBsb3JlciA9IFRpbWVTZXJpZXNFeHBsb3JlcjsKCl9kZWZpbmVQcm9wZXJ0eShUaW1lU2VyaWVzRXhwbG9yZXIsICJwcm9wVHlwZXMiLCB7CiAgYXBwU3RhdGVIYW5kbGVyOiBfcHJvcFR5cGVzLmRlZmF1bHQuZnVuYy5pc1JlcXVpcmVkLAogIGF1dG9ab29tRHVyYXRpb246IF9wcm9wVHlwZXMuZGVmYXVsdC5udW1iZXIuaXNSZXF1aXJlZCwKICBib3VuZHM6IF9wcm9wVHlwZXMuZGVmYXVsdC5vYmplY3QuaXNSZXF1aXJlZCwKICBkYXRlRm9ybWF0VHo6IF9wcm9wVHlwZXMuZGVmYXVsdC5zdHJpbmcuaXNSZXF1aXJlZCwKICBsYXN0UmVmcmVzaDogX3Byb3BUeXBlcy5kZWZhdWx0Lm51bWJlci5pc1JlcXVpcmVkLAogIHByZXZpb3VzUmVmcmVzaDogX3Byb3BUeXBlcy5kZWZhdWx0Lm51bWJlci5pc1JlcXVpcmVkLAogIHNlbGVjdGVkSm9iSWQ6IF9wcm9wVHlwZXMuZGVmYXVsdC5zdHJpbmcuaXNSZXF1aXJlZCwKICBzZWxlY3RlZERldGVjdG9ySW5kZXg6IF9wcm9wVHlwZXMuZGVmYXVsdC5udW1iZXIsCiAgc2VsZWN0ZWRFbnRpdGllczogX3Byb3BUeXBlcy5kZWZhdWx0Lm9iamVjdCwKICBzZWxlY3RlZEZvcmVjYXN0SWQ6IF9wcm9wVHlwZXMuZGVmYXVsdC5zdHJpbmcsCiAgdGFibGVJbnRlcnZhbDogX3Byb3BUeXBlcy5kZWZhdWx0LnN0cmluZywKICB0YWJsZVNldmVyaXR5OiBfcHJvcFR5cGVzLmRlZmF1bHQubnVtYmVyLAogIHpvb206IF9wcm9wVHlwZXMuZGVmYXVsdC5vYmplY3QKfSk7"},null]}