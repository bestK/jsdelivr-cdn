{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/ml/public/application/timeseriesexplorer/components/timeseries_chart/timeseries_chart.js","dependencies":[{"path":"x-pack/legacy/plugins/ml/public/application/timeseriesexplorer/components/timeseries_chart/timeseries_chart.js","mtime":1585205046000},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLlRpbWVzZXJpZXNDaGFydCA9IHZvaWQgMDsKCnZhciBfcHJvcFR5cGVzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJwcm9wLXR5cGVzIikpOwoKdmFyIF9yZWFjdCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgicmVhY3QiKSk7Cgp2YXIgX3VzZU9ic2VydmFibGUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoInJlYWN0LXVzZS9saWIvdXNlT2JzZXJ2YWJsZSIpKTsKCnZhciBfbG9kYXNoID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJsb2Rhc2giKSk7Cgp2YXIgX2QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoImQzIikpOwoKdmFyIF9tb21lbnQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIm1vbWVudCIpKTsKCnZhciBfY2hyb21lID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJ1aS9jaHJvbWUiKSk7Cgp2YXIgX2Fub21hbHlfdXRpbHMgPSByZXF1aXJlKCIuLi8uLi8uLi8uLi8uLi9jb21tb24vdXRpbC9hbm9tYWx5X3V0aWxzIik7Cgp2YXIgX2Fubm90YXRpb25zX3NlcnZpY2UgPSByZXF1aXJlKCIuLi8uLi8uLi9zZXJ2aWNlcy9hbm5vdGF0aW9uc19zZXJ2aWNlIik7Cgp2YXIgX2Zvcm1hdF92YWx1ZSA9IHJlcXVpcmUoIi4uLy4uLy4uL2Zvcm1hdHRlcnMvZm9ybWF0X3ZhbHVlIik7Cgp2YXIgX2NoYXJ0X3V0aWxzID0gcmVxdWlyZSgiLi4vLi4vLi4vdXRpbC9jaGFydF91dGlscyIpOwoKdmFyIF9kYXRlX3V0aWxzID0gcmVxdWlyZSgiLi4vLi4vLi4vdXRpbC9kYXRlX3V0aWxzIik7Cgp2YXIgX3RpbWVfYnVja2V0cyA9IHJlcXVpcmUoIi4uLy4uLy4uL3V0aWwvdGltZV9idWNrZXRzIik7Cgp2YXIgX3RhYmxlX3NlcnZpY2UgPSByZXF1aXJlKCIuLi8uLi8uLi9zZXJ2aWNlcy90YWJsZV9zZXJ2aWNlIik7Cgp2YXIgX2NvbnRleHRfY2hhcnRfbWFzayA9IHJlcXVpcmUoIi4uL2NvbnRleHRfY2hhcnRfbWFzayIpOwoKdmFyIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMgPSByZXF1aXJlKCIuLi8uLi90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMiKTsKCnZhciBfc3RyaW5nX3V0aWxzID0gcmVxdWlyZSgiLi4vLi4vLi4vdXRpbC9zdHJpbmdfdXRpbHMiKTsKCnZhciBfZmllbGRfZm9ybWF0X3NlcnZpY2UgPSByZXF1aXJlKCIuLi8uLi8uLi9zZXJ2aWNlcy9maWVsZF9mb3JtYXRfc2VydmljZSIpOwoKdmFyIF9jaGFydF90b29sdGlwX3NlcnZpY2UgPSByZXF1aXJlKCIuLi8uLi8uLi9jb21wb25lbnRzL2NoYXJ0X3Rvb2x0aXAvY2hhcnRfdG9vbHRpcF9zZXJ2aWNlIik7Cgp2YXIgX3RpbWVzZXJpZXNfY2hhcnRfYW5ub3RhdGlvbnMgPSByZXF1aXJlKCIuL3RpbWVzZXJpZXNfY2hhcnRfYW5ub3RhdGlvbnMiKTsKCnZhciBfcmVhY3QyID0gcmVxdWlyZSgiQGtibi9pMThuL3JlYWN0Iik7Cgp2YXIgX2NsYXNzLCBfdGVtcDsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH07IH0gZWxzZSB7IF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mKG9iaik7IH0KCmZ1bmN0aW9uIF9leHRlbmRzKCkgeyBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldOyBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpKSB7IHRhcmdldFtrZXldID0gc291cmNlW2tleV07IH0gfSB9IHJldHVybiB0YXJnZXQ7IH07IHJldHVybiBfZXh0ZW5kcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9CgpmdW5jdGlvbiBfY3JlYXRlQ2xhc3MoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfQoKZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oc2VsZiwgY2FsbCkgeyBpZiAoY2FsbCAmJiAoX3R5cGVvZihjYWxsKSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGNhbGwgPT09ICJmdW5jdGlvbiIpKSB7IHJldHVybiBjYWxsOyB9IHJldHVybiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpOyB9CgpmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyBfZ2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3QuZ2V0UHJvdG90eXBlT2YgOiBmdW5jdGlvbiBfZ2V0UHJvdG90eXBlT2YobykgeyByZXR1cm4gby5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG8pOyB9OyByZXR1cm4gX2dldFByb3RvdHlwZU9mKG8pOyB9CgpmdW5jdGlvbiBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKHNlbGYpIHsgaWYgKHNlbGYgPT09IHZvaWQgMCkgeyB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOyB9IHJldHVybiBzZWxmOyB9CgpmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAiZnVuY3Rpb24iICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBfc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpOyB9CgpmdW5jdGlvbiBfc2V0UHJvdG90eXBlT2YobywgcCkgeyBfc2V0UHJvdG90eXBlT2YgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwgZnVuY3Rpb24gX3NldFByb3RvdHlwZU9mKG8sIHApIHsgby5fX3Byb3RvX18gPSBwOyByZXR1cm4gbzsgfTsgcmV0dXJuIF9zZXRQcm90b3R5cGVPZihvLCBwKTsgfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkgeyBpZiAoa2V5IGluIG9iaikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsgdmFsdWU6IHZhbHVlLCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pOyB9IGVsc2UgeyBvYmpba2V5XSA9IHZhbHVlOyB9IHJldHVybiBvYmo7IH0KCnZhciBmb2N1c1pvb21QYW5lbEhlaWdodCA9IDI1Owp2YXIgZm9jdXNDaGFydEhlaWdodCA9IDMxMDsKdmFyIGZvY3VzSGVpZ2h0ID0gZm9jdXNab29tUGFuZWxIZWlnaHQgKyBmb2N1c0NoYXJ0SGVpZ2h0Owp2YXIgY29udGV4dENoYXJ0SGVpZ2h0ID0gNjA7CnZhciBjb250ZXh0Q2hhcnRMaW5lVG9wTWFyZ2luID0gMzsKdmFyIGNoYXJ0U3BhY2luZyA9IDI1Owp2YXIgc3dpbWxhbmVIZWlnaHQgPSAzMDsKdmFyIG1hcmdpbiA9IHsKICB0b3A6IDIwLAogIHJpZ2h0OiAxMCwKICBib3R0b206IDE1LAogIGxlZnQ6IDQwCn07Cgp2YXIgbWxBbm5vdGF0aW9uc0VuYWJsZWQgPSBfY2hyb21lLmRlZmF1bHQuZ2V0SW5qZWN0ZWQoJ21sQW5ub3RhdGlvbnNFbmFibGVkJywgZmFsc2UpOwoKdmFyIFpPT01fSU5URVJWQUxfT1BUSU9OUyA9IFt7CiAgZHVyYXRpb246IF9tb21lbnQuZGVmYXVsdC5kdXJhdGlvbigxLCAnaCcpLAogIGxhYmVsOiAnMWgnCn0sIHsKICBkdXJhdGlvbjogX21vbWVudC5kZWZhdWx0LmR1cmF0aW9uKDEyLCAnaCcpLAogIGxhYmVsOiAnMTJoJwp9LCB7CiAgZHVyYXRpb246IF9tb21lbnQuZGVmYXVsdC5kdXJhdGlvbigxLCAnZCcpLAogIGxhYmVsOiAnMWQnCn0sIHsKICBkdXJhdGlvbjogX21vbWVudC5kZWZhdWx0LmR1cmF0aW9uKDEsICd3JyksCiAgbGFiZWw6ICcxdycKfSwgewogIGR1cmF0aW9uOiBfbW9tZW50LmRlZmF1bHQuZHVyYXRpb24oMiwgJ3cnKSwKICBsYWJlbDogJzJ3Jwp9LCB7CiAgZHVyYXRpb246IF9tb21lbnQuZGVmYXVsdC5kdXJhdGlvbigxLCAnTScpLAogIGxhYmVsOiAnMU0nCn1dOyAvLyBTZXQgdXAgdGhlIGNvbG9yIHNjYWxlIHRvIHVzZSBmb3IgaW5kaWNhdGluZyBzY29yZS4KCnZhciBhbm9tYWx5Q29sb3JTY2FsZSA9IF9kLmRlZmF1bHQuc2NhbGUudGhyZXNob2xkKCkuZG9tYWluKFszLCAyNSwgNTAsIDc1LCAxMDBdKS5yYW5nZShbJyNkMmU5ZjcnLCAnIzhiYzhmYicsICcjZmZkZDAwJywgJyNmZjdlMDAnLCAnI2ZlNTA1MCddKTsgLy8gQ3JlYXRlIGEgZ3JheS10b25lZCB2ZXJzaW9uIG9mIHRoZSBjb2xvciBzY2FsZSB0byB1c2UgdW5kZXIgdGhlIGNvbnRleHQgY2hhcnQgbWFzay4KCgp2YXIgYW5vbWFseUdyYXlTY2FsZSA9IF9kLmRlZmF1bHQuc2NhbGUudGhyZXNob2xkKCkuZG9tYWluKFszLCAyNSwgNTAsIDc1LCAxMDBdKS5yYW5nZShbJyNkY2U3ZWQnLCAnI2IwYzVkNicsICcjYjFhMzRlJywgJyNiMTdmNGUnLCAnI2M4ODY4NiddKTsKCmZ1bmN0aW9uIGdldFN2Z0hlaWdodCgpIHsKICByZXR1cm4gZm9jdXNIZWlnaHQgKyBjb250ZXh0Q2hhcnRIZWlnaHQgKyBzd2ltbGFuZUhlaWdodCArIGNoYXJ0U3BhY2luZyArIG1hcmdpbi50b3AgKyBtYXJnaW4uYm90dG9tOwp9Cgp2YXIgVGltZXNlcmllc0NoYXJ0SW50bCA9ICgwLCBfcmVhY3QyLmluamVjdEkxOG4pKChfdGVtcCA9IF9jbGFzcyA9Ci8qI19fUFVSRV9fKi8KZnVuY3Rpb24gKF9SZWFjdCRDb21wb25lbnQpIHsKICBfaW5oZXJpdHMoVGltZXNlcmllc0NoYXJ0LCBfUmVhY3QkQ29tcG9uZW50KTsKCiAgZnVuY3Rpb24gVGltZXNlcmllc0NoYXJ0KCkgewogICAgdmFyIF9nZXRQcm90b3R5cGVPZjI7CgogICAgdmFyIF90aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBUaW1lc2VyaWVzQ2hhcnQpOwoKICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgIF90aGlzID0gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgKF9nZXRQcm90b3R5cGVPZjIgPSBfZ2V0UHJvdG90eXBlT2YoVGltZXNlcmllc0NoYXJ0KSkuY2FsbC5hcHBseShfZ2V0UHJvdG90eXBlT2YyLCBbdGhpc10uY29uY2F0KGFyZ3MpKSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAicm93TW91c2VlbnRlclN1YnNjcmliZXIiLCBudWxsKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJyb3dNb3VzZWxlYXZlU3Vic2NyaWJlciIsIG51bGwpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImNvbnRleHRDaGFydEluaXRpYWxpemVkIiwgZmFsc2UpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImRyYXdDb250ZXh0QnJ1c2giLCBmdW5jdGlvbiAoY29udGV4dEdyb3VwKSB7CiAgICAgIHZhciBjb250ZXh0Q2hhcnRTZWxlY3RlZCA9IF90aGlzLnByb3BzLmNvbnRleHRDaGFydFNlbGVjdGVkOwogICAgICB2YXIgYnJ1c2ggPSBfdGhpcy5icnVzaDsKICAgICAgdmFyIGNvbnRleHRYU2NhbGUgPSBfdGhpcy5jb250ZXh0WFNjYWxlOwogICAgICB2YXIgbWFzayA9IF90aGlzLm1hc2s7IC8vIENyZWF0ZSB0aGUgYnJ1c2ggZm9yIHpvb21pbmcgaW4gdG8gdGhlIGZvY3VzIGFyZWEgb2YgaW50ZXJlc3QuCgogICAgICBicnVzaC54KGNvbnRleHRYU2NhbGUpLm9uKCdicnVzaCcsIGJydXNoaW5nKS5vbignYnJ1c2hlbmQnLCBicnVzaGVkKTsKICAgICAgY29udGV4dEdyb3VwLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ3ggYnJ1c2gnKS5jYWxsKGJydXNoKS5zZWxlY3RBbGwoJ3JlY3QnKS5hdHRyKCd5JywgLTEpLmF0dHIoJ2hlaWdodCcsIGNvbnRleHRDaGFydEhlaWdodCArIHN3aW1sYW5lSGVpZ2h0ICsgMSk7IC8vIG1vdmUgdGhlIGxlZnQgYW5kIHJpZ2h0IHJlc2l6ZSBhcmVhcyBvdmVyIHRvCiAgICAgIC8vIGJlIHVuZGVyIHRoZSBoYW5kbGVzCgogICAgICBjb250ZXh0R3JvdXAuc2VsZWN0QWxsKCcudyByZWN0JykuYXR0cigneCcsIC0xMCkuYXR0cignd2lkdGgnLCAxMCk7CiAgICAgIGNvbnRleHRHcm91cC5zZWxlY3RBbGwoJy5lIHJlY3QnKS5hdHRyKCd4JywgMCkuYXR0cignd2lkdGgnLCAxMCk7CiAgICAgIHZhciBoYW5kbGVCcnVzaEV4dGVudCA9IGJydXNoLmV4dGVudCgpOwogICAgICB2YXIgdG9wQm9yZGVyID0gY29udGV4dEdyb3VwLmFwcGVuZCgncmVjdCcpLmF0dHIoJ2NsYXNzJywgJ3RvcC1ib3JkZXInKS5hdHRyKCd5JywgLTIpLmF0dHIoJ2hlaWdodCcsIGNvbnRleHRDaGFydExpbmVUb3BNYXJnaW4pOyAvLyBEcmF3IHRoZSBicnVzaCBoYW5kbGVzIHVzaW5nIFNWRyBmb3JlaWduT2JqZWN0IGVsZW1lbnRzLgogICAgICAvLyBOb3RlIHRoZXNlIGFyZSBub3Qgc3VwcG9ydGVkIG9uIElFMTEgYW5kIGJlbG93LCBzbyB3aWxsIG5vdCBhcHBlYXIgaW4gSUUuCgogICAgICB2YXIgbGVmdEhhbmRsZSA9IGNvbnRleHRHcm91cC5hcHBlbmQoJ2ZvcmVpZ25PYmplY3QnKS5hdHRyKCd3aWR0aCcsIDEwKS5hdHRyKCdoZWlnaHQnLCA5MCkuYXR0cignY2xhc3MnLCAnYnJ1c2gtaGFuZGxlJykuYXR0cigneCcsIGNvbnRleHRYU2NhbGUoaGFuZGxlQnJ1c2hFeHRlbnRbMF0pIC0gMTApLmh0bWwoJzxkaXYgY2xhc3M9ImJydXNoLWhhbmRsZS1pbm5lciBicnVzaC1oYW5kbGUtaW5uZXItbGVmdCI+PGkgY2xhc3M9ImZhIGZhLWNhcmV0LWxlZnQiPjwvaT48L2Rpdj4nKTsKICAgICAgdmFyIHJpZ2h0SGFuZGxlID0gY29udGV4dEdyb3VwLmFwcGVuZCgnZm9yZWlnbk9iamVjdCcpLmF0dHIoJ3dpZHRoJywgMTApLmF0dHIoJ2hlaWdodCcsIDkwKS5hdHRyKCdjbGFzcycsICdicnVzaC1oYW5kbGUnKS5hdHRyKCd4JywgY29udGV4dFhTY2FsZShoYW5kbGVCcnVzaEV4dGVudFsxXSkgKyAwKS5odG1sKCc8ZGl2IGNsYXNzPSJicnVzaC1oYW5kbGUtaW5uZXIgYnJ1c2gtaGFuZGxlLWlubmVyLXJpZ2h0Ij48aSBjbGFzcz0iZmEgZmEtY2FyZXQtcmlnaHQiPjwvaT48L2Rpdj4nKTsKCiAgICAgIGZ1bmN0aW9uIGJydXNoaW5nKCkgewogICAgICAgIHZhciBicnVzaEV4dGVudCA9IGJydXNoLmV4dGVudCgpOwogICAgICAgIG1hc2sucmV2ZWFsKGJydXNoRXh0ZW50KTsKICAgICAgICBsZWZ0SGFuZGxlLmF0dHIoJ3gnLCBjb250ZXh0WFNjYWxlKGJydXNoRXh0ZW50WzBdKSAtIDEwKTsKICAgICAgICByaWdodEhhbmRsZS5hdHRyKCd4JywgY29udGV4dFhTY2FsZShicnVzaEV4dGVudFsxXSkgKyAwKTsKICAgICAgICB0b3BCb3JkZXIuYXR0cigneCcsIGNvbnRleHRYU2NhbGUoYnJ1c2hFeHRlbnRbMF0pICsgMSk7IC8vIFVzZSBNYXRoLm1heCgwLCAuLi4pIHRvIG1ha2Ugc3VyZSB3ZSBkb24ndCBlbmQgdXAKICAgICAgICAvLyB3aXRoIGEgbmVnYXRpdmUgd2lkdGggd2hpY2ggd291bGQgY2F1c2UgYW4gU1ZHIGVycm9yLgoKICAgICAgICB2YXIgdG9wQm9yZGVyV2lkdGggPSBNYXRoLm1heCgwLCBjb250ZXh0WFNjYWxlKGJydXNoRXh0ZW50WzFdKSAtIGNvbnRleHRYU2NhbGUoYnJ1c2hFeHRlbnRbMF0pIC0gMik7CiAgICAgICAgdG9wQm9yZGVyLmF0dHIoJ3dpZHRoJywgdG9wQm9yZGVyV2lkdGgpOwogICAgICAgIHZhciBpc0VtcHR5ID0gYnJ1c2guZW1wdHkoKTsKCiAgICAgICAgX2QuZGVmYXVsdC5zZWxlY3RBbGwoJy5icnVzaC1oYW5kbGUnKS5zdHlsZSgndmlzaWJpbGl0eScsIGlzRW1wdHkgPyAnaGlkZGVuJyA6ICd2aXNpYmxlJyk7CiAgICAgIH0KCiAgICAgIGJydXNoaW5nKCk7CgogICAgICB2YXIgdGhhdCA9IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpOwoKICAgICAgZnVuY3Rpb24gYnJ1c2hlZCgpIHsKICAgICAgICB2YXIgaXNFbXB0eSA9IGJydXNoLmVtcHR5KCk7CiAgICAgICAgdmFyIHNlbGVjdGVkQm91bmRzID0gaXNFbXB0eSA/IGNvbnRleHRYU2NhbGUuZG9tYWluKCkgOiBicnVzaC5leHRlbnQoKTsKICAgICAgICB2YXIgc2VsZWN0aW9uTWluID0gc2VsZWN0ZWRCb3VuZHNbMF0uZ2V0VGltZSgpOwogICAgICAgIHZhciBzZWxlY3Rpb25NYXggPSBzZWxlY3RlZEJvdW5kc1sxXS5nZXRUaW1lKCk7IC8vIEF2b2lkIHRyaWdnZXJpbmcgYW4gdXBkYXRlIGlmIGJvdW5kcyBoYXZlbid0IGNoYW5nZWQKCiAgICAgICAgaWYgKHRoYXQuc2VsZWN0ZWRCb3VuZHMgIT09IHVuZGVmaW5lZCAmJiB0aGF0LnNlbGVjdGVkQm91bmRzLm1pbi52YWx1ZU9mKCkgPT09IHNlbGVjdGlvbk1pbiAmJiB0aGF0LnNlbGVjdGVkQm91bmRzLm1heC52YWx1ZU9mKCkgPT09IHNlbGVjdGlvbk1heCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gLy8gU2V0IHRoZSBjb2xvciBvZiB0aGUgc3dpbWxhbmUgY2VsbHMgYWNjb3JkaW5nIHRvIHdoZXRoZXIgdGhleSBhcmUgaW5zaWRlIHRoZSBzZWxlY3Rpb24uCgoKICAgICAgICBjb250ZXh0R3JvdXAuc2VsZWN0QWxsKCcuc3dpbWxhbmUtY2VsbCcpLnN0eWxlKCdmaWxsJywgZnVuY3Rpb24gKGQpIHsKICAgICAgICAgIHZhciBjZWxsTXMgPSBkLmRhdGUuZ2V0VGltZSgpOwoKICAgICAgICAgIGlmIChjZWxsTXMgPCBzZWxlY3Rpb25NaW4gfHwgY2VsbE1zID4gc2VsZWN0aW9uTWF4KSB7CiAgICAgICAgICAgIHJldHVybiBhbm9tYWx5R3JheVNjYWxlKGQuc2NvcmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGFub21hbHlDb2xvclNjYWxlKGQuc2NvcmUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoYXQuc2VsZWN0ZWRCb3VuZHMgPSB7CiAgICAgICAgICBtaW46ICgwLCBfbW9tZW50LmRlZmF1bHQpKHNlbGVjdGlvbk1pbiksCiAgICAgICAgICBtYXg6ICgwLCBfbW9tZW50LmRlZmF1bHQpKHNlbGVjdGlvbk1heCkKICAgICAgICB9OwogICAgICAgIGNvbnRleHRDaGFydFNlbGVjdGVkKHsKICAgICAgICAgIGZyb206IHNlbGVjdGVkQm91bmRzWzBdLAogICAgICAgICAgdG86IHNlbGVjdGVkQm91bmRzWzFdCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImRyYXdTd2ltbGFuZSIsIGZ1bmN0aW9uIChzd2xHcm91cCwgc3dsV2lkdGgsIHN3bEhlaWdodCkgewogICAgICB2YXIgX3RoaXMkcHJvcHMgPSBfdGhpcy5wcm9wcywKICAgICAgICAgIGNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsID0gX3RoaXMkcHJvcHMuY29udGV4dEFnZ3JlZ2F0aW9uSW50ZXJ2YWwsCiAgICAgICAgICBzd2ltbGFuZURhdGEgPSBfdGhpcyRwcm9wcy5zd2ltbGFuZURhdGE7CiAgICAgIHZhciBkYXRhID0gc3dpbWxhbmVEYXRhOwoKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBDYWxjdWxhdGUgdGhlIHggYXhpcyBkb21haW4uCiAgICAgIC8vIEVsYXN0aWNzZWFyY2ggYWdncmVnYXRpb24gcmV0dXJucyBwb2ludHMgYXQgc3RhcnQgb2YgYnVja2V0LCBzbyBzZXQgdGhlCiAgICAgIC8vIHgtYXhpcyBtaW4gdG8gdGhlIHN0YXJ0IG9mIHRoZSBhZ2dyZWdhdGlvbiBpbnRlcnZhbC4KICAgICAgLy8gTmVlZCB0byB1c2UgdGhlIG1pbihlYXJsaWVzdCkgYW5kIG1heChlYXJsaWVzdCkgb2YgdGhlIGNvbnRleHQgY2hhcnQKICAgICAgLy8gYWdncmVnYXRpb24gdG8gYWxpZ24gdGhlIGF4ZXMgb2YgdGhlIGNoYXJ0IGFuZCBzd2ltbGFuZSBlbGVtZW50cy4KCgogICAgICB2YXIgeEF4aXNEb21haW4gPSBfdGhpcy5jYWxjdWxhdGVDb250ZXh0WEF4aXNEb21haW4oKTsKCiAgICAgIHZhciB4ID0gX2QuZGVmYXVsdC50aW1lLnNjYWxlKCkucmFuZ2UoWzAsIHN3bFdpZHRoXSkuZG9tYWluKHhBeGlzRG9tYWluKTsKCiAgICAgIHZhciB5ID0gX2QuZGVmYXVsdC5zY2FsZS5saW5lYXIoKS5yYW5nZShbc3dsSGVpZ2h0LCAwXSkuZG9tYWluKFswLCBzd2xIZWlnaHRdKTsKCiAgICAgIHZhciB4QXhpcyA9IF9kLmRlZmF1bHQuc3ZnLmF4aXMoKS5zY2FsZSh4KS5vcmllbnQoJ2JvdHRvbScpLmlubmVyVGlja1NpemUoLXN3bEhlaWdodCkub3V0ZXJUaWNrU2l6ZSgwKTsKCiAgICAgIHZhciB5QXhpcyA9IF9kLmRlZmF1bHQuc3ZnLmF4aXMoKS5zY2FsZSh5KS5vcmllbnQoJ2xlZnQnKS50aWNrVmFsdWVzKHkuZG9tYWluKCkpLmlubmVyVGlja1NpemUoLXN3bFdpZHRoKS5vdXRlclRpY2tTaXplKDApOwoKICAgICAgdmFyIGF4ZXMgPSBzd2xHcm91cC5hcHBlbmQoJ2cnKTsKICAgICAgYXhlcy5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICd4IGF4aXMnKS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKDAsJyArIHN3bEhlaWdodCArICcpJykuY2FsbCh4QXhpcyk7CiAgICAgIGF4ZXMuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAneSBheGlzJykuY2FsbCh5QXhpcyk7CiAgICAgIHZhciBlYXJsaWVzdCA9IHhBeGlzRG9tYWluWzBdLmdldFRpbWUoKTsKICAgICAgdmFyIGxhdGVzdCA9IHhBeGlzRG9tYWluWzFdLmdldFRpbWUoKTsKICAgICAgdmFyIHN3aW1sYW5lQWdnTXMgPSBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbC5hc01pbGxpc2Vjb25kcygpOwogICAgICB2YXIgY2VsbFdpZHRoID0gc3dsV2lkdGggLyAoKGxhdGVzdCAtIGVhcmxpZXN0KSAvIHN3aW1sYW5lQWdnTXMpOwoKICAgICAgaWYgKGNlbGxXaWR0aCA8IDEpIHsKICAgICAgICBjZWxsV2lkdGggPSAxOwogICAgICB9CgogICAgICB2YXIgY2VsbHMgPSBzd2xHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdzd2ltbGFuZS1jZWxscycpLnNlbGVjdEFsbCgncmVjdCcpLmRhdGEoZGF0YSk7CiAgICAgIGNlbGxzLmVudGVyKCkuYXBwZW5kKCdyZWN0JykuYXR0cigneCcsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIHgoZC5kYXRlKTsKICAgICAgfSkuYXR0cigneScsIDApLmF0dHIoJ3J4JywgMCkuYXR0cigncnknLCAwKS5hdHRyKCdjbGFzcycsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGQuc2NvcmUgPiAwID8gJ3N3aW1sYW5lLWNlbGwnIDogJ3N3aW1sYW5lLWNlbGwtaGlkZGVuJzsKICAgICAgfSkuYXR0cignd2lkdGgnLCBjZWxsV2lkdGgpLmF0dHIoJ2hlaWdodCcsIHN3bEhlaWdodCkuc3R5bGUoJ2ZpbGwnLCBmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiBhbm9tYWx5Q29sb3JTY2FsZShkLnNjb3JlKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJjYWxjdWxhdGVDb250ZXh0WEF4aXNEb21haW4iLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdGhpcyRwcm9wczIgPSBfdGhpcy5wcm9wcywKICAgICAgICAgIGJvdW5kcyA9IF90aGlzJHByb3BzMi5ib3VuZHMsCiAgICAgICAgICBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbCA9IF90aGlzJHByb3BzMi5jb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbCwKICAgICAgICAgIHN3aW1sYW5lRGF0YSA9IF90aGlzJHByb3BzMi5zd2ltbGFuZURhdGE7IC8vIENhbGN1bGF0ZXMgdGhlIHggYXhpcyBkb21haW4gZm9yIHRoZSBjb250ZXh0IGVsZW1lbnRzLgogICAgICAvLyBFbGFzdGljc2VhcmNoIGFnZ3JlZ2F0aW9uIHJldHVybnMgcG9pbnRzIGF0IHN0YXJ0IG9mIGJ1Y2tldCwKICAgICAgLy8gc28gc2V0IHRoZSB4LWF4aXMgbWluIHRvIHRoZSBzdGFydCBvZiB0aGUgZmlyc3QgYWdncmVnYXRpb24gaW50ZXJ2YWwsCiAgICAgIC8vIGFuZCB0aGUgeC1heGlzIG1heCB0byB0aGUgZW5kIG9mIHRoZSBsYXN0IGFnZ3JlZ2F0aW9uIGludGVydmFsLgogICAgICAvLyBDb250ZXh0IGNoYXJ0IGFuZCBzd2ltbGFuZSB1c2UgdGhlIHNhbWUgYWdncmVnYXRpb24gaW50ZXJ2YWwuCgogICAgICB2YXIgZWFybGllc3QgPSBib3VuZHMubWluLnZhbHVlT2YoKTsKCiAgICAgIGlmIChzd2ltbGFuZURhdGEgIT09IHVuZGVmaW5lZCAmJiBzd2ltbGFuZURhdGEubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEFkanVzdCB0aGUgZWFybGllc3QgYmFjayB0byB0aGUgdGltZSBvZiB0aGUgZmlyc3Qgc3dpbWxhbmUgcG9pbnQKICAgICAgICAvLyBpZiB0aGlzIGlzIGJlZm9yZSB0aGUgdGltZSBmaWx0ZXIgbWluaW11bS4KICAgICAgICBlYXJsaWVzdCA9IE1hdGgubWluKF9sb2Rhc2guZGVmYXVsdC5maXJzdChzd2ltbGFuZURhdGEpLmRhdGUuZ2V0VGltZSgpLCBib3VuZHMubWluLnZhbHVlT2YoKSk7CiAgICAgIH0KCiAgICAgIHZhciBjb250ZXh0QWdnTXMgPSBjb250ZXh0QWdncmVnYXRpb25JbnRlcnZhbC5hc01pbGxpc2Vjb25kcygpOwogICAgICB2YXIgZWFybGllc3RNcyA9IE1hdGguZmxvb3IoZWFybGllc3QgLyBjb250ZXh0QWdnTXMpICogY29udGV4dEFnZ01zOwogICAgICB2YXIgbGF0ZXN0TXMgPSBNYXRoLmNlaWwoYm91bmRzLm1heC52YWx1ZU9mKCkgLyBjb250ZXh0QWdnTXMpICogY29udGV4dEFnZ01zOwogICAgICByZXR1cm4gW25ldyBEYXRlKGVhcmxpZXN0TXMpLCBuZXcgRGF0ZShsYXRlc3RNcyldOwogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAic2V0Q29udGV4dEJydXNoRXh0ZW50IiwgZnVuY3Rpb24gKGZyb20sIHRvKSB7CiAgICAgIHZhciBicnVzaCA9IF90aGlzLmJydXNoOwogICAgICB2YXIgYnJ1c2hFeHRlbnQgPSBicnVzaC5leHRlbnQoKTsKICAgICAgdmFyIG5ld0V4dGVudCA9IFtmcm9tLCB0b107CiAgICAgIGJydXNoLmV4dGVudChuZXdFeHRlbnQpOwogICAgICBicnVzaChfZC5kZWZhdWx0LnNlbGVjdCgnLmJydXNoJykpOwoKICAgICAgaWYgKG5ld0V4dGVudFswXS5nZXRUaW1lKCkgIT09IGJydXNoRXh0ZW50WzBdLmdldFRpbWUoKSB8fCBuZXdFeHRlbnRbMV0uZ2V0VGltZSgpICE9PSBicnVzaEV4dGVudFsxXS5nZXRUaW1lKCkpIHsKICAgICAgICBicnVzaC5ldmVudChfZC5kZWZhdWx0LnNlbGVjdCgnLmJydXNoJykpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoVGltZXNlcmllc0NoYXJ0LCBbewogICAga2V5OiAiY29tcG9uZW50V2lsbFVubW91bnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICB2YXIgZWxlbWVudCA9IF9kLmRlZmF1bHQuc2VsZWN0KHRoaXMucm9vdE5vZGUpOwoKICAgICAgZWxlbWVudC5odG1sKCcnKTsKCiAgICAgIGlmICh0aGlzLnJvd01vdXNlZW50ZXJTdWJzY3JpYmVyICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3dNb3VzZWVudGVyU3Vic2NyaWJlci51bnN1YnNjcmliZSgpOwogICAgICB9CgogICAgICBpZiAodGhpcy5yb3dNb3VzZWxlYXZlU3Vic2NyaWJlciAhPT0gbnVsbCkgewogICAgICAgIHRoaXMucm93TW91c2VsZWF2ZVN1YnNjcmliZXIudW5zdWJzY3JpYmUoKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogImNvbXBvbmVudERpZE1vdW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjb21wb25lbnREaWRNb3VudCgpIHsKICAgICAgdmFyIHN2Z1dpZHRoID0gdGhpcy5wcm9wcy5zdmdXaWR0aDsKICAgICAgdGhpcy52aXpXaWR0aCA9IHN2Z1dpZHRoIC0gbWFyZ2luLmxlZnQgLSBtYXJnaW4ucmlnaHQ7CiAgICAgIHZhciB2aXpXaWR0aCA9IHRoaXMudml6V2lkdGg7CiAgICAgIHRoaXMuZm9jdXNYU2NhbGUgPSBfZC5kZWZhdWx0LnRpbWUuc2NhbGUoKS5yYW5nZShbMCwgdml6V2lkdGhdKTsKICAgICAgdGhpcy5mb2N1c1lTY2FsZSA9IF9kLmRlZmF1bHQuc2NhbGUubGluZWFyKCkucmFuZ2UoW2ZvY3VzSGVpZ2h0LCBmb2N1c1pvb21QYW5lbEhlaWdodF0pOwogICAgICB2YXIgZm9jdXNYU2NhbGUgPSB0aGlzLmZvY3VzWFNjYWxlOwogICAgICB2YXIgZm9jdXNZU2NhbGUgPSB0aGlzLmZvY3VzWVNjYWxlOwogICAgICB0aGlzLmZvY3VzWEF4aXMgPSBfZC5kZWZhdWx0LnN2Zy5heGlzKCkuc2NhbGUoZm9jdXNYU2NhbGUpLm9yaWVudCgnYm90dG9tJykuaW5uZXJUaWNrU2l6ZSgtZm9jdXNDaGFydEhlaWdodCkub3V0ZXJUaWNrU2l6ZSgwKS50aWNrUGFkZGluZygxMCk7CiAgICAgIHRoaXMuZm9jdXNZQXhpcyA9IF9kLmRlZmF1bHQuc3ZnLmF4aXMoKS5zY2FsZShmb2N1c1lTY2FsZSkub3JpZW50KCdsZWZ0JykuaW5uZXJUaWNrU2l6ZSgtdml6V2lkdGgpLm91dGVyVGlja1NpemUoMCkudGlja1BhZGRpbmcoMTApOwogICAgICB0aGlzLmZvY3VzVmFsdWVzTGluZSA9IF9kLmRlZmF1bHQuc3ZnLmxpbmUoKS54KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGZvY3VzWFNjYWxlKGQuZGF0ZSk7CiAgICAgIH0pLnkoZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gZm9jdXNZU2NhbGUoZC52YWx1ZSk7CiAgICAgIH0pLmRlZmluZWQoZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gZC52YWx1ZSAhPT0gbnVsbDsKICAgICAgfSk7CiAgICAgIHRoaXMuZm9jdXNCb3VuZGVkQXJlYSA9IF9kLmRlZmF1bHQuc3ZnLmFyZWEoKS54KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGZvY3VzWFNjYWxlKGQuZGF0ZSkgfHwgMTsKICAgICAgfSkueTAoZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gZm9jdXNZU2NhbGUoZC51cHBlcik7CiAgICAgIH0pLnkxKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGZvY3VzWVNjYWxlKGQubG93ZXIpOwogICAgICB9KS5kZWZpbmVkKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGQubG93ZXIgIT09IG51bGwgJiYgZC51cHBlciAhPT0gbnVsbDsKICAgICAgfSk7CiAgICAgIHRoaXMuY29udGV4dFhTY2FsZSA9IF9kLmRlZmF1bHQudGltZS5zY2FsZSgpLnJhbmdlKFswLCB2aXpXaWR0aF0pOwogICAgICB0aGlzLmNvbnRleHRZU2NhbGUgPSBfZC5kZWZhdWx0LnNjYWxlLmxpbmVhcigpLnJhbmdlKFtjb250ZXh0Q2hhcnRIZWlnaHQsIGNvbnRleHRDaGFydExpbmVUb3BNYXJnaW5dKTsKICAgICAgdGhpcy5maWVsZEZvcm1hdCA9IHVuZGVmaW5lZDsgLy8gQW5ub3RhdGlvbnMgQnJ1c2gKCiAgICAgIGlmIChtbEFubm90YXRpb25zRW5hYmxlZCkgewogICAgICAgIHRoaXMuYW5ub3RhdGVCcnVzaCA9IF90aW1lc2VyaWVzX2NoYXJ0X2Fubm90YXRpb25zLmdldEFubm90YXRpb25CcnVzaC5jYWxsKHRoaXMpOwogICAgICB9IC8vIGJydXNoIGZvciBmb2N1cyBicnVzaGluZwoKCiAgICAgIHRoaXMuYnJ1c2ggPSBfZC5kZWZhdWx0LnN2Zy5icnVzaCgpOwogICAgICB0aGlzLm1hc2sgPSB1bmRlZmluZWQ7IC8vIExpc3RlbmVycyBmb3IgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgZm9yIHJvd3MgaW4gdGhlIHRhYmxlCiAgICAgIC8vIHRvIGhpZ2hsaWdodCB0aGUgY29ycmVzcG9uZGluZyBhbm9tYWx5IG1hcmsgaW4gdGhlIGZvY3VzIGNoYXJ0LgoKICAgICAgdmFyIGhpZ2hsaWdodEZvY3VzQ2hhcnRBbm9tYWx5ID0gdGhpcy5oaWdobGlnaHRGb2N1c0NoYXJ0QW5vbWFseS5iaW5kKHRoaXMpOwoKICAgICAgdmFyIGJvdW5kSGlnaGxpZ2h0Rm9jdXNDaGFydEFubm90YXRpb24gPSBfdGltZXNlcmllc19jaGFydF9hbm5vdGF0aW9ucy5oaWdobGlnaHRGb2N1c0NoYXJ0QW5ub3RhdGlvbi5iaW5kKHRoaXMpOwoKICAgICAgZnVuY3Rpb24gdGFibGVSZWNvcmRNb3VzZW50ZXJMaXN0ZW5lcihfcmVmKSB7CiAgICAgICAgdmFyIHJlY29yZCA9IF9yZWYucmVjb3JkLAogICAgICAgICAgICBfcmVmJHR5cGUgPSBfcmVmLnR5cGUsCiAgICAgICAgICAgIHR5cGUgPSBfcmVmJHR5cGUgPT09IHZvaWQgMCA/ICdhbm9tYWx5JyA6IF9yZWYkdHlwZTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdhbm9tYWx5JykgewogICAgICAgICAgaGlnaGxpZ2h0Rm9jdXNDaGFydEFub21hbHkocmVjb3JkKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdhbm5vdGF0aW9uJykgewogICAgICAgICAgYm91bmRIaWdobGlnaHRGb2N1c0NoYXJ0QW5ub3RhdGlvbihyZWNvcmQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHVuaGlnaGxpZ2h0Rm9jdXNDaGFydEFub21hbHkgPSB0aGlzLnVuaGlnaGxpZ2h0Rm9jdXNDaGFydEFub21hbHkuYmluZCh0aGlzKTsKCiAgICAgIHZhciBib3VuZFVuaGlnaGxpZ2h0Rm9jdXNDaGFydEFubm90YXRpb24gPSBfdGltZXNlcmllc19jaGFydF9hbm5vdGF0aW9ucy51bmhpZ2hsaWdodEZvY3VzQ2hhcnRBbm5vdGF0aW9uLmJpbmQodGhpcyk7CgogICAgICBmdW5jdGlvbiB0YWJsZVJlY29yZE1vdXNlbGVhdmVMaXN0ZW5lcihfcmVmMikgewogICAgICAgIHZhciByZWNvcmQgPSBfcmVmMi5yZWNvcmQsCiAgICAgICAgICAgIF9yZWYyJHR5cGUgPSBfcmVmMi50eXBlLAogICAgICAgICAgICB0eXBlID0gX3JlZjIkdHlwZSA9PT0gdm9pZCAwID8gJ2Fub21hbHknIDogX3JlZjIkdHlwZTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdhbm9tYWx5JykgewogICAgICAgICAgdW5oaWdobGlnaHRGb2N1c0NoYXJ0QW5vbWFseShyZWNvcmQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBib3VuZFVuaGlnaGxpZ2h0Rm9jdXNDaGFydEFubm90YXRpb24ocmVjb3JkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMucm93TW91c2VlbnRlclN1YnNjcmliZXIgPSBfdGFibGVfc2VydmljZS5tbFRhYmxlU2VydmljZS5yb3dNb3VzZWVudGVyJC5zdWJzY3JpYmUodGFibGVSZWNvcmRNb3VzZW50ZXJMaXN0ZW5lcik7CiAgICAgIHRoaXMucm93TW91c2VsZWF2ZVN1YnNjcmliZXIgPSBfdGFibGVfc2VydmljZS5tbFRhYmxlU2VydmljZS5yb3dNb3VzZWxlYXZlJC5zdWJzY3JpYmUodGFibGVSZWNvcmRNb3VzZWxlYXZlTGlzdGVuZXIpOwogICAgICB0aGlzLnJlbmRlckNoYXJ0KCk7CiAgICAgIHRoaXMuZHJhd0NvbnRleHRDaGFydFNlbGVjdGlvbigpOwogICAgICB0aGlzLnJlbmRlckZvY3VzQ2hhcnQoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjb21wb25lbnREaWRVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHsKICAgICAgaWYgKHRoaXMucHJvcHMucmVuZGVyRm9jdXNDaGFydE9ubHkgPT09IGZhbHNlIHx8IHByZXZQcm9wcy5zdmdXaWR0aCAhPT0gdGhpcy5wcm9wcy5zdmdXaWR0aCkgewogICAgICAgIHRoaXMucmVuZGVyQ2hhcnQoKTsKICAgICAgICB0aGlzLmRyYXdDb250ZXh0Q2hhcnRTZWxlY3Rpb24oKTsKICAgICAgfQoKICAgICAgdGhpcy5yZW5kZXJGb2N1c0NoYXJ0KCk7CgogICAgICBpZiAobWxBbm5vdGF0aW9uc0VuYWJsZWQgJiYgdGhpcy5wcm9wcy5hbm5vdGF0aW9uID09PSBudWxsKSB7CiAgICAgICAgdmFyIGNoYXJ0RWxlbWVudCA9IF9kLmRlZmF1bHQuc2VsZWN0KHRoaXMucm9vdE5vZGUpOwoKICAgICAgICBjaGFydEVsZW1lbnQuc2VsZWN0KCdnLm1sQW5ub3RhdGlvbkJydXNoJykuY2FsbCh0aGlzLmFubm90YXRlQnJ1c2guZXh0ZW50KFswLCAwXSkpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAicmVuZGVyQ2hhcnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbmRlckNoYXJ0KCkgewogICAgICB2YXIgX3RoaXMkcHJvcHMzID0gdGhpcy5wcm9wcywKICAgICAgICAgIGNvbnRleHRDaGFydERhdGEgPSBfdGhpcyRwcm9wczMuY29udGV4dENoYXJ0RGF0YSwKICAgICAgICAgIGNvbnRleHRGb3JlY2FzdERhdGEgPSBfdGhpcyRwcm9wczMuY29udGV4dEZvcmVjYXN0RGF0YSwKICAgICAgICAgIGRldGVjdG9ySW5kZXggPSBfdGhpcyRwcm9wczMuZGV0ZWN0b3JJbmRleCwKICAgICAgICAgIG1vZGVsUGxvdEVuYWJsZWQgPSBfdGhpcyRwcm9wczMubW9kZWxQbG90RW5hYmxlZCwKICAgICAgICAgIHNlbGVjdGVkSm9iID0gX3RoaXMkcHJvcHMzLnNlbGVjdGVkSm9iLAogICAgICAgICAgc3ZnV2lkdGggPSBfdGhpcyRwcm9wczMuc3ZnV2lkdGg7CiAgICAgIHZhciBjcmVhdGVGb2N1c0NoYXJ0ID0gdGhpcy5jcmVhdGVGb2N1c0NoYXJ0LmJpbmQodGhpcyk7CiAgICAgIHZhciBkcmF3Q29udGV4dEVsZW1lbnRzID0gdGhpcy5kcmF3Q29udGV4dEVsZW1lbnRzLmJpbmQodGhpcyk7CiAgICAgIHZhciBmb2N1c1hTY2FsZSA9IHRoaXMuZm9jdXNYU2NhbGU7CiAgICAgIHZhciBmb2N1c1lBeGlzID0gdGhpcy5mb2N1c1lBeGlzOwogICAgICB2YXIgZm9jdXNZU2NhbGUgPSB0aGlzLmZvY3VzWVNjYWxlOwogICAgICB2YXIgc3ZnSGVpZ2h0ID0gZ2V0U3ZnSGVpZ2h0KCk7IC8vIENsZWFyIGFueSBleGlzdGluZyBlbGVtZW50cyBmcm9tIHRoZSB2aXN1YWxpemF0aW9uLAogICAgICAvLyB0aGVuIGJ1aWxkIHRoZSBzdmcgZWxlbWVudHMgZm9yIHRoZSBidWJibGUgY2hhcnQuCgogICAgICB2YXIgY2hhcnRFbGVtZW50ID0gX2QuZGVmYXVsdC5zZWxlY3QodGhpcy5yb290Tm9kZSk7CgogICAgICBjaGFydEVsZW1lbnQuc2VsZWN0QWxsKCcqJykucmVtb3ZlKCk7CgogICAgICBpZiAodHlwZW9mIHNlbGVjdGVkSm9iICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHRoaXMuZmllbGRGb3JtYXQgPSBfZmllbGRfZm9ybWF0X3NlcnZpY2UubWxGaWVsZEZvcm1hdFNlcnZpY2UuZ2V0RmllbGRGb3JtYXQoc2VsZWN0ZWRKb2Iuam9iX2lkLCBkZXRlY3RvckluZGV4KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChjb250ZXh0Q2hhcnREYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmaWVsZEZvcm1hdCA9IHRoaXMuZmllbGRGb3JtYXQ7CiAgICAgIHZhciBzdmcgPSBjaGFydEVsZW1lbnQuYXBwZW5kKCdzdmcnKS5hdHRyKCd3aWR0aCcsIHN2Z1dpZHRoKS5hdHRyKCdoZWlnaHQnLCBzdmdIZWlnaHQpOwogICAgICB2YXIgY29udGV4dERhdGFNaW47CiAgICAgIHZhciBjb250ZXh0RGF0YU1heDsKCiAgICAgIGlmIChtb2RlbFBsb3RFbmFibGVkID09PSB0cnVlIHx8IGNvbnRleHRGb3JlY2FzdERhdGEgIT09IHVuZGVmaW5lZCAmJiBjb250ZXh0Rm9yZWNhc3REYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgY29tYmluZWREYXRhID0gY29udGV4dEZvcmVjYXN0RGF0YSA9PT0gdW5kZWZpbmVkID8gY29udGV4dENoYXJ0RGF0YSA6IGNvbnRleHRDaGFydERhdGEuY29uY2F0KGNvbnRleHRGb3JlY2FzdERhdGEpOwogICAgICAgIGNvbnRleHREYXRhTWluID0gX2QuZGVmYXVsdC5taW4oY29tYmluZWREYXRhLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgcmV0dXJuIE1hdGgubWluKGQudmFsdWUsIGQubG93ZXIpOwogICAgICAgIH0pOwogICAgICAgIGNvbnRleHREYXRhTWF4ID0gX2QuZGVmYXVsdC5tYXgoY29tYmluZWREYXRhLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgcmV0dXJuIE1hdGgubWF4KGQudmFsdWUsIGQudXBwZXIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRleHREYXRhTWluID0gX2QuZGVmYXVsdC5taW4oY29udGV4dENoYXJ0RGF0YSwgZnVuY3Rpb24gKGQpIHsKICAgICAgICAgIHJldHVybiBkLnZhbHVlOwogICAgICAgIH0pOwogICAgICAgIGNvbnRleHREYXRhTWF4ID0gX2QuZGVmYXVsdC5tYXgoY29udGV4dENoYXJ0RGF0YSwgZnVuY3Rpb24gKGQpIHsKICAgICAgICAgIHJldHVybiBkLnZhbHVlOwogICAgICAgIH0pOwogICAgICB9IC8vIFNldCB0aGUgc2l6ZSBvZiB0aGUgbGVmdCBtYXJnaW4gYWNjb3JkaW5nIHRvIHRoZSB3aWR0aCBvZiB0aGUgbGFyZ2VzdCB5IGF4aXMgdGljayBsYWJlbC4KICAgICAgLy8gVGhlIG1pbiAvIG1heCBvZiB0aGUgYWdncmVnYXRlZCBjb250ZXh0IGNoYXJ0IGRhdGEgbWF5IGJlIGxlc3MgdGhhbiB0aGUgbWluIC8gbWF4IG9mIHRoZQogICAgICAvLyBkYXRhIHdoaWNoIGlzIGRpc3BsYXllZCBpbiB0aGUgZm9jdXMgY2hhcnQgd2hpY2ggaXMgbGlrZWx5IHRvIGJlIHBsb3R0ZWQgYXQgYSBsb3dlcgogICAgICAvLyBhZ2dyZWdhdGlvbiBpbnRlcnZhbC4gVGhlcmVmb3JlIGNlaWwgdGhlIG1pbiAvIG1heCB3aXRoIHRoZSBoaWdoZXIgYWJzb2x1dGUgdmFsdWUgdG8gYWxsb3cKICAgICAgLy8gZm9yIGV4dHJhIHNwYWNlIGZvciBjaGFydCBsYWJlbHMgd2hpY2ggbWF5IGhhdmUgaGlnaGVyIHZhbHVlcyB0aGFuIHRoZSBjb250ZXh0IGRhdGEKICAgICAgLy8gZS5nLiBhZ2dyZWdhdGVkIG1heCBtYXkgYmUgOTUwMCwgd2hlcmVhcyBmb2N1cyBwbG90IG1heCBtYXkgYmUgMTEyMzQuCgoKICAgICAgdmFyIGNlaWxlZE1heCA9IGNvbnRleHREYXRhTWF4ID4gMCA/IE1hdGgucG93KDEwLCBNYXRoLmNlaWwoTWF0aC5sb2cxMChNYXRoLmFicyhjb250ZXh0RGF0YU1heCkpKSkgOiBjb250ZXh0RGF0YU1heDsKICAgICAgdmFyIGZsb29yZWRNaW4gPSBjb250ZXh0RGF0YU1pbiA+PSAwID8gY29udGV4dERhdGFNaW4gOiAtMSAqIE1hdGgucG93KDEwLCBNYXRoLmNlaWwoTWF0aC5sb2cxMChNYXRoLmFicyhjb250ZXh0RGF0YU1pbikpKSk7IC8vIFRlbXBvcmFyaWx5IHNldCB0aGUgZG9tYWluIG9mIHRoZSBmb2N1cyB5IGF4aXMgdG8gdGhlIG1pbiAvIG1heCBvZiB0aGUgZnVsbCBjb250ZXh0IGNoYXJ0CiAgICAgIC8vIGRhdGEgcmFuZ2Ugc28gdGhhdCB3ZSBjYW4gbWVhc3VyZSB0aGUgbWF4aW11bSB0aWNrIGxhYmVsIHdpZHRoIG9uIHRlbXBvcmFyeSB0ZXh0IGVsZW1lbnRzLgoKICAgICAgZm9jdXNZU2NhbGUuZG9tYWluKFtmbG9vcmVkTWluLCBjZWlsZWRNYXhdKTsKICAgICAgdmFyIG1heFlBeGlzTGFiZWxXaWR0aCA9IDA7CiAgICAgIHZhciB0ZW1wTGFiZWxUZXh0ID0gc3ZnLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ3RlbXAtYXhpcy1sYWJlbCB0aWNrJyk7CiAgICAgIHRlbXBMYWJlbFRleHQuc2VsZWN0QWxsKCd0ZXh0LnRlbXAuYXhpcycpLmRhdGEoZm9jdXNZU2NhbGUudGlja3MoKSkuZW50ZXIoKS5hcHBlbmQoJ3RleHQnKS50ZXh0KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgaWYgKGZpZWxkRm9ybWF0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiBmaWVsZEZvcm1hdC5jb252ZXJ0KGQsICd0ZXh0Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmb2N1c1lTY2FsZS50aWNrRm9ybWF0KCkoZCk7CiAgICAgICAgfQogICAgICB9KS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBtYXhZQXhpc0xhYmVsV2lkdGggPSBNYXRoLm1heCh0aGlzLmdldEJCb3goKS53aWR0aCArIGZvY3VzWUF4aXMudGlja1BhZGRpbmcoKSwgbWF4WUF4aXNMYWJlbFdpZHRoKTsKICAgICAgfSkucmVtb3ZlKCk7CgogICAgICBfZC5kZWZhdWx0LnNlbGVjdCgnLnRlbXAtYXhpcy1sYWJlbCcpLnJlbW92ZSgpOwoKICAgICAgbWFyZ2luLmxlZnQgPSBNYXRoLm1heChtYXhZQXhpc0xhYmVsV2lkdGgsIDQwKTsKICAgICAgdGhpcy52aXpXaWR0aCA9IE1hdGgubWF4KHN2Z1dpZHRoIC0gbWFyZ2luLmxlZnQgLSBtYXJnaW4ucmlnaHQsIDApOwogICAgICBmb2N1c1hTY2FsZS5yYW5nZShbMCwgdGhpcy52aXpXaWR0aF0pOwogICAgICBmb2N1c1lBeGlzLmlubmVyVGlja1NpemUoLXRoaXMudml6V2lkdGgpOwogICAgICB2YXIgZm9jdXMgPSBzdmcuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnZm9jdXMtY2hhcnQnKS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyBtYXJnaW4ubGVmdCArICcsJyArIG1hcmdpbi50b3AgKyAnKScpOwogICAgICB2YXIgY29udGV4dCA9IHN2Zy5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdjb250ZXh0LWNoYXJ0JykuYXR0cigndHJhbnNmb3JtJywgJ3RyYW5zbGF0ZSgnICsgbWFyZ2luLmxlZnQgKyAnLCcgKyAoZm9jdXNIZWlnaHQgKyBtYXJnaW4udG9wICsgY2hhcnRTcGFjaW5nKSArICcpJyk7IC8vIE1hc2sgdG8gaGlkZSBhbm5vdGF0aW9ucyBvdmVyZmxvdwoKICAgICAgaWYgKG1sQW5ub3RhdGlvbnNFbmFibGVkKSB7CiAgICAgICAgdmFyIGFubm90YXRpb25zTWFzayA9IHN2Zy5hcHBlbmQoJ2RlZnMnKS5hcHBlbmQoJ21hc2snKS5hdHRyKCdpZCcsIF90aW1lc2VyaWVzX2NoYXJ0X2Fubm90YXRpb25zLkFOTk9UQVRJT05fTUFTS19JRCk7CiAgICAgICAgYW5ub3RhdGlvbnNNYXNrLmFwcGVuZCgncmVjdCcpLmF0dHIoJ3gnLCAwKS5hdHRyKCd5JywgMCkuYXR0cignd2lkdGgnLCB0aGlzLnZpeldpZHRoKS5hdHRyKCdoZWlnaHQnLCBmb2N1c0hlaWdodCkuc3R5bGUoJ2ZpbGwnLCAnd2hpdGUnKTsKICAgICAgfSAvLyBEcmF3IGVhY2ggb2YgdGhlIGNvbXBvbmVudCBlbGVtZW50cy4KCgogICAgICBjcmVhdGVGb2N1c0NoYXJ0KGZvY3VzLCB0aGlzLnZpeldpZHRoLCBmb2N1c0hlaWdodCk7CiAgICAgIGRyYXdDb250ZXh0RWxlbWVudHMoY29udGV4dCwgdGhpcy52aXpXaWR0aCwgY29udGV4dENoYXJ0SGVpZ2h0LCBzd2ltbGFuZUhlaWdodCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZHJhd0NvbnRleHRDaGFydFNlbGVjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZHJhd0NvbnRleHRDaGFydFNlbGVjdGlvbigpIHsKICAgICAgdmFyIF90aGlzJHByb3BzNCA9IHRoaXMucHJvcHMsCiAgICAgICAgICBjb250ZXh0Q2hhcnREYXRhID0gX3RoaXMkcHJvcHM0LmNvbnRleHRDaGFydERhdGEsCiAgICAgICAgICBjb250ZXh0Q2hhcnRTZWxlY3RlZCA9IF90aGlzJHByb3BzNC5jb250ZXh0Q2hhcnRTZWxlY3RlZCwKICAgICAgICAgIGNvbnRleHRGb3JlY2FzdERhdGEgPSBfdGhpcyRwcm9wczQuY29udGV4dEZvcmVjYXN0RGF0YSwKICAgICAgICAgIHpvb21Gcm9tID0gX3RoaXMkcHJvcHM0Lnpvb21Gcm9tLAogICAgICAgICAgem9vbVRvID0gX3RoaXMkcHJvcHM0Lnpvb21UbzsKCiAgICAgIGlmIChjb250ZXh0Q2hhcnREYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gTWFrZSBhcHByb3ByaWF0ZSBzZWxlY3Rpb24gaW4gdGhlIGNvbnRleHQgY2hhcnQgdG8gdHJpZ2dlciBsb2FkaW5nIG9mIHRoZSBmb2N1cyBjaGFydC4KCgogICAgICB2YXIgZm9jdXNMb2FkRnJvbTsKICAgICAgdmFyIGZvY3VzTG9hZFRvOwogICAgICB2YXIgY29udGV4dFhNaW4gPSB0aGlzLmNvbnRleHRYU2NhbGUuZG9tYWluKClbMF0uZ2V0VGltZSgpOwogICAgICB2YXIgY29udGV4dFhNYXggPSB0aGlzLmNvbnRleHRYU2NhbGUuZG9tYWluKClbMV0uZ2V0VGltZSgpOwogICAgICB2YXIgY29tYmluZWREYXRhID0gY29udGV4dENoYXJ0RGF0YTsKCiAgICAgIGlmIChjb250ZXh0Rm9yZWNhc3REYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjb21iaW5lZERhdGEgPSBjb21iaW5lZERhdGEuY29uY2F0KGNvbnRleHRGb3JlY2FzdERhdGEpOwogICAgICB9CgogICAgICBpZiAoem9vbUZyb20pIHsKICAgICAgICBmb2N1c0xvYWRGcm9tID0gem9vbUZyb20uZ2V0VGltZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvY3VzTG9hZEZyb20gPSBfbG9kYXNoLmRlZmF1bHQucmVkdWNlKGNvbWJpbmVkRGF0YSwgZnVuY3Rpb24gKG1lbW8sIHBvaW50KSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5taW4obWVtbywgcG9pbnQuZGF0ZS5nZXRUaW1lKCkpOwogICAgICAgIH0sIG5ldyBEYXRlKDIwOTksIDEyLCAzMSkuZ2V0VGltZSgpKTsKICAgICAgfQoKICAgICAgZm9jdXNMb2FkRnJvbSA9IE1hdGgubWF4KGZvY3VzTG9hZEZyb20sIGNvbnRleHRYTWluKTsKCiAgICAgIGlmICh6b29tVG8pIHsKICAgICAgICBmb2N1c0xvYWRUbyA9IHpvb21Uby5nZXRUaW1lKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9jdXNMb2FkVG8gPSBfbG9kYXNoLmRlZmF1bHQucmVkdWNlKGNvbWJpbmVkRGF0YSwgZnVuY3Rpb24gKG1lbW8sIHBvaW50KSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5tYXgobWVtbywgcG9pbnQuZGF0ZS5nZXRUaW1lKCkpOwogICAgICAgIH0sIDApOwogICAgICB9CgogICAgICBmb2N1c0xvYWRUbyA9IE1hdGgubWluKGZvY3VzTG9hZFRvLCBjb250ZXh0WE1heCk7CgogICAgICBpZiAoZm9jdXNMb2FkRnJvbSAhPT0gY29udGV4dFhNaW4gfHwgZm9jdXNMb2FkVG8gIT09IGNvbnRleHRYTWF4KSB7CiAgICAgICAgdGhpcy5zZXRDb250ZXh0QnJ1c2hFeHRlbnQobmV3IERhdGUoZm9jdXNMb2FkRnJvbSksIG5ldyBEYXRlKGZvY3VzTG9hZFRvKSk7CiAgICAgICAgdmFyIG5ld1NlbGVjdGVkQm91bmRzID0gewogICAgICAgICAgbWluOiAoMCwgX21vbWVudC5kZWZhdWx0KShuZXcgRGF0ZShmb2N1c0xvYWRGcm9tKSksCiAgICAgICAgICBtYXg6ICgwLCBfbW9tZW50LmRlZmF1bHQpKGZvY3VzTG9hZEZyb20pCiAgICAgICAgfTsKICAgICAgICB0aGlzLnNlbGVjdGVkQm91bmRzID0gbmV3U2VsZWN0ZWRCb3VuZHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNvbnRleHRYU2NhbGVEb21haW4gPSB0aGlzLmNvbnRleHRYU2NhbGUuZG9tYWluKCk7CiAgICAgICAgdmFyIF9uZXdTZWxlY3RlZEJvdW5kcyA9IHsKICAgICAgICAgIG1pbjogKDAsIF9tb21lbnQuZGVmYXVsdCkobmV3IERhdGUoY29udGV4dFhTY2FsZURvbWFpblswXSkpLAogICAgICAgICAgbWF4OiAoMCwgX21vbWVudC5kZWZhdWx0KShjb250ZXh0WFNjYWxlRG9tYWluWzFdKQogICAgICAgIH07CgogICAgICAgIGlmICghX2xvZGFzaC5kZWZhdWx0LmlzRXF1YWwoX25ld1NlbGVjdGVkQm91bmRzLCB0aGlzLnNlbGVjdGVkQm91bmRzKSkgewogICAgICAgICAgdGhpcy5zZWxlY3RlZEJvdW5kcyA9IF9uZXdTZWxlY3RlZEJvdW5kczsKICAgICAgICAgIHRoaXMuc2V0Q29udGV4dEJydXNoRXh0ZW50KG5ldyBEYXRlKGNvbnRleHRYU2NhbGVEb21haW5bMF0pLCBuZXcgRGF0ZShjb250ZXh0WFNjYWxlRG9tYWluWzFdKSk7CgogICAgICAgICAgaWYgKHRoaXMuY29udGV4dENoYXJ0SW5pdGlhbGl6ZWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dENoYXJ0SW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICBjb250ZXh0Q2hhcnRTZWxlY3RlZCh7CiAgICAgICAgICAgICAgZnJvbTogY29udGV4dFhTY2FsZURvbWFpblswXSwKICAgICAgICAgICAgICB0bzogY29udGV4dFhTY2FsZURvbWFpblsxXQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVGb2N1c0NoYXJ0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVGb2N1c0NoYXJ0KGZjc0dyb3VwLCBmY3NXaWR0aCwgZmNzSGVpZ2h0KSB7CiAgICAgIC8vIFNwbGl0IG91dCBjcmVhdGlvbiBvZiB0aGUgZm9jdXMgY2hhcnQgZnJvbSB0aGUgcmVuZGVyaW5nLAogICAgICAvLyBhcyB3ZSB3YW50IHRvIHJlLXJlbmRlciB0aGUgcGF0aHMgYW5kIHBvaW50cyB3aGVuIHRoZSB6b29tIGFyZWEgY2hhbmdlcy4KICAgICAgdmFyIGNvbnRleHRGb3JlY2FzdERhdGEgPSB0aGlzLnByb3BzLmNvbnRleHRGb3JlY2FzdERhdGE7IC8vIEFkZCBhIGdyb3VwIGF0IHRoZSB0b3AgdG8gZGlzcGxheSBpbmZvIG9uIHRoZSBjaGFydCBhZ2dyZWdhdGlvbiBpbnRlcnZhbAogICAgICAvLyBhbmQgbGlua3MgdG8gc2V0IHRoZSBicnVzaCBzcGFuIHRvIDFoLCAxZCwgMXcgZXRjLgoKICAgICAgdmFyIHpvb21Hcm91cCA9IGZjc0dyb3VwLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ2ZvY3VzLXpvb20nKTsKICAgICAgem9vbUdyb3VwLmFwcGVuZCgncmVjdCcpLmF0dHIoJ3gnLCAwKS5hdHRyKCd5JywgMCkuYXR0cignd2lkdGgnLCBmY3NXaWR0aCkuYXR0cignaGVpZ2h0JywgZm9jdXNab29tUGFuZWxIZWlnaHQpLmF0dHIoJ2NsYXNzJywgJ2NoYXJ0LWJvcmRlcicpOwogICAgICB0aGlzLmNyZWF0ZVpvb21JbmZvRWxlbWVudHMoem9vbUdyb3VwLCBmY3NXaWR0aCk7IC8vIENyZWF0ZSB0aGUgZWxlbWVudHMgZm9yIGFubm90YXRpb25zCgogICAgICBpZiAobWxBbm5vdGF0aW9uc0VuYWJsZWQpIHsKICAgICAgICB2YXIgYW5ub3RhdGVCcnVzaCA9IHRoaXMuYW5ub3RhdGVCcnVzaC5iaW5kKHRoaXMpOwogICAgICAgIHZhciBicnVzaFggPSAwOwogICAgICAgIHZhciBicnVzaFdpZHRoID0gMDsKCiAgICAgICAgaWYgKHRoaXMucHJvcHMuYW5ub3RhdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgLy8gSWYgdGhlIGFubm90YXRpb24gYnJ1c2ggaXMgc2hvd2luZywgc2V0IGl0IHRvIHRoZSBzYW1lIHBvc2l0aW9uCiAgICAgICAgICBicnVzaFggPSB0aGlzLmZvY3VzWFNjYWxlKHRoaXMucHJvcHMuYW5ub3RhdGlvbi50aW1lc3RhbXApOwogICAgICAgICAgYnJ1c2hXaWR0aCA9ICgwLCBfdGltZXNlcmllc19jaGFydF9hbm5vdGF0aW9ucy5nZXRBbm5vdGF0aW9uV2lkdGgpKHRoaXMucHJvcHMuYW5ub3RhdGlvbiwgdGhpcy5mb2N1c1hTY2FsZSk7CiAgICAgICAgfQoKICAgICAgICBmY3NHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdtbEFubm90YXRpb25CcnVzaCcpLmNhbGwoYW5ub3RhdGVCcnVzaCkuc2VsZWN0QWxsKCdyZWN0JykuYXR0cigneCcsIGJydXNoWCkuYXR0cigneScsIGZvY3VzWm9vbVBhbmVsSGVpZ2h0KS5hdHRyKCd3aWR0aCcsIGJydXNoV2lkdGgpLmF0dHIoJ2hlaWdodCcsIGZvY3VzQ2hhcnRIZWlnaHQpOwogICAgICAgIGZjc0dyb3VwLmFwcGVuZCgnZycpLmNsYXNzZWQoJ21sQW5ub3RhdGlvbnMnLCB0cnVlKTsKICAgICAgfSAvLyBBZGQgYm9yZGVyIHJvdW5kIHBsb3QgYXJlYS4KCgogICAgICBmY3NHcm91cC5hcHBlbmQoJ3JlY3QnKS5hdHRyKCd4JywgMCkuYXR0cigneScsIGZvY3VzWm9vbVBhbmVsSGVpZ2h0KS5hdHRyKCd3aWR0aCcsIGZjc1dpZHRoKS5hdHRyKCdoZWlnaHQnLCBmb2N1c0NoYXJ0SGVpZ2h0KS5hdHRyKCdjbGFzcycsICdjaGFydC1ib3JkZXInKTsgLy8gQWRkIGJhY2tncm91bmQgZm9yIHggYXhpcy4KCiAgICAgIHZhciB4QXhpc0JnID0gZmNzR3JvdXAuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAneC1heGlzLWJhY2tncm91bmQnKTsKICAgICAgeEF4aXNCZy5hcHBlbmQoJ3JlY3QnKS5hdHRyKCd4JywgMCkuYXR0cigneScsIGZjc0hlaWdodCkuYXR0cignd2lkdGgnLCBmY3NXaWR0aCkuYXR0cignaGVpZ2h0JywgY2hhcnRTcGFjaW5nKTsKICAgICAgeEF4aXNCZy5hcHBlbmQoJ2xpbmUnKS5hdHRyKCd4MScsIDApLmF0dHIoJ3kxJywgZmNzSGVpZ2h0KS5hdHRyKCd4MicsIDApLmF0dHIoJ3kyJywgZmNzSGVpZ2h0ICsgY2hhcnRTcGFjaW5nKTsKICAgICAgeEF4aXNCZy5hcHBlbmQoJ2xpbmUnKS5hdHRyKCd4MScsIGZjc1dpZHRoKS5hdHRyKCd5MScsIGZjc0hlaWdodCkuYXR0cigneDInLCBmY3NXaWR0aCkuYXR0cigneTInLCBmY3NIZWlnaHQgKyBjaGFydFNwYWNpbmcpOwogICAgICB4QXhpc0JnLmFwcGVuZCgnbGluZScpLmF0dHIoJ3gxJywgMCkuYXR0cigneTEnLCBmY3NIZWlnaHQgKyBjaGFydFNwYWNpbmcpLmF0dHIoJ3gyJywgZmNzV2lkdGgpLmF0dHIoJ3kyJywgZmNzSGVpZ2h0ICsgY2hhcnRTcGFjaW5nKTsKICAgICAgdmFyIGF4ZXMgPSBmY3NHcm91cC5hcHBlbmQoJ2cnKTsKICAgICAgYXhlcy5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICd4IGF4aXMnKS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKDAsJyArIGZjc0hlaWdodCArICcpJyk7CiAgICAgIGF4ZXMuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAneSBheGlzJyk7IC8vIENyZWF0ZSB0aGUgZWxlbWVudHMgZm9yIHRoZSBtZXRyaWMgdmFsdWUgbGluZSBhbmQgbW9kZWwgYm91bmRzIGFyZWEuCgogICAgICBmY3NHcm91cC5hcHBlbmQoJ3BhdGgnKS5hdHRyKCdjbGFzcycsICdhcmVhIGJvdW5kcycpOwogICAgICBmY3NHcm91cC5hcHBlbmQoJ3BhdGgnKS5hdHRyKCdjbGFzcycsICd2YWx1ZXMtbGluZScpOwogICAgICBmY3NHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdmb2N1cy1jaGFydC1tYXJrZXJzJyk7IC8vIENyZWF0ZSB0aGUgcGF0aCBlbGVtZW50cyBmb3IgdGhlIGZvcmVjYXN0IHZhbHVlIGxpbmUgYW5kIGJvdW5kcyBhcmVhLgoKICAgICAgaWYgKGNvbnRleHRGb3JlY2FzdERhdGEpIHsKICAgICAgICBmY3NHcm91cC5hcHBlbmQoJ3BhdGgnKS5hdHRyKCdjbGFzcycsICdhcmVhIGZvcmVjYXN0Jyk7CiAgICAgICAgZmNzR3JvdXAuYXBwZW5kKCdwYXRoJykuYXR0cignY2xhc3MnLCAndmFsdWVzLWxpbmUgZm9yZWNhc3QnKTsKICAgICAgICBmY3NHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdmb2N1cy1jaGFydC1tYXJrZXJzIGZvcmVjYXN0Jyk7CiAgICAgIH0KCiAgICAgIGZjc0dyb3VwLmFwcGVuZCgncmVjdCcpLmF0dHIoJ3gnLCAwKS5hdHRyKCd5JywgMCkuYXR0cignd2lkdGgnLCBmY3NXaWR0aCkuYXR0cignaGVpZ2h0JywgZmNzSGVpZ2h0ICsgMjQpLmF0dHIoJ2NsYXNzJywgJ2NoYXJ0LWJvcmRlciBjaGFydC1ib3JkZXItaGlnaGxpZ2h0Jyk7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVuZGVyRm9jdXNDaGFydCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyRm9jdXNDaGFydCgpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgX3RoaXMkcHJvcHM1ID0gdGhpcy5wcm9wcywKICAgICAgICAgIGZvY3VzQWdncmVnYXRpb25JbnRlcnZhbCA9IF90aGlzJHByb3BzNS5mb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwsCiAgICAgICAgICBmb2N1c0Fubm90YXRpb25EYXRhID0gX3RoaXMkcHJvcHM1LmZvY3VzQW5ub3RhdGlvbkRhdGEsCiAgICAgICAgICBmb2N1c0NoYXJ0RGF0YSA9IF90aGlzJHByb3BzNS5mb2N1c0NoYXJ0RGF0YSwKICAgICAgICAgIGZvY3VzRm9yZWNhc3REYXRhID0gX3RoaXMkcHJvcHM1LmZvY3VzRm9yZWNhc3REYXRhLAogICAgICAgICAgbW9kZWxQbG90RW5hYmxlZCA9IF90aGlzJHByb3BzNS5tb2RlbFBsb3RFbmFibGVkLAogICAgICAgICAgc2VsZWN0ZWRKb2IgPSBfdGhpcyRwcm9wczUuc2VsZWN0ZWRKb2IsCiAgICAgICAgICBzaG93QW5ub3RhdGlvbnMgPSBfdGhpcyRwcm9wczUuc2hvd0Fubm90YXRpb25zLAogICAgICAgICAgc2hvd0ZvcmVjYXN0ID0gX3RoaXMkcHJvcHM1LnNob3dGb3JlY2FzdCwKICAgICAgICAgIHNob3dNb2RlbEJvdW5kcyA9IF90aGlzJHByb3BzNS5zaG93TW9kZWxCb3VuZHMsCiAgICAgICAgICBpbnRsID0gX3RoaXMkcHJvcHM1LmludGwsCiAgICAgICAgICB6b29tRnJvbUZvY3VzTG9hZGVkID0gX3RoaXMkcHJvcHM1Lnpvb21Gcm9tRm9jdXNMb2FkZWQsCiAgICAgICAgICB6b29tVG9Gb2N1c0xvYWRlZCA9IF90aGlzJHByb3BzNS56b29tVG9Gb2N1c0xvYWRlZDsKCiAgICAgIGlmIChmb2N1c0NoYXJ0RGF0YSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZGF0YSA9IGZvY3VzQ2hhcnREYXRhOwogICAgICB2YXIgY29udGV4dFlTY2FsZSA9IHRoaXMuY29udGV4dFlTY2FsZTsKICAgICAgdmFyIHNob3dGb2N1c0NoYXJ0VG9vbHRpcCA9IHRoaXMuc2hvd0ZvY3VzQ2hhcnRUb29sdGlwLmJpbmQodGhpcyk7CgogICAgICB2YXIgZm9jdXNDaGFydCA9IF9kLmRlZmF1bHQuc2VsZWN0KCcuZm9jdXMtY2hhcnQnKTsgLy8gVXBkYXRlIHRoZSBwbG90IGludGVydmFsIGxhYmVscy4KCgogICAgICB2YXIgZm9jdXNBZ2dJbnQgPSBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwuZXhwcmVzc2lvbjsKICAgICAgdmFyIGJ1Y2tldFNwYW4gPSBzZWxlY3RlZEpvYi5hbmFseXNpc19jb25maWcuYnVja2V0X3NwYW47CgogICAgICB2YXIgY2hhcnRFbGVtZW50ID0gX2QuZGVmYXVsdC5zZWxlY3QodGhpcy5yb290Tm9kZSk7CgogICAgICBjaGFydEVsZW1lbnQuc2VsZWN0KCcuem9vbS1hZ2dyZWdhdGlvbi1pbnRlcnZhbCcpLnRleHQoaW50bC5mb3JtYXRNZXNzYWdlKHsKICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQuem9vbUFnZ3JlZ2F0aW9uSW50ZXJ2YWxMYWJlbCcsCiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICcoYWdncmVnYXRpb24gaW50ZXJ2YWw6IHtmb2N1c0FnZ0ludH0sIGJ1Y2tldCBzcGFuOiB7YnVja2V0U3Bhbn0pJwogICAgICB9LCB7CiAgICAgICAgZm9jdXNBZ2dJbnQ6IGZvY3VzQWdnSW50LAogICAgICAgIGJ1Y2tldFNwYW46IGJ1Y2tldFNwYW4KICAgICAgfSkpOyAvLyBSZW5kZXIgdGhlIGF4ZXMuCiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgeCBheGlzIGRvbWFpbi4KICAgICAgLy8gRWxhc3RpY3NlYXJjaCBhZ2dyZWdhdGlvbiByZXR1cm5zIHBvaW50cyBhdCBzdGFydCBvZiBidWNrZXQsCiAgICAgIC8vIHNvIHNldCB0aGUgeC1heGlzIG1pbiB0byB0aGUgc3RhcnQgb2YgdGhlIGZpcnN0IGFnZ3JlZ2F0aW9uIGludGVydmFsLAogICAgICAvLyBhbmQgdGhlIHgtYXhpcyBtYXggdG8gdGhlIGVuZCBvZiB0aGUgbGFzdCBhZ2dyZWdhdGlvbiBpbnRlcnZhbC4KCiAgICAgIGlmICh6b29tRnJvbUZvY3VzTG9hZGVkID09PSB1bmRlZmluZWQgfHwgem9vbVRvRm9jdXNMb2FkZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGJvdW5kcyA9IHsKICAgICAgICBtaW46ICgwLCBfbW9tZW50LmRlZmF1bHQpKHpvb21Gcm9tRm9jdXNMb2FkZWQuZ2V0VGltZSgpKSwKICAgICAgICBtYXg6ICgwLCBfbW9tZW50LmRlZmF1bHQpKHpvb21Ub0ZvY3VzTG9hZGVkLmdldFRpbWUoKSkKICAgICAgfTsKICAgICAgdmFyIGFnZ01zID0gZm9jdXNBZ2dyZWdhdGlvbkludGVydmFsLmFzTWlsbGlzZWNvbmRzKCk7CiAgICAgIHZhciBlYXJsaWVzdCA9ICgwLCBfbW9tZW50LmRlZmF1bHQpKE1hdGguZmxvb3IoYm91bmRzLm1pbi52YWx1ZU9mKCkgLyBhZ2dNcykgKiBhZ2dNcyk7CiAgICAgIHZhciBsYXRlc3QgPSAoMCwgX21vbWVudC5kZWZhdWx0KShNYXRoLmNlaWwoYm91bmRzLm1heC52YWx1ZU9mKCkgLyBhZ2dNcykgKiBhZ2dNcyk7CiAgICAgIHRoaXMuZm9jdXNYU2NhbGUuZG9tYWluKFtlYXJsaWVzdC50b0RhdGUoKSwgbGF0ZXN0LnRvRGF0ZSgpXSk7IC8vIENhbGN1bGF0ZSB0aGUgeS1heGlzIGRvbWFpbi4KCiAgICAgIGlmIChmb2N1c0NoYXJ0RGF0YS5sZW5ndGggPiAwIHx8IGZvY3VzRm9yZWNhc3REYXRhICE9PSB1bmRlZmluZWQgJiYgZm9jdXNGb3JlY2FzdERhdGEubGVuZ3RoID4gMCkgewogICAgICAgIGlmICh0aGlzLmZpZWxkRm9ybWF0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRoaXMuZm9jdXNZQXhpcy50aWNrRm9ybWF0KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpczIuZmllbGRGb3JtYXQuY29udmVydChkLCAndGV4dCcpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IHRpY2sgZm9ybWF0dGVyLgogICAgICAgICAgdGhpcy5mb2N1c1lBeGlzLnRpY2tGb3JtYXQobnVsbCk7CiAgICAgICAgfSAvLyBDYWxjdWxhdGUgdGhlIG1pbi9tYXggb2YgdGhlIG1ldHJpYyBkYXRhIGFuZCB0aGUgZm9yZWNhc3QgZGF0YS4KCgogICAgICAgIHZhciB5TWluID0gMDsKICAgICAgICB2YXIgeU1heCA9IDA7CiAgICAgICAgdmFyIGNvbWJpbmVkRGF0YSA9IGRhdGE7CgogICAgICAgIGlmIChmb2N1c0ZvcmVjYXN0RGF0YSAhPT0gdW5kZWZpbmVkICYmIGZvY3VzRm9yZWNhc3REYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbWJpbmVkRGF0YSA9IGRhdGEuY29uY2F0KGZvY3VzRm9yZWNhc3REYXRhKTsKICAgICAgICB9CgogICAgICAgIHlNaW4gPSBfZC5kZWZhdWx0Lm1pbihjb21iaW5lZERhdGEsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICB2YXIgbWV0cmljVmFsdWUgPSBkLnZhbHVlOwoKICAgICAgICAgIGlmIChtZXRyaWNWYWx1ZSA9PT0gbnVsbCAmJiBkLmFub21hbHlTY29yZSAhPT0gdW5kZWZpbmVkICYmIGQuYWN0dWFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgLy8gSWYgYW4gYW5vbWFseSBjb2luY2lkZXMgd2l0aCBhIGdhcCBpbiB0aGUgZGF0YSwgdXNlIHRoZSBhbm9tYWx5IGFjdHVhbCB2YWx1ZS4KICAgICAgICAgICAgbWV0cmljVmFsdWUgPSBBcnJheS5pc0FycmF5KGQuYWN0dWFsKSA/IGQuYWN0dWFsWzBdIDogZC5hY3R1YWw7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQubG93ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAobWV0cmljVmFsdWUgIT09IG51bGwgJiYgbWV0cmljVmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbihtZXRyaWNWYWx1ZSwgZC5sb3dlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gU2V0IGFjY29yZGluZyB0byB0aGUgbWluaW11bSBvZiB0aGUgbG93ZXIgb2YgdGhlIG1vZGVsIHBsb3QgcmVzdWx0cy4KICAgICAgICAgICAgICByZXR1cm4gZC5sb3dlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBtZXRyaWNWYWx1ZTsKICAgICAgICB9KTsKICAgICAgICB5TWF4ID0gX2QuZGVmYXVsdC5tYXgoY29tYmluZWREYXRhLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgdmFyIG1ldHJpY1ZhbHVlID0gZC52YWx1ZTsKCiAgICAgICAgICBpZiAobWV0cmljVmFsdWUgPT09IG51bGwgJiYgZC5hbm9tYWx5U2NvcmUgIT09IHVuZGVmaW5lZCAmJiBkLmFjdHVhbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIC8vIElmIGFuIGFub21hbHkgY29pbmNpZGVzIHdpdGggYSBnYXAgaW4gdGhlIGRhdGEsIHVzZSB0aGUgYW5vbWFseSBhY3R1YWwgdmFsdWUuCiAgICAgICAgICAgIG1ldHJpY1ZhbHVlID0gQXJyYXkuaXNBcnJheShkLmFjdHVhbCkgPyBkLmFjdHVhbFswXSA6IGQuYWN0dWFsOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBkLnVwcGVyICE9PSB1bmRlZmluZWQgPyBNYXRoLm1heChtZXRyaWNWYWx1ZSwgZC51cHBlcikgOiBtZXRyaWNWYWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHlNYXggPT09IHlNaW4pIHsKICAgICAgICAgIGlmICh0aGlzLmNvbnRleHRZU2NhbGUuZG9tYWluKClbMF0gIT09IGNvbnRleHRZU2NhbGUuZG9tYWluKClbMV0gJiYgeU1pbiA+PSBjb250ZXh0WVNjYWxlLmRvbWFpbigpWzBdICYmIHlNYXggPD0gY29udGV4dFlTY2FsZS5kb21haW4oKVsxXSkgewogICAgICAgICAgICAvLyBTZXQgdGhlIGZvY3VzIGNoYXJ0IGxpbWl0cyB0byBiZSB0aGUgc2FtZSBhcyB0aGUgY29udGV4dCBjaGFydC4KICAgICAgICAgICAgeU1pbiA9IGNvbnRleHRZU2NhbGUuZG9tYWluKClbMF07CiAgICAgICAgICAgIHlNYXggPSBjb250ZXh0WVNjYWxlLmRvbWFpbigpWzFdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeU1pbiAtPSB5TWluICogMC4wNTsKICAgICAgICAgICAgeU1heCArPSB5TWF4ICogMC4wNTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIGlmIGFubm90YXRpb25zIGFyZSBwcmVzZW50LCB3ZSBleHRlbmQgeU1heCB0byBhdm9pZCBvdmVybGFwCiAgICAgICAgLy8gYmV0d2VlbiBhbm5vdGF0aW9uIGxhYmVscywgY2hhcnQgbGluZXMgYW5kIGFub21hbGllcy4KCgogICAgICAgIGlmIChtbEFubm90YXRpb25zRW5hYmxlZCAmJiBmb2N1c0Fubm90YXRpb25EYXRhICYmIGZvY3VzQW5ub3RhdGlvbkRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIGxldmVscyA9ICgwLCBfdGltZXNlcmllc19jaGFydF9hbm5vdGF0aW9ucy5nZXRBbm5vdGF0aW9uTGV2ZWxzKShmb2N1c0Fubm90YXRpb25EYXRhKTsKCiAgICAgICAgICB2YXIgbWF4TGV2ZWwgPSBfZC5kZWZhdWx0Lm1heChPYmplY3Qua2V5cyhsZXZlbHMpLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBsZXZlbHNba2V5XTsKICAgICAgICAgIH0pKTsgLy8gVE9ETyBuZWVkcyByZXZpc2l0aW5nIHRvIGJlIGEgbW9yZSByb2J1c3Qgbm9ybWFsaXphdGlvbgoKCiAgICAgICAgICB5TWF4ID0geU1heCAqICgxICsgKG1heExldmVsICsgMSkgLyA1KTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZm9jdXNZU2NhbGUuZG9tYWluKFt5TWluLCB5TWF4XSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRGlzcGxheSAxMCB1bmxhYmVsbGVkIHRpY2tzLgogICAgICAgIHRoaXMuZm9jdXNZU2NhbGUuZG9tYWluKFswLCAxMF0pOwogICAgICAgIHRoaXMuZm9jdXNZQXhpcy50aWNrRm9ybWF0KCcnKTsKICAgICAgfSAvLyBHZXQgdGhlIHNjYWxlZCBkYXRlIGZvcm1hdCB0byB1c2UgZm9yIHggYXhpcyB0aWNrIGxhYmVscy4KCgogICAgICB2YXIgdGltZUJ1Y2tldHMgPSBuZXcgX3RpbWVfYnVja2V0cy5UaW1lQnVja2V0cygpOwogICAgICB0aW1lQnVja2V0cy5zZXRJbnRlcnZhbCgnYXV0bycpOwogICAgICB0aW1lQnVja2V0cy5zZXRCb3VuZHMoYm91bmRzKTsKICAgICAgdmFyIHhBeGlzVGlja0Zvcm1hdCA9IHRpbWVCdWNrZXRzLmdldFNjYWxlZERhdGVGb3JtYXQoKTsKICAgICAgZm9jdXNDaGFydC5zZWxlY3QoJy54LmF4aXMnKS5jYWxsKHRoaXMuZm9jdXNYQXhpcy50aWNrcygoMCwgX2NoYXJ0X3V0aWxzLm51bVRpY2tzRm9yRGF0ZUZvcm1hdCkodGhpcy52aXpXaWR0aCksIHhBeGlzVGlja0Zvcm1hdCkudGlja0Zvcm1hdChmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiAoMCwgX21vbWVudC5kZWZhdWx0KShkKS5mb3JtYXQoeEF4aXNUaWNrRm9ybWF0KTsKICAgICAgfSkpOwogICAgICBmb2N1c0NoYXJ0LnNlbGVjdCgnLnkuYXhpcycpLmNhbGwodGhpcy5mb2N1c1lBeGlzKTsKICAgICAgKDAsIF9jaGFydF91dGlscy5maWx0ZXJBeGlzTGFiZWxzKShmb2N1c0NoYXJ0LnNlbGVjdCgnLnguYXhpcycpLCB0aGlzLnZpeldpZHRoKTsgLy8gUmVuZGVyIHRoZSBib3VuZHMgYXJlYSBhbmQgdmFsdWVzIGxpbmUuCgogICAgICBpZiAobW9kZWxQbG90RW5hYmxlZCA9PT0gdHJ1ZSkgewogICAgICAgIGZvY3VzQ2hhcnQuc2VsZWN0KCcuYXJlYS5ib3VuZHMnKS5hdHRyKCdkJywgdGhpcy5mb2N1c0JvdW5kZWRBcmVhKGRhdGEpKS5jbGFzc2VkKCdoaWRkZW4nLCAhc2hvd01vZGVsQm91bmRzKTsKICAgICAgfQoKICAgICAgaWYgKG1sQW5ub3RhdGlvbnNFbmFibGVkKSB7CiAgICAgICAgKDAsIF90aW1lc2VyaWVzX2NoYXJ0X2Fubm90YXRpb25zLnJlbmRlckFubm90YXRpb25zKShmb2N1c0NoYXJ0LCBmb2N1c0Fubm90YXRpb25EYXRhLCBmb2N1c1pvb21QYW5lbEhlaWdodCwgZm9jdXNDaGFydEhlaWdodCwgdGhpcy5mb2N1c1hTY2FsZSwgc2hvd0Fubm90YXRpb25zLCBzaG93Rm9jdXNDaGFydFRvb2x0aXApOyAvLyBkaXNhYmxlIGJydXNoaW5nIChjcmVhdGlvbiBvZiBhbm5vdGF0aW9ucykgd2hlbiBhbm5vdGF0aW9ucyBhcmVuJ3Qgc2hvd24KCiAgICAgICAgZm9jdXNDaGFydC5zZWxlY3QoJy5tbEFubm90YXRpb25CcnVzaCcpLnN0eWxlKCdkaXNwbGF5Jywgc2hvd0Fubm90YXRpb25zID8gbnVsbCA6ICdub25lJyk7CiAgICAgIH0KCiAgICAgIGZvY3VzQ2hhcnQuc2VsZWN0KCcudmFsdWVzLWxpbmUnKS5hdHRyKCdkJywgdGhpcy5mb2N1c1ZhbHVlc0xpbmUoZGF0YSkpOwogICAgICAoMCwgX2NoYXJ0X3V0aWxzLmRyYXdMaW5lQ2hhcnREb3RzKShkYXRhLCBmb2N1c0NoYXJ0LCB0aGlzLmZvY3VzVmFsdWVzTGluZSk7IC8vIFJlbmRlciBjaXJjbGUgbWFya2VycyBmb3IgdGhlIHBvaW50cy4KICAgICAgLy8gVGhlc2UgYXJlIHVzZWQgZm9yIGRpc3BsYXlpbmcgdG9vbHRpcHMgb24gbW91c2VvdmVyLgogICAgICAvLyBEb24ndCByZW5kZXIgZG90cyB3aGVyZSB2YWx1ZT1udWxsIChkYXRhIGdhcHMsIHdpdGggbm8gYW5vbWFsaWVzKQogICAgICAvLyBvciBmb3IgbXVsdGktYnVja2V0IGFub21hbGllcy4KCiAgICAgIHZhciBkb3RzID0gX2QuZGVmYXVsdC5zZWxlY3QoJy5mb2N1cy1jaGFydC1tYXJrZXJzJykuc2VsZWN0QWxsKCcubWV0cmljLXZhbHVlJykuZGF0YShkYXRhLmZpbHRlcihmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiAoZC52YWx1ZSAhPT0gbnVsbCB8fCB0eXBlb2YgZC5hbm9tYWx5U2NvcmUgPT09ICdudW1iZXInKSAmJiAhKDAsIF9jaGFydF91dGlscy5zaG93TXVsdGlCdWNrZXRBbm9tYWx5TWFya2VyKShkKTsKICAgICAgfSkpOyAvLyBSZW1vdmUgZG90cyB0aGF0IGFyZSBubyBsb25nZXIgbmVlZGVkIGkuZS4gaWYgbnVtYmVyIG9mIGNoYXJ0IHBvaW50cyBoYXMgZGVjcmVhc2VkLgoKCiAgICAgIGRvdHMuZXhpdCgpLnJlbW92ZSgpOyAvLyBDcmVhdGUgYW55IG5ldyBkb3RzIHRoYXQgYXJlIG5lZWRlZCBpLmUuIGlmIG51bWJlciBvZiBjaGFydCBwb2ludHMgaGFzIGluY3JlYXNlZC4KCiAgICAgIGRvdHMuZW50ZXIoKS5hcHBlbmQoJ2NpcmNsZScpLmF0dHIoJ3InLCBfY2hhcnRfdXRpbHMuTElORV9DSEFSVF9BTk9NQUxZX1JBRElVUykub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgc2hvd0ZvY3VzQ2hhcnRUb29sdGlwKGQsIHRoaXMpOwogICAgICB9KS5vbignbW91c2VvdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF9jaGFydF90b29sdGlwX3NlcnZpY2UubWxDaGFydFRvb2x0aXBTZXJ2aWNlLmhpZGUoKTsKICAgICAgfSk7IC8vIFVwZGF0ZSBhbGwgZG90cyB0byBuZXcgcG9zaXRpb25zLgoKICAgICAgZG90cy5hdHRyKCdjeCcsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5mb2N1c1hTY2FsZShkLmRhdGUpOwogICAgICB9KS5hdHRyKCdjeScsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5mb2N1c1lTY2FsZShkLnZhbHVlKTsKICAgICAgfSkuYXR0cignY2xhc3MnLCBmdW5jdGlvbiAoZCkgewogICAgICAgIHZhciBtYXJrZXJDbGFzcyA9ICdtZXRyaWMtdmFsdWUnOwoKICAgICAgICBpZiAoX2xvZGFzaC5kZWZhdWx0LmhhcyhkLCAnYW5vbWFseVNjb3JlJykpIHsKICAgICAgICAgIG1hcmtlckNsYXNzICs9ICIgYW5vbWFseS1tYXJrZXIgIi5jb25jYXQoKDAsIF9hbm9tYWx5X3V0aWxzLmdldFNldmVyaXR5V2l0aExvdykoZC5hbm9tYWx5U2NvcmUpLmlkKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXJrZXJDbGFzczsKICAgICAgfSk7IC8vIFJlbmRlciBjcm9zcyBzeW1ib2xzIGZvciBhbnkgbXVsdGktYnVja2V0IGFub21hbGllcy4KCiAgICAgIHZhciBtdWx0aUJ1Y2tldE1hcmtlcnMgPSBfZC5kZWZhdWx0LnNlbGVjdCgnLmZvY3VzLWNoYXJ0LW1hcmtlcnMnKS5zZWxlY3RBbGwoJy5tdWx0aS1idWNrZXQnKS5kYXRhKGRhdGEuZmlsdGVyKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGQuYW5vbWFseVNjb3JlICE9PSBudWxsICYmICgwLCBfY2hhcnRfdXRpbHMuc2hvd011bHRpQnVja2V0QW5vbWFseU1hcmtlcikoZCkgPT09IHRydWU7CiAgICAgIH0pKTsgLy8gUmVtb3ZlIG11bHRpLWJ1Y2tldCBtYXJrZXJzIHRoYXQgYXJlIG5vIGxvbmdlciBuZWVkZWQuCgoKICAgICAgbXVsdGlCdWNrZXRNYXJrZXJzLmV4aXQoKS5yZW1vdmUoKTsgLy8gQWRkIGFueSBuZXcgbWFya2VycyB0aGF0IGFyZSBuZWVkZWQgaS5lLiBpZiBudW1iZXIgb2YgbXVsdGktYnVja2V0IHBvaW50cyBoYXMgaW5jcmVhc2VkLgoKICAgICAgbXVsdGlCdWNrZXRNYXJrZXJzLmVudGVyKCkuYXBwZW5kKCdwYXRoJykuYXR0cignZCcsIF9kLmRlZmF1bHQuc3ZnLnN5bWJvbCgpLnNpemUoX2NoYXJ0X3V0aWxzLk1VTFRJX0JVQ0tFVF9TWU1CT0xfU0laRSkudHlwZSgnY3Jvc3MnKSkub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgc2hvd0ZvY3VzQ2hhcnRUb29sdGlwKGQsIHRoaXMpOwogICAgICB9KS5vbignbW91c2VvdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF9jaGFydF90b29sdGlwX3NlcnZpY2UubWxDaGFydFRvb2x0aXBTZXJ2aWNlLmhpZGUoKTsKICAgICAgfSk7IC8vIFVwZGF0ZSBhbGwgbWFya2VycyB0byBuZXcgcG9zaXRpb25zLgoKICAgICAgbXVsdGlCdWNrZXRNYXJrZXJzLmF0dHIoJ3RyYW5zZm9ybScsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuICJ0cmFuc2xhdGUoIi5jb25jYXQoX3RoaXMyLmZvY3VzWFNjYWxlKGQuZGF0ZSksICIsICIpLmNvbmNhdChfdGhpczIuZm9jdXNZU2NhbGUoZC52YWx1ZSksICIpIik7CiAgICAgIH0pLmF0dHIoJ2NsYXNzJywgZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gImFub21hbHktbWFya2VyIG11bHRpLWJ1Y2tldCAiLmNvbmNhdCgoMCwgX2Fub21hbHlfdXRpbHMuZ2V0U2V2ZXJpdHlXaXRoTG93KShkLmFub21hbHlTY29yZSkuaWQpOwogICAgICB9KTsgLy8gQWRkIHJlY3Rhbmd1bGFyIG1hcmtlcnMgZm9yIGFueSBzY2hlZHVsZWQgZXZlbnRzLgoKICAgICAgdmFyIHNjaGVkdWxlZEV2ZW50TWFya2VycyA9IF9kLmRlZmF1bHQuc2VsZWN0KCcuZm9jdXMtY2hhcnQtbWFya2VycycpLnNlbGVjdEFsbCgnLnNjaGVkdWxlZC1ldmVudC1tYXJrZXInKS5kYXRhKGRhdGEuZmlsdGVyKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGQuc2NoZWR1bGVkRXZlbnRzICE9PSB1bmRlZmluZWQ7CiAgICAgIH0pKTsgLy8gUmVtb3ZlIG1hcmtlcnMgdGhhdCBhcmUgbm8gbG9uZ2VyIG5lZWRlZCBpLmUuIGlmIG51bWJlciBvZiBjaGFydCBwb2ludHMgaGFzIGRlY3JlYXNlZC4KCgogICAgICBzY2hlZHVsZWRFdmVudE1hcmtlcnMuZXhpdCgpLnJlbW92ZSgpOyAvLyBDcmVhdGUgYW55IG5ldyBtYXJrZXJzIHRoYXQgYXJlIG5lZWRlZCBpLmUuIGlmIG51bWJlciBvZiBjaGFydCBwb2ludHMgaGFzIGluY3JlYXNlZC4KCiAgICAgIHNjaGVkdWxlZEV2ZW50TWFya2Vycy5lbnRlcigpLmFwcGVuZCgncmVjdCcpLmF0dHIoJ3dpZHRoJywgX2NoYXJ0X3V0aWxzLkxJTkVfQ0hBUlRfQU5PTUFMWV9SQURJVVMgKiAyKS5hdHRyKCdoZWlnaHQnLCBfY2hhcnRfdXRpbHMuU0NIRURVTEVEX0VWRU5UX1NZTUJPTF9IRUlHSFQpLmF0dHIoJ2NsYXNzJywgJ3NjaGVkdWxlZC1ldmVudC1tYXJrZXInKS5hdHRyKCdyeCcsIDEpLmF0dHIoJ3J5JywgMSk7IC8vIFVwZGF0ZSBhbGwgbWFya2VycyB0byBuZXcgcG9zaXRpb25zLgoKICAgICAgc2NoZWR1bGVkRXZlbnRNYXJrZXJzLmF0dHIoJ3gnLCBmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiBfdGhpczIuZm9jdXNYU2NhbGUoZC5kYXRlKSAtIF9jaGFydF91dGlscy5MSU5FX0NIQVJUX0FOT01BTFlfUkFESVVTOwogICAgICB9KS5hdHRyKCd5JywgZnVuY3Rpb24gKGQpIHsKICAgICAgICByZXR1cm4gX3RoaXMyLmZvY3VzWVNjYWxlKGQudmFsdWUpIC0gMzsKICAgICAgfSk7IC8vIFBsb3QgYW55IGZvcmVjYXN0IGRhdGEgaW4gc2NvcGUuCgogICAgICBpZiAoZm9jdXNGb3JlY2FzdERhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGZvY3VzQ2hhcnQuc2VsZWN0KCcuYXJlYS5mb3JlY2FzdCcpLmF0dHIoJ2QnLCB0aGlzLmZvY3VzQm91bmRlZEFyZWEoZm9jdXNGb3JlY2FzdERhdGEpKS5jbGFzc2VkKCdoaWRkZW4nLCAhc2hvd0ZvcmVjYXN0KTsKICAgICAgICBmb2N1c0NoYXJ0LnNlbGVjdCgnLnZhbHVlcy1saW5lLmZvcmVjYXN0JykuYXR0cignZCcsIHRoaXMuZm9jdXNWYWx1ZXNMaW5lKGZvY3VzRm9yZWNhc3REYXRhKSkuY2xhc3NlZCgnaGlkZGVuJywgIXNob3dGb3JlY2FzdCk7CgogICAgICAgIHZhciBmb3JlY2FzdERvdHMgPSBfZC5kZWZhdWx0LnNlbGVjdCgnLmZvY3VzLWNoYXJ0LW1hcmtlcnMuZm9yZWNhc3QnKS5zZWxlY3RBbGwoJy5tZXRyaWMtdmFsdWUnKS5kYXRhKGZvY3VzRm9yZWNhc3REYXRhKTsgLy8gUmVtb3ZlIGRvdHMgdGhhdCBhcmUgbm8gbG9uZ2VyIG5lZWRlZCBpLmUuIGlmIG51bWJlciBvZiBmb3JlY2FzdCBwb2ludHMgaGFzIGRlY3JlYXNlZC4KCgogICAgICAgIGZvcmVjYXN0RG90cy5leGl0KCkucmVtb3ZlKCk7IC8vIENyZWF0ZSBhbnkgbmV3IGRvdHMgdGhhdCBhcmUgbmVlZGVkIGkuZS4gaWYgbnVtYmVyIG9mIGZvcmVjYXN0IHBvaW50cyBoYXMgaW5jcmVhc2VkLgoKICAgICAgICBmb3JlY2FzdERvdHMuZW50ZXIoKS5hcHBlbmQoJ2NpcmNsZScpLmF0dHIoJ3InLCBfY2hhcnRfdXRpbHMuTElORV9DSEFSVF9BTk9NQUxZX1JBRElVUykub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICBzaG93Rm9jdXNDaGFydFRvb2x0aXAoZCwgdGhpcyk7CiAgICAgICAgfSkub24oJ21vdXNlb3V0JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9jaGFydF90b29sdGlwX3NlcnZpY2UubWxDaGFydFRvb2x0aXBTZXJ2aWNlLmhpZGUoKTsKICAgICAgICB9KTsgLy8gVXBkYXRlIGFsbCBkb3RzIHRvIG5ldyBwb3NpdGlvbnMuCgogICAgICAgIGZvcmVjYXN0RG90cy5hdHRyKCdjeCcsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMyLmZvY3VzWFNjYWxlKGQuZGF0ZSk7CiAgICAgICAgfSkuYXR0cignY3knLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgcmV0dXJuIF90aGlzMi5mb2N1c1lTY2FsZShkLnZhbHVlKTsKICAgICAgICB9KS5hdHRyKCdjbGFzcycsICdtZXRyaWMtdmFsdWUnKS5jbGFzc2VkKCdoaWRkZW4nLCAhc2hvd0ZvcmVjYXN0KTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogImNyZWF0ZVpvb21JbmZvRWxlbWVudHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZVpvb21JbmZvRWxlbWVudHMoem9vbUdyb3VwLCBmY3NXaWR0aCkgewogICAgICB2YXIgX3RoaXMkcHJvcHM2ID0gdGhpcy5wcm9wcywKICAgICAgICAgIGF1dG9ab29tRHVyYXRpb24gPSBfdGhpcyRwcm9wczYuYXV0b1pvb21EdXJhdGlvbiwKICAgICAgICAgIGJvdW5kcyA9IF90aGlzJHByb3BzNi5ib3VuZHMsCiAgICAgICAgICBtb2RlbFBsb3RFbmFibGVkID0gX3RoaXMkcHJvcHM2Lm1vZGVsUGxvdEVuYWJsZWQsCiAgICAgICAgICBpbnRsID0gX3RoaXMkcHJvcHM2LmludGw7CiAgICAgIHZhciBzZXRab29tSW50ZXJ2YWwgPSB0aGlzLnNldFpvb21JbnRlcnZhbC5iaW5kKHRoaXMpOyAvLyBDcmVhdGUgem9vbSBkdXJhdGlvbiBsaW5rcyBhcHBsaWNhYmxlIGZvciB0aGUgY3VycmVudCB0aW1lIHNwYW4uCiAgICAgIC8vIERvbid0IGFkZCBsaW5rcyBmb3IgYW55IGR1cmF0aW9ucyB3aGljaCB3b3VsZCBnaXZlIGEgYnJ1c2ggZXh0ZW50IGxlc3MgdGhhbiAxMHB4LgoKICAgICAgdmFyIGJvdW5kc1NlY3MgPSBib3VuZHMubWF4LnVuaXgoKSAtIGJvdW5kcy5taW4udW5peCgpOwogICAgICB2YXIgbWluU2VjcyA9IDEwIC8gdGhpcy52aXpXaWR0aCAqIGJvdW5kc1NlY3M7CiAgICAgIHZhciB4UG9zID0gMTA7CiAgICAgIHZhciB6b29tTGFiZWwgPSB6b29tR3JvdXAuYXBwZW5kKCd0ZXh0JykuYXR0cigneCcsIHhQb3MpLmF0dHIoJ3knLCAxNykuYXR0cignY2xhc3MnLCAnem9vbS1pbmZvLXRleHQnKS50ZXh0KGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgaWQ6ICd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIudGltZVNlcmllc0NoYXJ0Lnpvb21MYWJlbCcsCiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdab29tOicKICAgICAgfSkpOwogICAgICB2YXIgem9vbU9wdGlvbnMgPSBbewogICAgICAgIGR1cmF0aW9uTXM6IGF1dG9ab29tRHVyYXRpb24sCiAgICAgICAgbGFiZWw6ICdhdXRvJwogICAgICB9XTsKCiAgICAgIF9sb2Rhc2guZGVmYXVsdC5lYWNoKFpPT01fSU5URVJWQUxfT1BUSU9OUywgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgIGlmIChvcHRpb24uZHVyYXRpb24uYXNTZWNvbmRzKCkgPiBtaW5TZWNzICYmIG9wdGlvbi5kdXJhdGlvbi5hc1NlY29uZHMoKSA8IGJvdW5kc1NlY3MpIHsKICAgICAgICAgIHpvb21PcHRpb25zLnB1c2goewogICAgICAgICAgICBkdXJhdGlvbk1zOiBvcHRpb24uZHVyYXRpb24uYXNNaWxsaXNlY29uZHMoKSwKICAgICAgICAgICAgbGFiZWw6IG9wdGlvbi5sYWJlbAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHhQb3MgKz0gem9vbUxhYmVsLm5vZGUoKS5nZXRCQm94KCkud2lkdGggKyA0OwoKICAgICAgX2xvZGFzaC5kZWZhdWx0LmVhY2goem9vbU9wdGlvbnMsIGZ1bmN0aW9uIChvcHRpb24pIHsKICAgICAgICB2YXIgdGV4dCA9IHpvb21Hcm91cC5hcHBlbmQoJ2EnKS5hdHRyKCdkYXRhLW1zJywgb3B0aW9uLmR1cmF0aW9uTXMpLmF0dHIoJ2hyZWYnLCAnJykuYXBwZW5kKCd0ZXh0JykuYXR0cigneCcsIHhQb3MpLmF0dHIoJ3knLCAxNykuYXR0cignY2xhc3MnLCAnem9vbS1pbmZvLXRleHQnKS50ZXh0KG9wdGlvbi5sYWJlbCk7CiAgICAgICAgeFBvcyArPSB0ZXh0Lm5vZGUoKS5nZXRCQm94KCkud2lkdGggKyA0OwogICAgICB9KTsKCiAgICAgIHpvb21Hcm91cC5hcHBlbmQoJ3RleHQnKS5hdHRyKCd4JywgeFBvcyArIDYpLmF0dHIoJ3knLCAxNykuYXR0cignY2xhc3MnLCAnem9vbS1pbmZvLXRleHQgem9vbS1hZ2dyZWdhdGlvbi1pbnRlcnZhbCcpLnRleHQoaW50bC5mb3JtYXRNZXNzYWdlKHsKICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQuem9vbUdyb3VwQWdncmVnYXRpb25JbnRlcnZhbExhYmVsJywKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJyhhZ2dyZWdhdGlvbiBpbnRlcnZhbDogLCBidWNrZXQgc3BhbjogKScKICAgICAgfSkpOwoKICAgICAgaWYgKG1vZGVsUGxvdEVuYWJsZWQgPT09IGZhbHNlKSB7CiAgICAgICAgdmFyIG1vZGVsUGxvdExhYmVsID0gem9vbUdyb3VwLmFwcGVuZCgndGV4dCcpLmF0dHIoJ3gnLCAzMDApLmF0dHIoJ3knLCAxNykuYXR0cignY2xhc3MnLCAnem9vbS1pbmZvLXRleHQnKS50ZXh0KGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQubW9kZWxCb3VuZHNOb3RBdmFpbGFibGVMYWJlbCcsCiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ01vZGVsIGJvdW5kcyBhcmUgbm90IGF2YWlsYWJsZScKICAgICAgICB9KSk7CiAgICAgICAgbW9kZWxQbG90TGFiZWwuYXR0cigneCcsIGZjc1dpZHRoIC0gKG1vZGVsUGxvdExhYmVsLm5vZGUoKS5nZXRCQm94KCkud2lkdGggKyAxMCkpOwogICAgICB9CgogICAgICB2YXIgY2hhcnRFbGVtZW50ID0gX2QuZGVmYXVsdC5zZWxlY3QodGhpcy5yb290Tm9kZSk7CgogICAgICBjaGFydEVsZW1lbnQuc2VsZWN0QWxsKCcuZm9jdXMtem9vbSBhJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgIF9kLmRlZmF1bHQuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgc2V0Wm9vbUludGVydmFsKF9kLmRlZmF1bHQuc2VsZWN0KHRoaXMpLmF0dHIoJ2RhdGEtbXMnKSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImRyYXdDb250ZXh0RWxlbWVudHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRyYXdDb250ZXh0RWxlbWVudHMoY3h0R3JvdXAsIGN4dFdpZHRoLCBjeHRDaGFydEhlaWdodCwgc3dsSGVpZ2h0KSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIF90aGlzJHByb3BzNyA9IHRoaXMucHJvcHMsCiAgICAgICAgICBib3VuZHMgPSBfdGhpcyRwcm9wczcuYm91bmRzLAogICAgICAgICAgY29udGV4dENoYXJ0RGF0YSA9IF90aGlzJHByb3BzNy5jb250ZXh0Q2hhcnREYXRhLAogICAgICAgICAgY29udGV4dEZvcmVjYXN0RGF0YSA9IF90aGlzJHByb3BzNy5jb250ZXh0Rm9yZWNhc3REYXRhLAogICAgICAgICAgbW9kZWxQbG90RW5hYmxlZCA9IF90aGlzJHByb3BzNy5tb2RlbFBsb3RFbmFibGVkOwogICAgICB2YXIgZGF0YSA9IGNvbnRleHRDaGFydERhdGE7CiAgICAgIHRoaXMuY29udGV4dFhTY2FsZSA9IF9kLmRlZmF1bHQudGltZS5zY2FsZSgpLnJhbmdlKFswLCBjeHRXaWR0aF0pLmRvbWFpbih0aGlzLmNhbGN1bGF0ZUNvbnRleHRYQXhpc0RvbWFpbigpKTsKICAgICAgdmFyIGNvbWJpbmVkRGF0YSA9IGNvbnRleHRGb3JlY2FzdERhdGEgPT09IHVuZGVmaW5lZCA/IGRhdGEgOiBkYXRhLmNvbmNhdChjb250ZXh0Rm9yZWNhc3REYXRhKTsKICAgICAgdmFyIHZhbHVlc1JhbmdlID0gewogICAgICAgIG1pbjogTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICBtYXg6IE51bWJlci5NSU5fVkFMVUUKICAgICAgfTsKCiAgICAgIF9sb2Rhc2guZGVmYXVsdC5lYWNoKGNvbWJpbmVkRGF0YSwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB2YWx1ZXNSYW5nZS5taW4gPSBNYXRoLm1pbihpdGVtLnZhbHVlLCB2YWx1ZXNSYW5nZS5taW4pOwogICAgICAgIHZhbHVlc1JhbmdlLm1heCA9IE1hdGgubWF4KGl0ZW0udmFsdWUsIHZhbHVlc1JhbmdlLm1heCk7CiAgICAgIH0pOwoKICAgICAgdmFyIGRhdGFNaW4gPSB2YWx1ZXNSYW5nZS5taW47CiAgICAgIHZhciBkYXRhTWF4ID0gdmFsdWVzUmFuZ2UubWF4OwogICAgICB2YXIgY2hhcnRMaW1pdHMgPSB7CiAgICAgICAgbWluOiBkYXRhTWluLAogICAgICAgIG1heDogZGF0YU1heAogICAgICB9OwoKICAgICAgaWYgKG1vZGVsUGxvdEVuYWJsZWQgPT09IHRydWUgfHwgY29udGV4dEZvcmVjYXN0RGF0YSAhPT0gdW5kZWZpbmVkICYmIGNvbnRleHRGb3JlY2FzdERhdGEubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBib3VuZHNSYW5nZSA9IHsKICAgICAgICAgIG1pbjogTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgIG1heDogTnVtYmVyLk1JTl9WQUxVRQogICAgICAgIH07CgogICAgICAgIF9sb2Rhc2guZGVmYXVsdC5lYWNoKGNvbWJpbmVkRGF0YSwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgIGJvdW5kc1JhbmdlLm1pbiA9IE1hdGgubWluKGl0ZW0ubG93ZXIsIGJvdW5kc1JhbmdlLm1pbik7CiAgICAgICAgICBib3VuZHNSYW5nZS5tYXggPSBNYXRoLm1heChpdGVtLnVwcGVyLCBib3VuZHNSYW5nZS5tYXgpOwogICAgICAgIH0pOwoKICAgICAgICBkYXRhTWluID0gTWF0aC5taW4oZGF0YU1pbiwgYm91bmRzUmFuZ2UubWluKTsKICAgICAgICBkYXRhTWF4ID0gTWF0aC5tYXgoZGF0YU1heCwgYm91bmRzUmFuZ2UubWF4KTsgLy8gU2V0IHRoZSB5IGF4aXMgZG9tYWluIHNvIHRoYXQgdGhlIHJhbmdlIG9mIGFjdHVhbCB2YWx1ZXMgdGFrZXMgdXAgYXQgbGVhc3QgNTAlIG9mIHRoZSBmdWxsIHJhbmdlLgoKICAgICAgICBpZiAodmFsdWVzUmFuZ2UubWF4IC0gdmFsdWVzUmFuZ2UubWluIDwgMC41ICogKGRhdGFNYXggLSBkYXRhTWluKSkgewogICAgICAgICAgaWYgKHZhbHVlc1JhbmdlLm1pbiA+IGRhdGFNaW4pIHsKICAgICAgICAgICAgY2hhcnRMaW1pdHMubWluID0gdmFsdWVzUmFuZ2UubWluIC0gMC41ICogKHZhbHVlc1JhbmdlLm1heCAtIHZhbHVlc1JhbmdlLm1pbik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHZhbHVlc1JhbmdlLm1heCA8IGRhdGFNYXgpIHsKICAgICAgICAgICAgY2hhcnRMaW1pdHMubWF4ID0gdmFsdWVzUmFuZ2UubWF4ICsgMC41ICogKHZhbHVlc1JhbmdlLm1heCAtIHZhbHVlc1JhbmdlLm1pbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmNvbnRleHRZU2NhbGUgPSBfZC5kZWZhdWx0LnNjYWxlLmxpbmVhcigpLnJhbmdlKFtjeHRDaGFydEhlaWdodCwgY29udGV4dENoYXJ0TGluZVRvcE1hcmdpbl0pLmRvbWFpbihbY2hhcnRMaW1pdHMubWluLCBjaGFydExpbWl0cy5tYXhdKTsKICAgICAgdmFyIGJvcmRlcnMgPSBjeHRHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICdheGlzJyk7IC8vIEFkZCBib3JkZXJzIGxlZnQgYW5kIHJpZ2h0LgoKICAgICAgYm9yZGVycy5hcHBlbmQoJ2xpbmUnKS5hdHRyKCd4MScsIDApLmF0dHIoJ3kxJywgMCkuYXR0cigneDInLCAwKS5hdHRyKCd5MicsIGN4dENoYXJ0SGVpZ2h0ICsgc3dsSGVpZ2h0KTsKICAgICAgYm9yZGVycy5hcHBlbmQoJ2xpbmUnKS5hdHRyKCd4MScsIGN4dFdpZHRoKS5hdHRyKCd5MScsIDApLmF0dHIoJ3gyJywgY3h0V2lkdGgpLmF0dHIoJ3kyJywgY3h0Q2hhcnRIZWlnaHQgKyBzd2xIZWlnaHQpOyAvLyBBZGQgeCBheGlzLgoKICAgICAgdmFyIHRpbWVCdWNrZXRzID0gbmV3IF90aW1lX2J1Y2tldHMuVGltZUJ1Y2tldHMoKTsKICAgICAgdGltZUJ1Y2tldHMuc2V0SW50ZXJ2YWwoJ2F1dG8nKTsKICAgICAgdGltZUJ1Y2tldHMuc2V0Qm91bmRzKGJvdW5kcyk7CiAgICAgIHZhciB4QXhpc1RpY2tGb3JtYXQgPSB0aW1lQnVja2V0cy5nZXRTY2FsZWREYXRlRm9ybWF0KCk7CgogICAgICB2YXIgeEF4aXMgPSBfZC5kZWZhdWx0LnN2Zy5heGlzKCkuc2NhbGUodGhpcy5jb250ZXh0WFNjYWxlKS5vcmllbnQoJ3RvcCcpLmlubmVyVGlja1NpemUoLWN4dENoYXJ0SGVpZ2h0KS5vdXRlclRpY2tTaXplKDApLnRpY2tQYWRkaW5nKDApLnRpY2tzKCgwLCBfY2hhcnRfdXRpbHMubnVtVGlja3NGb3JEYXRlRm9ybWF0KShjeHRXaWR0aCwgeEF4aXNUaWNrRm9ybWF0KSkudGlja0Zvcm1hdChmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiAoMCwgX21vbWVudC5kZWZhdWx0KShkKS5mb3JtYXQoeEF4aXNUaWNrRm9ybWF0KTsKICAgICAgfSk7CgogICAgICBjeHRHcm91cC5kYXR1bShkYXRhKTsKCiAgICAgIHZhciBjb250ZXh0Qm91bmRzQXJlYSA9IF9kLmRlZmF1bHQuc3ZnLmFyZWEoKS54KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMy5jb250ZXh0WFNjYWxlKGQuZGF0ZSk7CiAgICAgIH0pLnkwKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMy5jb250ZXh0WVNjYWxlKE1hdGgubWluKGNoYXJ0TGltaXRzLm1heCwgTWF0aC5tYXgoZC5sb3dlciwgY2hhcnRMaW1pdHMubWluKSkpOwogICAgICB9KS55MShmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiBfdGhpczMuY29udGV4dFlTY2FsZShNYXRoLm1heChjaGFydExpbWl0cy5taW4sIE1hdGgubWluKGQudXBwZXIsIGNoYXJ0TGltaXRzLm1heCkpKTsKICAgICAgfSkuZGVmaW5lZChmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiBkLmxvd2VyICE9PSBudWxsICYmIGQudXBwZXIgIT09IG51bGw7CiAgICAgIH0pOwoKICAgICAgaWYgKG1vZGVsUGxvdEVuYWJsZWQgPT09IHRydWUpIHsKICAgICAgICBjeHRHcm91cC5hcHBlbmQoJ3BhdGgnKS5kYXR1bShkYXRhKS5hdHRyKCdjbGFzcycsICdhcmVhIGNvbnRleHQnKS5hdHRyKCdkJywgY29udGV4dEJvdW5kc0FyZWEpOwogICAgICB9CgogICAgICB2YXIgY29udGV4dFZhbHVlc0xpbmUgPSBfZC5kZWZhdWx0LnN2Zy5saW5lKCkueChmdW5jdGlvbiAoZCkgewogICAgICAgIHJldHVybiBfdGhpczMuY29udGV4dFhTY2FsZShkLmRhdGUpOwogICAgICB9KS55KGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMy5jb250ZXh0WVNjYWxlKGQudmFsdWUpOwogICAgICB9KS5kZWZpbmVkKGZ1bmN0aW9uIChkKSB7CiAgICAgICAgcmV0dXJuIGQudmFsdWUgIT09IG51bGw7CiAgICAgIH0pOwoKICAgICAgY3h0R3JvdXAuYXBwZW5kKCdwYXRoJykuZGF0dW0oZGF0YSkuYXR0cignY2xhc3MnLCAndmFsdWVzLWxpbmUnKS5hdHRyKCdkJywgY29udGV4dFZhbHVlc0xpbmUpOwogICAgICAoMCwgX2NoYXJ0X3V0aWxzLmRyYXdMaW5lQ2hhcnREb3RzKShkYXRhLCBjeHRHcm91cCwgY29udGV4dFZhbHVlc0xpbmUsIDEpOyAvLyBDcmVhdGUgdGhlIHBhdGggZWxlbWVudHMgZm9yIHRoZSBmb3JlY2FzdCB2YWx1ZSBsaW5lIGFuZCBib3VuZHMgYXJlYS4KCiAgICAgIGlmIChjb250ZXh0Rm9yZWNhc3REYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjeHRHcm91cC5hcHBlbmQoJ3BhdGgnKS5kYXR1bShjb250ZXh0Rm9yZWNhc3REYXRhKS5hdHRyKCdjbGFzcycsICdhcmVhIGZvcmVjYXN0JykuYXR0cignZCcsIGNvbnRleHRCb3VuZHNBcmVhKTsKICAgICAgICBjeHRHcm91cC5hcHBlbmQoJ3BhdGgnKS5kYXR1bShjb250ZXh0Rm9yZWNhc3REYXRhKS5hdHRyKCdjbGFzcycsICd2YWx1ZXMtbGluZSBmb3JlY2FzdCcpLmF0dHIoJ2QnLCBjb250ZXh0VmFsdWVzTGluZSk7CiAgICAgIH0gLy8gQ3JlYXRlIGFuZCBkcmF3IHRoZSBhbm9tYWx5IHN3aW1sYW5lLgoKCiAgICAgIHZhciBzd2ltbGFuZSA9IGN4dEdyb3VwLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ3N3aW1sYW5lJykuYXR0cigndHJhbnNmb3JtJywgJ3RyYW5zbGF0ZSgwLCcgKyBjeHRDaGFydEhlaWdodCArICcpJyk7CiAgICAgIHRoaXMuZHJhd1N3aW1sYW5lKHN3aW1sYW5lLCBjeHRXaWR0aCwgc3dsSGVpZ2h0KTsgLy8gRHJhdyBhIG1hc2sgb3ZlciB0aGUgc2VjdGlvbnMgb2YgdGhlIGNvbnRleHQgY2hhcnQgYW5kIHN3aW1sYW5lCiAgICAgIC8vIHdoaWNoIGZhbGwgb3V0c2lkZSBvZiB0aGUgem9vbSBicnVzaCBzZWxlY3Rpb24gYXJlYS4KCiAgICAgIHRoaXMubWFzayA9IG5ldyBfY29udGV4dF9jaGFydF9tYXNrLkNvbnRleHRDaGFydE1hc2soY3h0R3JvdXAsIGNvbnRleHRDaGFydERhdGEsIG1vZGVsUGxvdEVuYWJsZWQsIHN3bEhlaWdodCkueCh0aGlzLmNvbnRleHRYU2NhbGUpLnkodGhpcy5jb250ZXh0WVNjYWxlKTsgLy8gRHJhdyB0aGUgeCBheGlzIG9uIHRvcCBvZiB0aGUgbWFzayBzbyB0aGF0IHRoZSBsYWJlbHMgYXJlIHZpc2libGUuCgogICAgICBjeHRHcm91cC5hcHBlbmQoJ2cnKS5hdHRyKCdjbGFzcycsICd4IGF4aXMgY29udGV4dC1jaGFydC1heGlzJykuY2FsbCh4QXhpcyk7IC8vIE1vdmUgdGhlIHggYXhpcyBsYWJlbHMgdXAgc28gdGhhdCB0aGV5IGFyZSBpbnNpZGUgdGhlIGNvbnRhY3QgY2hhcnQgYXJlYS4KCiAgICAgIGN4dEdyb3VwLnNlbGVjdEFsbCgnLnguY29udGV4dC1jaGFydC1heGlzIHRleHQnKS5hdHRyKCdkeScsIGN4dENoYXJ0SGVpZ2h0IC0gNSk7CiAgICAgICgwLCBfY2hhcnRfdXRpbHMuZmlsdGVyQXhpc0xhYmVscykoY3h0R3JvdXAuc2VsZWN0QWxsKCcueC5jb250ZXh0LWNoYXJ0LWF4aXMnKSwgY3h0V2lkdGgpOwogICAgICB0aGlzLmRyYXdDb250ZXh0QnJ1c2goY3h0R3JvdXApOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFpvb21JbnRlcnZhbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0Wm9vbUludGVydmFsKG1zKSB7CiAgICAgIHZhciBfdGhpcyRwcm9wczggPSB0aGlzLnByb3BzLAogICAgICAgICAgYm91bmRzID0gX3RoaXMkcHJvcHM4LmJvdW5kcywKICAgICAgICAgIHpvb21UbyA9IF90aGlzJHByb3BzOC56b29tVG87CiAgICAgIHZhciBtaW5Cb3VuZHNNcyA9IGJvdW5kcy5taW4udmFsdWVPZigpOwogICAgICB2YXIgbWF4Qm91bmRzTXMgPSBib3VuZHMubWF4LnZhbHVlT2YoKTsgLy8gQXR0ZW1wdCB0byByZXRhaW4gdGhlIHNhbWUgem9vbSBlbmQgdGltZS4KICAgICAgLy8gSWYgbm90LCBnbyBiYWNrIHRvIHRoZSBib3VuZHMgc3RhcnQgYW5kIGFkZCBvbiB0aGUgcmVxdWlyZWQgbWlsbGlzLgoKICAgICAgdmFyIG1pbGxpcyA9ICttczsKICAgICAgdmFyIHRvID0gem9vbVRvLmdldFRpbWUoKTsKICAgICAgdmFyIGZyb20gPSB0byAtIG1pbGxpczsKCiAgICAgIGlmIChmcm9tIDwgbWluQm91bmRzTXMpIHsKICAgICAgICBmcm9tID0gbWluQm91bmRzTXM7CiAgICAgICAgdG8gPSBNYXRoLm1pbihtaW5Cb3VuZHNNcyArIG1pbGxpcywgbWF4Qm91bmRzTXMpOwogICAgICB9CgogICAgICB0aGlzLnNldENvbnRleHRCcnVzaEV4dGVudChuZXcgRGF0ZShmcm9tKSwgbmV3IERhdGUodG8pKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzaG93Rm9jdXNDaGFydFRvb2x0aXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNob3dGb2N1c0NoYXJ0VG9vbHRpcChtYXJrZXIsIGNpcmNsZSkgewogICAgICB2YXIgX3RoaXMkcHJvcHM5ID0gdGhpcy5wcm9wcywKICAgICAgICAgIG1vZGVsUGxvdEVuYWJsZWQgPSBfdGhpcyRwcm9wczkubW9kZWxQbG90RW5hYmxlZCwKICAgICAgICAgIGludGwgPSBfdGhpcyRwcm9wczkuaW50bDsKICAgICAgdmFyIGZpZWxkRm9ybWF0ID0gdGhpcy5maWVsZEZvcm1hdDsKICAgICAgdmFyIHNlcmllc0tleSA9ICdzaW5nbGVfbWV0cmljX3ZpZXdlcic7IC8vIFNob3cgdGhlIHRpbWUgYW5kIG1ldHJpYyB2YWx1ZXMgaW4gdGhlIHRvb2x0aXAuCiAgICAgIC8vIFVzZXMgZGF0ZSwgdmFsdWUsIHVwcGVyLCBsb3dlciBhbmQgYW5vbWFseVNjb3JlIChvcHRpb25hbCkgbWFya2VyIHByb3BlcnRpZXMuCgogICAgICB2YXIgZm9ybWF0dGVkRGF0ZSA9ICgwLCBfZGF0ZV91dGlscy5mb3JtYXRIdW1hblJlYWRhYmxlRGF0ZVRpbWVTZWNvbmRzKShtYXJrZXIuZGF0ZSk7CiAgICAgIHZhciB0b29sdGlwRGF0YSA9IFt7CiAgICAgICAgbmFtZTogZm9ybWF0dGVkRGF0ZQogICAgICB9XTsKCiAgICAgIGlmIChfbG9kYXNoLmRlZmF1bHQuaGFzKG1hcmtlciwgJ2Fub21hbHlTY29yZScpKSB7CiAgICAgICAgdmFyIHNjb3JlID0gcGFyc2VJbnQobWFya2VyLmFub21hbHlTY29yZSk7CiAgICAgICAgdmFyIGRpc3BsYXlTY29yZSA9IHNjb3JlID4gMCA/IHNjb3JlIDogJzwgMSc7CiAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQuYW5vbWFseVNjb3JlTGFiZWwnLAogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2Fub21hbHkgc2NvcmUnCiAgICAgICAgICB9KSwKICAgICAgICAgIHZhbHVlOiBkaXNwbGF5U2NvcmUsCiAgICAgICAgICBjb2xvcjogYW5vbWFseUNvbG9yU2NhbGUoc2NvcmUpLAogICAgICAgICAgc2VyaWVzS2V5OiBzZXJpZXNLZXksCiAgICAgICAgICB5QWNjZXNzb3I6ICdhbm9tYWx5X3Njb3JlJwogICAgICAgIH0pOwoKICAgICAgICBpZiAoKDAsIF9jaGFydF91dGlscy5zaG93TXVsdGlCdWNrZXRBbm9tYWx5VG9vbHRpcCkobWFya2VyKSA9PT0gdHJ1ZSkgewogICAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICAgIG5hbWU6IGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICAgICAgaWQ6ICd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIudGltZVNlcmllc0NoYXJ0Lm11bHRpQnVja2V0SW1wYWN0TGFiZWwnLAogICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnbXVsdGktYnVja2V0IGltcGFjdCcKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHZhbHVlOiAoMCwgX2Fub21hbHlfdXRpbHMuZ2V0TXVsdGlCdWNrZXRJbXBhY3RMYWJlbCkobWFya2VyLm11bHRpQnVja2V0SW1wYWN0KSwKICAgICAgICAgICAgc2VyaWVzS2V5OiBzZXJpZXNLZXksCiAgICAgICAgICAgIHlBY2Nlc3NvcjogJ211bHRpX2J1Y2tldF9pbXBhY3QnCiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChtb2RlbFBsb3RFbmFibGVkID09PSBmYWxzZSkgewogICAgICAgICAgLy8gU2hvdyBhY3R1YWwvdHlwaWNhbCB3aGVuIGF2YWlsYWJsZSBleGNlcHQgZm9yIHJhcmUgZGV0ZWN0b3JzLgogICAgICAgICAgLy8gUmFyZSBkZXRlY3RvcnMgYWx3YXlzIGhhdmUgMSBhcyBhY3R1YWwgYW5kIHRoZSBwcm9iYWJpbGl0eSBhcyB0eXBpY2FsLgogICAgICAgICAgLy8gRXhwb3NpbmcgdGhvc2UgdmFsdWVzIGluIHRoZSB0b29sdGlwIHdpdGggYWN0dWFsL3R5cGljYWwgbGFiZWxzIG1pZ2h0IGlycml0YXRlIHVzZXJzLgogICAgICAgICAgaWYgKF9sb2Rhc2guZGVmYXVsdC5oYXMobWFya2VyLCAnYWN0dWFsJykgJiYgbWFya2VyLmZ1bmN0aW9uICE9PSAncmFyZScpIHsKICAgICAgICAgICAgLy8gRGlzcGxheSB0aGUgcmVjb3JkIGFjdHVhbCBpbiBwcmVmZXJlbmNlIHRvIHRoZSBjaGFydCB2YWx1ZSwgd2hpY2ggbWF5IGJlCiAgICAgICAgICAgIC8vIGRpZmZlcmVudCBkZXBlbmRpbmcgb24gdGhlIGFnZ3JlZ2F0aW9uIGludGVydmFsIG9mIHRoZSBjaGFydC4KICAgICAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICAgICAgbmFtZTogaW50bC5mb3JtYXRNZXNzYWdlKHsKICAgICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC5hY3R1YWxMYWJlbCcsCiAgICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2FjdHVhbCcKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICB2YWx1ZTogKDAsIF9mb3JtYXRfdmFsdWUuZm9ybWF0VmFsdWUpKG1hcmtlci5hY3R1YWwsIG1hcmtlci5mdW5jdGlvbiwgZmllbGRGb3JtYXQpLAogICAgICAgICAgICAgIHNlcmllc0tleTogc2VyaWVzS2V5LAogICAgICAgICAgICAgIHlBY2Nlc3NvcjogJ2FjdHVhbCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICAgIG5hbWU6IGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQudHlwaWNhbExhYmVsJywKICAgICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAndHlwaWNhbCcKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICB2YWx1ZTogKDAsIF9mb3JtYXRfdmFsdWUuZm9ybWF0VmFsdWUpKG1hcmtlci50eXBpY2FsLCBtYXJrZXIuZnVuY3Rpb24sIGZpZWxkRm9ybWF0KSwKICAgICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgICB5QWNjZXNzb3I6ICd0eXBpY2FsJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICAgIG5hbWU6IGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQudmFsdWVMYWJlbCcsCiAgICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ3ZhbHVlJwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIHZhbHVlOiAoMCwgX2Zvcm1hdF92YWx1ZS5mb3JtYXRWYWx1ZSkobWFya2VyLnZhbHVlLCBtYXJrZXIuZnVuY3Rpb24sIGZpZWxkRm9ybWF0KSwKICAgICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgICB5QWNjZXNzb3I6ICd2YWx1ZScKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoX2xvZGFzaC5kZWZhdWx0LmhhcyhtYXJrZXIsICdieUZpZWxkTmFtZScpICYmIF9sb2Rhc2guZGVmYXVsdC5oYXMobWFya2VyLCAnbnVtYmVyT2ZDYXVzZXMnKSkgewogICAgICAgICAgICAgIHZhciBudW1iZXJPZkNhdXNlcyA9IG1hcmtlci5udW1iZXJPZkNhdXNlczsgLy8gSWYgbnVtYmVyT2ZDYXVzZXMgPT09IDEsIHdvbid0IGdvIGludG8gdGhpcyBibG9jayBhcyBhY3R1YWwvdHlwaWNhbCBjb3BpZWQgdG8gdG9wIGxldmVsIGZpZWxkcy4KCiAgICAgICAgICAgICAgdmFyIGJ5RmllbGROYW1lID0gKDAsIF9zdHJpbmdfdXRpbHMubWxFc2NhcGUpKG1hcmtlci5ieUZpZWxkTmFtZSk7CiAgICAgICAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQubW9yZVRoYW5PbmVVbnVzdWFsQnlGaWVsZFZhbHVlc0xhYmVsJywKICAgICAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICd7bnVtYmVyT2ZDYXVzZXN9e3BsdXNTaWdufSB1bnVzdWFsIHtieUZpZWxkTmFtZX0gdmFsdWVzJwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBudW1iZXJPZkNhdXNlczogbnVtYmVyT2ZDYXVzZXMsCiAgICAgICAgICAgICAgICAgIGJ5RmllbGROYW1lOiBieUZpZWxkTmFtZSwKICAgICAgICAgICAgICAgICAgLy8gTWF4aW11bSBvZiAxMCBjYXVzZXMgYXJlIHN0b3JlZCBpbiB0aGUgcmVjb3JkLCBzbyAnMTAnIG1heSBtZWFuIG1vcmUgdGhhbiAxMC4KICAgICAgICAgICAgICAgICAgcGx1c1NpZ246IG51bWJlck9mQ2F1c2VzIDwgMTAgPyAnJyA6ICcrJwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgICAgIHlBY2Nlc3NvcjogJ251bWJlck9mQ2F1c2VzJwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC5tb2RlbFBsb3RFbmFibGVkLmFjdHVhbExhYmVsJywKICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2FjdHVhbCcKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHZhbHVlOiAoMCwgX2Zvcm1hdF92YWx1ZS5mb3JtYXRWYWx1ZSkobWFya2VyLmFjdHVhbCwgbWFya2VyLmZ1bmN0aW9uLCBmaWVsZEZvcm1hdCksCiAgICAgICAgICAgIHNlcmllc0tleTogc2VyaWVzS2V5LAogICAgICAgICAgICB5QWNjZXNzb3I6ICdhY3R1YWwnCiAgICAgICAgICB9KTsKICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC5tb2RlbFBsb3RFbmFibGVkLnVwcGVyQm91bmRzTGFiZWwnLAogICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAndXBwZXIgYm91bmRzJwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdmFsdWU6ICgwLCBfZm9ybWF0X3ZhbHVlLmZvcm1hdFZhbHVlKShtYXJrZXIudXBwZXIsIG1hcmtlci5mdW5jdGlvbiwgZmllbGRGb3JtYXQpLAogICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgeUFjY2Vzc29yOiAndXBwZXJfYm91bmRzJwogICAgICAgICAgfSk7CiAgICAgICAgICB0b29sdGlwRGF0YS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogaW50bC5mb3JtYXRNZXNzYWdlKHsKICAgICAgICAgICAgICBpZDogJ3hwYWNrLm1sLnRpbWVTZXJpZXNFeHBsb3Jlci50aW1lU2VyaWVzQ2hhcnQubW9kZWxQbG90RW5hYmxlZC5sb3dlckJvdW5kc0xhYmVsJywKICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2xvd2VyIGJvdW5kcycKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHZhbHVlOiAoMCwgX2Zvcm1hdF92YWx1ZS5mb3JtYXRWYWx1ZSkobWFya2VyLmxvd2VyLCBtYXJrZXIuZnVuY3Rpb24sIGZpZWxkRm9ybWF0KSwKICAgICAgICAgICAgc2VyaWVzS2V5OiBzZXJpZXNLZXksCiAgICAgICAgICAgIHlBY2Nlc3NvcjogJ2xvd2VyX2JvdW5kcycKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUT0RPIC0gbmVlZCBiZXR0ZXIgZm9ybWF0dGluZyBmb3Igc21hbGwgZGVjaW1hbHMuCiAgICAgICAgaWYgKF9sb2Rhc2guZGVmYXVsdC5nZXQobWFya2VyLCAnaXNGb3JlY2FzdCcsIGZhbHNlKSA9PT0gdHJ1ZSkgewogICAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICAgIG5hbWU6IGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICAgICAgaWQ6ICd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIudGltZVNlcmllc0NoYXJ0LndpdGhvdXRBbm9tYWx5U2NvcmUucHJlZGljdGlvbkxhYmVsJywKICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ3ByZWRpY3Rpb24nCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICB2YWx1ZTogKDAsIF9mb3JtYXRfdmFsdWUuZm9ybWF0VmFsdWUpKG1hcmtlci52YWx1ZSwgbWFya2VyLmZ1bmN0aW9uLCBmaWVsZEZvcm1hdCksCiAgICAgICAgICAgIHNlcmllc0tleTogc2VyaWVzS2V5LAogICAgICAgICAgICB5QWNjZXNzb3I6ICdwcmVkaWN0aW9uJwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC53aXRob3V0QW5vbWFseVNjb3JlLnZhbHVlTGFiZWwnLAogICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAndmFsdWUnCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICB2YWx1ZTogKDAsIF9mb3JtYXRfdmFsdWUuZm9ybWF0VmFsdWUpKG1hcmtlci52YWx1ZSwgbWFya2VyLmZ1bmN0aW9uLCBmaWVsZEZvcm1hdCksCiAgICAgICAgICAgIHNlcmllc0tleTogc2VyaWVzS2V5LAogICAgICAgICAgICB5QWNjZXNzb3I6ICd2YWx1ZScKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1vZGVsUGxvdEVuYWJsZWQgPT09IHRydWUpIHsKICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC53aXRob3V0QW5vbWFseVNjb3JlQW5kTW9kZWxQbG90RW5hYmxlZC51cHBlckJvdW5kc0xhYmVsJywKICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ3VwcGVyIGJvdW5kcycKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHZhbHVlOiAoMCwgX2Zvcm1hdF92YWx1ZS5mb3JtYXRWYWx1ZSkobWFya2VyLnVwcGVyLCBtYXJrZXIuZnVuY3Rpb24sIGZpZWxkRm9ybWF0KSwKICAgICAgICAgICAgc2VyaWVzS2V5OiBzZXJpZXNLZXksCiAgICAgICAgICAgIHlBY2Nlc3NvcjogJ3VwcGVyX2JvdW5kcycKICAgICAgICAgIH0pOwogICAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICAgIG5hbWU6IGludGwuZm9ybWF0TWVzc2FnZSh7CiAgICAgICAgICAgICAgaWQ6ICd4cGFjay5tbC50aW1lU2VyaWVzRXhwbG9yZXIudGltZVNlcmllc0NoYXJ0LndpdGhvdXRBbm9tYWx5U2NvcmVBbmRNb2RlbFBsb3RFbmFibGVkLmxvd2VyQm91bmRzTGFiZWwnLAogICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnbG93ZXIgYm91bmRzJwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdmFsdWU6ICgwLCBfZm9ybWF0X3ZhbHVlLmZvcm1hdFZhbHVlKShtYXJrZXIubG93ZXIsIG1hcmtlci5mdW5jdGlvbiwgZmllbGRGb3JtYXQpLAogICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgeUFjY2Vzc29yOiAnbG93ZXJfYm91bmRzJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoX2xvZGFzaC5kZWZhdWx0LmhhcyhtYXJrZXIsICdzY2hlZHVsZWRFdmVudHMnKSkgewogICAgICAgIG1hcmtlci5zY2hlZHVsZWRFdmVudHMuZm9yRWFjaChmdW5jdGlvbiAoc2NoZWR1bGVkRXZlbnQsIGkpIHsKICAgICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiBpbnRsLmZvcm1hdE1lc3NhZ2UoewogICAgICAgICAgICAgIGlkOiAneHBhY2subWwudGltZVNlcmllc0V4cGxvcmVyLnRpbWVTZXJpZXNDaGFydC5zY2hlZHVsZWRFdmVudHNMYWJlbCcsCiAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdzY2hlZHVsZWQgZXZlbnR7Y291bnRlcn0nCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBjb3VudGVyOiBtYXJrZXIuc2NoZWR1bGVkRXZlbnRzLmxlbmd0aCA+IDEgPyAiICMiLmNvbmNhdChpICsgMSkgOiAnJwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdmFsdWU6IHNjaGVkdWxlZEV2ZW50LAogICAgICAgICAgICBzZXJpZXNLZXk6IHNlcmllc0tleSwKICAgICAgICAgICAgeUFjY2Vzc29yOiAic2NoZWR1bGVkX2V2ZW50c18iLmNvbmNhdChpICsgMSkKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAobWxBbm5vdGF0aW9uc0VuYWJsZWQgJiYgX2xvZGFzaC5kZWZhdWx0LmhhcyhtYXJrZXIsICdhbm5vdGF0aW9uJykpIHsKICAgICAgICB0b29sdGlwRGF0YS5sZW5ndGggPSAwOwogICAgICAgIHRvb2x0aXBEYXRhLnB1c2goewogICAgICAgICAgbmFtZTogbWFya2VyLmFubm90YXRpb24KICAgICAgICB9KTsKICAgICAgICB2YXIgdGltZXNwYW4gPSAoMCwgX21vbWVudC5kZWZhdWx0KShtYXJrZXIudGltZXN0YW1wKS5mb3JtYXQoJ01NTU0gRG8gWVlZWSwgSEg6bW0nKTsKCiAgICAgICAgaWYgKHR5cGVvZiBtYXJrZXIuZW5kX3RpbWVzdGFtcCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHRpbWVzcGFuICs9ICIgLSAiLmNvbmNhdCgoMCwgX21vbWVudC5kZWZhdWx0KShtYXJrZXIuZW5kX3RpbWVzdGFtcCkuZm9ybWF0KCdNTU1NIERvIFlZWVksIEhIOm1tJykpOwogICAgICAgIH0KCiAgICAgICAgdG9vbHRpcERhdGEucHVzaCh7CiAgICAgICAgICBuYW1lOiB0aW1lc3BhbgogICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgeE9mZnNldCA9IF9jaGFydF91dGlscy5MSU5FX0NIQVJUX0FOT01BTFlfUkFESVVTICogMjsgLy8gV2hlbiB0aGUgYW5ub3RhdGlvbiBhcmVhIGlzIGhvdmVyZWQKCiAgICAgIGlmIChjaXJjbGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAncmVjdCcpIHsKICAgICAgICB2YXIgeCA9IE51bWJlcihjaXJjbGUuZ2V0QXR0cmlidXRlKCd4JykpOwoKICAgICAgICBpZiAoeCA8IDApIHsKICAgICAgICAgIC8vIFRoZSBiZWdpbm5pbmcgb2YgdGhlIGFubm90YXRpb24gYXJlYSBpcyBvdXRzaWRlIG9mIHRoZSBmb2N1cyBjaGFydCwKICAgICAgICAgIC8vIGhlbmNlIHdlIG5lZWQgdG8gYWRqdXN0IHRoZSB4IG9mZnNldCBvZiBhIHRvb2x0aXAuCiAgICAgICAgICB4T2Zmc2V0ID0gTWF0aC5hYnMoeCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBfY2hhcnRfdG9vbHRpcF9zZXJ2aWNlLm1sQ2hhcnRUb29sdGlwU2VydmljZS5zaG93KHRvb2x0aXBEYXRhLCBjaXJjbGUsIHsKICAgICAgICB4OiB4T2Zmc2V0LAogICAgICAgIHk6IDAKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaGlnaGxpZ2h0Rm9jdXNDaGFydEFub21hbHkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGhpZ2hsaWdodEZvY3VzQ2hhcnRBbm9tYWx5KHJlY29yZCkgewogICAgICAvLyBIaWdobGlnaHRzIHRoZSBhbm9tYWx5IG1hcmtlciBpbiB0aGUgZm9jdXMgY2hhcnQgY29ycmVzcG9uZGluZyB0byB0aGUgc3BlY2lmaWVkIHJlY29yZC4KICAgICAgdmFyIF90aGlzJHByb3BzMTAgPSB0aGlzLnByb3BzLAogICAgICAgICAgZm9jdXNDaGFydERhdGEgPSBfdGhpcyRwcm9wczEwLmZvY3VzQ2hhcnREYXRhLAogICAgICAgICAgZm9jdXNBZ2dyZWdhdGlvbkludGVydmFsID0gX3RoaXMkcHJvcHMxMC5mb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWw7CiAgICAgIHZhciBmb2N1c1hTY2FsZSA9IHRoaXMuZm9jdXNYU2NhbGU7CiAgICAgIHZhciBmb2N1c1lTY2FsZSA9IHRoaXMuZm9jdXNZU2NhbGU7CiAgICAgIHZhciBzaG93Rm9jdXNDaGFydFRvb2x0aXAgPSB0aGlzLnNob3dGb2N1c0NoYXJ0VG9vbHRpcC5iaW5kKHRoaXMpOyAvLyBGaW5kIHRoZSBhbm9tYWx5IG1hcmtlciB3aGljaCBjb3JyZXNwb25kcyB0byB0aGUgdGltZSBvZiB0aGUgYW5vbWFseSByZWNvcmQuCiAgICAgIC8vIERlcGVuZGluZyBvbiB0aGUgd2F5IHRoZSBjaGFydCBpcyBhZ2dyZWdhdGVkLCB0aGVyZSBtYXkgbm90IGJlCiAgICAgIC8vIGEgcG9pbnQgYXQgZXhhY3RseSB0aGUgc2FtZSB0aW1lIGFzIHRoZSByZWNvcmQgYmVpbmcgaGlnaGxpZ2h0ZWQuCgogICAgICB2YXIgYW5vbWFseVRpbWUgPSByZWNvcmQuc291cmNlLnRpbWVzdGFtcDsKICAgICAgdmFyIG1hcmtlclRvU2VsZWN0ID0gKDAsIF90aW1lc2VyaWVzZXhwbG9yZXJfdXRpbHMuZmluZENoYXJ0UG9pbnRGb3JBbm9tYWx5VGltZSkoZm9jdXNDaGFydERhdGEsIGFub21hbHlUaW1lLCBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWwpOyAvLyBSZW5kZXIgYW4gYWRkaXRpb25hbCBoaWdobGlnaHRlZCBhbm9tYWx5IG1hcmtlciBvbiB0aGUgZm9jdXMgY2hhcnQuCiAgICAgIC8vIFRPRE8gLSBwbG90IGFub21hbHkgbWFya2VycyBmb3IgY2FzZXMgd2hlcmUgdGhlcmUgaXMgYW4gYW5vbWFseSBkdWUKICAgICAgLy8gdG8gdGhlIGFic2VuY2Ugb2YgZGF0YSBhbmQgbW9kZWwgcGxvdCBpcyBlbmFibGVkLgoKICAgICAgaWYgKG1hcmtlclRvU2VsZWN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgc2VsZWN0ZWRNYXJrZXIgPSBfZC5kZWZhdWx0LnNlbGVjdCgnLmZvY3VzLWNoYXJ0LW1hcmtlcnMnKS5zZWxlY3RBbGwoJy5mb2N1cy1jaGFydC1oaWdobGlnaHRlZC1tYXJrZXInKS5kYXRhKFttYXJrZXJUb1NlbGVjdF0pOwoKICAgICAgICBpZiAoKDAsIF9jaGFydF91dGlscy5zaG93TXVsdGlCdWNrZXRBbm9tYWx5TWFya2VyKShtYXJrZXJUb1NlbGVjdCkgPT09IHRydWUpIHsKICAgICAgICAgIHNlbGVjdGVkTWFya2VyLmVudGVyKCkuYXBwZW5kKCdwYXRoJykuYXR0cignZCcsIF9kLmRlZmF1bHQuc3ZnLnN5bWJvbCgpLnNpemUoX2NoYXJ0X3V0aWxzLk1VTFRJX0JVQ0tFVF9TWU1CT0xfU0laRSkudHlwZSgnY3Jvc3MnKSkuYXR0cigndHJhbnNmb3JtJywgZnVuY3Rpb24gKGQpIHsKICAgICAgICAgICAgcmV0dXJuICJ0cmFuc2xhdGUoIi5jb25jYXQoZm9jdXNYU2NhbGUoZC5kYXRlKSwgIiwgIikuY29uY2F0KGZvY3VzWVNjYWxlKGQudmFsdWUpLCAiKSIpOwogICAgICAgICAgfSkuYXR0cignY2xhc3MnLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgICByZXR1cm4gImFub21hbHktbWFya2VyIG11bHRpLWJ1Y2tldCAiLmNvbmNhdCgoMCwgX2Fub21hbHlfdXRpbHMuZ2V0U2V2ZXJpdHlXaXRoTG93KShkLmFub21hbHlTY29yZSkuaWQsICIgaGlnaGxpZ2h0ZWQiKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RlZE1hcmtlci5lbnRlcigpLmFwcGVuZCgnY2lyY2xlJykuYXR0cigncicsIF9jaGFydF91dGlscy5MSU5FX0NIQVJUX0FOT01BTFlfUkFESVVTKS5hdHRyKCdjeCcsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICAgIHJldHVybiBmb2N1c1hTY2FsZShkLmRhdGUpOwogICAgICAgICAgfSkuYXR0cignY3knLCBmdW5jdGlvbiAoZCkgewogICAgICAgICAgICByZXR1cm4gZm9jdXNZU2NhbGUoZC52YWx1ZSk7CiAgICAgICAgICB9KS5hdHRyKCdjbGFzcycsIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICAgIHJldHVybiAiYW5vbWFseS1tYXJrZXIgbWV0cmljLXZhbHVlICIuY29uY2F0KCgwLCBfYW5vbWFseV91dGlscy5nZXRTZXZlcml0eVdpdGhMb3cpKGQuYW5vbWFseVNjb3JlKS5pZCwgIiBoaWdobGlnaHRlZCIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSAvLyBEaXNwbGF5IHRoZSBjaGFydCB0b29sdGlwIGZvciB0aGlzIG1hcmtlci4KICAgICAgICAvLyBOb3RlIHRoZSB2YWx1ZXMgb2YgdGhlIHJlY29yZCBhbmQgbWFya2VyIG1heSBkaWZmZXIgZGVwZW5kaW5nIG9uIHRoZSBsZXZlbHMgb2YgYWdncmVnYXRpb24uCgoKICAgICAgICB2YXIgY2hhcnRFbGVtZW50ID0gX2QuZGVmYXVsdC5zZWxlY3QodGhpcy5yb290Tm9kZSk7CgogICAgICAgIHZhciBhbm9tYWx5TWFya2VyID0gY2hhcnRFbGVtZW50LnNlbGVjdEFsbCgnLmZvY3VzLWNoYXJ0LW1hcmtlcnMgLmFub21hbHktbWFya2VyLmhpZ2hsaWdodGVkJyk7CgogICAgICAgIGlmIChhbm9tYWx5TWFya2VyLmxlbmd0aCkgewogICAgICAgICAgc2hvd0ZvY3VzQ2hhcnRUb29sdGlwKG1hcmtlclRvU2VsZWN0LCBhbm9tYWx5TWFya2VyWzBdWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1bmhpZ2hsaWdodEZvY3VzQ2hhcnRBbm9tYWx5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1bmhpZ2hsaWdodEZvY3VzQ2hhcnRBbm9tYWx5KCkgewogICAgICBfZC5kZWZhdWx0LnNlbGVjdCgnLmZvY3VzLWNoYXJ0LW1hcmtlcnMnKS5zZWxlY3RBbGwoJy5hbm9tYWx5LW1hcmtlci5oaWdobGlnaHRlZCcpLnJlbW92ZSgpOwoKICAgICAgX2NoYXJ0X3Rvb2x0aXBfc2VydmljZS5tbENoYXJ0VG9vbHRpcFNlcnZpY2UuaGlkZSgpOwogICAgfQogIH0sIHsKICAgIGtleTogInNob3VsZENvbXBvbmVudFVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRSZWYiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFJlZihjb21wb25lbnROb2RlKSB7CiAgICAgIHRoaXMucm9vdE5vZGUgPSBjb21wb25lbnROb2RlOwogICAgfQogIH0sIHsKICAgIGtleTogInJlbmRlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICByZXR1cm4gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgICAgIGNsYXNzTmFtZTogIm1sLXRpbWVzZXJpZXMtY2hhcnQtcmVhY3QiLAogICAgICAgIHJlZjogdGhpcy5zZXRSZWYuYmluZCh0aGlzKQogICAgICB9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBUaW1lc2VyaWVzQ2hhcnQ7Cn0oX3JlYWN0LmRlZmF1bHQuQ29tcG9uZW50KSwgX2RlZmluZVByb3BlcnR5KF9jbGFzcywgInByb3BUeXBlcyIsIHsKICBhbm5vdGF0aW9uOiBfcHJvcFR5cGVzLmRlZmF1bHQub2JqZWN0LAogIGF1dG9ab29tRHVyYXRpb246IF9wcm9wVHlwZXMuZGVmYXVsdC5udW1iZXIsCiAgYm91bmRzOiBfcHJvcFR5cGVzLmRlZmF1bHQub2JqZWN0LAogIGNvbnRleHRBZ2dyZWdhdGlvbkludGVydmFsOiBfcHJvcFR5cGVzLmRlZmF1bHQub2JqZWN0LAogIGNvbnRleHRDaGFydERhdGE6IF9wcm9wVHlwZXMuZGVmYXVsdC5hcnJheSwKICBjb250ZXh0Rm9yZWNhc3REYXRhOiBfcHJvcFR5cGVzLmRlZmF1bHQuYXJyYXksCiAgY29udGV4dENoYXJ0U2VsZWN0ZWQ6IF9wcm9wVHlwZXMuZGVmYXVsdC5mdW5jLmlzUmVxdWlyZWQsCiAgZGV0ZWN0b3JJbmRleDogX3Byb3BUeXBlcy5kZWZhdWx0Lm51bWJlciwKICBmb2N1c0FnZ3JlZ2F0aW9uSW50ZXJ2YWw6IF9wcm9wVHlwZXMuZGVmYXVsdC5vYmplY3QsCiAgZm9jdXNBbm5vdGF0aW9uRGF0YTogX3Byb3BUeXBlcy5kZWZhdWx0LmFycmF5LAogIGZvY3VzQ2hhcnREYXRhOiBfcHJvcFR5cGVzLmRlZmF1bHQuYXJyYXksCiAgZm9jdXNGb3JlY2FzdERhdGE6IF9wcm9wVHlwZXMuZGVmYXVsdC5hcnJheSwKICBtb2RlbFBsb3RFbmFibGVkOiBfcHJvcFR5cGVzLmRlZmF1bHQuYm9vbC5pc1JlcXVpcmVkLAogIHJlbmRlckZvY3VzQ2hhcnRPbmx5OiBfcHJvcFR5cGVzLmRlZmF1bHQuYm9vbC5pc1JlcXVpcmVkLAogIHNlbGVjdGVkSm9iOiBfcHJvcFR5cGVzLmRlZmF1bHQub2JqZWN0LAogIHNob3dGb3JlY2FzdDogX3Byb3BUeXBlcy5kZWZhdWx0LmJvb2wuaXNSZXF1aXJlZCwKICBzaG93TW9kZWxCb3VuZHM6IF9wcm9wVHlwZXMuZGVmYXVsdC5ib29sLmlzUmVxdWlyZWQsCiAgc3ZnV2lkdGg6IF9wcm9wVHlwZXMuZGVmYXVsdC5udW1iZXIuaXNSZXF1aXJlZCwKICBzd2ltbGFuZURhdGE6IF9wcm9wVHlwZXMuZGVmYXVsdC5hcnJheSwKICB6b29tRnJvbTogX3Byb3BUeXBlcy5kZWZhdWx0Lm9iamVjdCwKICB6b29tVG86IF9wcm9wVHlwZXMuZGVmYXVsdC5vYmplY3QsCiAgem9vbUZyb21Gb2N1c0xvYWRlZDogX3Byb3BUeXBlcy5kZWZhdWx0Lm9iamVjdCwKICB6b29tVG9Gb2N1c0xvYWRlZDogX3Byb3BUeXBlcy5kZWZhdWx0Lm9iamVjdAp9KSwgX3RlbXApKTsKCnZhciBUaW1lc2VyaWVzQ2hhcnQgPSBmdW5jdGlvbiBUaW1lc2VyaWVzQ2hhcnQocHJvcHMpIHsKICB2YXIgYW5ub3RhdGlvblByb3AgPSAoMCwgX3VzZU9ic2VydmFibGUuZGVmYXVsdCkoX2Fubm90YXRpb25zX3NlcnZpY2UuYW5ub3RhdGlvbiQpOwoKICBpZiAoYW5ub3RhdGlvblByb3AgPT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIG51bGw7CiAgfQoKICByZXR1cm4gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChUaW1lc2VyaWVzQ2hhcnRJbnRsLCBfZXh0ZW5kcyh7CiAgICBhbm5vdGF0aW9uOiBhbm5vdGF0aW9uUHJvcAogIH0sIHByb3BzKSk7Cn07CgpleHBvcnRzLlRpbWVzZXJpZXNDaGFydCA9IFRpbWVzZXJpZXNDaGFydDs="},null]}