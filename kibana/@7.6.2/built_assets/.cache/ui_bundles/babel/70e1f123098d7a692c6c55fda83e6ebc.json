{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!src/legacy/core_plugins/kibana/public/discover/np_ready/angular/discover.js","dependencies":[{"path":"src/legacy/core_plugins/kibana/public/discover/np_ready/angular/discover.js","mtime":1585205039488},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKdmFyIF9sb2Rhc2ggPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoImxvZGFzaCIpKTsKCnZhciBfcmVhY3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoInJlYWN0IikpOwoKdmFyIF9yeGpzID0gcmVxdWlyZSgicnhqcyIpOwoKdmFyIF9tb21lbnQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIm1vbWVudCIpKTsKCnZhciBfZGF0ZW1hdGggPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIkBlbGFzdGljL2RhdGVtYXRoIikpOwoKdmFyIF9pMThuID0gcmVxdWlyZSgiQGtibi9pMThuIik7CgpyZXF1aXJlKCIuLi9jb21wb25lbnRzL2ZpZWxkX2Nob29zZXIvZmllbGRfY2hvb3NlciIpOwoKcmVxdWlyZSgiLi9kb2NfdGFibGUiKTsKCnZhciBfZ2V0X3NvcnQgPSByZXF1aXJlKCIuL2RvY190YWJsZS9saWIvZ2V0X3NvcnQiKTsKCnZhciBfZ2V0X3NvcnRfZm9yX3NlYXJjaF9zb3VyY2UgPSByZXF1aXJlKCIuL2RvY190YWJsZS9saWIvZ2V0X3NvcnRfZm9yX3NlYXJjaF9zb3VyY2UiKTsKCnZhciBjb2x1bW5BY3Rpb25zID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZSgiLi9kb2NfdGFibGUvYWN0aW9ucy9jb2x1bW5zIikpOwoKdmFyIF9kaXNjb3ZlciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9kaXNjb3Zlci5odG1sIikpOwoKdmFyIF9zaG93X29wZW5fc2VhcmNoX3BhbmVsID0gcmVxdWlyZSgiLi4vY29tcG9uZW50cy90b3BfbmF2L3Nob3dfb3Blbl9zZWFyY2hfcGFuZWwiKTsKCnZhciBfaGVscF9tZW51X3V0aWwgPSByZXF1aXJlKCIuLi9jb21wb25lbnRzL2hlbHBfbWVudS9oZWxwX21lbnVfdXRpbCIpOwoKcmVxdWlyZSgiLi4vY29tcG9uZW50cy9mZXRjaF9lcnJvciIpOwoKdmFyIF9nZXRfcGFpbmxlc3NfZXJyb3IgPSByZXF1aXJlKCIuL2dldF9wYWlubGVzc19lcnJvciIpOwoKdmFyIF9raWJhbmFfc2VydmljZXMgPSByZXF1aXJlKCIuLi8uLi9raWJhbmFfc2VydmljZXMiKTsKCnZhciBfYnJlYWRjcnVtYnMgPSByZXF1aXJlKCIuLi9oZWxwZXJzL2JyZWFkY3J1bWJzIik7Cgp2YXIgX3B1YmxpYyA9IHJlcXVpcmUoIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BsdWdpbnMvZGF0YS9wdWJsaWMiKTsKCnZhciBfZ2V0X2luZGV4X3BhdHRlcm5faWQgPSByZXF1aXJlKCIuLi9oZWxwZXJzL2dldF9pbmRleF9wYXR0ZXJuX2lkIik7Cgp2YXIgX3B1YmxpYzIgPSByZXF1aXJlKCIuLi8uLi8uLi8uLi8uLi9kYXRhL3B1YmxpYyIpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqKSB7IGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBlbHNlIHsgdmFyIG5ld09iaiA9IHt9OyBpZiAob2JqICE9IG51bGwpIHsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiB7fTsgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IH0gbmV3T2JqLmRlZmF1bHQgPSBvYmo7IHJldHVybiBuZXdPYmo7IH0gfQoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmZ1bmN0aW9uIF90b0NvbnN1bWFibGVBcnJheShhcnIpIHsgcmV0dXJuIF9hcnJheVdpdGhvdXRIb2xlcyhhcnIpIHx8IF9pdGVyYWJsZVRvQXJyYXkoYXJyKSB8fCBfbm9uSXRlcmFibGVTcHJlYWQoKTsgfQoKZnVuY3Rpb24gX25vbkl0ZXJhYmxlU3ByZWFkKCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gc3ByZWFkIG5vbi1pdGVyYWJsZSBpbnN0YW5jZSIpOyB9CgpmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5KGl0ZXIpIHsgaWYgKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoaXRlcikgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGl0ZXIpID09PSAiW29iamVjdCBBcmd1bWVudHNdIikgcmV0dXJuIEFycmF5LmZyb20oaXRlcik7IH0KCmZ1bmN0aW9uIF9hcnJheVdpdGhvdXRIb2xlcyhhcnIpIHsgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgeyBmb3IgKHZhciBpID0gMCwgYXJyMiA9IG5ldyBBcnJheShhcnIubGVuZ3RoKTsgaSA8IGFyci5sZW5ndGg7IGkrKykgeyBhcnIyW2ldID0gYXJyW2ldOyB9IHJldHVybiBhcnIyOyB9IH0KCmZ1bmN0aW9uIG93bktleXMob2JqZWN0LCBlbnVtZXJhYmxlT25seSkgeyB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iamVjdCk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBzeW1ib2xzID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpOyBpZiAoZW51bWVyYWJsZU9ubHkpIHN5bWJvbHMgPSBzeW1ib2xzLmZpbHRlcihmdW5jdGlvbiAoc3ltKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgc3ltKS5lbnVtZXJhYmxlOyB9KTsga2V5cy5wdXNoLmFwcGx5KGtleXMsIHN5bWJvbHMpOyB9IHJldHVybiBrZXlzOyB9CgpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTsgaWYgKGkgJSAyKSB7IG93bktleXMoc291cmNlLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgX2RlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzb3VyY2Vba2V5XSk7IH0pOyB9IGVsc2UgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoc291cmNlKSk7IH0gZWxzZSB7IG93bktleXMoc291cmNlKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNvdXJjZSwga2V5KSk7IH0pOyB9IH0gcmV0dXJuIHRhcmdldDsgfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KG9iaiwga2V5LCB2YWx1ZSkgeyBpZiAoa2V5IGluIG9iaikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsgdmFsdWU6IHZhbHVlLCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pOyB9IGVsc2UgeyBvYmpba2V5XSA9IHZhbHVlOyB9IHJldHVybiBvYmo7IH0KCnZhciBfZ2V0U2VydmljZXMgPSAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRTZXJ2aWNlcykoKSwKICAgIGNvcmUgPSBfZ2V0U2VydmljZXMuY29yZSwKICAgIGNocm9tZSA9IF9nZXRTZXJ2aWNlcy5jaHJvbWUsCiAgICBkYXRhID0gX2dldFNlcnZpY2VzLmRhdGEsCiAgICBkb2NUaXRsZSA9IF9nZXRTZXJ2aWNlcy5kb2NUaXRsZSwKICAgIGZpbHRlck1hbmFnZXIgPSBfZ2V0U2VydmljZXMuZmlsdGVyTWFuYWdlciwKICAgIHNoYXJlID0gX2dldFNlcnZpY2VzLnNoYXJlLAogICAgdGltZWZpbHRlciA9IF9nZXRTZXJ2aWNlcy50aW1lZmlsdGVyLAogICAgdG9hc3ROb3RpZmljYXRpb25zID0gX2dldFNlcnZpY2VzLnRvYXN0Tm90aWZpY2F0aW9ucywKICAgIHVpU2V0dGluZ3MgPSBfZ2V0U2VydmljZXMudWlTZXR0aW5nczsKCnZhciBnZXRTYXZlZFF1ZXJ5ID0gZGF0YS5xdWVyeS5zYXZlZFF1ZXJpZXMuZ2V0U2F2ZWRRdWVyeTsKdmFyIGZldGNoU3RhdHVzZXMgPSB7CiAgVU5JTklUSUFMSVpFRDogJ3VuaW5pdGlhbGl6ZWQnLAogIExPQURJTkc6ICdsb2FkaW5nJywKICBDT01QTEVURTogJ2NvbXBsZXRlJwp9Owp2YXIgYXBwID0gKDAsIF9raWJhbmFfc2VydmljZXMuZ2V0QW5ndWxhck1vZHVsZSkoKTsKYXBwLnJ1bihmdW5jdGlvbiAoZ2xvYmFsU3RhdGUsICRyb290U2NvcGUpIHsKICAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5yZWdpc3RlclRpbWVmaWx0ZXJXaXRoR2xvYmFsU3RhdGVGYWN0b3J5KSh0aW1lZmlsdGVyLCBnbG9iYWxTdGF0ZSwgJHJvb3RTY29wZSk7Cn0pOwphcHAuY29uZmlnKGZ1bmN0aW9uICgkcm91dGVQcm92aWRlcikgewogIHZhciBkZWZhdWx0cyA9IHsKICAgIHJlcXVpcmVEZWZhdWx0SW5kZXg6IHRydWUsCiAgICByZXF1aXJlVUlDYXBhYmlsaXR5OiAnZGlzY292ZXIuc2hvdycsCiAgICBrN0JyZWFkY3J1bWJzOiBmdW5jdGlvbiBrN0JyZWFkY3J1bWJzKCRyb3V0ZSwgJGluamVjdG9yKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaW52b2tlKCRyb3V0ZS5jdXJyZW50LnBhcmFtcy5pZCA/IF9icmVhZGNydW1icy5nZXRTYXZlZFNlYXJjaEJyZWFkY3J1bWJzIDogX2JyZWFkY3J1bWJzLmdldFJvb3RCcmVhZGNydW1icyk7CiAgICB9LAogICAgYmFkZ2U6IGZ1bmN0aW9uIGJhZGdlKHVpQ2FwYWJpbGl0aWVzKSB7CiAgICAgIGlmICh1aUNhcGFiaWxpdGllcy5kaXNjb3Zlci5zYXZlKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICB0ZXh0OiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJhZGdlLnJlYWRPbmx5LnRleHQnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1JlYWQgb25seScKICAgICAgICB9KSwKICAgICAgICB0b29sdGlwOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJhZGdlLnJlYWRPbmx5LnRvb2x0aXAnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1VuYWJsZSB0byBzYXZlIHNlYXJjaGVzJwogICAgICAgIH0pLAogICAgICAgIGljb25UeXBlOiAnZ2xhc3NlcycKICAgICAgfTsKICAgIH0KICB9OwogICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9kaXNjb3Zlci86aWQ/JywgX29iamVjdFNwcmVhZCh7fSwgZGVmYXVsdHMsIHsKICAgIHRlbXBsYXRlOiBfZGlzY292ZXIuZGVmYXVsdCwKICAgIHJlbG9hZE9uU2VhcmNoOiBmYWxzZSwKICAgIHJlc29sdmU6IHsKICAgICAgc2F2ZWRPYmplY3RzOiBmdW5jdGlvbiBzYXZlZE9iamVjdHMocmVkaXJlY3RXaGVuTWlzc2luZywgJHJvdXRlLCBrYm5VcmwsIFByb21pc2UsICRyb290U2NvcGUsIFN0YXRlKSB7CiAgICAgICAgdmFyIGluZGV4UGF0dGVybnMgPSAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRTZXJ2aWNlcykoKS5pbmRleFBhdHRlcm5zOwogICAgICAgIHZhciBzYXZlZFNlYXJjaElkID0gJHJvdXRlLmN1cnJlbnQucGFyYW1zLmlkOwogICAgICAgIHJldHVybiAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5lbnN1cmVEZWZhdWx0SW5kZXhQYXR0ZXJuKShjb3JlLCAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRTZXJ2aWNlcykoKS5kYXRhLCAkcm9vdFNjb3BlLCBrYm5VcmwpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucHJvcHMoewogICAgICAgICAgICBpcDogaW5kZXhQYXR0ZXJucy5nZXRDYWNoZSgpLnRoZW4oZnVuY3Rpb24gKGluZGV4UGF0dGVybkxpc3QpIHsKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiAgSW4gbWFraW5nIHRoZSBpbmRleFBhdHRlcm4gbW9kaWZpYWJsZSBpdCB3YXMgcGxhY2VkIGluIGFwcFN0YXRlLiBVbmZvcnR1bmF0ZWx5LAogICAgICAgICAgICAgICAqICB0aGUgbG9hZCBvcmRlciBvZiBBcHBTdGF0ZSBjb25mbGljdHMgd2l0aCB0aGUgbG9hZCBvcmRlciBvZiBtYW55IG90aGVyIHRoaW5ncwogICAgICAgICAgICAgICAqICBzbyBpbiBvcmRlciB0byBnZXQgdGhlIG5hbWUgb2YgdGhlIGluZGV4IHdlIHNob3VsZCB1c2UsIGFuZCB0byBzd2l0Y2ggdG8gdGhlCiAgICAgICAgICAgICAgICogIGRlZmF1bHQgaWYgbmVjZXNzYXJ5LCB3ZSBwYXJzZSB0aGUgYXBwU3RhdGUgd2l0aCBhIHRlbXBvcmFyeSBTdGF0ZSBvYmplY3QgYW5kCiAgICAgICAgICAgICAgICogIHRoZW4gZGVzdHJveSBpdCBpbW1lZGlhdGx5IGFmdGVyIHdlJ3JlIGRvbmUKICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqICBAdHlwZSB7U3RhdGV9CiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbmV3IFN0YXRlKCdfYScsIHt9KTsKICAgICAgICAgICAgICB2YXIgaWQgPSAoMCwgX2dldF9pbmRleF9wYXR0ZXJuX2lkLmdldEluZGV4UGF0dGVybklkKShzdGF0ZS5pbmRleCwgaW5kZXhQYXR0ZXJuTGlzdCwgdWlTZXR0aW5ncy5nZXQoJ2RlZmF1bHRJbmRleCcpKTsKICAgICAgICAgICAgICBzdGF0ZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucHJvcHMoewogICAgICAgICAgICAgICAgbGlzdDogaW5kZXhQYXR0ZXJuTGlzdCwKICAgICAgICAgICAgICAgIGxvYWRlZDogaW5kZXhQYXR0ZXJucy5nZXQoaWQpLAogICAgICAgICAgICAgICAgc3RhdGVWYWw6IHN0YXRlLmluZGV4LAogICAgICAgICAgICAgICAgc3RhdGVWYWxGb3VuZDogISFzdGF0ZS5pbmRleCAmJiBpZCA9PT0gc3RhdGUuaW5kZXgKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIHNhdmVkU2VhcmNoOiAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRTZXJ2aWNlcykoKS5nZXRTYXZlZFNlYXJjaEJ5SWQoc2F2ZWRTZWFyY2hJZCwga2JuVXJsKS50aGVuKGZ1bmN0aW9uIChzYXZlZFNlYXJjaCkgewogICAgICAgICAgICAgIGlmIChzYXZlZFNlYXJjaElkKSB7CiAgICAgICAgICAgICAgICBjaHJvbWUucmVjZW50bHlBY2Nlc3NlZC5hZGQoc2F2ZWRTZWFyY2guZ2V0RnVsbFBhdGgoKSwgc2F2ZWRTZWFyY2gudGl0bGUsIHNhdmVkU2VhcmNoSWQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIHNhdmVkU2VhcmNoOwogICAgICAgICAgICB9KS5jYXRjaChyZWRpcmVjdFdoZW5NaXNzaW5nKHsKICAgICAgICAgICAgICBzZWFyY2g6ICcvZGlzY292ZXInLAogICAgICAgICAgICAgICdpbmRleC1wYXR0ZXJuJzogJy9tYW5hZ2VtZW50L2tpYmFuYS9vYmplY3RzL3NhdmVkU2VhcmNoZXMvJyArICRyb3V0ZS5jdXJyZW50LnBhcmFtcy5pZAogICAgICAgICAgICB9KSkKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSkpOwp9KTsKYXBwLmRpcmVjdGl2ZSgnZGlzY292ZXJBcHAnLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb250cm9sbGVyQXM6ICdkaXNjb3ZlckFwcCcsCiAgICBjb250cm9sbGVyOiBkaXNjb3ZlckNvbnRyb2xsZXIKICB9Owp9KTsKCmZ1bmN0aW9uIGRpc2NvdmVyQ29udHJvbGxlcigkZWxlbWVudCwgJHJvdXRlLCAkc2NvcGUsICR0aW1lb3V0LCAkd2luZG93LCBBcHBTdGF0ZSwgUHJpdmF0ZSwgUHJvbWlzZSwgY29uZmlnLCBrYm5VcmwsIGxvY2FsU3RvcmFnZSwgdWlDYXBhYmlsaXRpZXMsIGdldEFwcFN0YXRlLCBnbG9iYWxTdGF0ZSkgewogIHZhciBfdGhpcyA9IHRoaXM7CgogIHZhciByZXNwb25zZUhhbmRsZXIgPSAoMCwgX2tpYmFuYV9zZXJ2aWNlcy52aXNsaWJTZXJpZXNSZXNwb25zZUhhbmRsZXJQcm92aWRlcikoKS5oYW5kbGVyOwogIHZhciBmaWx0ZXJTdGF0ZU1hbmFnZXIgPSBuZXcgX3B1YmxpYzIuRmlsdGVyU3RhdGVNYW5hZ2VyKGdsb2JhbFN0YXRlLCBnZXRBcHBTdGF0ZSwgZmlsdGVyTWFuYWdlcik7CiAgdmFyIGluc3BlY3RvckFkYXB0ZXJzID0gewogICAgcmVxdWVzdHM6IG5ldyBfa2liYW5hX3NlcnZpY2VzLlJlcXVlc3RBZGFwdGVyKCkKICB9OwogIHZhciBzdWJzY3JpcHRpb25zID0gbmV3IF9yeGpzLlN1YnNjcmlwdGlvbigpOwogIHRpbWVmaWx0ZXIuZGlzYWJsZVRpbWVSYW5nZVNlbGVjdG9yKCk7CiAgdGltZWZpbHRlci5kaXNhYmxlQXV0b1JlZnJlc2hTZWxlY3RvcigpOwoKICAkc2NvcGUudGltZWZpbHRlclVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbiAocmFuZ2VzKSB7CiAgICB0aW1lZmlsdGVyLnNldFRpbWUoewogICAgICBmcm9tOiAoMCwgX21vbWVudC5kZWZhdWx0KShyYW5nZXMuZnJvbSkudG9JU09TdHJpbmcoKSwKICAgICAgdG86ICgwLCBfbW9tZW50LmRlZmF1bHQpKHJhbmdlcy50bykudG9JU09TdHJpbmcoKSwKICAgICAgbW9kZTogJ2Fic29sdXRlJwogICAgfSk7CiAgfTsKCiAgJHNjb3BlLmludGVydmFsT3B0aW9ucyA9IF9raWJhbmFfc2VydmljZXMuaW50ZXJ2YWxPcHRpb25zOwogICRzY29wZS5zaG93SW50ZXJ2YWwgPSBmYWxzZTsKICAkc2NvcGUubWluaW11bVZpc2libGVSb3dzID0gNTA7CiAgJHNjb3BlLmZldGNoU3RhdHVzID0gZmV0Y2hTdGF0dXNlcy5VTklOSVRJQUxJWkVEOwogICRzY29wZS5yZWZyZXNoSW50ZXJ2YWwgPSB0aW1lZmlsdGVyLmdldFJlZnJlc2hJbnRlcnZhbCgpOwogICRzY29wZS5zaG93U2F2ZVF1ZXJ5ID0gdWlDYXBhYmlsaXRpZXMuZGlzY292ZXIuc2F2ZVF1ZXJ5OwogICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVpQ2FwYWJpbGl0aWVzLmRpc2NvdmVyLnNhdmVRdWVyeTsKICB9LCBmdW5jdGlvbiAobmV3Q2FwYWJpbGl0eSkgewogICAgJHNjb3BlLnNob3dTYXZlUXVlcnkgPSBuZXdDYXBhYmlsaXR5OwogIH0pOwoKICAkc2NvcGUuaW50ZXJ2YWxFbmFibGVkID0gZnVuY3Rpb24gKGludGVydmFsKSB7CiAgICByZXR1cm4gaW50ZXJ2YWwudmFsICE9PSAnY3VzdG9tJzsKICB9OyAvLyB0aGUgc2F2ZWQgc2F2ZWRTZWFyY2gKCgogIHZhciBzYXZlZFNlYXJjaCA9ICRyb3V0ZS5jdXJyZW50LmxvY2Fscy5zYXZlZE9iamVjdHMuc2F2ZWRTZWFyY2g7CiAgdmFyIGFib3J0Q29udHJvbGxlcjsKICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgIGlmIChhYm9ydENvbnRyb2xsZXIpIGFib3J0Q29udHJvbGxlci5hYm9ydCgpOwogICAgc2F2ZWRTZWFyY2guZGVzdHJveSgpOwogICAgc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpOwogICAgZmlsdGVyU3RhdGVNYW5hZ2VyLmRlc3Ryb3koKTsKICB9KTsKICB2YXIgJGFwcFN0YXR1cyA9ICRzY29wZS5hcHBTdGF0dXMgPSB0aGlzLmFwcFN0YXR1cyA9IHsKICAgIGRpcnR5OiAhc2F2ZWRTZWFyY2guaWQKICB9OwoKICB2YXIgZ2V0VG9wTmF2TGlua3MgPSBmdW5jdGlvbiBnZXRUb3BOYXZMaW5rcygpIHsKICAgIHZhciBuZXdTZWFyY2ggPSB7CiAgICAgIGlkOiAnbmV3JywKICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LmxvY2FsTWVudS5uZXdTZWFyY2hUaXRsZScsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ05ldycKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5uZXdTZWFyY2hEZXNjcmlwdGlvbicsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ05ldyBTZWFyY2gnCiAgICAgIH0pLAogICAgICBydW46IGZ1bmN0aW9uIHJ1bigpIHsKICAgICAgICAkc2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBrYm5VcmwuY2hhbmdlKCcvZGlzY292ZXInKTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgdGVzdElkOiAnZGlzY292ZXJOZXdCdXR0b24nCiAgICB9OwogICAgdmFyIHNhdmVTZWFyY2ggPSB7CiAgICAgIGlkOiAnc2F2ZScsCiAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5zYXZlVGl0bGUnLCB7CiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTYXZlJwogICAgICB9KSwKICAgICAgZGVzY3JpcHRpb246IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNhdmVTZWFyY2hEZXNjcmlwdGlvbicsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1NhdmUgU2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnZGlzY292ZXJTYXZlQnV0dG9uJywKICAgICAgcnVuOiBmdW5jdGlvbiBydW4oKSB7CiAgICAgICAgdmFyIG9uU2F2ZSwgc2F2ZU1vZGFsOwogICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gcnVuJChfY29udGV4dCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG9uU2F2ZSA9IGZ1bmN0aW9uIG9uU2F2ZShfcmVmKSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdUaXRsZSA9IF9yZWYubmV3VGl0bGUsCiAgICAgICAgICAgICAgICAgICAgICBuZXdDb3B5T25TYXZlID0gX3JlZi5uZXdDb3B5T25TYXZlLAogICAgICAgICAgICAgICAgICAgICAgaXNUaXRsZUR1cGxpY2F0ZUNvbmZpcm1lZCA9IF9yZWYuaXNUaXRsZUR1cGxpY2F0ZUNvbmZpcm1lZCwKICAgICAgICAgICAgICAgICAgICAgIG9uVGl0bGVEdXBsaWNhdGUgPSBfcmVmLm9uVGl0bGVEdXBsaWNhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGl0bGUgPSBzYXZlZFNlYXJjaC50aXRsZTsKICAgICAgICAgICAgICAgICAgc2F2ZWRTZWFyY2gudGl0bGUgPSBuZXdUaXRsZTsKICAgICAgICAgICAgICAgICAgc2F2ZWRTZWFyY2guY29weU9uU2F2ZSA9IG5ld0NvcHlPblNhdmU7CiAgICAgICAgICAgICAgICAgIHZhciBzYXZlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICBjb25maXJtT3ZlcndyaXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBpc1RpdGxlRHVwbGljYXRlQ29uZmlybWVkOiBpc1RpdGxlRHVwbGljYXRlQ29uZmlybWVkLAogICAgICAgICAgICAgICAgICAgIG9uVGl0bGVEdXBsaWNhdGU6IG9uVGl0bGVEdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHNhdmVEYXRhU291cmNlKHNhdmVPcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzYXZlIHdhc24ndCBzdWNjZXNzZnVsLCBwdXQgdGhlIG9yaWdpbmFsIHZhbHVlcyBiYWNrLgogICAgICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2UuaWQgfHwgcmVzcG9uc2UuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgIHNhdmVkU2VhcmNoLnRpdGxlID0gY3VycmVudFRpdGxlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc2F2ZU1vZGFsID0gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfa2liYW5hX3NlcnZpY2VzLlNhdmVkT2JqZWN0U2F2ZU1vZGFsLCB7CiAgICAgICAgICAgICAgICAgIG9uU2F2ZTogb25TYXZlLAogICAgICAgICAgICAgICAgICBvbkNsb3NlOiBmdW5jdGlvbiBvbkNsb3NlKCkge30sCiAgICAgICAgICAgICAgICAgIHRpdGxlOiBzYXZlZFNlYXJjaC50aXRsZSwKICAgICAgICAgICAgICAgICAgc2hvd0NvcHlPblNhdmU6IHNhdmVkU2VhcmNoLmlkID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgICBvYmplY3RUeXBlOiAic2VhcmNoIiwKICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNhdmVTYXZlU2VhcmNoRGVzY3JpcHRpb24nLCB7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTYXZlIHlvdXIgRGlzY292ZXIgc2VhcmNoIHNvIHlvdSBjYW4gdXNlIGl0IGluIHZpc3VhbGl6YXRpb25zIGFuZCBkYXNoYm9hcmRzJwogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5zaG93U2F2ZU1vZGFsKShzYXZlTW9kYWwpOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHZhciBvcGVuU2VhcmNoID0gewogICAgICBpZDogJ29wZW4nLAogICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUub3BlblRpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnT3BlbicKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5vcGVuU2F2ZWRTZWFyY2hEZXNjcmlwdGlvbicsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ09wZW4gU2F2ZWQgU2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnZGlzY292ZXJPcGVuQnV0dG9uJywKICAgICAgcnVuOiBmdW5jdGlvbiBydW4oKSB7CiAgICAgICAgKDAsIF9zaG93X29wZW5fc2VhcmNoX3BhbmVsLnNob3dPcGVuU2VhcmNoUGFuZWwpKHsKICAgICAgICAgIG1ha2VVcmw6IGZ1bmN0aW9uIG1ha2VVcmwoc2VhcmNoSWQpIHsKICAgICAgICAgICAgcmV0dXJuIGtiblVybC5ldmFsKCcjL2Rpc2NvdmVyL3t7aWR9fScsIHsKICAgICAgICAgICAgICBpZDogc2VhcmNoSWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgSTE4bkNvbnRleHQ6IGNvcmUuaTE4bi5Db250ZXh0CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgc2hhcmVTZWFyY2ggPSB7CiAgICAgIGlkOiAnc2hhcmUnLAogICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUuc2hhcmVUaXRsZScsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1NoYXJlJwogICAgICB9KSwKICAgICAgZGVzY3JpcHRpb246IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNoYXJlU2VhcmNoRGVzY3JpcHRpb24nLCB7CiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTaGFyZSBTZWFyY2gnCiAgICAgIH0pLAogICAgICB0ZXN0SWQ6ICdzaGFyZVRvcE5hdkJ1dHRvbicsCiAgICAgIHJ1bjogZnVuY3Rpb24gcnVuKGFuY2hvckVsZW1lbnQpIHsKICAgICAgICB2YXIgc2hhcmluZ0RhdGE7CiAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hc3luYyhmdW5jdGlvbiBydW4kKF9jb250ZXh0MikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcChfdGhpcy5nZXRTaGFyaW5nRGF0YSgpKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgc2hhcmluZ0RhdGEgPSBfY29udGV4dDIuc2VudDsKICAgICAgICAgICAgICAgIHNoYXJlLnRvZ2dsZVNoYXJlQ29udGV4dE1lbnUoewogICAgICAgICAgICAgICAgICBhbmNob3JFbGVtZW50OiBhbmNob3JFbGVtZW50LAogICAgICAgICAgICAgICAgICBhbGxvd0VtYmVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgYWxsb3dTaG9ydFVybDogdWlDYXBhYmlsaXRpZXMuZGlzY292ZXIuY3JlYXRlU2hvcnRVcmwsCiAgICAgICAgICAgICAgICAgIHNoYXJlYWJsZVVybDogKDAsIF9raWJhbmFfc2VydmljZXMudW5oYXNoVXJsKSh3aW5kb3cubG9jYXRpb24uaHJlZiksCiAgICAgICAgICAgICAgICAgIG9iamVjdElkOiBzYXZlZFNlYXJjaC5pZCwKICAgICAgICAgICAgICAgICAgb2JqZWN0VHlwZTogJ3NlYXJjaCcsCiAgICAgICAgICAgICAgICAgIHNoYXJpbmdEYXRhOiBfb2JqZWN0U3ByZWFkKHt9LCBzaGFyaW5nRGF0YSwgewogICAgICAgICAgICAgICAgICAgIHRpdGxlOiBzYXZlZFNlYXJjaC50aXRsZQogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgaXNEaXJ0eTogJGFwcFN0YXR1cy5kaXJ0eQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHZhciBpbnNwZWN0U2VhcmNoID0gewogICAgICBpZDogJ2luc3BlY3QnLAogICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUuaW5zcGVjdFRpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnSW5zcGVjdCcKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5vcGVuSW5zcGVjdG9yRm9yU2VhcmNoRGVzY3JpcHRpb24nLCB7CiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdPcGVuIEluc3BlY3RvciBmb3Igc2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnb3Blbkluc3BlY3RvckJ1dHRvbicsCiAgICAgIHJ1bjogZnVuY3Rpb24gcnVuKCkgewogICAgICAgICgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFNlcnZpY2VzKSgpLmluc3BlY3Rvci5vcGVuKGluc3BlY3RvckFkYXB0ZXJzLCB7CiAgICAgICAgICB0aXRsZTogc2F2ZWRTZWFyY2gudGl0bGUKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBbbmV3U2VhcmNoXS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KHVpQ2FwYWJpbGl0aWVzLmRpc2NvdmVyLnNhdmUgPyBbc2F2ZVNlYXJjaF0gOiBbXSksIFtvcGVuU2VhcmNoLCBzaGFyZVNlYXJjaCwgaW5zcGVjdFNlYXJjaF0pOwogIH07CgogICRzY29wZS50b3BOYXZNZW51ID0gZ2V0VG9wTmF2TGlua3MoKTsgLy8gdGhlIGFjdHVhbCBjb3VyaWVyLlNlYXJjaFNvdXJjZQoKICAkc2NvcGUuc2VhcmNoU291cmNlID0gc2F2ZWRTZWFyY2guc2VhcmNoU291cmNlOwogICRzY29wZS5pbmRleFBhdHRlcm4gPSByZXNvbHZlSW5kZXhQYXR0ZXJuTG9hZGluZygpOwogICRzY29wZS5zZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ2luZGV4JywgJHNjb3BlLmluZGV4UGF0dGVybikuc2V0RmllbGQoJ2hpZ2hsaWdodEFsbCcsIHRydWUpLnNldEZpZWxkKCd2ZXJzaW9uJywgdHJ1ZSk7IC8vIEV2ZW4gd2hlbiBzZWFyY2hpbmcgcm9sbHVwcywgd2Ugd2FudCB0byB1c2UgdGhlIGRlZmF1bHQgc3RyYXRlZ3kgc28gdGhhdCB3ZSBnZXQgYmFjayBhCiAgLy8gZG9jdW1lbnQtbGlrZSByZXNwb25zZS4KCiAgJHNjb3BlLnNlYXJjaFNvdXJjZS5zZXRQcmVmZXJyZWRTZWFyY2hTdHJhdGVneUlkKCdkZWZhdWx0Jyk7IC8vIHNlYXJjaFNvdXJjZSB3aGljaCBhcHBsaWVzIHRpbWUgcmFuZ2UKCiAgdmFyIHRpbWVSYW5nZVNlYXJjaFNvdXJjZSA9IHNhdmVkU2VhcmNoLnNlYXJjaFNvdXJjZS5jcmVhdGUoKTsKCiAgaWYgKCgwLCBfa2liYW5hX3NlcnZpY2VzLmlzRGVmYXVsdFR5cGVJbmRleFBhdHRlcm4pKCRzY29wZS5pbmRleFBhdHRlcm4pKSB7CiAgICB0aW1lUmFuZ2VTZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ2ZpbHRlcicsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRpbWVmaWx0ZXIuY3JlYXRlRmlsdGVyKCRzY29wZS5pbmRleFBhdHRlcm4pOwogICAgfSk7CiAgfQoKICAkc2NvcGUuc2VhcmNoU291cmNlLnNldFBhcmVudCh0aW1lUmFuZ2VTZWFyY2hTb3VyY2UpOwogIHZhciBwYWdlVGl0bGVTdWZmaXggPSBzYXZlZFNlYXJjaC5pZCAmJiBzYXZlZFNlYXJjaC50aXRsZSA/ICI6ICIuY29uY2F0KHNhdmVkU2VhcmNoLnRpdGxlKSA6ICcnOwogIGNocm9tZS5kb2NUaXRsZS5jaGFuZ2UoIkRpc2NvdmVyIi5jb25jYXQocGFnZVRpdGxlU3VmZml4KSk7CgogIHZhciBkaXNjb3ZlckJyZWFkY3J1bWJzVGl0bGUgPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmRpc2NvdmVyQnJlYWRjcnVtYlRpdGxlJywgewogICAgZGVmYXVsdE1lc3NhZ2U6ICdEaXNjb3ZlcicKICB9KTsKCiAgaWYgKHNhdmVkU2VhcmNoLmlkICYmIHNhdmVkU2VhcmNoLnRpdGxlKSB7CiAgICBjaHJvbWUuc2V0QnJlYWRjcnVtYnMoW3sKICAgICAgdGV4dDogZGlzY292ZXJCcmVhZGNydW1ic1RpdGxlLAogICAgICBocmVmOiAnIy9kaXNjb3ZlcicKICAgIH0sIHsKICAgICAgdGV4dDogc2F2ZWRTZWFyY2gudGl0bGUKICAgIH1dKTsKICB9IGVsc2UgewogICAgY2hyb21lLnNldEJyZWFkY3J1bWJzKFt7CiAgICAgIHRleHQ6IGRpc2NvdmVyQnJlYWRjcnVtYnNUaXRsZQogICAgfV0pOwogIH0KCiAgdmFyIHN0YXRlTW9uaXRvcjsKICB2YXIgJHN0YXRlID0gJHNjb3BlLnN0YXRlID0gbmV3IEFwcFN0YXRlKGdldFN0YXRlRGVmYXVsdHMoKSk7CiAgJHNjb3BlLmZpbHRlcnMgPSBmaWx0ZXJNYW5hZ2VyLmdldEZpbHRlcnMoKTsKICAkc2NvcGUuc2NyZWVuVGl0bGUgPSBzYXZlZFNlYXJjaC50aXRsZTsKCiAgJHNjb3BlLm9uRmlsdGVyc1VwZGF0ZWQgPSBmdW5jdGlvbiAoZmlsdGVycykgewogICAgLy8gVGhlIGZpbHRlcnMgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHNldCB3aGVuIHRoZSBmaWx0ZXJNYW5hZ2VyIGVtaXRzIGFuIHVwZGF0ZSBldmVudCAoc2VlIGJlbG93KQogICAgZmlsdGVyTWFuYWdlci5zZXRGaWx0ZXJzKGZpbHRlcnMpOwogIH07CgogIHZhciBnZXRGaWVsZENvdW50cyA9IGZ1bmN0aW9uIGdldEZpZWxkQ291bnRzKCkgewogICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hc3luYyhmdW5jdGlvbiBnZXRGaWVsZENvdW50cyQoX2NvbnRleHQzKSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGlmICghKCRzY29wZS5mZXRjaFN0YXR1cyA9PT0gZmV0Y2hTdGF0dXNlcy5DT01QTEVURSkpIHsKICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCAkc2NvcGUuZmllbGRDb3VudHMpOwoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSA0OwogICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgICAgdmFyIHVud2F0Y2ggPSAkc2NvcGUuJHdhdGNoKCdmZXRjaFN0YXR1cycsIGZ1bmN0aW9uIChuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlID09PSBmZXRjaFN0YXR1c2VzLkNPTVBMRVRFKSB7CiAgICAgICAgICAgICAgICAgIHVud2F0Y2goKTsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgkc2NvcGUuZmllbGRDb3VudHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSk7CgogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgX2NvbnRleHQzLnNlbnQpOwoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIGdldFNoYXJpbmdEYXRhRmllbGRzID0gZnVuY3Rpb24gZ2V0U2hhcmluZ0RhdGFGaWVsZHMoKSB7CiAgICB2YXIgc2VsZWN0ZWRGaWVsZHMsIGZpZWxkQ291bnRzLCB0aW1lRmllbGROYW1lLCBoaWRlVGltZUNvbHVtbiwgZmllbGRzOwogICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hc3luYyhmdW5jdGlvbiBnZXRTaGFyaW5nRGF0YUZpZWxkcyQoX2NvbnRleHQ0KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIHNlbGVjdGVkRmllbGRzID0gJHN0YXRlLmNvbHVtbnM7CgogICAgICAgICAgICBpZiAoIShzZWxlY3RlZEZpZWxkcy5sZW5ndGggPT09IDEgJiYgc2VsZWN0ZWRGaWVsZHNbMF0gPT09ICdfc291cmNlJykpIHsKICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDY7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNDsKICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcChnZXRGaWVsZENvdW50cygpKTsKCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIGZpZWxkQ291bnRzID0gX2NvbnRleHQ0LnNlbnQ7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgc2VhcmNoRmllbGRzOiBudWxsLAogICAgICAgICAgICAgIHNlbGVjdEZpZWxkczogX2xvZGFzaC5kZWZhdWx0LmtleXMoZmllbGRDb3VudHMpLnNvcnQoKQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIHRpbWVGaWVsZE5hbWUgPSAkc2NvcGUuaW5kZXhQYXR0ZXJuLnRpbWVGaWVsZE5hbWU7CiAgICAgICAgICAgIGhpZGVUaW1lQ29sdW1uID0gY29uZmlnLmdldCgnZG9jX3RhYmxlOmhpZGVUaW1lQ29sdW1uJyk7CiAgICAgICAgICAgIGZpZWxkcyA9IHRpbWVGaWVsZE5hbWUgJiYgIWhpZGVUaW1lQ29sdW1uID8gW3RpbWVGaWVsZE5hbWVdLmNvbmNhdChfdG9Db25zdW1hYmxlQXJyYXkoc2VsZWN0ZWRGaWVsZHMpKSA6IHNlbGVjdGVkRmllbGRzOwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgewogICAgICAgICAgICAgIHNlYXJjaEZpZWxkczogZmllbGRzLAogICAgICAgICAgICAgIHNlbGVjdEZpZWxkczogZmllbGRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CgogIHRoaXMuZ2V0U2hhcmluZ0RhdGEgPSBmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgdmFyIHNlYXJjaFNvdXJjZSwgX3JlZjIsIHNlYXJjaEZpZWxkcywgc2VsZWN0RmllbGRzLCBib2R5OwoKICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQ1KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDUucHJldiA9IF9jb250ZXh0NS5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZSA9ICRzY29wZS5zZWFyY2hTb3VyY2UuY3JlYXRlQ29weSgpOwogICAgICAgICAgICBfY29udGV4dDUubmV4dCA9IDM7CiAgICAgICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXdyYXAoZ2V0U2hhcmluZ0RhdGFGaWVsZHMoKSk7CgogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBfcmVmMiA9IF9jb250ZXh0NS5zZW50OwogICAgICAgICAgICBzZWFyY2hGaWVsZHMgPSBfcmVmMi5zZWFyY2hGaWVsZHM7CiAgICAgICAgICAgIHNlbGVjdEZpZWxkcyA9IF9yZWYyLnNlbGVjdEZpZWxkczsKICAgICAgICAgICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdmaWVsZHMnLCBzZWFyY2hGaWVsZHMpOwogICAgICAgICAgICBzZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ3NvcnQnLCAoMCwgX2dldF9zb3J0X2Zvcl9zZWFyY2hfc291cmNlLmdldFNvcnRGb3JTZWFyY2hTb3VyY2UpKCRzdGF0ZS5zb3J0LCAkc2NvcGUuaW5kZXhQYXR0ZXJuKSk7CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnaGlnaGxpZ2h0JywgbnVsbCk7CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnaGlnaGxpZ2h0QWxsJywgbnVsbCk7CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnYWdncycsIG51bGwpOwogICAgICAgICAgICBzZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ3NpemUnLCBudWxsKTsKICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAxNDsKICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcChzZWFyY2hTb3VyY2UuZ2V0U2VhcmNoUmVxdWVzdEJvZHkoKSk7CgogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgYm9keSA9IF9jb250ZXh0NS5zZW50OwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LmFicnVwdCgicmV0dXJuIiwgewogICAgICAgICAgICAgIHNlYXJjaFJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIGluZGV4OiBzZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ2luZGV4JykudGl0bGUsCiAgICAgICAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmaWVsZHM6IHNlbGVjdEZpZWxkcywKICAgICAgICAgICAgICBtZXRhRmllbGRzOiAkc2NvcGUuaW5kZXhQYXR0ZXJuLm1ldGFGaWVsZHMsCiAgICAgICAgICAgICAgY29uZmxpY3RlZFR5cGVzRmllbGRzOiAkc2NvcGUuaW5kZXhQYXR0ZXJuLmZpZWxkcy5maWx0ZXIoZnVuY3Rpb24gKGYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmLnR5cGUgPT09ICdjb25mbGljdCc7CiAgICAgICAgICAgICAgfSkubWFwKGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZi5uYW1lOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIGluZGV4UGF0dGVybklkOiBzZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ2luZGV4JykuaWQKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKCiAgJHNjb3BlLnVpU3RhdGUgPSAkc3RhdGUubWFrZVN0YXRlZnVsKCd1aVN0YXRlJyk7CgogIGZ1bmN0aW9uIGdldFN0YXRlRGVmYXVsdHMoKSB7CiAgICByZXR1cm4gewogICAgICBxdWVyeTogJHNjb3BlLnNhdmVkUXVlcnkgJiYgJHNjb3BlLnNhdmVkUXVlcnkuYXR0cmlidXRlcy5xdWVyeSB8fCAkc2NvcGUuc2VhcmNoU291cmNlLmdldEZpZWxkKCdxdWVyeScpIHx8IHsKICAgICAgICBxdWVyeTogJycsCiAgICAgICAgbGFuZ3VhZ2U6IGxvY2FsU3RvcmFnZS5nZXQoJ2tpYmFuYS51c2VyUXVlcnlMYW5ndWFnZScpIHx8IGNvbmZpZy5nZXQoJ3NlYXJjaDpxdWVyeUxhbmd1YWdlJykKICAgICAgfSwKICAgICAgc29ydDogX2dldF9zb3J0LmdldFNvcnQuYXJyYXkoc2F2ZWRTZWFyY2guc29ydCwgJHNjb3BlLmluZGV4UGF0dGVybiwgY29uZmlnLmdldCgnZGlzY292ZXI6c29ydDpkZWZhdWx0T3JkZXInKSksCiAgICAgIGNvbHVtbnM6IHNhdmVkU2VhcmNoLmNvbHVtbnMubGVuZ3RoID4gMCA/IHNhdmVkU2VhcmNoLmNvbHVtbnMgOiBjb25maWcuZ2V0KCdkZWZhdWx0Q29sdW1ucycpLnNsaWNlKCksCiAgICAgIGluZGV4OiAkc2NvcGUuaW5kZXhQYXR0ZXJuLmlkLAogICAgICBpbnRlcnZhbDogJ2F1dG8nLAogICAgICBmaWx0ZXJzOiAkc2NvcGUuc2F2ZWRRdWVyeSAmJiAkc2NvcGUuc2F2ZWRRdWVyeS5hdHRyaWJ1dGVzLmZpbHRlcnMgfHwgX2xvZGFzaC5kZWZhdWx0LmNsb25lRGVlcCgkc2NvcGUuc2VhcmNoU291cmNlLmdldE93bkZpZWxkKCdmaWx0ZXInKSkKICAgIH07CiAgfQoKICAkc3RhdGUuaW5kZXggPSAkc2NvcGUuaW5kZXhQYXR0ZXJuLmlkOwogICRzdGF0ZS5zb3J0ID0gX2dldF9zb3J0LmdldFNvcnQuYXJyYXkoJHN0YXRlLnNvcnQsICRzY29wZS5pbmRleFBhdHRlcm4pOwoKICAkc2NvcGUuZ2V0QnVja2V0SW50ZXJ2YWxUb29sVGlwVGV4dCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJ1Y2tldEludGVydmFsVG9vbHRpcCcsIHsKICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdUaGlzIGludGVydmFsIGNyZWF0ZXMge2J1Y2tldHNEZXNjcmlwdGlvbn0gdG8gc2hvdyBpbiB0aGUgc2VsZWN0ZWQgdGltZSByYW5nZSwgc28gaXQgaGFzIGJlZW4gc2NhbGVkIHRvIHtidWNrZXRJbnRlcnZhbERlc2NyaXB0aW9ufScsCiAgICAgIHZhbHVlczogewogICAgICAgIGJ1Y2tldHNEZXNjcmlwdGlvbjogJHNjb3BlLmJ1Y2tldEludGVydmFsLnNjYWxlID4gMSA/IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuYnVja2V0SW50ZXJ2YWxUb29sdGlwLnRvb0xhcmdlQnVja2V0c1RleHQnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ2J1Y2tldHMgdGhhdCBhcmUgdG9vIGxhcmdlJwogICAgICAgIH0pIDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5idWNrZXRJbnRlcnZhbFRvb2x0aXAudG9vTWFueUJ1Y2tldHNUZXh0JywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICd0b28gbWFueSBidWNrZXRzJwogICAgICAgIH0pLAogICAgICAgIGJ1Y2tldEludGVydmFsRGVzY3JpcHRpb246ICRzY29wZS5idWNrZXRJbnRlcnZhbC5kZXNjcmlwdGlvbgogICAgICB9CiAgICB9KTsKICB9OwoKICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbignc3RhdGUuY29sdW1ucycsIGZ1bmN0aW9uICgpIHsKICAgICRzdGF0ZS5zYXZlKCk7CiAgfSk7CiAgJHNjb3BlLm9wdHMgPSB7CiAgICAvLyBudW1iZXIgb2YgcmVjb3JkcyB0byBmZXRjaCwgdGhlbiBwYWdpbmF0ZSB0aHJvdWdoCiAgICBzYW1wbGVTaXplOiBjb25maWcuZ2V0KCdkaXNjb3ZlcjpzYW1wbGVTaXplJyksCiAgICB0aW1lZmllbGQ6ICgwLCBfa2liYW5hX3NlcnZpY2VzLmlzRGVmYXVsdFR5cGVJbmRleFBhdHRlcm4pKCRzY29wZS5pbmRleFBhdHRlcm4pICYmICRzY29wZS5pbmRleFBhdHRlcm4udGltZUZpZWxkTmFtZSwKICAgIHNhdmVkU2VhcmNoOiBzYXZlZFNlYXJjaCwKICAgIGluZGV4UGF0dGVybkxpc3Q6ICRyb3V0ZS5jdXJyZW50LmxvY2Fscy5zYXZlZE9iamVjdHMuaXAubGlzdAogIH07CgogIHZhciBzaG91bGRTZWFyY2hPblBhZ2VMb2FkID0gZnVuY3Rpb24gc2hvdWxkU2VhcmNoT25QYWdlTG9hZCgpIHsKICAgIC8vIElmIGEgc2F2ZWQgcXVlcnkgaXMgcmVmZXJlbmNlZCBpbiB0aGUgYXBwIHN0YXRlLCBvbWl0IHRoZSBpbml0aWFsIGxvYWQgYmVjYXVzZSB0aGUgc2F2ZWQgcXVlcnkgd2lsbAogICAgLy8gYmUgZmV0Y2hlZCBzZXBhcmF0ZWx5IGFuZCB0cmlnZ2VyIGEgcmVsb2FkCiAgICBpZiAoJHNjb3BlLnN0YXRlLnNhdmVkUXVlcnkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSAvLyBBIHNhdmVkIHNlYXJjaCBpcyBjcmVhdGVkIG9uIGV2ZXJ5IHBhZ2UgbG9hZCwgc28gd2UgY2hlY2sgdGhlIElEIHRvIHNlZSBpZiB3ZSdyZSBsb2FkaW5nIGEKICAgIC8vIHByZXZpb3VzbHkgc2F2ZWQgc2VhcmNoIG9yIGlmIGl0IGlzIGp1c3QgdHJhbnNpZW50CgoKICAgIHJldHVybiBjb25maWcuZ2V0KCdkaXNjb3ZlcjpzZWFyY2hPblBhZ2VMb2FkJykgfHwgc2F2ZWRTZWFyY2guaWQgIT09IHVuZGVmaW5lZCB8fCBfbG9kYXNoLmRlZmF1bHQuZ2V0KCRzY29wZSwgJ3JlZnJlc2hJbnRlcnZhbC5wYXVzZScpID09PSBmYWxzZTsKICB9OwoKICB2YXIgaW5pdCA9IF9sb2Rhc2guZGVmYXVsdC5vbmNlKGZ1bmN0aW9uICgpIHsKICAgIHN0YXRlTW9uaXRvciA9IF9raWJhbmFfc2VydmljZXMuc3RhdGVNb25pdG9yRmFjdG9yeS5jcmVhdGUoJHN0YXRlLCBnZXRTdGF0ZURlZmF1bHRzKCkpOwogICAgc3RhdGVNb25pdG9yLm9uQ2hhbmdlKGZ1bmN0aW9uIChzdGF0dXMpIHsKICAgICAgJGFwcFN0YXR1cy5kaXJ0eSA9IHN0YXR1cy5kaXJ0eSB8fCAhc2F2ZWRTZWFyY2guaWQ7CiAgICB9KTsKICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc3RhdGVNb25pdG9yLmRlc3Ryb3koKTsKICAgIH0pOwogICAgJHNjb3BlLnVwZGF0ZURhdGFTb3VyY2UoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgc3Vic2NyaXB0aW9ucy5hZGQoKDAsIF9raWJhbmFfc2VydmljZXMuc3Vic2NyaWJlV2l0aFNjb3BlKSgkc2NvcGUsIHRpbWVmaWx0ZXIuZ2V0QXV0b1JlZnJlc2hGZXRjaCQoKSwgewogICAgICAgIG5leHQ6ICRzY29wZS5mZXRjaAogICAgICB9KSk7CiAgICAgIHN1YnNjcmlwdGlvbnMuYWRkKCgwLCBfa2liYW5hX3NlcnZpY2VzLnN1YnNjcmliZVdpdGhTY29wZSkoJHNjb3BlLCB0aW1lZmlsdGVyLmdldFJlZnJlc2hJbnRlcnZhbFVwZGF0ZSQoKSwgewogICAgICAgIG5leHQ6ICRzY29wZS51cGRhdGVSZWZyZXNoSW50ZXJ2YWwKICAgICAgfSkpOwogICAgICBzdWJzY3JpcHRpb25zLmFkZCgoMCwgX2tpYmFuYV9zZXJ2aWNlcy5zdWJzY3JpYmVXaXRoU2NvcGUpKCRzY29wZSwgdGltZWZpbHRlci5nZXRUaW1lVXBkYXRlJCgpLCB7CiAgICAgICAgbmV4dDogJHNjb3BlLnVwZGF0ZVRpbWUKICAgICAgfSkpOwogICAgICBzdWJzY3JpcHRpb25zLmFkZCgoMCwgX2tpYmFuYV9zZXJ2aWNlcy5zdWJzY3JpYmVXaXRoU2NvcGUpKCRzY29wZSwgdGltZWZpbHRlci5nZXRGZXRjaCQoKSwgewogICAgICAgIG5leHQ6ICRzY29wZS5mZXRjaAogICAgICB9KSk7CiAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCdzdGF0ZS5zb3J0JywgZnVuY3Rpb24gKHNvcnQpIHsKICAgICAgICBpZiAoIXNvcnQpIHJldHVybjsgLy8gZ2V0IHRoZSBjdXJyZW50IHNvcnQgZnJvbSBzZWFyY2hTb3VyY2UgYXMgYXJyYXkgb2YgYXJyYXlzCgogICAgICAgIHZhciBjdXJyZW50U29ydCA9IF9nZXRfc29ydC5nZXRTb3J0LmFycmF5KCRzY29wZS5zZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ3NvcnQnKSwgJHNjb3BlLmluZGV4UGF0dGVybik7IC8vIGlmIHRoZSBzZWFyY2hTb3VyY2UgZG9lc24ndCBrbm93LCB0ZWxsIGl0IHNvCgoKICAgICAgICBpZiAoIV9raWJhbmFfc2VydmljZXMuYW5ndWxhci5lcXVhbHMoc29ydCwgY3VycmVudFNvcnQpKSAkc2NvcGUuZmV0Y2goKTsKICAgICAgfSk7IC8vIHVwZGF0ZSBkYXRhIHNvdXJjZSB3aGVuIGZpbHRlcnMgdXBkYXRlCgogICAgICBzdWJzY3JpcHRpb25zLmFkZCgoMCwgX2tpYmFuYV9zZXJ2aWNlcy5zdWJzY3JpYmVXaXRoU2NvcGUpKCRzY29wZSwgZmlsdGVyTWFuYWdlci5nZXRVcGRhdGVzJCgpLCB7CiAgICAgICAgbmV4dDogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICRzY29wZS5maWx0ZXJzID0gZmlsdGVyTWFuYWdlci5nZXRGaWx0ZXJzKCk7CiAgICAgICAgICAkc2NvcGUudXBkYXRlRGF0YVNvdXJjZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAkc3RhdGUuc2F2ZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KSk7IC8vIGZldGNoIGRhdGEgd2hlbiBmaWx0ZXJzIGZpcmUgZmV0Y2ggZXZlbnQKCiAgICAgIHN1YnNjcmlwdGlvbnMuYWRkKCgwLCBfa2liYW5hX3NlcnZpY2VzLnN1YnNjcmliZVdpdGhTY29wZSkoJHNjb3BlLCBmaWx0ZXJNYW5hZ2VyLmdldEZldGNoZXMkKCksIHsKICAgICAgICBuZXh0OiAkc2NvcGUuZmV0Y2gKICAgICAgfSkpOyAvLyB1cGRhdGUgZGF0YSBzb3VyY2Ugd2hlbiBoaXR0aW5nIGZvcndhcmQvYmFjayBhbmQgdGhlIHF1ZXJ5IGNoYW5nZXMKCiAgICAgICRzY29wZS4kbGlzdGVuKCRzdGF0ZSwgJ2ZldGNoX3dpdGhfY2hhbmdlcycsIGZ1bmN0aW9uIChkaWZmKSB7CiAgICAgICAgaWYgKGRpZmYuaW5kZXhPZigncXVlcnknKSA+PSAwKSAkc2NvcGUuZmV0Y2goKTsKICAgICAgfSk7CiAgICAgICRzY29wZS4kd2F0Y2goJ29wdHMudGltZWZpZWxkJywgZnVuY3Rpb24gKHRpbWVmaWVsZCkgewogICAgICAgICRzY29wZS5lbmFibGVUaW1lUmFuZ2VTZWxlY3RvciA9ICEhdGltZWZpZWxkOwogICAgICB9KTsKICAgICAgJHNjb3BlLiR3YXRjaCgnc3RhdGUuaW50ZXJ2YWwnLCBmdW5jdGlvbiAobmV3SW50ZXJ2YWwsIG9sZEludGVydmFsKSB7CiAgICAgICAgaWYgKG5ld0ludGVydmFsICE9PSBvbGRJbnRlcnZhbCkgewogICAgICAgICAgJHNjb3BlLmZldGNoKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgJHNjb3BlLiR3YXRjaCgndmlzLmFnZ3MnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gbm8gdGltZWZpZWxkLCBubyB2aXMsIG5vdGhpbmcgdG8gdXBkYXRlCiAgICAgICAgaWYgKCEkc2NvcGUub3B0cy50aW1lZmllbGQpIHJldHVybjsKICAgICAgICB2YXIgYnVja2V0cyA9ICRzY29wZS52aXMuZ2V0QWdnQ29uZmlnKCkuYnlTY2hlbWFHcm91cCgnYnVja2V0cycpOwoKICAgICAgICBpZiAoYnVja2V0cyAmJiBidWNrZXRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgJHNjb3BlLmJ1Y2tldEludGVydmFsID0gYnVja2V0c1swXS5idWNrZXRzLmdldEludGVydmFsKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgJHNjb3BlLiR3YXRjaCgnc3RhdGUucXVlcnknLCBmdW5jdGlvbiAobmV3UXVlcnksIG9sZFF1ZXJ5KSB7CiAgICAgICAgaWYgKCFfbG9kYXNoLmRlZmF1bHQuaXNFcXVhbChuZXdRdWVyeSwgb2xkUXVlcnkpKSB7CiAgICAgICAgICB2YXIgcXVlcnkgPSAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5taWdyYXRlTGVnYWN5UXVlcnkpKG5ld1F1ZXJ5KTsKCiAgICAgICAgICBpZiAoIV9sb2Rhc2guZGVmYXVsdC5pc0VxdWFsKHF1ZXJ5LCBuZXdRdWVyeSkpIHsKICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZVF1ZXJ5QW5kRmV0Y2goewogICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICAkc2NvcGUuJHdhdGNoTXVsdGkoWydyb3dzJywgJ2ZldGNoU3RhdHVzJ10sIGZ1bmN0aW9uIHVwZGF0ZVJlc3VsdFN0YXRlKCkgewogICAgICAgIHZhciBwcmV2ID0ge307CiAgICAgICAgdmFyIHN0YXR1cyA9IHsKICAgICAgICAgIFVOSU5JVElBTElaRUQ6ICd1bmluaXRpYWxpemVkJywKICAgICAgICAgIExPQURJTkc6ICdsb2FkaW5nJywKICAgICAgICAgIC8vIGluaXRpYWwgZGF0YSBsb2FkCiAgICAgICAgICBSRUFEWTogJ3JlYWR5JywKICAgICAgICAgIC8vIHJlc3VsdHMgY2FtZSBiYWNrCiAgICAgICAgICBOT19SRVNVTFRTOiAnbm9uZScgLy8gbm8gcmVzdWx0cyBjYW1lIGJhY2sKCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gcGljayhyb3dzLCBvbGRSb3dzLCBmZXRjaFN0YXR1cykgewogICAgICAgICAgLy8gaW5pdGlhbCBzdGF0ZSwgcHJldGVuZCB3ZSdyZSBhbHJlYWR5IGxvYWRpbmcgaWYgd2UncmUgYWJvdXQgdG8gZXhlY3V0ZSBhIHNlYXJjaCBzbwogICAgICAgICAgLy8gdGhhdCB0aGUgdW5pbml0aWxpemVkIG1lc3NhZ2UgZG9lc24ndCBmbGFzaCBvbiBzY3JlZW4KICAgICAgICAgIGlmIChyb3dzID09IG51bGwgJiYgb2xkUm93cyA9PSBudWxsICYmIHNob3VsZFNlYXJjaE9uUGFnZUxvYWQoKSkgewogICAgICAgICAgICByZXR1cm4gc3RhdHVzLkxPQURJTkc7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZldGNoU3RhdHVzID09PSBmZXRjaFN0YXR1c2VzLlVOSU5JVElBTElaRUQpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXR1cy5VTklOSVRJQUxJWkVEOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciByb3dzRW1wdHkgPSBfbG9kYXNoLmRlZmF1bHQuaXNFbXB0eShyb3dzKTsKCiAgICAgICAgICBpZiAocm93c0VtcHR5ICYmIGZldGNoU3RhdHVzID09PSBmZXRjaFN0YXR1c2VzLkxPQURJTkcpIHJldHVybiBzdGF0dXMuTE9BRElORztlbHNlIGlmICghcm93c0VtcHR5KSByZXR1cm4gc3RhdHVzLlJFQURZO2Vsc2UgcmV0dXJuIHN0YXR1cy5OT19SRVNVTFRTOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gewogICAgICAgICAgICByb3dzOiAkc2NvcGUucm93cywKICAgICAgICAgICAgZmV0Y2hTdGF0dXM6ICRzY29wZS5mZXRjaFN0YXR1cwogICAgICAgICAgfTsKICAgICAgICAgICRzY29wZS5yZXN1bHRTdGF0ZSA9IHBpY2soY3VycmVudC5yb3dzLCBwcmV2LnJvd3MsIGN1cnJlbnQuZmV0Y2hTdGF0dXMsIHByZXYuZmV0Y2hTdGF0dXMpOwogICAgICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgICAgfTsKICAgICAgfSgpKTsKCiAgICAgIGlmICgkc2NvcGUub3B0cy50aW1lZmllbGQpIHsKICAgICAgICBzZXR1cFZpc3VhbGl6YXRpb24oKTsKICAgICAgICAkc2NvcGUudXBkYXRlVGltZSgpOwogICAgICB9CgogICAgICBpbml0LmNvbXBsZXRlID0gdHJ1ZTsKICAgICAgJHN0YXRlLnJlcGxhY2UoKTsKCiAgICAgIGlmIChzaG91bGRTZWFyY2hPblBhZ2VMb2FkKCkpIHsKICAgICAgICAkc2NvcGUuZmV0Y2goKTsKICAgICAgfQogICAgfSk7CiAgfSk7CgogIGZ1bmN0aW9uIHNhdmVEYXRhU291cmNlKHNhdmVPcHRpb25zKSB7CiAgICB2YXIgaWQ7CiAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIHNhdmVEYXRhU291cmNlJChfY29udGV4dDYpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ni5wcmV2ID0gX2NvbnRleHQ2Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAyOwogICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKCRzY29wZS51cGRhdGVEYXRhU291cmNlKCkpOwoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc2F2ZWRTZWFyY2guY29sdW1ucyA9ICRzY29wZS5zdGF0ZS5jb2x1bW5zOwogICAgICAgICAgICBzYXZlZFNlYXJjaC5zb3J0ID0gJHNjb3BlLnN0YXRlLnNvcnQ7CiAgICAgICAgICAgIF9jb250ZXh0Ni5wcmV2ID0gNDsKICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSA3OwogICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKHNhdmVkU2VhcmNoLnNhdmUoc2F2ZU9wdGlvbnMpKTsKCiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGlkID0gX2NvbnRleHQ2LnNlbnQ7CiAgICAgICAgICAgICRzY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBzdGF0ZU1vbml0b3Iuc2V0SW5pdGlhbFN0YXRlKCRzdGF0ZS50b0pTT04oKSk7CgogICAgICAgICAgICAgIGlmIChpZCkgewogICAgICAgICAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoewogICAgICAgICAgICAgICAgICB0aXRsZTogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5ub3RpZmljYXRpb25zLnNhdmVkU2VhcmNoVGl0bGUnLCB7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICJTZWFyY2ggJ3tzYXZlZFNlYXJjaFRpdGxlfScgd2FzIHNhdmVkIiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgICAgICAgICAgIHNhdmVkU2VhcmNoVGl0bGU6IHNhdmVkU2VhcmNoLnRpdGxlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgJ2RhdGEtdGVzdC1zdWJqJzogJ3NhdmVTZWFyY2hTdWNjZXNzJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKHNhdmVkU2VhcmNoLmlkICE9PSAkcm91dGUuY3VycmVudC5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgICAga2JuVXJsLmNoYW5nZSgnL2Rpc2NvdmVyL3t7aWR9fScsIHsKICAgICAgICAgICAgICAgICAgICBpZDogc2F2ZWRTZWFyY2guaWQKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgZGVmYXVsdHMgc28gdGhhdCAicmVsb2FkIHNhdmVkIHF1ZXJ5IiBmdW5jdGlvbnMgY29ycmVjdGx5CiAgICAgICAgICAgICAgICAgICRzdGF0ZS5zZXREZWZhdWx0cyhnZXRTdGF0ZURlZmF1bHRzKCkpOwogICAgICAgICAgICAgICAgICBkb2NUaXRsZS5jaGFuZ2Uoc2F2ZWRTZWFyY2gubGFzdFNhdmVkVGl0bGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgaWQ6IGlkCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgIF9jb250ZXh0Ni5wcmV2ID0gMTI7CiAgICAgICAgICAgIF9jb250ZXh0Ni50MCA9IF9jb250ZXh0NlsiY2F0Y2giXSg0KTsKICAgICAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZERhbmdlcih7CiAgICAgICAgICAgICAgdGl0bGU6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubm90aWZpY2F0aW9ucy5ub3RTYXZlZFNlYXJjaFRpdGxlJywgewogICAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICJTZWFyY2ggJ3tzYXZlZFNlYXJjaFRpdGxlfScgd2FzIG5vdCBzYXZlZC4iLAogICAgICAgICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgICAgICAgIHNhdmVkU2VhcmNoVGl0bGU6IHNhdmVkU2VhcmNoLnRpdGxlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgdGV4dDogX2NvbnRleHQ2LnQwLm1lc3NhZ2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgZXJyb3I6IF9jb250ZXh0Ni50MAogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBudWxsLCBudWxsLCBbWzQsIDEyXV0pOwogIH0KCiAgJHNjb3BlLm9wdHMuZmV0Y2ggPSAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBpZ25vcmUgcmVxdWVzdHMgdG8gZmV0Y2ggYmVmb3JlIHRoZSBhcHAgaW5pdHMKICAgIGlmICghaW5pdC5jb21wbGV0ZSkgcmV0dXJuOwogICAgJHNjb3BlLmZldGNoRXJyb3IgPSB1bmRlZmluZWQ7CiAgICAkc2NvcGUudXBkYXRlVGltZSgpOyAvLyBBYm9ydCBhbnkgaW4tcHJvZ3Jlc3MgcmVxdWVzdHMgYmVmb3JlIGZldGNoaW5nIGFnYWluCgogICAgaWYgKGFib3J0Q29udHJvbGxlcikgYWJvcnRDb250cm9sbGVyLmFib3J0KCk7CiAgICBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAkc2NvcGUudXBkYXRlRGF0YVNvdXJjZSgpLnRoZW4oc2V0dXBWaXN1YWxpemF0aW9uKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgJHN0YXRlLnNhdmUoKTsKICAgICAgJHNjb3BlLmZldGNoU3RhdHVzID0gZmV0Y2hTdGF0dXNlcy5MT0FESU5HOwogICAgICBsb2dJbnNwZWN0b3JSZXF1ZXN0KCk7CiAgICAgIHJldHVybiAkc2NvcGUuc2VhcmNoU291cmNlLmZldGNoKHsKICAgICAgICBhYm9ydFNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbAogICAgICB9KTsKICAgIH0pLnRoZW4ob25SZXN1bHRzKS5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgLy8gSWYgdGhlIHJlcXVlc3Qgd2FzIGFib3J0ZWQgdGhlbiBubyBuZWVkIHRvIHN1cmZhY2UgdGhpcyBlcnJvciBpbiB0aGUgVUkKICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubmFtZSA9PT0gJ0Fib3J0RXJyb3InKSByZXR1cm47CiAgICAgIHZhciBmZXRjaEVycm9yID0gKDAsIF9nZXRfcGFpbmxlc3NfZXJyb3IuZ2V0UGFpbmxlc3NFcnJvcikoZXJyb3IpOwoKICAgICAgaWYgKGZldGNoRXJyb3IpIHsKICAgICAgICAkc2NvcGUuZmV0Y2hFcnJvciA9IGZldGNoRXJyb3I7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZEVycm9yKGVycm9yLCB7CiAgICAgICAgICB0aXRsZTogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5lcnJvckxvYWRpbmdEYXRhJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0Vycm9yIGxvYWRpbmcgZGF0YScKICAgICAgICAgIH0pLAogICAgICAgICAgdG9hc3RNZXNzYWdlOiBlcnJvci5zaG9ydE1lc3NhZ2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgJHNjb3BlLnVwZGF0ZVF1ZXJ5QW5kRmV0Y2ggPSBmdW5jdGlvbiAoX3JlZjMpIHsKICAgIHZhciBxdWVyeSA9IF9yZWYzLnF1ZXJ5LAogICAgICAgIGRhdGVSYW5nZSA9IF9yZWYzLmRhdGVSYW5nZTsKICAgIHRpbWVmaWx0ZXIuc2V0VGltZShkYXRlUmFuZ2UpOwogICAgJHN0YXRlLnF1ZXJ5ID0gcXVlcnk7CiAgICAkc2NvcGUuZmV0Y2goKTsKICB9OwoKICBmdW5jdGlvbiBvblJlc3VsdHMocmVzcCkgewogICAgbG9nSW5zcGVjdG9yUmVzcG9uc2UocmVzcCk7CgogICAgaWYgKCRzY29wZS5vcHRzLnRpbWVmaWVsZCkgewogICAgICB2YXIgdGFiaWZpZWREYXRhID0gKDAsIF9raWJhbmFfc2VydmljZXMudGFiaWZ5QWdnUmVzcG9uc2UpKCRzY29wZS52aXMuYWdncywgcmVzcCk7CiAgICAgICRzY29wZS5zZWFyY2hTb3VyY2UucmF3UmVzcG9uc2UgPSByZXNwOwogICAgICBQcm9taXNlLnJlc29sdmUoKDAsIF9raWJhbmFfc2VydmljZXMuYnVpbGRWaXNsaWJEaW1lbnNpb25zKSgkc2NvcGUudmlzLCB7CiAgICAgICAgdGltZVJhbmdlOiAkc2NvcGUudGltZVJhbmdlLAogICAgICAgIHNlYXJjaFNvdXJjZTogJHNjb3BlLnNlYXJjaFNvdXJjZQogICAgICB9KSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgIHJldHVybiByZXNwb25zZUhhbmRsZXIodGFiaWZpZWREYXRhLCByZXNwKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICRzY29wZS5oaXN0b2dyYW1EYXRhID0gcmVzcDsKICAgICAgfSk7CiAgICB9CgogICAgJHNjb3BlLmhpdHMgPSByZXNwLmhpdHMudG90YWw7CiAgICAkc2NvcGUucm93cyA9IHJlc3AuaGl0cy5oaXRzOyAvLyBpZiB3ZSBoYXZlbid0IGNvdW50ZWQgeWV0LCByZXNldCB0aGUgY291bnRzCgogICAgdmFyIGNvdW50cyA9ICRzY29wZS5maWVsZENvdW50cyA9ICRzY29wZS5maWVsZENvdW50cyB8fCB7fTsKICAgICRzY29wZS5yb3dzLmZvckVhY2goZnVuY3Rpb24gKGhpdCkgewogICAgICB2YXIgZmllbGRzID0gT2JqZWN0LmtleXMoJHNjb3BlLmluZGV4UGF0dGVybi5mbGF0dGVuSGl0KGhpdCkpOwogICAgICBmaWVsZHMuZm9yRWFjaChmdW5jdGlvbiAoZmllbGROYW1lKSB7CiAgICAgICAgY291bnRzW2ZpZWxkTmFtZV0gPSAoY291bnRzW2ZpZWxkTmFtZV0gfHwgMCkgKyAxOwogICAgICB9KTsKICAgIH0pOwogICAgJHNjb3BlLmZldGNoU3RhdHVzID0gZmV0Y2hTdGF0dXNlcy5DT01QTEVURTsKICB9CgogIHZhciBpbnNwZWN0b3JSZXF1ZXN0OwoKICBmdW5jdGlvbiBsb2dJbnNwZWN0b3JSZXF1ZXN0KCkgewogICAgaW5zcGVjdG9yQWRhcHRlcnMucmVxdWVzdHMucmVzZXQoKTsKCiAgICB2YXIgdGl0bGUgPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmluc3BlY3RvclJlcXVlc3REYXRhVGl0bGUnLCB7CiAgICAgIGRlZmF1bHRNZXNzYWdlOiAnZGF0YScKICAgIH0pOwoKICAgIHZhciBkZXNjcmlwdGlvbiA9IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuaW5zcGVjdG9yUmVxdWVzdERlc2NyaXB0aW9uJywgewogICAgICBkZWZhdWx0TWVzc2FnZTogJ1RoaXMgcmVxdWVzdCBxdWVyaWVzIEVsYXN0aWNzZWFyY2ggdG8gZmV0Y2ggdGhlIGRhdGEgZm9yIHRoZSBzZWFyY2guJwogICAgfSk7CgogICAgaW5zcGVjdG9yUmVxdWVzdCA9IGluc3BlY3RvckFkYXB0ZXJzLnJlcXVlc3RzLnN0YXJ0KHRpdGxlLCB7CiAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbgogICAgfSk7CiAgICBpbnNwZWN0b3JSZXF1ZXN0LnN0YXRzKCgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFJlcXVlc3RJbnNwZWN0b3JTdGF0cykoJHNjb3BlLnNlYXJjaFNvdXJjZSkpOwogICAgJHNjb3BlLnNlYXJjaFNvdXJjZS5nZXRTZWFyY2hSZXF1ZXN0Qm9keSgpLnRoZW4oZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgaW5zcGVjdG9yUmVxdWVzdC5qc29uKGJvZHkpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBsb2dJbnNwZWN0b3JSZXNwb25zZShyZXNwKSB7CiAgICBpbnNwZWN0b3JSZXF1ZXN0LnN0YXRzKCgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFJlc3BvbnNlSW5zcGVjdG9yU3RhdHMpKCRzY29wZS5zZWFyY2hTb3VyY2UsIHJlc3ApKS5vayh7CiAgICAgIGpzb246IHJlc3AKICAgIH0pOwogIH0KCiAgJHNjb3BlLnVwZGF0ZVRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICAkc2NvcGUudGltZVJhbmdlID0gewogICAgICBmcm9tOiBfZGF0ZW1hdGguZGVmYXVsdC5wYXJzZSh0aW1lZmlsdGVyLmdldFRpbWUoKS5mcm9tKSwKICAgICAgdG86IF9kYXRlbWF0aC5kZWZhdWx0LnBhcnNlKHRpbWVmaWx0ZXIuZ2V0VGltZSgpLnRvLCB7CiAgICAgICAgcm91bmRVcDogdHJ1ZQogICAgICB9KQogICAgfTsKICAgICRzY29wZS50aW1lID0gdGltZWZpbHRlci5nZXRUaW1lKCk7CiAgfTsKCiAgJHNjb3BlLnRvTW9tZW50ID0gZnVuY3Rpb24gKGRhdGV0aW1lKSB7CiAgICByZXR1cm4gKDAsIF9tb21lbnQuZGVmYXVsdCkoZGF0ZXRpbWUpLmZvcm1hdChjb25maWcuZ2V0KCdkYXRlRm9ybWF0JykpOwogIH07CgogICRzY29wZS51cGRhdGVSZWZyZXNoSW50ZXJ2YWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbmV3SW50ZXJ2YWwgPSB0aW1lZmlsdGVyLmdldFJlZnJlc2hJbnRlcnZhbCgpOwogICAgdmFyIHNob3VsZEZldGNoID0gX2xvZGFzaC5kZWZhdWx0LmdldCgkc2NvcGUsICdyZWZyZXNoSW50ZXJ2YWwucGF1c2UnKSA9PT0gdHJ1ZSAmJiBuZXdJbnRlcnZhbC5wYXVzZSA9PT0gZmFsc2U7CiAgICAkc2NvcGUucmVmcmVzaEludGVydmFsID0gbmV3SW50ZXJ2YWw7CgogICAgaWYgKHNob3VsZEZldGNoKSB7CiAgICAgICRzY29wZS5mZXRjaCgpOwogICAgfQogIH07CgogICRzY29wZS5vblJlZnJlc2hDaGFuZ2UgPSBmdW5jdGlvbiAoX3JlZjQpIHsKICAgIHZhciBpc1BhdXNlZCA9IF9yZWY0LmlzUGF1c2VkLAogICAgICAgIHJlZnJlc2hJbnRlcnZhbCA9IF9yZWY0LnJlZnJlc2hJbnRlcnZhbDsKICAgIHRpbWVmaWx0ZXIuc2V0UmVmcmVzaEludGVydmFsKHsKICAgICAgcGF1c2U6IGlzUGF1c2VkLAogICAgICB2YWx1ZTogcmVmcmVzaEludGVydmFsID8gcmVmcmVzaEludGVydmFsIDogJHNjb3BlLnJlZnJlc2hJbnRlcnZhbC52YWx1ZQogICAgfSk7CiAgfTsKCiAgJHNjb3BlLnJlc2V0UXVlcnkgPSBmdW5jdGlvbiAoKSB7CiAgICBrYm5VcmwuY2hhbmdlKCcvZGlzY292ZXIve3tpZH19JywgewogICAgICBpZDogJHJvdXRlLmN1cnJlbnQucGFyYW1zLmlkCiAgICB9KTsKICB9OwoKICAkc2NvcGUubmV3UXVlcnkgPSBmdW5jdGlvbiAoKSB7CiAgICBrYm5VcmwuY2hhbmdlKCcvZGlzY292ZXInKTsKICB9OwoKICAkc2NvcGUudXBkYXRlRGF0YVNvdXJjZSA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uIHVwZGF0ZURhdGFTb3VyY2UoKSB7CiAgICB2YXIgaW5kZXhQYXR0ZXJuID0gJHNjb3BlLmluZGV4UGF0dGVybiwKICAgICAgICBzZWFyY2hTb3VyY2UgPSAkc2NvcGUuc2VhcmNoU291cmNlOwogICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdzaXplJywgJHNjb3BlLm9wdHMuc2FtcGxlU2l6ZSkuc2V0RmllbGQoJ3NvcnQnLCAoMCwgX2dldF9zb3J0X2Zvcl9zZWFyY2hfc291cmNlLmdldFNvcnRGb3JTZWFyY2hTb3VyY2UpKCRzdGF0ZS5zb3J0LCBpbmRleFBhdHRlcm4pKS5zZXRGaWVsZCgncXVlcnknLCAhJHN0YXRlLnF1ZXJ5ID8gbnVsbCA6ICRzdGF0ZS5xdWVyeSkuc2V0RmllbGQoJ2ZpbHRlcicsIGZpbHRlck1hbmFnZXIuZ2V0RmlsdGVycygpKTsKICB9KTsKCiAgJHNjb3BlLnNldFNvcnRPcmRlciA9IGZ1bmN0aW9uIHNldFNvcnRPcmRlcihzb3J0UGFpcikgewogICAgJHNjb3BlLnN0YXRlLnNvcnQgPSBzb3J0UGFpcjsKICB9OyAvLyBUT0RPOiBPbiBhcnJheSBmaWVsZHMsIG5lZ2F0aW5nIGRvZXMgbm90IG5lZ2F0ZSB0aGUgY29tYmluYXRpb24sIHJhdGhlciBhbGwgdGVybXMKCgogICRzY29wZS5maWx0ZXJRdWVyeSA9IGZ1bmN0aW9uIChmaWVsZCwgdmFsdWVzLCBvcGVyYXRpb24pIHsKICAgICRzY29wZS5pbmRleFBhdHRlcm4ucG9wdWxhcml6ZUZpZWxkKGZpZWxkLCAxKTsKICAgIHZhciBuZXdGaWx0ZXJzID0gKDAsIF9wdWJsaWMuZ2VuZXJhdGVGaWx0ZXJzKShmaWx0ZXJNYW5hZ2VyLCBmaWVsZCwgdmFsdWVzLCBvcGVyYXRpb24sICRzY29wZS5pbmRleFBhdHRlcm4uaWQpOwogICAgcmV0dXJuIGZpbHRlck1hbmFnZXIuYWRkRmlsdGVycyhuZXdGaWx0ZXJzKTsKICB9OwoKICAkc2NvcGUuYWRkQ29sdW1uID0gZnVuY3Rpb24gYWRkQ29sdW1uKGNvbHVtbk5hbWUpIHsKICAgICRzY29wZS5pbmRleFBhdHRlcm4ucG9wdWxhcml6ZUZpZWxkKGNvbHVtbk5hbWUsIDEpOwogICAgY29sdW1uQWN0aW9ucy5hZGRDb2x1bW4oJHNjb3BlLnN0YXRlLmNvbHVtbnMsIGNvbHVtbk5hbWUpOwogIH07CgogICRzY29wZS5yZW1vdmVDb2x1bW4gPSBmdW5jdGlvbiByZW1vdmVDb2x1bW4oY29sdW1uTmFtZSkgewogICAgJHNjb3BlLmluZGV4UGF0dGVybi5wb3B1bGFyaXplRmllbGQoY29sdW1uTmFtZSwgMSk7CiAgICBjb2x1bW5BY3Rpb25zLnJlbW92ZUNvbHVtbigkc2NvcGUuc3RhdGUuY29sdW1ucywgY29sdW1uTmFtZSk7CiAgfTsKCiAgJHNjb3BlLm1vdmVDb2x1bW4gPSBmdW5jdGlvbiBtb3ZlQ29sdW1uKGNvbHVtbk5hbWUsIG5ld0luZGV4KSB7CiAgICBjb2x1bW5BY3Rpb25zLm1vdmVDb2x1bW4oJHNjb3BlLnN0YXRlLmNvbHVtbnMsIGNvbHVtbk5hbWUsIG5ld0luZGV4KTsKICB9OwoKICAkc2NvcGUuc2Nyb2xsVG9Ub3AgPSBmdW5jdGlvbiAoKSB7CiAgICAkd2luZG93LnNjcm9sbFRvKDAsIDApOwogIH07CgogICRzY29wZS5zY3JvbGxUb0JvdHRvbSA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIGRlbGF5IHNjcm9sbGluZyB0byBhZnRlciB0aGUgcm93cyBoYXZlIGJlZW4gcmVuZGVyZWQKICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgJGVsZW1lbnQuZmluZCgnI2Rpc2NvdmVyQm90dG9tTWFya2VyJykuZm9jdXMoKTsKICAgIH0sIDApOwogIH07CgogICRzY29wZS5zaG93QWxsUm93cyA9IGZ1bmN0aW9uICgpIHsKICAgICRzY29wZS5taW5pbXVtVmlzaWJsZVJvd3MgPSAkc2NvcGUuaGl0czsKICB9OwoKICAkc2NvcGUub25RdWVyeVNhdmVkID0gZnVuY3Rpb24gKHNhdmVkUXVlcnkpIHsKICAgICRzY29wZS5zYXZlZFF1ZXJ5ID0gc2F2ZWRRdWVyeTsKICB9OwoKICAkc2NvcGUub25TYXZlZFF1ZXJ5VXBkYXRlZCA9IGZ1bmN0aW9uIChzYXZlZFF1ZXJ5KSB7CiAgICAkc2NvcGUuc2F2ZWRRdWVyeSA9IF9vYmplY3RTcHJlYWQoe30sIHNhdmVkUXVlcnkpOwogIH07CgogICRzY29wZS5vbkNsZWFyU2F2ZWRRdWVyeSA9IGZ1bmN0aW9uICgpIHsKICAgIGRlbGV0ZSAkc2NvcGUuc2F2ZWRRdWVyeTsKICAgIGRlbGV0ZSAkc3RhdGUuc2F2ZWRRdWVyeTsKICAgICRzdGF0ZS5xdWVyeSA9IHsKICAgICAgcXVlcnk6ICcnLAogICAgICBsYW5ndWFnZTogbG9jYWxTdG9yYWdlLmdldCgna2liYW5hLnVzZXJRdWVyeUxhbmd1YWdlJykgfHwgY29uZmlnLmdldCgnc2VhcmNoOnF1ZXJ5TGFuZ3VhZ2UnKQogICAgfTsKICAgIGZpbHRlck1hbmFnZXIucmVtb3ZlQWxsKCk7CiAgICAkc3RhdGUuc2F2ZSgpOwogICAgJHNjb3BlLmZldGNoKCk7CiAgfTsKCiAgdmFyIHVwZGF0ZVN0YXRlRnJvbVNhdmVkUXVlcnkgPSBmdW5jdGlvbiB1cGRhdGVTdGF0ZUZyb21TYXZlZFF1ZXJ5KHNhdmVkUXVlcnkpIHsKICAgICRzdGF0ZS5xdWVyeSA9IHNhdmVkUXVlcnkuYXR0cmlidXRlcy5xdWVyeTsKICAgICRzdGF0ZS5zYXZlKCk7CiAgICBmaWx0ZXJNYW5hZ2VyLnNldEZpbHRlcnMoc2F2ZWRRdWVyeS5hdHRyaWJ1dGVzLmZpbHRlcnMgfHwgW10pOwoKICAgIGlmIChzYXZlZFF1ZXJ5LmF0dHJpYnV0ZXMudGltZWZpbHRlcikgewogICAgICB0aW1lZmlsdGVyLnNldFRpbWUoewogICAgICAgIGZyb206IHNhdmVkUXVlcnkuYXR0cmlidXRlcy50aW1lZmlsdGVyLmZyb20sCiAgICAgICAgdG86IHNhdmVkUXVlcnkuYXR0cmlidXRlcy50aW1lZmlsdGVyLnRvCiAgICAgIH0pOwoKICAgICAgaWYgKHNhdmVkUXVlcnkuYXR0cmlidXRlcy50aW1lZmlsdGVyLnJlZnJlc2hJbnRlcnZhbCkgewogICAgICAgIHRpbWVmaWx0ZXIuc2V0UmVmcmVzaEludGVydmFsKHNhdmVkUXVlcnkuYXR0cmlidXRlcy50aW1lZmlsdGVyLnJlZnJlc2hJbnRlcnZhbCk7CiAgICAgIH0KICAgIH0KCiAgICAkc2NvcGUuZmV0Y2goKTsKICB9OwoKICAkc2NvcGUuJHdhdGNoKCdzYXZlZFF1ZXJ5JywgZnVuY3Rpb24gKG5ld1NhdmVkUXVlcnkpIHsKICAgIGlmICghbmV3U2F2ZWRRdWVyeSkgcmV0dXJuOwogICAgJHN0YXRlLnNhdmVkUXVlcnkgPSBuZXdTYXZlZFF1ZXJ5LmlkOwogICAgJHN0YXRlLnNhdmUoKTsKICAgIHVwZGF0ZVN0YXRlRnJvbVNhdmVkUXVlcnkobmV3U2F2ZWRRdWVyeSk7CiAgfSk7CiAgJHNjb3BlLiR3YXRjaCgnc3RhdGUuc2F2ZWRRdWVyeScsIGZ1bmN0aW9uIChuZXdTYXZlZFF1ZXJ5SWQpIHsKICAgIGlmICghbmV3U2F2ZWRRdWVyeUlkKSB7CiAgICAgICRzY29wZS5zYXZlZFF1ZXJ5ID0gdW5kZWZpbmVkOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKCEkc2NvcGUuc2F2ZWRRdWVyeSB8fCBuZXdTYXZlZFF1ZXJ5SWQgIT09ICRzY29wZS5zYXZlZFF1ZXJ5LmlkKSB7CiAgICAgIGdldFNhdmVkUXVlcnkobmV3U2F2ZWRRdWVyeUlkKS50aGVuKGZ1bmN0aW9uIChzYXZlZFF1ZXJ5KSB7CiAgICAgICAgJHNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgJHNjb3BlLnNhdmVkUXVlcnkgPSBzYXZlZFF1ZXJ5OwogICAgICAgICAgdXBkYXRlU3RhdGVGcm9tU2F2ZWRRdWVyeShzYXZlZFF1ZXJ5KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIHNldHVwVmlzdWFsaXphdGlvbigpIHsKICAgIHZhciB2aXNTdGF0ZUFnZ3MsIHZpc1N0YXRlLCB2aXNTYXZlZE9iamVjdDsKICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUuYXN5bmMoZnVuY3Rpb24gc2V0dXBWaXN1YWxpemF0aW9uJChfY29udGV4dDcpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgaWYgKCRzY29wZS5vcHRzLnRpbWVmaWVsZCkgewogICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgdmlzU3RhdGVBZ2dzID0gW3sKICAgICAgICAgICAgICB0eXBlOiAnY291bnQnLAogICAgICAgICAgICAgIHNjaGVtYTogJ21ldHJpYycKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHR5cGU6ICdkYXRlX2hpc3RvZ3JhbScsCiAgICAgICAgICAgICAgc2NoZW1hOiAnc2VnbWVudCcsCiAgICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgICBmaWVsZDogJHNjb3BlLm9wdHMudGltZWZpZWxkLAogICAgICAgICAgICAgICAgaW50ZXJ2YWw6ICRzdGF0ZS5pbnRlcnZhbCwKICAgICAgICAgICAgICAgIHRpbWVSYW5nZTogdGltZWZpbHRlci5nZXRUaW1lKCkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwoKICAgICAgICAgICAgaWYgKCEkc2NvcGUudmlzKSB7CiAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSA4OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2aXNTdGF0ZSA9ICRzY29wZS52aXMuZ2V0RW5hYmxlZFN0YXRlKCk7CiAgICAgICAgICAgIHZpc1N0YXRlLmFnZ3MgPSB2aXNTdGF0ZUFnZ3M7CiAgICAgICAgICAgICRzY29wZS52aXMuc2V0U3RhdGUodmlzU3RhdGUpOwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ3LmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICB2aXNTYXZlZE9iamVjdCA9IHsKICAgICAgICAgICAgICBpbmRleFBhdHRlcm46ICRzY29wZS5pbmRleFBhdHRlcm4uaWQsCiAgICAgICAgICAgICAgdmlzU3RhdGU6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICdoaXN0b2dyYW0nLAogICAgICAgICAgICAgICAgdGl0bGU6IHNhdmVkU2VhcmNoLnRpdGxlLAogICAgICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgICAgIGFkZExlZ2VuZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgIGFkZFRpbWVNYXJrZXI6IHRydWUKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhZ2dzOiB2aXNTdGF0ZUFnZ3MKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgICRzY29wZS52aXMgPSBuZXcgX2tpYmFuYV9zZXJ2aWNlcy5WaXMoJHNjb3BlLnNlYXJjaFNvdXJjZS5nZXRGaWVsZCgnaW5kZXgnKSwgdmlzU2F2ZWRPYmplY3QudmlzU3RhdGUpOwogICAgICAgICAgICB2aXNTYXZlZE9iamVjdC52aXMgPSAkc2NvcGUudmlzOwogICAgICAgICAgICAkc2NvcGUuc2VhcmNoU291cmNlLm9uUmVxdWVzdFN0YXJ0KGZ1bmN0aW9uIChzZWFyY2hTb3VyY2UsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnZpcy5nZXRBZ2dDb25maWcoKS5vblNlYXJjaFJlcXVlc3RTdGFydChzZWFyY2hTb3VyY2UsIG9wdGlvbnMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHNjb3BlLnNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnYWdncycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnZpcy5nZXRBZ2dDb25maWcoKS50b0RzbCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVJbmRleFBhdHRlcm5Mb2FkaW5nKCkgewogICAgdmFyIF8kcm91dGUkY3VycmVudCRsb2NhbCA9ICRyb3V0ZS5jdXJyZW50LmxvY2Fscy5zYXZlZE9iamVjdHMuaXAsCiAgICAgICAgbG9hZGVkSW5kZXhQYXR0ZXJuID0gXyRyb3V0ZSRjdXJyZW50JGxvY2FsLmxvYWRlZCwKICAgICAgICBzdGF0ZVZhbCA9IF8kcm91dGUkY3VycmVudCRsb2NhbC5zdGF0ZVZhbCwKICAgICAgICBzdGF0ZVZhbEZvdW5kID0gXyRyb3V0ZSRjdXJyZW50JGxvY2FsLnN0YXRlVmFsRm91bmQ7CiAgICB2YXIgb3duSW5kZXhQYXR0ZXJuID0gJHNjb3BlLnNlYXJjaFNvdXJjZS5nZXRPd25GaWVsZCgnaW5kZXgnKTsKCiAgICBpZiAob3duSW5kZXhQYXR0ZXJuICYmICFzdGF0ZVZhbCkgewogICAgICByZXR1cm4gb3duSW5kZXhQYXR0ZXJuOwogICAgfQoKICAgIGlmIChzdGF0ZVZhbCAmJiAhc3RhdGVWYWxGb3VuZCkgewogICAgICB2YXIgd2FybmluZ1RpdGxlID0gX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci52YWx1ZUlzTm90Q29uZmlndXJlZEluZGV4UGF0dGVybklEV2FybmluZ1RpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAne3N0YXRlVmFsfSBpcyBub3QgYSBjb25maWd1cmVkIGluZGV4IHBhdHRlcm4gSUQnLAogICAgICAgIHZhbHVlczogewogICAgICAgICAgc3RhdGVWYWw6ICJcIiIuY29uY2F0KHN0YXRlVmFsLCAiXCIiKQogICAgICAgIH0KICAgICAgfSk7CgogICAgICBpZiAob3duSW5kZXhQYXR0ZXJuKSB7CiAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZFdhcm5pbmcoewogICAgICAgICAgdGl0bGU6IHdhcm5pbmdUaXRsZSwKICAgICAgICAgIHRleHQ6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuc2hvd2luZ1NhdmVkSW5kZXhQYXR0ZXJuV2FybmluZ0Rlc2NyaXB0aW9uJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1Nob3dpbmcgdGhlIHNhdmVkIGluZGV4IHBhdHRlcm46ICJ7b3duSW5kZXhQYXR0ZXJuVGl0bGV9IiAoe293bkluZGV4UGF0dGVybklkfSknLAogICAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgICBvd25JbmRleFBhdHRlcm5UaXRsZTogb3duSW5kZXhQYXR0ZXJuLnRpdGxlLAogICAgICAgICAgICAgIG93bkluZGV4UGF0dGVybklkOiBvd25JbmRleFBhdHRlcm4uaWQKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb3duSW5kZXhQYXR0ZXJuOwogICAgICB9CgogICAgICB0b2FzdE5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyh7CiAgICAgICAgdGl0bGU6IHdhcm5pbmdUaXRsZSwKICAgICAgICB0ZXh0OiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLnNob3dpbmdEZWZhdWx0SW5kZXhQYXR0ZXJuV2FybmluZ0Rlc2NyaXB0aW9uJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTaG93aW5nIHRoZSBkZWZhdWx0IGluZGV4IHBhdHRlcm46ICJ7bG9hZGVkSW5kZXhQYXR0ZXJuVGl0bGV9IiAoe2xvYWRlZEluZGV4UGF0dGVybklkfSknLAogICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgIGxvYWRlZEluZGV4UGF0dGVyblRpdGxlOiBsb2FkZWRJbmRleFBhdHRlcm4udGl0bGUsCiAgICAgICAgICAgIGxvYWRlZEluZGV4UGF0dGVybklkOiBsb2FkZWRJbmRleFBhdHRlcm4uaWQKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gbG9hZGVkSW5kZXhQYXR0ZXJuOwogIH0gLy8gQmxvY2sgdGhlIFVJIGZyb20gbG9hZGluZyBpZiB0aGUgdXNlciBoYXMgbG9hZGVkIGEgcm9sbHVwIGluZGV4IHBhdHRlcm4gYnV0IGl0IGlzbid0CiAgLy8gc3VwcG9ydGVkLgoKCiAgJHNjb3BlLmlzVW5zdXBwb3J0ZWRJbmRleFBhdHRlcm4gPSAhKDAsIF9raWJhbmFfc2VydmljZXMuaXNEZWZhdWx0VHlwZUluZGV4UGF0dGVybikoJHJvdXRlLmN1cnJlbnQubG9jYWxzLnNhdmVkT2JqZWN0cy5pcC5sb2FkZWQpICYmICEoMCwgX2tpYmFuYV9zZXJ2aWNlcy5oYXNTZWFyY2hTdGF0ZWd5Rm9ySW5kZXhQYXR0ZXJuKSgkcm91dGUuY3VycmVudC5sb2NhbHMuc2F2ZWRPYmplY3RzLmlwLmxvYWRlZCk7CgogIGlmICgkc2NvcGUuaXNVbnN1cHBvcnRlZEluZGV4UGF0dGVybikgewogICAgJHNjb3BlLnVuc3VwcG9ydGVkSW5kZXhQYXR0ZXJuVHlwZSA9ICRyb3V0ZS5jdXJyZW50LmxvY2Fscy5zYXZlZE9iamVjdHMuaXAubG9hZGVkLnR5cGU7CiAgICByZXR1cm47CiAgfQoKICAoMCwgX2hlbHBfbWVudV91dGlsLmFkZEhlbHBNZW51VG9BcHBDaHJvbWUpKGNocm9tZSk7CiAgaW5pdCgpOwp9"},null]}