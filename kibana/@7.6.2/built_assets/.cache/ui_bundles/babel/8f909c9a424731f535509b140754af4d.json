{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/ml/public/application/services/job_service.js","dependencies":[{"path":"x-pack/legacy/plugins/ml/public/application/services/job_service.js","mtime":1585205045948},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1585205104179},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1585205115915},{"path":"node_modules/babel-loader/lib/index.js","mtime":1585205080825}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLm1sSm9iU2VydmljZSA9IHZvaWQgMDsKCnZhciBfbG9kYXNoID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJsb2Rhc2giKSk7Cgp2YXIgX2FuZ3VsYXIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoImFuZ3VsYXIiKSk7Cgp2YXIgX21vbWVudCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgibW9tZW50IikpOwoKdmFyIF9pMThuID0gcmVxdWlyZSgiQGtibi9pMThuIik7Cgp2YXIgX21sX2FwaV9zZXJ2aWNlID0gcmVxdWlyZSgiLi9tbF9hcGlfc2VydmljZSIpOwoKdmFyIF9tZXNzYWdlYmFyID0gcmVxdWlyZSgiLi4vY29tcG9uZW50cy9tZXNzYWdlYmFyIik7Cgp2YXIgX3VybF91dGlscyA9IHJlcXVpcmUoIi4uL3V0aWwvdXJsX3V0aWxzIik7Cgp2YXIgX2pvYl91dGlscyA9IHJlcXVpcmUoIi4uLy4uLy4uL2NvbW1vbi91dGlsL2pvYl91dGlscyIpOwoKdmFyIF9wYXJzZV9pbnRlcnZhbCA9IHJlcXVpcmUoIi4uLy4uLy4uL2NvbW1vbi91dGlsL3BhcnNlX2ludGVydmFsIik7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gX3RvQ29uc3VtYWJsZUFycmF5KGFycikgeyByZXR1cm4gX2FycmF5V2l0aG91dEhvbGVzKGFycikgfHwgX2l0ZXJhYmxlVG9BcnJheShhcnIpIHx8IF9ub25JdGVyYWJsZVNwcmVhZCgpOyB9CgpmdW5jdGlvbiBfbm9uSXRlcmFibGVTcHJlYWQoKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIik7IH0KCmZ1bmN0aW9uIF9pdGVyYWJsZVRvQXJyYXkoaXRlcikgeyBpZiAoU3ltYm9sLml0ZXJhdG9yIGluIE9iamVjdChpdGVyKSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaXRlcikgPT09ICJbb2JqZWN0IEFyZ3VtZW50c10iKSByZXR1cm4gQXJyYXkuZnJvbShpdGVyKTsgfQoKZnVuY3Rpb24gX2FycmF5V2l0aG91dEhvbGVzKGFycikgeyBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7IGZvciAodmFyIGkgPSAwLCBhcnIyID0gbmV3IEFycmF5KGFyci5sZW5ndGgpOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7IGFycjJbaV0gPSBhcnJbaV07IH0gcmV0dXJuIGFycjI7IH0gfQoKZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsgfSB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfQoKZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHsgaWYgKGtleSBpbiBvYmopIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7IHZhbHVlOiB2YWx1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KTsgfSBlbHNlIHsgb2JqW2tleV0gPSB2YWx1ZTsgfSByZXR1cm4gb2JqOyB9Cgp2YXIgbXNncyA9IF9tZXNzYWdlYmFyLm1sTWVzc2FnZUJhclNlcnZpY2U7CnZhciBqb2JzID0gW107CnZhciBkYXRhZmVlZElkcyA9IHt9OwoKdmFyIEpvYlNlcnZpY2UgPQovKiNfX1BVUkVfXyovCmZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBKb2JTZXJ2aWNlKCkgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSm9iU2VydmljZSk7CgogICAgX2RlZmluZVByb3BlcnR5KHRoaXMsICJsb2FkSm9ic1dyYXBwZXIiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdGhpcy5sb2FkSm9icygpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICByZXR1cm4gcmVzcDsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIGxvYWRpbmcgam9icyBpbiByb3V0ZSByZXNvbHZlLicsIGVycm9yKTsgLy8gQWx3YXlzIHJlc29sdmUgdG8gZW5zdXJlIHRhYiBzdGlsbCB3b3Jrcy4KCiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKFtdKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICAvLyB0ZW1wSm9iQ2xvbmluZ09iamVjdHMgLT4gdXNlZCB0byBwYXNzIGEgam9iIG9iamVjdCBiZXR3ZWVuIHRoZSBqb2IgbWFuYWdlbWVudCBwYWdlIGFuZAogICAgLy8gYW5kIHRoZSBhZHZhbmNlZCB3aXphcmQuCiAgICAvLyBpZiBwb3B1bGF0ZWQgd2hlbiBsb2FkaW5nIHRoZSBhZHZhbmNlZCB3aXphcmQsIHRoZSBqb2IgaXMgdXNlZCBmb3IgY2xvbmluZy4KICAgIC8vIGlmIHBvcHVsYXRlZCB3aGVuIGxvYWRpbmcgdGhlIGpvYiBtYW5hZ2VtZW50IHBhZ2UsIHRoZSBzdGFydCBkYXRhZmVlZCBtb2RhbAogICAgLy8gaXMgYXV0b21hdGljYWxseSBvcGVuZWQuCiAgICB0aGlzLnRlbXBKb2JDbG9uaW5nT2JqZWN0cyA9IHsKICAgICAgam9iOiB1bmRlZmluZWQsCiAgICAgIHNraXBUaW1lUmFuZ2VTdGVwOiBmYWxzZSwKICAgICAgc3RhcnQ6IHVuZGVmaW5lZCwKICAgICAgZW5kOiB1bmRlZmluZWQsCiAgICAgIGNhbGVuZGFyczogdW5kZWZpbmVkCiAgICB9OwogICAgdGhpcy5qb2JzID0gW107IC8vIFByb3ZpZGUgcmVhZHkgYWNjZXNzIHRvIHdpZGVseSB1c2VkIGJhc2ljIGpvYiBwcm9wZXJ0aWVzLgogICAgLy8gTm90ZSB0aGVzZSBnZXQgcG9wdWxhdGVkIG9uIGEgY2FsbCB0byBsb2FkSm9icy4KCiAgICB0aGlzLmJhc2ljSm9icyA9IHt9OwogICAgdGhpcy5qb2JEZXNjcmlwdGlvbnMgPSB7fTsKICAgIHRoaXMuZGV0ZWN0b3JzQnlKb2IgPSB7fTsKICAgIHRoaXMuY3VzdG9tVXJsc0J5Sm9iID0ge307CiAgICB0aGlzLmpvYlN0YXRzID0gewogICAgICBhY3RpdmVOb2RlczogewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5hY3RpdmVNTE5vZGVzTGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0FjdGl2ZSBNTCBOb2RlcycKICAgICAgICB9KSwKICAgICAgICB2YWx1ZTogMCwKICAgICAgICBzaG93OiB0cnVlCiAgICAgIH0sCiAgICAgIHRvdGFsOiB7CiAgICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC5qb2JTZXJ2aWNlLnRvdGFsSm9ic0xhYmVsJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdUb3RhbCBqb2JzJwogICAgICAgIH0pLAogICAgICAgIHZhbHVlOiAwLAogICAgICAgIHNob3c6IHRydWUKICAgICAgfSwKICAgICAgb3BlbjogewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5vcGVuSm9ic0xhYmVsJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdPcGVuIGpvYnMnCiAgICAgICAgfSksCiAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgc2hvdzogdHJ1ZQogICAgICB9LAogICAgICBjbG9zZWQ6IHsKICAgICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLmpvYlNlcnZpY2UuY2xvc2VkSm9ic0xhYmVsJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdDbG9zZWQgam9icycKICAgICAgICB9KSwKICAgICAgICB2YWx1ZTogMCwKICAgICAgICBzaG93OiB0cnVlCiAgICAgIH0sCiAgICAgIGZhaWxlZDogewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5mYWlsZWRKb2JzTGFiZWwnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0ZhaWxlZCBqb2JzJwogICAgICAgIH0pLAogICAgICAgIHZhbHVlOiAwLAogICAgICAgIHNob3c6IGZhbHNlCiAgICAgIH0sCiAgICAgIGFjdGl2ZURhdGFmZWVkczogewogICAgICAgIGxhYmVsOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5hY3RpdmVEYXRhZmVlZHNMYWJlbCcsIHsKICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnQWN0aXZlIGRhdGFmZWVkcycKICAgICAgICB9KSwKICAgICAgICB2YWx1ZTogMCwKICAgICAgICBzaG93OiB0cnVlCiAgICAgIH0KICAgIH07CiAgfQoKICBfY3JlYXRlQ2xhc3MoSm9iU2VydmljZSwgW3sKICAgIGtleTogImdldEJsYW5rSm9iIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRCbGFua0pvYigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBqb2JfaWQ6ICcnLAogICAgICAgIGRlc2NyaXB0aW9uOiAnJywKICAgICAgICBncm91cHM6IFtdLAogICAgICAgIGFuYWx5c2lzX2NvbmZpZzogewogICAgICAgICAgYnVja2V0X3NwYW46ICcxNW0nLAogICAgICAgICAgaW5mbHVlbmNlcnM6IFtdLAogICAgICAgICAgZGV0ZWN0b3JzOiBbXQogICAgICAgIH0sCiAgICAgICAgZGF0YV9kZXNjcmlwdGlvbjogewogICAgICAgICAgdGltZV9maWVsZDogJycsCiAgICAgICAgICB0aW1lX2Zvcm1hdDogJycsCiAgICAgICAgICAvLyAnZXBvY2gnLAogICAgICAgICAgZmllbGRfZGVsaW1pdGVyOiAnJywKICAgICAgICAgIHF1b3RlX2NoYXJhY3RlcjogJyInLAogICAgICAgICAgZm9ybWF0OiAnZGVsaW1pdGVkJwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJsb2FkSm9icyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gbG9hZEpvYnMoKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBqb2JzID0gW107CiAgICAgICAgZGF0YWZlZWRJZHMgPSB7fTsKCiAgICAgICAgX21sX2FwaV9zZXJ2aWNlLm1sLmdldEpvYnMoKS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAvLyBtYWtlIGRlZXAgY29weSBvZiBqb2JzCiAgICAgICAgICBfYW5ndWxhci5kZWZhdWx0LmNvcHkocmVzcC5qb2JzLCBqb2JzKTsgLy8gbG9hZCBqb2JzIHN0YXRzCgoKICAgICAgICAgIF9tbF9hcGlfc2VydmljZS5tbC5nZXRKb2JTdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzUmVzcCkgewogICAgICAgICAgICAvLyBtZXJnZSBqb2JzIHN0YXRzIGludG8gam9icwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpvYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgam9iID0gam9ic1tpXTsgLy8gY3JlYXRlIGVtcHR5IHBsYWNlaG9sZGVycyBmb3Igc3RhdHMgYW5kIGRhdGFmZWVkIG9iamVjdHMKCiAgICAgICAgICAgICAgam9iLmRhdGFfY291bnRzID0ge307CiAgICAgICAgICAgICAgam9iLm1vZGVsX3NpemVfc3RhdHMgPSB7fTsKICAgICAgICAgICAgICBqb2IuZGF0YWZlZWRfY29uZmlnID0ge307CgogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3RhdHNSZXNwLmpvYnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIGlmIChqb2Iuam9iX2lkID09PSBzdGF0c1Jlc3Auam9ic1tqXS5qb2JfaWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGpvYlN0YXRzID0gX2FuZ3VsYXIuZGVmYXVsdC5jb3B5KHN0YXRzUmVzcC5qb2JzW2pdKTsKCiAgICAgICAgICAgICAgICAgIGpvYi5zdGF0ZSA9IGpvYlN0YXRzLnN0YXRlOwogICAgICAgICAgICAgICAgICBqb2IuZGF0YV9jb3VudHMgPSBqb2JTdGF0cy5kYXRhX2NvdW50czsKICAgICAgICAgICAgICAgICAgam9iLm1vZGVsX3NpemVfc3RhdHMgPSBqb2JTdGF0cy5tb2RlbF9zaXplX3N0YXRzOwoKICAgICAgICAgICAgICAgICAgaWYgKGpvYlN0YXRzLm5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBqb2Iubm9kZSA9IGpvYlN0YXRzLm5vZGU7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChqb2JTdGF0cy5vcGVuX3RpbWUpIHsKICAgICAgICAgICAgICAgICAgICBqb2Iub3Blbl90aW1lID0gam9iU3RhdHMub3Blbl90aW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBfdGhpczIubG9hZERhdGFmZWVkcygpLnRoZW4oZnVuY3Rpb24gKGRhdGFmZWVkc1Jlc3ApIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgam9icy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9qID0gMDsgX2ogPCBkYXRhZmVlZHNSZXNwLmRhdGFmZWVkcy5sZW5ndGg7IF9qKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGpvYnNbX2ldLmpvYl9pZCA9PT0gZGF0YWZlZWRzUmVzcC5kYXRhZmVlZHNbX2pdLmpvYl9pZCkgewogICAgICAgICAgICAgICAgICAgIGpvYnNbX2ldLmRhdGFmZWVkX2NvbmZpZyA9IGRhdGFmZWVkc1Jlc3AuZGF0YWZlZWRzW19qXTsKICAgICAgICAgICAgICAgICAgICBkYXRhZmVlZElkc1tqb2JzW19pXS5qb2JfaWRdID0gZGF0YWZlZWRzUmVzcC5kYXRhZmVlZHNbX2pdLmRhdGFmZWVkX2lkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwcm9jZXNzQmFzaWNKb2JJbmZvKF90aGlzMiwgam9icyk7CiAgICAgICAgICAgICAgX3RoaXMyLmpvYnMgPSBqb2JzOwogICAgICAgICAgICAgIGNyZWF0ZUpvYlN0YXRzKF90aGlzMi5qb2JzLCBfdGhpczIuam9iU3RhdHMpOwogICAgICAgICAgICAgIHJlc29sdmUoewogICAgICAgICAgICAgICAgam9iczogX3RoaXMyLmpvYnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBlcnJvcihlcnIpOwogICAgICAgIH0pOwoKICAgICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdqb2JTZXJ2aWNlIGVycm9yIGdldHRpbmcgbGlzdCBvZiBqb2JzOicsIGVycik7CiAgICAgICAgICBtc2dzLmVycm9yKF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC5qb2JTZXJ2aWNlLmpvYnNMaXN0Q291bGROb3RCZVJldHJpZXZlZEVycm9yTWVzc2FnZScsIHsKICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdKb2JzIGxpc3QgY291bGQgbm90IGJlIHJldHJpZXZlZCcKICAgICAgICAgIH0pKTsKICAgICAgICAgIG1zZ3MuZXJyb3IoJycsIGVycik7CiAgICAgICAgICByZWplY3QoewogICAgICAgICAgICBqb2JzOiBqb2JzLAogICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZWZyZXNoSm9iIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZWZyZXNoSm9iKGpvYklkKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBfbWxfYXBpX3NlcnZpY2UubWwuZ2V0Sm9icyh7CiAgICAgICAgICBqb2JJZDogam9iSWQKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICB2YXIgbmV3Sm9iID0ge307CgogICAgICAgICAgaWYgKHJlc3Auam9icyAmJiByZXNwLmpvYnMubGVuZ3RoKSB7CiAgICAgICAgICAgIF9hbmd1bGFyLmRlZmF1bHQuY29weShyZXNwLmpvYnNbMF0sIG5ld0pvYik7IC8vIGxvYWQgam9icyBzdGF0cwoKCiAgICAgICAgICAgIF9tbF9hcGlfc2VydmljZS5tbC5nZXRKb2JTdGF0cyh7CiAgICAgICAgICAgICAgam9iSWQ6IGpvYklkCiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHN0YXRzUmVzcCkgewogICAgICAgICAgICAgIC8vIG1lcmdlIGpvYnMgc3RhdHMgaW50byBqb2JzCiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBzdGF0c1Jlc3Auam9icy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgaWYgKG5ld0pvYi5qb2JfaWQgPT09IHN0YXRzUmVzcC5qb2JzW2pdLmpvYl9pZCkgewogICAgICAgICAgICAgICAgICB2YXIgc3RhdHNKb2IgPSBzdGF0c1Jlc3Auam9ic1tqXTsKICAgICAgICAgICAgICAgICAgbmV3Sm9iLnN0YXRlID0gc3RhdHNKb2Iuc3RhdGU7CiAgICAgICAgICAgICAgICAgIG5ld0pvYi5kYXRhX2NvdW50cyA9IHt9OwogICAgICAgICAgICAgICAgICBuZXdKb2IubW9kZWxfc2l6ZV9zdGF0cyA9IHt9OwoKICAgICAgICAgICAgICAgICAgX2FuZ3VsYXIuZGVmYXVsdC5jb3B5KHN0YXRzSm9iLmRhdGFfY291bnRzLCBuZXdKb2IuZGF0YV9jb3VudHMpOwoKICAgICAgICAgICAgICAgICAgX2FuZ3VsYXIuZGVmYXVsdC5jb3B5KHN0YXRzSm9iLm1vZGVsX3NpemVfc3RhdHMsIG5ld0pvYi5tb2RlbF9zaXplX3N0YXRzKTsKCiAgICAgICAgICAgICAgICAgIGlmIChuZXdKb2Iubm9kZSkgewogICAgICAgICAgICAgICAgICAgIF9hbmd1bGFyLmRlZmF1bHQuY29weShzdGF0c0pvYi5ub2RlLCBuZXdKb2Iubm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChzdGF0c0pvYi5vcGVuX3RpbWUpIHsKICAgICAgICAgICAgICAgICAgICBuZXdKb2Iub3Blbl90aW1lID0gc3RhdHNKb2Iub3Blbl90aW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSAvLyByZXBsYWNlIHRoZSBqb2IgaW4gdGhlIGpvYnMgYXJyYXkKCgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgam9icy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGpvYnNbaV0uam9iX2lkID09PSBuZXdKb2Iuam9iX2lkKSB7CiAgICAgICAgICAgICAgICAgIGpvYnNbaV0gPSBuZXdKb2I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgZGF0YWZlZWRJZCA9IF90aGlzMy5nZXREYXRhZmVlZElkKGpvYklkKTsKCiAgICAgICAgICAgICAgX3RoaXMzLmxvYWREYXRhZmVlZHMoZGF0YWZlZWRJZCkudGhlbihmdW5jdGlvbiAoZGF0YWZlZWRzUmVzcCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgam9icy5sZW5ndGg7IF9pMisrKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9qMiA9IDA7IF9qMiA8IGRhdGFmZWVkc1Jlc3AuZGF0YWZlZWRzLmxlbmd0aDsgX2oyKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoam9ic1tfaTJdLmpvYl9pZCA9PT0gZGF0YWZlZWRzUmVzcC5kYXRhZmVlZHNbX2oyXS5qb2JfaWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGpvYnNbX2kyXS5kYXRhZmVlZF9jb25maWcgPSBkYXRhZmVlZHNSZXNwLmRhdGFmZWVkc1tfajJdOwogICAgICAgICAgICAgICAgICAgICAgZGF0YWZlZWRJZHNbam9ic1tfaTJdLmpvYl9pZF0gPSBkYXRhZmVlZHNSZXNwLmRhdGFmZWVkc1tfajJdLmRhdGFmZWVkX2lkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF90aGlzMy5qb2JzID0gam9iczsKICAgICAgICAgICAgICAgIGNyZWF0ZUpvYlN0YXRzKF90aGlzMy5qb2JzLCBfdGhpczMuam9iU3RhdHMpOwogICAgICAgICAgICAgICAgcmVzb2x2ZSh7CiAgICAgICAgICAgICAgICAgIGpvYnM6IF90aGlzMy5qb2JzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgICAgY29uc29sZS5sb2coJ0pvYlNlcnZpY2UgZXJyb3IgZ2V0dGluZyBsaXN0IG9mIGpvYnM6JywgZXJyKTsKICAgICAgICAgIG1zZ3MuZXJyb3IoX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLmpvYlNlcnZpY2Uuam9ic0xpc3RDb3VsZE5vdEJlUmV0cmlldmVkRXJyb3JNZXNzYWdlJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0pvYnMgbGlzdCBjb3VsZCBub3QgYmUgcmV0cmlldmVkJwogICAgICAgICAgfSkpOwogICAgICAgICAgbXNncy5lcnJvcignJywgZXJyKTsKICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgIGpvYnM6IGpvYnMsCiAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImxvYWREYXRhZmVlZHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGxvYWREYXRhZmVlZHMoZGF0YWZlZWRJZCkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHZhciBkYXRhZmVlZHMgPSBbXTsKICAgICAgICB2YXIgc0lkID0gZGF0YWZlZWRJZCAhPT0gdW5kZWZpbmVkID8gewogICAgICAgICAgZGF0YWZlZWRfaWQ6IGRhdGFmZWVkSWQKICAgICAgICB9IDogdW5kZWZpbmVkOwoKICAgICAgICBfbWxfYXBpX3NlcnZpY2UubWwuZ2V0RGF0YWZlZWRzKHNJZCkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xvYWREYXRhZmVlZHMgcXVlcnkgcmVzcG9uc2U6JywgcmVzcCk7CiAgICAgICAgICAvLyBtYWtlIGRlZXAgY29weSBvZiBkYXRhZmVlZHMKICAgICAgICAgIF9hbmd1bGFyLmRlZmF1bHQuY29weShyZXNwLmRhdGFmZWVkcywgZGF0YWZlZWRzKTsgLy8gbG9hZCBkYXRhZmVlZHMgc3RhdHMKCgogICAgICAgICAgX21sX2FwaV9zZXJ2aWNlLm1sLmdldERhdGFmZWVkU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0c1Jlc3ApIHsKICAgICAgICAgICAgLy8gbWVyZ2UgZGF0YWZlZWRzIHN0YXRzIGludG8gZGF0YWZlZWRzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YWZlZWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGFmZWVkID0gZGF0YWZlZWRzW2ldOwoKICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN0YXRzUmVzcC5kYXRhZmVlZHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhZmVlZC5kYXRhZmVlZF9pZCA9PT0gc3RhdHNSZXNwLmRhdGFmZWVkc1tqXS5kYXRhZmVlZF9pZCkgewogICAgICAgICAgICAgICAgICBkYXRhZmVlZC5zdGF0ZSA9IHN0YXRzUmVzcC5kYXRhZmVlZHNbal0uc3RhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNvbHZlKHsKICAgICAgICAgICAgICBkYXRhZmVlZHM6IGRhdGFmZWVkcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IoZXJyKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgICAgY29uc29sZS5sb2coJ2xvYWREYXRhZmVlZHMgZXJyb3IgZ2V0dGluZyBsaXN0IG9mIGRhdGFmZWVkczonLCBlcnIpOwogICAgICAgICAgbXNncy5lcnJvcihfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5kYXRhZmVlZHNMaXN0Q291bGROb3RCZVJldHJpZXZlZEVycm9yTWVzc2FnZScsIHsKICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdkYXRhZmVlZHMgbGlzdCBjb3VsZCBub3QgYmUgcmV0cmlldmVkJwogICAgICAgICAgfSkpOwogICAgICAgICAgbXNncy5lcnJvcignJywgZXJyKTsKICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgIGpvYnM6IGpvYnMsCiAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZVNpbmdsZUpvYkRhdGFmZWVkU3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZVNpbmdsZUpvYkRhdGFmZWVkU3RhdGUoam9iSWQpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHZhciBkYXRhZmVlZElkID0gX3RoaXM0LmdldERhdGFmZWVkSWQoam9iSWQpOwoKICAgICAgICBfbWxfYXBpX3NlcnZpY2UubWwuZ2V0RGF0YWZlZWRTdGF0cyh7CiAgICAgICAgICBkYXRhZmVlZElkOiBkYXRhZmVlZElkCiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgLy8gY29uc29sZS5sb2coJ3VwZGF0ZVNpbmdsZUpvYkNvdW50cyBjb250cm9sbGVyIHF1ZXJ5IHJlc3BvbnNlOicsIHJlc3ApOwogICAgICAgICAgdmFyIGRhdGFmZWVkcyA9IHJlc3AuZGF0YWZlZWRzOwogICAgICAgICAgdmFyIHN0YXRlID0gJ1VOS05PV04nOwoKICAgICAgICAgIGlmIChkYXRhZmVlZHMgJiYgZGF0YWZlZWRzLmxlbmd0aCkgewogICAgICAgICAgICBzdGF0ZSA9IGRhdGFmZWVkc1swXS5zdGF0ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXNvbHZlKHN0YXRlKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgcmVqZWN0KHJlc3ApOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzYXZlTmV3Sm9iIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzYXZlTmV3Sm9iKGpvYikgewogICAgICAvLyBydW4gdGhlbiBhbmQgY2F0Y2ggdGhyb3VnaCB0aGUgc2FtZSBjaGVjawogICAgICBmdW5jdGlvbiBmdW5jKHJlc3ApIHsKICAgICAgICBjb25zb2xlLmxvZygnUmVzcG9uc2UgZm9yIGpvYiBxdWVyeTonLCByZXNwKTsKICAgICAgICB2YXIgc3VjY2VzcyA9IGNoZWNrU2F2ZVJlc3BvbnNlKHJlc3AsIGpvYik7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3MsCiAgICAgICAgICBqb2I6IGpvYiwKICAgICAgICAgIHJlc3A6IHJlc3AKICAgICAgICB9OwogICAgICB9IC8vIHJldHVybiB0aGUgcHJvbWlzZSBjaGFpbgoKCiAgICAgIHJldHVybiBfbWxfYXBpX3NlcnZpY2UubWwuYWRkSm9iKHsKICAgICAgICBqb2JJZDogam9iLmpvYl9pZCwKICAgICAgICBqb2I6IGpvYgogICAgICB9KS50aGVuKGZ1bmMpLmNhdGNoKGZ1bmMpOwogICAgfQogIH0sIHsKICAgIGtleTogImNsb25lSm9iIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbG9uZUpvYihqb2IpIHsKICAgICAgLy8gY3JlYXRlIGEgZGVlcCBjb3B5IG9mIGEgam9iIG9iamVjdAogICAgICAvLyBhbHNvIHJlbW92ZSBpdGVtcyBmcm9tIHRoZSBqb2Igd2hpY2ggYXJlIHNldCBieSB0aGUgc2VydmVyIGFuZCBub3QgbmVlZGVkCiAgICAgIC8vIGluIHRoZSBmdXR1cmUgdGhpcyBmb3JtYXR0aW5nIGNvdWxkIGJlIG9wdGlvbmFsCiAgICAgIHZhciB0ZW1wSm9iID0gX2FuZ3VsYXIuZGVmYXVsdC5jb3B5KGpvYik7IC8vIHJlbW92ZSBhbGwgb2YgdGhlIGl0ZW1zIHdoaWNoIHNob3VsZCBub3QgYmUgY29waWVkCiAgICAgIC8vIHN1Y2ggYXMgY291bnRzLCBzdGF0ZSBhbmQgdGltZXMKCgogICAgICBkZWxldGUgdGVtcEpvYi5zdGF0ZTsKICAgICAgZGVsZXRlIHRlbXBKb2Iuam9iX3ZlcnNpb247CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLmRhdGFfY291bnRzOwogICAgICBkZWxldGUgdGVtcEpvYi5jcmVhdGVfdGltZTsKICAgICAgZGVsZXRlIHRlbXBKb2IuZmluaXNoZWRfdGltZTsKICAgICAgZGVsZXRlIHRlbXBKb2IubGFzdF9kYXRhX3RpbWU7CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLm1vZGVsX3NpemVfc3RhdHM7CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLm5vZGU7CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLmF2ZXJhZ2VfYnVja2V0X3Byb2Nlc3NpbmdfdGltZV9tczsKICAgICAgZGVsZXRlIHRlbXBKb2IubW9kZWxfc25hcHNob3RfaWQ7CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLm9wZW5fdGltZTsKICAgICAgZGVsZXRlIHRlbXBKb2IuZXN0YWJsaXNoZWRfbW9kZWxfbWVtb3J5OwogICAgICBkZWxldGUgdGVtcEpvYi5jYWxlbmRhcnM7CiAgICAgIGRlbGV0ZSB0ZW1wSm9iLmFuYWx5c2lzX2NvbmZpZy51c2VfcGVyX3BhcnRpdGlvbl9ub3JtYWxpemF0aW9uOwoKICAgICAgX2xvZGFzaC5kZWZhdWx0LmVhY2godGVtcEpvYi5hbmFseXNpc19jb25maWcuZGV0ZWN0b3JzLCBmdW5jdGlvbiAoZCkgewogICAgICAgIGRlbGV0ZSBkLmRldGVjdG9yX2luZGV4OwogICAgICB9KTsgLy8gcmVtb3ZlIHBhcnRzIG9mIHRoZSBkYXRhZmVlZCBjb25maWcgd2hpY2ggc2hvdWxkIG5vdCBiZSBjb3BpZWQKCgogICAgICBpZiAodGVtcEpvYi5kYXRhZmVlZF9jb25maWcpIHsKICAgICAgICBkZWxldGUgdGVtcEpvYi5kYXRhZmVlZF9jb25maWcuZGF0YWZlZWRfaWQ7CiAgICAgICAgZGVsZXRlIHRlbXBKb2IuZGF0YWZlZWRfY29uZmlnLmpvYl9pZDsKICAgICAgICBkZWxldGUgdGVtcEpvYi5kYXRhZmVlZF9jb25maWcuc3RhdGU7CiAgICAgICAgZGVsZXRlIHRlbXBKb2IuZGF0YWZlZWRfY29uZmlnLm5vZGU7CiAgICAgICAgZGVsZXRlIHRlbXBKb2IuZGF0YWZlZWRfY29uZmlnLnRpbWluZ19zdGF0czsgLy8gcmVtb3ZlIHF1ZXJ5X2RlbGF5IGlmIGl0J3MgYmV0d2VlbiA2MHMgYW5kIDEyMHMKICAgICAgICAvLyB0aGUgYmFjay1lbmQgcHJvZHVjZXMgYSByYW5kb20gdmFsdWUgYmV0d2VlbiA2MCBhbmQgMTIwIGFuZCBzbwogICAgICAgIC8vIGJ5IGRlbGV0aW5nIGl0LCB0aGUgYmFjay1lbmQgd2lsbCBwcm9kdWNlIGEgbmV3IHJhbmRvbSB2YWx1ZQoKICAgICAgICBpZiAodGVtcEpvYi5kYXRhZmVlZF9jb25maWcucXVlcnlfZGVsYXkpIHsKICAgICAgICAgIHZhciBpbnRlcnZhbCA9ICgwLCBfcGFyc2VfaW50ZXJ2YWwucGFyc2VJbnRlcnZhbCkodGVtcEpvYi5kYXRhZmVlZF9jb25maWcucXVlcnlfZGVsYXkpOwoKICAgICAgICAgIGlmIChpbnRlcnZhbCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcXVlcnlEZWxheSA9IGludGVydmFsLmFzU2Vjb25kcygpOwoKICAgICAgICAgICAgaWYgKHF1ZXJ5RGVsYXkgPiA2MCAmJiBxdWVyeURlbGF5IDwgMTIwKSB7CiAgICAgICAgICAgICAgZGVsZXRlIHRlbXBKb2IuZGF0YWZlZWRfY29uZmlnLnF1ZXJ5X2RlbGF5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIHdoZW4ganVtcGluZyBmcm9tIGEgd2l6YXJkIHRvIHRoZSBhZHZhbmNlZCBqb2IgY3JlYXRpb24sCiAgICAgIC8vIHRoZSB3aXphcmQncyBjcmVhdGVkX2J5IGluZm9ybWF0aW9uIHNob3VsZCBiZSBzdHJpcHBlZC4KCgogICAgICBpZiAodGVtcEpvYi5jdXN0b21fc2V0dGluZ3MgJiYgdGVtcEpvYi5jdXN0b21fc2V0dGluZ3MuY3JlYXRlZF9ieSkgewogICAgICAgIGRlbGV0ZSB0ZW1wSm9iLmN1c3RvbV9zZXR0aW5ncy5jcmVhdGVkX2J5OwogICAgICB9CgogICAgICByZXR1cm4gdGVtcEpvYjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1cGRhdGVKb2IiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZUpvYihqb2JJZCwgam9iKSB7CiAgICAgIC8vIHJldHVybiB0aGUgcHJvbWlzZSBjaGFpbgogICAgICByZXR1cm4gX21sX2FwaV9zZXJ2aWNlLm1sLnVwZGF0ZUpvYih7CiAgICAgICAgam9iSWQ6IGpvYklkLAogICAgICAgIGpvYjogam9iCiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICBjb25zb2xlLmxvZygndXBkYXRlIGpvYicsIHJlc3ApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzdWNjZXNzOiB0cnVlCiAgICAgICAgfTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgIG1zZ3MuZXJyb3IoX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLmpvYlNlcnZpY2UuY291bGROb3RVcGRhdGVKb2JFcnJvck1lc3NhZ2UnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0NvdWxkIG5vdCB1cGRhdGUgam9iOiB7am9iSWR9JywKICAgICAgICAgIHZhbHVlczogewogICAgICAgICAgICBqb2JJZDogam9iSWQKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgICAgY29uc29sZS5sb2coJ3VwZGF0ZSBqb2InLCBlcnIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAidmFsaWRhdGVKb2IiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbGlkYXRlSm9iKG9iaikgewogICAgICAvLyByZXR1cm4gdGhlIHByb21pc2UgY2hhaW4KICAgICAgcmV0dXJuIF9tbF9hcGlfc2VydmljZS5tbC52YWxpZGF0ZUpvYihvYmopLnRoZW4oZnVuY3Rpb24gKG1lc3NhZ2VzKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICBtZXNzYWdlczogbWVzc2FnZXMKICAgICAgICB9OwogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgbXNncy5lcnJvcihfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subWwuam9iU2VydmljZS5qb2JWYWxpZGF0aW9uRXJyb3JNZXNzYWdlJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdKb2IgVmFsaWRhdGlvbiBFcnJvcjoge2Vycm9yTWVzc2FnZX0nLAogICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgIGVycm9yTWVzc2FnZTogZXJyLm1lc3NhZ2UKICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgICAgY29uc29sZS5sb2coJ3ZhbGlkYXRlIGpvYicsIGVycik7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgbWVzc2FnZXM6IFt7CiAgICAgICAgICAgIHN0YXR1czogJ2Vycm9yJywKICAgICAgICAgICAgdGV4dDogZXJyLm1lc3NhZ2UKICAgICAgICAgIH1dCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9IC8vIGZpbmQgYSBqb2IgYmFzZWQgb24gdGhlIGlkCgogIH0sIHsKICAgIGtleTogImdldEpvYiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Sm9iKGpvYklkKSB7CiAgICAgIHZhciBqb2IgPSBfbG9kYXNoLmRlZmF1bHQuZmluZChqb2JzLCBmdW5jdGlvbiAoaikgewogICAgICAgIHJldHVybiBqLmpvYl9pZCA9PT0gam9iSWQ7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGpvYjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZWFyY2hQcmV2aWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZWFyY2hQcmV2aWV3KGpvYikgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChqb2IuZGF0YWZlZWRfY29uZmlnKSB7CiAgICAgICAgICAvLyBpZiBxdWVyeSBpcyBzZXQsIGFkZCBpdCB0byB0aGUgc2VhcmNoLCBvdGhlcndpc2UgdXNlIG1hdGNoX2FsbAogICAgICAgICAgdmFyIHF1ZXJ5ID0gewogICAgICAgICAgICBtYXRjaF9hbGw6IHt9CiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChqb2IuZGF0YWZlZWRfY29uZmlnLnF1ZXJ5KSB7CiAgICAgICAgICAgIHF1ZXJ5ID0gam9iLmRhdGFmZWVkX2NvbmZpZy5xdWVyeTsKICAgICAgICAgIH0gLy8gR2V0IGJ1Y2tldCBzcGFuCiAgICAgICAgICAvLyBHZXQgZmlyc3QgZG9jIHRpbWUgZm9yIGRhdGFmZWVkCiAgICAgICAgICAvLyBDcmVhdGUgYSBuZXcgcXVlcnkgLSBtdXN0IHVzZXIgcXVlcnkgYW5kIG11c3QgcmFuZ2UgcXVlcnkuCiAgICAgICAgICAvLyBUaW1lIHJhbmdlICd0bycgZmlyc3QgZG9jIHRpbWUgcGx1cyA8IDEwIGJ1Y2tldHMKICAgICAgICAgIC8vIERvIGEgcHJlbGltaW5hcnkgc2VhcmNoIHRvIGdldCB0aGUgZGF0ZSBvZiB0aGUgZWFybGllc3QgZG9jIG1hdGNoaW5nIHRoZQogICAgICAgICAgLy8gcXVlcnkgaW4gdGhlIGRhdGFmZWVkLiBUaGlzIHdpbGwgYmUgdXNlZCB0byBhcHBseSBhIHRpbWUgcmFuZ2UgY3JpdGVyaWEKICAgICAgICAgIC8vIG9uIHRoZSBkYXRhZmVlZCBzZWFyY2ggcHJldmlldy4KICAgICAgICAgIC8vIFRoaXMgdGltZSBmaWx0ZXIgaXMgcmVxdWlyZWQgZm9yIGRhdGFmZWVkIHNlYXJjaGVzIHVzaW5nIGFnZ3JlZ2F0aW9ucyB0byBlbnN1cmUKICAgICAgICAgIC8vIHRoZSBzZWFyY2ggZG9lcyBub3QgY3JlYXRlIHRvbyBtYW55IGJ1Y2tldHMgKGRlZmF1bHQgMTAwMDAgbWF4X2J1Y2tldCBsaW1pdCksCiAgICAgICAgICAvLyBidXQgYXBwbHkgaXQgdG8gc2VhcmNoZXMgd2l0aG91dCBhZ2dyZWdhdGlvbnMgdG9vIGZvciBjb25zaXN0ZW5jeS4KCgogICAgICAgICAgX21sX2FwaV9zZXJ2aWNlLm1sLmdldFRpbWVGaWVsZFJhbmdlKHsKICAgICAgICAgICAgaW5kZXg6IGpvYi5kYXRhZmVlZF9jb25maWcuaW5kaWNlcywKICAgICAgICAgICAgdGltZUZpZWxkTmFtZTogam9iLmRhdGFfZGVzY3JpcHRpb24udGltZV9maWVsZCwKICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5CiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICh0aW1lUmFuZ2UpIHsKICAgICAgICAgICAgdmFyIGJ1Y2tldFNwYW4gPSAoMCwgX3BhcnNlX2ludGVydmFsLnBhcnNlSW50ZXJ2YWwpKGpvYi5hbmFseXNpc19jb25maWcuYnVja2V0X3NwYW4pOwogICAgICAgICAgICB2YXIgZWFybGllc3RNcyA9IHRpbWVSYW5nZS5zdGFydC5lcG9jaDsKICAgICAgICAgICAgdmFyIGxhdGVzdE1zID0gK3RpbWVSYW5nZS5zdGFydC5lcG9jaCArIDEwICogYnVja2V0U3Bhbi5hc01pbGxpc2Vjb25kcygpOwogICAgICAgICAgICB2YXIgYm9keSA9IHsKICAgICAgICAgICAgICBxdWVyeTogewogICAgICAgICAgICAgICAgYm9vbDogewogICAgICAgICAgICAgICAgICBtdXN0OiBbewogICAgICAgICAgICAgICAgICAgIHJhbmdlOiBfZGVmaW5lUHJvcGVydHkoe30sIGpvYi5kYXRhX2Rlc2NyaXB0aW9uLnRpbWVfZmllbGQsIHsKICAgICAgICAgICAgICAgICAgICAgIGd0ZTogZWFybGllc3RNcywKICAgICAgICAgICAgICAgICAgICAgIGx0OiBsYXRlc3RNcywKICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogJ2Vwb2NoX21pbGxpcycKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICB9LCBxdWVyeV0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07IC8vIGlmIGFnZ3Mgb3IgYWdncmVnYXRpb25zIGlzIHNldCwgYWRkIGl0IHRvIHRoZSBzZWFyY2gKCiAgICAgICAgICAgIHZhciBhZ2dyZWdhdGlvbnMgPSBqb2IuZGF0YWZlZWRfY29uZmlnLmFnZ3MgfHwgam9iLmRhdGFmZWVkX2NvbmZpZy5hZ2dyZWdhdGlvbnM7CgogICAgICAgICAgICBpZiAoYWdncmVnYXRpb25zICYmIE9iamVjdC5rZXlzKGFnZ3JlZ2F0aW9ucykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgYm9keS5zaXplID0gMDsKICAgICAgICAgICAgICBib2R5LmFnZ3JlZ2F0aW9ucyA9IGFnZ3JlZ2F0aW9uczsgLy8gYWRkIHNjcmlwdF9maWVsZHMgaWYgcHJlc2VudAoKICAgICAgICAgICAgICB2YXIgc2NyaXB0RmllbGRzID0gam9iLmRhdGFmZWVkX2NvbmZpZy5zY3JpcHRfZmllbGRzOwoKICAgICAgICAgICAgICBpZiAoc2NyaXB0RmllbGRzICYmIE9iamVjdC5rZXlzKHNjcmlwdEZpZWxkcykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBib2R5LnNjcmlwdF9maWVsZHMgPSBzY3JpcHRGaWVsZHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGlmIGFnZ3JlZ2F0aW9ucyBpcyBub3Qgc2V0IGFuZCByZXRyaWV2ZVdob2xlU291cmNlIGlzIG5vdCBzZXQsIGFkZCBhbGwgb2YgdGhlIGZpZWxkcyBmcm9tIHRoZSBqb2IKICAgICAgICAgICAgICBib2R5LnNpemUgPSBfam9iX3V0aWxzLk1MX0RBVEFfUFJFVklFV19DT1VOVDsgLy8gYWRkIHNjcmlwdF9maWVsZHMgaWYgcHJlc2VudAoKICAgICAgICAgICAgICB2YXIgX3NjcmlwdEZpZWxkcyA9IGpvYi5kYXRhZmVlZF9jb25maWcuc2NyaXB0X2ZpZWxkczsKCiAgICAgICAgICAgICAgaWYgKF9zY3JpcHRGaWVsZHMgJiYgT2JqZWN0LmtleXMoX3NjcmlwdEZpZWxkcykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBib2R5LnNjcmlwdF9maWVsZHMgPSBfc2NyaXB0RmllbGRzOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IHt9OyAvLyBnZXQgZmllbGRzIGZyb20gZGV0ZWN0b3JzCgogICAgICAgICAgICAgIGlmIChqb2IuYW5hbHlzaXNfY29uZmlnLmRldGVjdG9ycykgewogICAgICAgICAgICAgICAgX2xvZGFzaC5kZWZhdWx0LmVhY2goam9iLmFuYWx5c2lzX2NvbmZpZy5kZXRlY3RvcnMsIGZ1bmN0aW9uIChkdHIpIHsKICAgICAgICAgICAgICAgICAgaWYgKGR0ci5ieV9maWVsZF9uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzW2R0ci5ieV9maWVsZF9uYW1lXSA9IHt9OwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZiAoZHRyLmZpZWxkX25hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZHNbZHRyLmZpZWxkX25hbWVdID0ge307CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChkdHIub3Zlcl9maWVsZF9uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzW2R0ci5vdmVyX2ZpZWxkX25hbWVdID0ge307CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChkdHIucGFydGl0aW9uX2ZpZWxkX25hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZHNbZHRyLnBhcnRpdGlvbl9maWVsZF9uYW1lXSA9IHt9OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IC8vIGdldCBmaWVsZHMgZnJvbSBpbmZsdWVuY2VycwoKCiAgICAgICAgICAgICAgaWYgKGpvYi5hbmFseXNpc19jb25maWcuaW5mbHVlbmNlcnMpIHsKICAgICAgICAgICAgICAgIF9sb2Rhc2guZGVmYXVsdC5lYWNoKGpvYi5hbmFseXNpc19jb25maWcuaW5mbHVlbmNlcnMsIGZ1bmN0aW9uIChpbmYpIHsKICAgICAgICAgICAgICAgICAgZmllbGRzW2luZl0gPSB7fTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gLy8gZ2V0IGZpZWxkcyBmcm9tIGNhdGVnb3JpemF0aW9uRmllbGROYW1lCgoKICAgICAgICAgICAgICBpZiAoam9iLmFuYWx5c2lzX2NvbmZpZy5jYXRlZ29yaXphdGlvbl9maWVsZF9uYW1lKSB7CiAgICAgICAgICAgICAgICBmaWVsZHNbam9iLmFuYWx5c2lzX2NvbmZpZy5jYXRlZ29yaXphdGlvbl9maWVsZF9uYW1lXSA9IHt9OwogICAgICAgICAgICAgIH0gLy8gZ2V0IGZpZWxkcyBmcm9tIHN1bW1hcnlfY291bnRfZmllbGRfbmFtZQoKCiAgICAgICAgICAgICAgaWYgKGpvYi5hbmFseXNpc19jb25maWcuc3VtbWFyeV9jb3VudF9maWVsZF9uYW1lKSB7CiAgICAgICAgICAgICAgICBmaWVsZHNbam9iLmFuYWx5c2lzX2NvbmZpZy5zdW1tYXJ5X2NvdW50X2ZpZWxkX25hbWVdID0ge307CiAgICAgICAgICAgICAgfSAvLyBnZXQgZmllbGRzIGZyb20gdGltZV9maWVsZAoKCiAgICAgICAgICAgICAgaWYgKGpvYi5kYXRhX2Rlc2NyaXB0aW9uLnRpbWVfZmllbGQpIHsKICAgICAgICAgICAgICAgIGZpZWxkc1tqb2IuZGF0YV9kZXNjcmlwdGlvbi50aW1lX2ZpZWxkXSA9IHt9OwogICAgICAgICAgICAgIH0gLy8gY29uc29sZS5sb2coJ2ZpZWxkczogJywgZmllbGRzKTsKCgogICAgICAgICAgICAgIHZhciBmaWVsZHNMaXN0ID0gT2JqZWN0LmtleXMoZmllbGRzKTsKCiAgICAgICAgICAgICAgaWYgKGZpZWxkc0xpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBib2R5Ll9zb3VyY2UgPSBmaWVsZHNMaXN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgICAgaW5kZXg6IGpvYi5kYXRhZmVlZF9jb25maWcuaW5kaWNlcywKICAgICAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBfbWxfYXBpX3NlcnZpY2UubWwuZXNTZWFyY2goZGF0YSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgIHJlc29sdmUocmVzcCk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAgICAgcmVqZWN0KHJlc3ApOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAgIHJlamVjdChyZXNwKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAib3BlbkpvYiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb3BlbkpvYihqb2JJZCkgewogICAgICByZXR1cm4gX21sX2FwaV9zZXJ2aWNlLm1sLm9wZW5Kb2IoewogICAgICAgIGpvYklkOiBqb2JJZAogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbG9zZUpvYiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2xvc2VKb2Ioam9iSWQpIHsKICAgICAgcmV0dXJuIF9tbF9hcGlfc2VydmljZS5tbC5jbG9zZUpvYih7CiAgICAgICAgam9iSWQ6IGpvYklkCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogInNhdmVOZXdEYXRhZmVlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2F2ZU5ld0RhdGFmZWVkKGRhdGFmZWVkQ29uZmlnLCBqb2JJZCkgewogICAgICB2YXIgZGF0YWZlZWRJZCA9ICJkYXRhZmVlZC0iLmNvbmNhdChqb2JJZCk7CiAgICAgIGRhdGFmZWVkQ29uZmlnLmpvYl9pZCA9IGpvYklkOwogICAgICByZXR1cm4gX21sX2FwaV9zZXJ2aWNlLm1sLmFkZERhdGFmZWVkKHsKICAgICAgICBkYXRhZmVlZElkOiBkYXRhZmVlZElkLAogICAgICAgIGRhdGFmZWVkQ29uZmlnOiBkYXRhZmVlZENvbmZpZwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1cGRhdGVEYXRhZmVlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlRGF0YWZlZWQoZGF0YWZlZWRJZCwgZGF0YWZlZWRDb25maWcpIHsKICAgICAgcmV0dXJuIF9tbF9hcGlfc2VydmljZS5tbC51cGRhdGVEYXRhZmVlZCh7CiAgICAgICAgZGF0YWZlZWRJZDogZGF0YWZlZWRJZCwKICAgICAgICBkYXRhZmVlZENvbmZpZzogZGF0YWZlZWRDb25maWcKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGNvbnNvbGUubG9nKCd1cGRhdGUgZGF0YWZlZWQnLCByZXNwKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc3VjY2VzczogdHJ1ZQogICAgICAgIH07CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBtc2dzLmVycm9yKF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC5qb2JTZXJ2aWNlLmNvdWxkTm90VXBkYXRlRGF0YWZlZWRFcnJvck1lc3NhZ2UnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0NvdWxkIG5vdCB1cGRhdGUgZGF0YWZlZWQ6IHtkYXRhZmVlZElkfScsCiAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgZGF0YWZlZWRJZDogZGF0YWZlZWRJZAogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgICBjb25zb2xlLmxvZygndXBkYXRlIGRhdGFmZWVkJywgZXJyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZQogICAgICAgIH07CiAgICAgIH0pOwogICAgfSAvLyBzdGFydCB0aGUgZGF0YWZlZWQgZm9yIGEgZ2l2ZW4gam9iCiAgICAvLyByZWZyZXNoIHRoZSBqb2Igc3RhdGUgb24gc3RhcnQgc3VjY2VzcwoKICB9LCB7CiAgICBrZXk6ICJzdGFydERhdGFmZWVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzdGFydERhdGFmZWVkKGRhdGFmZWVkSWQsIGpvYklkLCBzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgLy8gaWYgdGhlIGVuZCB0aW1lc3RhbXAgaXMgYSBudW1iZXIsIGFkZCBvbmUgbXMgdG8gaXQgdG8gbWFrZSBpdAogICAgICAgIC8vIGluY2x1c2l2ZSBvZiB0aGUgZW5kIG9mIHRoZSBkYXRhCiAgICAgICAgaWYgKF9sb2Rhc2guZGVmYXVsdC5pc051bWJlcihlbmQpKSB7CiAgICAgICAgICBlbmQrKzsKICAgICAgICB9CgogICAgICAgIF9tbF9hcGlfc2VydmljZS5tbC5zdGFydERhdGFmZWVkKHsKICAgICAgICAgIGRhdGFmZWVkSWQ6IGRhdGFmZWVkSWQsCiAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICBlbmQ6IGVuZAogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgIHJlc29sdmUocmVzcCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29uc29sZS5sb2coJ2pvYlNlcnZpY2UgZXJyb3Igc3RhcnRpbmcgZGF0YWZlZWQ6JywgZXJyKTsKICAgICAgICAgIG1zZ3MuZXJyb3IoX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLm1sLmpvYlNlcnZpY2UuY291bGROb3RTdGFydERhdGFmZWVkRXJyb3JNZXNzYWdlJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0NvdWxkIG5vdCBzdGFydCBkYXRhZmVlZCBmb3Ige2pvYklkfScsCiAgICAgICAgICAgIHZhbHVlczogewogICAgICAgICAgICAgIGpvYklkOiBqb2JJZAogICAgICAgICAgICB9CiAgICAgICAgICB9KSwgZXJyKTsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gLy8gc3RvcCB0aGUgZGF0YWZlZWQgZm9yIGEgZ2l2ZW4gam9iCiAgICAvLyByZWZyZXNoIHRoZSBqb2Igc3RhdGUgb24gc3RvcCBzdWNjZXNzCgogIH0sIHsKICAgIGtleTogInN0b3BEYXRhZmVlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcERhdGFmZWVkKGRhdGFmZWVkSWQsIGpvYklkKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgX21sX2FwaV9zZXJ2aWNlLm1sLnN0b3BEYXRhZmVlZCh7CiAgICAgICAgICBkYXRhZmVlZElkOiBkYXRhZmVlZElkCiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgcmVzb2x2ZShyZXNwKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnam9iU2VydmljZSBlcnJvciBzdG9wcGluZyBkYXRhZmVlZDonLCBlcnIpOwoKICAgICAgICAgIHZhciBjb3VsZE5vdFN0b3BEYXRhZmVlZEVycm9yTWVzc2FnZSA9IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC5qb2JTZXJ2aWNlLmNvdWxkTm90U3RvcERhdGFmZWVkRXJyb3JNZXNzYWdlJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ0NvdWxkIG5vdCBzdG9wIGRhdGFmZWVkIGZvciB7am9iSWR9JywKICAgICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgICAgam9iSWQ6IGpvYklkCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChlcnIuc3RhdHVzQ29kZSA9PT0gNTAwKSB7CiAgICAgICAgICAgIG1zZ3MuZXJyb3IoY291bGROb3RTdG9wRGF0YWZlZWRFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICBtc2dzLmVycm9yKF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5tbC5qb2JTZXJ2aWNlLnJlcXVlc3RNYXlIYXZlVGltZWRPdXRFcnJvck1lc3NhZ2UnLCB7CiAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdSZXF1ZXN0IG1heSBoYXZlIHRpbWVkIG91dCBhbmQgbWF5IHN0aWxsIGJlIHJ1bm5pbmcgaW4gdGhlIGJhY2tncm91bmQuJwogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtc2dzLmVycm9yKGNvdWxkTm90U3RvcERhdGFmZWVkRXJyb3JNZXNzYWdlLCBlcnIpOwogICAgICAgICAgfQoKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJmb3JjZVN0YXJ0RGF0YWZlZWRzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmb3JjZVN0YXJ0RGF0YWZlZWRzKGRJZHMsIHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIF9tbF9hcGlfc2VydmljZS5tbC5qb2JzLmZvcmNlU3RhcnREYXRhZmVlZHMoZElkcywgc3RhcnQsIGVuZCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic3RvcERhdGFmZWVkcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3RvcERhdGFmZWVkcyhkSWRzKSB7CiAgICAgIHJldHVybiBfbWxfYXBpX3NlcnZpY2UubWwuam9icy5zdG9wRGF0YWZlZWRzKGRJZHMpOwogICAgfQogIH0sIHsKICAgIGtleTogImRlbGV0ZUpvYnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlbGV0ZUpvYnMoaklkcykgewogICAgICByZXR1cm4gX21sX2FwaV9zZXJ2aWNlLm1sLmpvYnMuZGVsZXRlSm9icyhqSWRzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbG9zZUpvYnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNsb3NlSm9icyhqSWRzKSB7CiAgICAgIHJldHVybiBfbWxfYXBpX3NlcnZpY2UubWwuam9icy5jbG9zZUpvYnMoaklkcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAidmFsaWRhdGVEZXRlY3RvciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVEZXRlY3RvcihkZXRlY3RvcikgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGlmIChkZXRlY3RvcikgewogICAgICAgICAgX21sX2FwaV9zZXJ2aWNlLm1sLnZhbGlkYXRlRGV0ZWN0b3IoewogICAgICAgICAgICBkZXRlY3RvcjogZGV0ZWN0b3IKICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgcmVzb2x2ZShyZXNwKTsKICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICAgIHJlamVjdChyZXNwKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWplY3Qoe30pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0RGF0YWZlZWRJZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RGF0YWZlZWRJZChqb2JJZCkgewogICAgICB2YXIgZGF0YWZlZWRJZCA9IGRhdGFmZWVkSWRzW2pvYklkXTsKCiAgICAgIGlmIChkYXRhZmVlZElkID09PSB1bmRlZmluZWQpIHsKICAgICAgICBkYXRhZmVlZElkID0gImRhdGFmZWVkLSIuY29uY2F0KGpvYklkKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRhdGFmZWVkSWQ7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0RGF0YWZlZWRQcmV2aWV3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXREYXRhZmVlZFByZXZpZXcoam9iSWQpIHsKICAgICAgdmFyIGRhdGFmZWVkSWQgPSB0aGlzLmdldERhdGFmZWVkSWQoam9iSWQpOwogICAgICByZXR1cm4gX21sX2FwaV9zZXJ2aWNlLm1sLmRhdGFmZWVkUHJldmlldyh7CiAgICAgICAgZGF0YWZlZWRJZDogZGF0YWZlZWRJZAogICAgICB9KTsKICAgIH0gLy8gZ2V0IHRoZSBsaXN0IG9mIGpvYiBncm91cCBpZHMgYXMgd2VsbCBhcyBob3cgbWFueSBqb2JzIGFyZSBpbiBlYWNoIGdyb3VwCgogIH0sIHsKICAgIGtleTogImdldEpvYkdyb3VwcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0Sm9iR3JvdXBzKCkgewogICAgICB2YXIgZ3JvdXBzID0gW107CiAgICAgIHZhciB0ZW1wR3JvdXBzID0ge307CiAgICAgIHRoaXMuam9icy5mb3JFYWNoKGZ1bmN0aW9uIChqb2IpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShqb2IuZ3JvdXBzKSkgewogICAgICAgICAgam9iLmdyb3Vwcy5mb3JFYWNoKGZ1bmN0aW9uIChncm91cCkgewogICAgICAgICAgICBpZiAodGVtcEdyb3Vwc1tncm91cF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHRlbXBHcm91cHNbZ3JvdXBdID0gW2pvYl07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGVtcEdyb3Vwc1tncm91cF0ucHVzaChqb2IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgX2xvZGFzaC5kZWZhdWx0LmVhY2godGVtcEdyb3VwcywgZnVuY3Rpb24gKGpzLCBpZCkgewogICAgICAgIGdyb3Vwcy5wdXNoKHsKICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgIGpvYnM6IGpzCiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGdyb3VwczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVSZXN1bHRzVXJsRm9ySm9icyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUmVzdWx0c1VybEZvckpvYnMoam9ic0xpc3QsIHJlc3VsdHNQYWdlKSB7CiAgICAgIHJldHVybiBfY3JlYXRlUmVzdWx0c1VybEZvckpvYnMoam9ic0xpc3QsIHJlc3VsdHNQYWdlKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVSZXN1bHRzVXJsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVSZXN1bHRzVXJsKGpvYklkcywgZnJvbSwgdG8sIHJlc3VsdHNQYWdlKSB7CiAgICAgIHJldHVybiBfY3JlYXRlUmVzdWx0c1VybChqb2JJZHMsIGZyb20sIHRvLCByZXN1bHRzUGFnZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0Sm9iQW5kR3JvdXBJZHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEpvYkFuZEdyb3VwSWRzKCkgewogICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmFzeW5jKGZ1bmN0aW9uIGdldEpvYkFuZEdyb3VwSWRzJChfY29udGV4dCkgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfY29udGV4dC5wcmV2ID0gMDsKICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMzsKICAgICAgICAgICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLmF3cmFwKF9tbF9hcGlfc2VydmljZS5tbC5qb2JzLmdldEFsbEpvYkFuZEdyb3VwSWRzKCkpOwoKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIF9jb250ZXh0LnNlbnQpOwoKICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSA2OwogICAgICAgICAgICAgIF9jb250ZXh0LnQwID0gX2NvbnRleHRbImNhdGNoIl0oMCk7CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgewogICAgICAgICAgICAgICAgam9iSWRzOiBbXSwKICAgICAgICAgICAgICAgIGdyb3VwSWRzOiBbXQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBudWxsLCBudWxsLCBbWzAsIDZdXSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gSm9iU2VydmljZTsKfSgpOyAvLyBwcml2YXRlIGZ1bmN0aW9uIHVzZWQgdG8gY2hlY2sgdGhlIGpvYiBzYXZpbmcgcmVzcG9uc2UKCgpmdW5jdGlvbiBjaGVja1NhdmVSZXNwb25zZShyZXNwLCBvcmlnSm9iKSB7CiAgaWYgKHJlc3ApIHsKICAgIGlmIChyZXNwLmpvYl9pZCkgewogICAgICBpZiAocmVzcC5qb2JfaWQgPT09IG9yaWdKb2Iuam9iX2lkKSB7CiAgICAgICAgY29uc29sZS5sb2coJ2NoZWNrU2F2ZVJlc3BvbnNlKCk6IHNhdmUgc3VjY2Vzc2Z1bCcpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocmVzcC5lcnJvckNvZGUpIHsKICAgICAgICBjb25zb2xlLmxvZygnY2hlY2tTYXZlUmVzcG9uc2UoKTogc2F2ZSBmYWlsZWQnLCByZXNwKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgY29uc29sZS5sb2coJ2NoZWNrU2F2ZVJlc3BvbnNlKCk6IHJlc3BvbnNlIGlzIGVtcHR5Jyk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CgpmdW5jdGlvbiBwcm9jZXNzQmFzaWNKb2JJbmZvKGxvY2FsSm9iU2VydmljZSwgam9ic0xpc3QpIHsKICAvLyBQcm9jZXNzIHRoZSBsaXN0IG9mIGpvYiBkYXRhIG9idGFpbmVkIGZyb20gdGhlIGpvYnMgZW5kcG9pbnQgdG8gcmV0dXJuCiAgLy8gYW4gYXJyYXkgb2Ygb2JqZWN0cyBjb250YWluaW5nIHRoZSBiYXNpYyBpbmZvcm1hdGlvbiAoaWQsIGRlc2NyaXB0aW9uLCBidWNrZXRTcGFuLAogIC8vIGFuZCBkZXRlY3RvcnMgcHJvcGVydGllcywgcGx1cyBhIGN1c3RvbVVybHMga2V5IGlmIGN1c3RvbSBVUkxzCiAgLy8gaGF2ZSBiZWVuIGNvbmZpZ3VyZWQgZm9yIHRoZSBqb2IpIHVzZWQgYnkgdmFyaW91cyByZXN1bHQgZGFzaGJvYXJkcyBpbiB0aGUgbWwgcGx1Z2luLgogIC8vIFRoZSBrZXkgaW5mb3JtYXRpb24gaXMgc3RvcmVkIGluIHRoZSBqb2JTZXJ2aWNlIG9iamVjdCBmb3IgcXVpY2sgYWNjZXNzLgogIHZhciBwcm9jZXNzZWRKb2JzTGlzdCA9IFtdOwogIHZhciBkZXRlY3RvcnNCeUpvYiA9IHt9OwogIHZhciBjdXN0b21VcmxzQnlKb2IgPSB7fTsgLy8gdXNlIGNsb25lZCBjb3B5IG9mIGpvYnMgbGlzdCBzbyBub3QgdG8gYWx0ZXIgdGhlIG9yaWdpbmFsCgogIHZhciBqb2JzTGlzdENvcHkgPSBfbG9kYXNoLmRlZmF1bHQuY2xvbmVEZWVwKGpvYnNMaXN0KTsKCiAgX2xvZGFzaC5kZWZhdWx0LmVhY2goam9ic0xpc3RDb3B5LCBmdW5jdGlvbiAoam9iT2JqKSB7CiAgICB2YXIgYW5hbHlzaXNDb25maWcgPSBqb2JPYmouYW5hbHlzaXNfY29uZmlnOwogICAgdmFyIGJ1Y2tldFNwYW4gPSAoMCwgX3BhcnNlX2ludGVydmFsLnBhcnNlSW50ZXJ2YWwpKGFuYWx5c2lzQ29uZmlnLmJ1Y2tldF9zcGFuKTsKICAgIHZhciBqb2IgPSB7CiAgICAgIGlkOiBqb2JPYmouam9iX2lkLAogICAgICBidWNrZXRTcGFuU2Vjb25kczogYnVja2V0U3Bhbi5hc1NlY29uZHMoKQogICAgfTsKCiAgICBpZiAoX2xvZGFzaC5kZWZhdWx0Lmhhcyhqb2JPYmosICdkZXNjcmlwdGlvbicpICYmIC9eXHMqJC8udGVzdChqb2JPYmouZGVzY3JpcHRpb24pID09PSBmYWxzZSkgewogICAgICBqb2IuZGVzY3JpcHRpb24gPSBqb2JPYmouZGVzY3JpcHRpb247CiAgICB9IGVsc2UgewogICAgICAvLyBKdXN0IHVzZSB0aGUgaWQgYXMgdGhlIGRlc2NyaXB0aW9uLgogICAgICBqb2IuZGVzY3JpcHRpb24gPSBqb2JPYmouam9iX2lkOwogICAgfQoKICAgIGpvYi5kZXRlY3RvcnMgPSBfbG9kYXNoLmRlZmF1bHQuZ2V0KGFuYWx5c2lzQ29uZmlnLCAnZGV0ZWN0b3JzJywgW10pOwogICAgZGV0ZWN0b3JzQnlKb2Jbam9iLmlkXSA9IGpvYi5kZXRlY3RvcnM7CgogICAgaWYgKF9sb2Rhc2guZGVmYXVsdC5oYXMoam9iT2JqLCAnY3VzdG9tX3NldHRpbmdzLmN1c3RvbV91cmxzJykpIHsKICAgICAgam9iLmN1c3RvbVVybHMgPSBbXTsKCiAgICAgIF9sb2Rhc2guZGVmYXVsdC5lYWNoKGpvYk9iai5jdXN0b21fc2V0dGluZ3MuY3VzdG9tX3VybHMsIGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICBpZiAoX2xvZGFzaC5kZWZhdWx0Lmhhcyh1cmwsICd1cmxfbmFtZScpICYmIF9sb2Rhc2guZGVmYXVsdC5oYXModXJsLCAndXJsX3ZhbHVlJykgJiYgKDAsIF91cmxfdXRpbHMuaXNXZWJVcmwpKHVybC51cmxfdmFsdWUpKSB7CiAgICAgICAgICAvLyBPbmx5IG1ha2Ugd2ViIFVSTHMgKGkuZS4gaHR0cCBvciBodHRwcykgYXZhaWxhYmxlIGluIGRhc2hib2FyZCBkcmlsbGRvd25zLgogICAgICAgICAgam9iLmN1c3RvbVVybHMucHVzaCh1cmwpOwogICAgICAgIH0KICAgICAgfSk7IC8vIE9ubHkgYWRkIGFuIGVudHJ5IGZvciBhIGpvYiBpZiBjdXN0b21VcmxzIGhhdmUgYmVlbiBkZWZpbmVkLgoKCiAgICAgIGlmIChqb2IuY3VzdG9tVXJscy5sZW5ndGggPiAwKSB7CiAgICAgICAgY3VzdG9tVXJsc0J5Sm9iW2pvYi5pZF0gPSBqb2IuY3VzdG9tVXJsczsKICAgICAgfQogICAgfQoKICAgIGxvY2FsSm9iU2VydmljZS5qb2JEZXNjcmlwdGlvbnNbam9iLmlkXSA9IGpvYi5kZXNjcmlwdGlvbjsKICAgIGxvY2FsSm9iU2VydmljZS5iYXNpY0pvYnNbam9iLmlkXSA9IGpvYjsKICAgIHByb2Nlc3NlZEpvYnNMaXN0LnB1c2goam9iKTsKICB9KTsKCiAgbG9jYWxKb2JTZXJ2aWNlLmRldGVjdG9yc0J5Sm9iID0gZGV0ZWN0b3JzQnlKb2I7CiAgbG9jYWxKb2JTZXJ2aWNlLmN1c3RvbVVybHNCeUpvYiA9IGN1c3RvbVVybHNCeUpvYjsKICByZXR1cm4gcHJvY2Vzc2VkSm9ic0xpc3Q7Cn0gLy8gTG9vcCB0aHJvdWdoIHRoZSBqb2JzIGxpc3QgYW5kIGNyZWF0ZSBiYXNpYyBzdGF0cwovLyBzdGF0cyBhcmUgZGlzcGxheWVkIGFsb25nIHRoZSB0b3Agb2YgdGhlIEpvYnMgTWFuYWdlbWVudCBwYWdlCgoKZnVuY3Rpb24gY3JlYXRlSm9iU3RhdHMoam9ic0xpc3QsIGpvYlN0YXRzKSB7CiAgam9iU3RhdHMuYWN0aXZlTm9kZXMudmFsdWUgPSAwOwogIGpvYlN0YXRzLnRvdGFsLnZhbHVlID0gMDsKICBqb2JTdGF0cy5vcGVuLnZhbHVlID0gMDsKICBqb2JTdGF0cy5jbG9zZWQudmFsdWUgPSAwOwogIGpvYlN0YXRzLmZhaWxlZC52YWx1ZSA9IDA7CiAgam9iU3RhdHMuYWN0aXZlRGF0YWZlZWRzLnZhbHVlID0gMDsgLy8gb2JqZWN0IHRvIGtlZXAgdHJhY2sgb2Ygbm9kZXMgYmVpbmcgdXNlZCBieSBqb2JzCgogIHZhciBtbE5vZGVzID0ge307CiAgdmFyIGZhaWxlZEpvYnMgPSAwOwoKICBfbG9kYXNoLmRlZmF1bHQuZWFjaChqb2JzTGlzdCwgZnVuY3Rpb24gKGpvYikgewogICAgaWYgKGpvYi5zdGF0ZSA9PT0gJ29wZW5lZCcpIHsKICAgICAgam9iU3RhdHMub3Blbi52YWx1ZSsrOwogICAgfSBlbHNlIGlmIChqb2Iuc3RhdGUgPT09ICdjbG9zZWQnKSB7CiAgICAgIGpvYlN0YXRzLmNsb3NlZC52YWx1ZSsrOwogICAgfSBlbHNlIGlmIChqb2Iuc3RhdGUgPT09ICdmYWlsZWQnKSB7CiAgICAgIGZhaWxlZEpvYnMrKzsKICAgIH0KCiAgICBpZiAoam9iLmRhdGFmZWVkX2NvbmZpZyAmJiBqb2IuZGF0YWZlZWRfY29uZmlnLnN0YXRlID09PSAnc3RhcnRlZCcpIHsKICAgICAgam9iU3RhdHMuYWN0aXZlRGF0YWZlZWRzLnZhbHVlKys7CiAgICB9CgogICAgaWYgKGpvYi5ub2RlICYmIGpvYi5ub2RlLm5hbWUpIHsKICAgICAgbWxOb2Rlc1tqb2Iubm9kZS5uYW1lXSA9IHt9OwogICAgfQogIH0pOwoKICBqb2JTdGF0cy50b3RhbC52YWx1ZSA9IGpvYnNMaXN0Lmxlbmd0aDsgLy8gLy8gT25seSBzaG93IGZhaWxlZCBqb2JzIGlmIGl0IGlzIG5vbi16ZXJvCgogIGlmIChmYWlsZWRKb2JzKSB7CiAgICBqb2JTdGF0cy5mYWlsZWQudmFsdWUgPSBmYWlsZWRKb2JzOwogICAgam9iU3RhdHMuZmFpbGVkLnNob3cgPSB0cnVlOwogIH0gZWxzZSB7CiAgICBqb2JTdGF0cy5mYWlsZWQuc2hvdyA9IGZhbHNlOwogIH0KCiAgam9iU3RhdHMuYWN0aXZlTm9kZXMudmFsdWUgPSBPYmplY3Qua2V5cyhtbE5vZGVzKS5sZW5ndGg7Cn0KCmZ1bmN0aW9uIF9jcmVhdGVSZXN1bHRzVXJsRm9ySm9icyhqb2JzTGlzdCwgcmVzdWx0c1BhZ2UpIHsKICB2YXIgZnJvbSA9IHVuZGVmaW5lZDsKICB2YXIgdG8gPSB1bmRlZmluZWQ7CgogIGlmIChqb2JzTGlzdC5sZW5ndGggPT09IDEpIHsKICAgIGZyb20gPSBqb2JzTGlzdFswXS5lYXJsaWVzdFRpbWVzdGFtcE1zOwogICAgdG8gPSBqb2JzTGlzdFswXS5sYXRlc3RSZXN1bHRzVGltZXN0YW1wTXM7IC8vIFdpbGwgYmUgbWF4KGxhdGVzdCBzb3VyY2UgZGF0YSwgbGF0ZXN0IGJ1Y2tldCByZXN1bHRzKQogIH0gZWxzZSB7CiAgICB2YXIgam9ic1dpdGhEYXRhID0gam9ic0xpc3QuZmlsdGVyKGZ1bmN0aW9uIChqKSB7CiAgICAgIHJldHVybiBqLmVhcmxpZXN0VGltZXN0YW1wTXMgIT09IHVuZGVmaW5lZDsKICAgIH0pOwoKICAgIGlmIChqb2JzV2l0aERhdGEubGVuZ3RoID4gMCkgewogICAgICBmcm9tID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgX3RvQ29uc3VtYWJsZUFycmF5KGpvYnNXaXRoRGF0YS5tYXAoZnVuY3Rpb24gKGopIHsKICAgICAgICByZXR1cm4gai5lYXJsaWVzdFRpbWVzdGFtcE1zOwogICAgICB9KSkpOwogICAgICB0byA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIF90b0NvbnN1bWFibGVBcnJheShqb2JzV2l0aERhdGEubWFwKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgcmV0dXJuIGoubGF0ZXN0UmVzdWx0c1RpbWVzdGFtcE1zOwogICAgICB9KSkpOwogICAgfQogIH0KCiAgdmFyIHRpbWVGb3JtYXQgPSAnWVlZWS1NTS1ERCBISDptbTpzcyc7CiAgdmFyIGZyb21TdHJpbmcgPSAoMCwgX21vbWVudC5kZWZhdWx0KShmcm9tKS5mb3JtYXQodGltZUZvcm1hdCk7IC8vIERlZmF1bHRzIHRvICdub3cnIGlmICdmcm9tJyBpcyB1bmRlZmluZWQKCiAgdmFyIHRvU3RyaW5nID0gKDAsIF9tb21lbnQuZGVmYXVsdCkodG8pLmZvcm1hdCh0aW1lRm9ybWF0KTsgLy8gRGVmYXVsdHMgdG8gJ25vdycgaWYgJ3RvJyBpcyB1bmRlZmluZWQKCiAgdmFyIGpvYklkcyA9IGpvYnNMaXN0Lm1hcChmdW5jdGlvbiAoaikgewogICAgcmV0dXJuIGouaWQ7CiAgfSk7CiAgcmV0dXJuIF9jcmVhdGVSZXN1bHRzVXJsKGpvYklkcywgZnJvbVN0cmluZywgdG9TdHJpbmcsIHJlc3VsdHNQYWdlKTsKfQoKZnVuY3Rpb24gX2NyZWF0ZVJlc3VsdHNVcmwoam9iSWRzLCBzdGFydCwgZW5kLCByZXN1bHRzUGFnZSkgewogIHZhciBpZFN0cmluZyA9IGpvYklkcy5tYXAoZnVuY3Rpb24gKGopIHsKICAgIHJldHVybiAiJyIuY29uY2F0KGosICInIik7CiAgfSkuam9pbignLCcpOwogIHZhciBmcm9tID0gKDAsIF9tb21lbnQuZGVmYXVsdCkoc3RhcnQpLnRvSVNPU3RyaW5nKCk7CiAgdmFyIHRvID0gKDAsIF9tb21lbnQuZGVmYXVsdCkoZW5kKS50b0lTT1N0cmluZygpOwogIHZhciBwYXRoID0gJyc7CgogIGlmIChyZXN1bHRzUGFnZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBwYXRoICs9ICcjLyc7CiAgICBwYXRoICs9IHJlc3VsdHNQYWdlOwogIH0KCiAgcGF0aCArPSAiP19nPShtbDooam9iSWRzOiEoIi5jb25jYXQoaWRTdHJpbmcsICIpKSIpOwogIHBhdGggKz0gIixyZWZyZXNoSW50ZXJ2YWw6KGRpc3BsYXk6T2ZmLHBhdXNlOiFmLHZhbHVlOjApLHRpbWU6KGZyb206JyIuY29uY2F0KGZyb20sICInIik7CiAgcGF0aCArPSAiLG1vZGU6YWJzb2x1dGUsdG86JyIuY29uY2F0KHRvLCAiJyIpOwogIHBhdGggKz0gIikpJl9hPShxdWVyeToocXVlcnlfc3RyaW5nOihhbmFseXplX3dpbGRjYXJkOiF0LHF1ZXJ5OicqJykpKSI7CiAgcmV0dXJuIHBhdGg7Cn0KCnZhciBtbEpvYlNlcnZpY2UgPSBuZXcgSm9iU2VydmljZSgpOwpleHBvcnRzLm1sSm9iU2VydmljZSA9IG1sSm9iU2VydmljZTs="},null]}